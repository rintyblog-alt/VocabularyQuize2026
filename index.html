<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light" />
  <!-- Public runtime config placeholders (replace on deploy; do not commit real keys). -->
  <meta name="firebase-api-key" content="AIzaSyB7DKVD4rQKekzfqzQiFzZBvonMXLOFWe0" />
  <meta name="firebase-auth-domain" content="vocabuquiz.firebaseapp.com" />
  <meta name="firebase-project-id" content="vocabuquiz" />
  <meta name="firebase-storage-bucket" content="vocabuquiz.firebasestorage.app" />
  <meta name="firebase-messaging-sender-id" content="290676646464" />
  <meta name="firebase-app-id" content="1:290676646464:web:cd3bba927ebbf71b4b35a5" />
  <meta name="emailjs-service-id" content="service_fyd3no8" />
  <meta name="emailjs-template-id" content="template_103i08s" />
  <meta name="emailjs-public-key" content="GQAs4-6iXdocFFrhE" />
  <title>VocabuQuiz</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,500,0,0" />
  <style>
    :root{
      --bg:#fbfbf9;
      --panel:#ffffff;
      --text:#111214;
      --muted:#5b6068;
      --border:#d9dde3;
      --shadow: 0 10px 30px rgba(17,18,20,.06);
      --accent:#1f2a44;
      --radius:14px;
      --radius-sm:10px;
      --fade:.26s;
      --ok:#0f5132;
      --ng:#842029;
      --okbg:rgba(15,81,50,.08);
      --ngbg:rgba(132,32,41,.08);
      --maru:#d11f2a; /* correct: red circle */
      --batsu:#1c4fd6; /* wrong: blue cross */
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", "Hiragino Sans", "Hiragino Kaku Gothic ProN", Meiryo, Arial, sans-serif;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    .app{
      min-height:100%;
      display:flex;
      flex-direction:column;
      align-items:center;
    }

    .topbar{
      width:100%;
      max-width:980px;
      padding:14px 18px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }

    .brand{
      display:flex;
      align-items:baseline;
      gap:10px;
      min-width:0;
    }
    .brand-title{
      font-weight:650;
      letter-spacing:.02em;
      color:var(--accent);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .brand-sub{
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .icon-btn{
      appearance:none;
      border:1px solid var(--border);
      background:var(--panel);
      color:var(--accent);
      border-radius:999px;
      position:relative;
      width:40px;
      height:40px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      box-shadow: 0 2px 10px rgba(17,18,20,.04);
      transition: transform var(--fade) ease, opacity var(--fade) ease, background var(--fade) ease;
    }
    .icon-btn:active{ transform: translateY(1px); }
    .icon-btn[disabled]{ opacity:.45; cursor:not-allowed; }

    /* ===== Phase 1 Frame Refresh ===== */
    .topbar{
      position:sticky;
      top:0;
      display:block;
      z-index:50;
      width:100%;
      max-width:none;
      padding: 10px 14px;
      border-bottom: 1px solid rgba(217,221,227,.7);
      background: rgba(251,251,249,.92);
    }
    @supports (backdrop-filter: blur(1px)){
      .topbar{ backdrop-filter: blur(10px); }
    }
    .topbar-inner{
      width:100%;
      max-width: 1040px;
      margin:0 auto;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .topbar-left{
      display:flex;
      align-items:center;
      gap:12px;
      min-width:0;
    }
    .topbar-actions{
      display:flex;
      align-items:center;
      gap:10px;
    }

    .ms{
      font-family: "Material Symbols Rounded";
      font-weight: 500;
      font-style: normal;
      font-size: 20px;
      line-height: 1;
      display:inline-block;
      letter-spacing: normal;
      text-transform: none;
      white-space: nowrap;
      word-wrap: normal;
      direction: ltr;
      -webkit-font-feature-settings: "liga";
      -webkit-font-smoothing: antialiased;
    }

    .notif-dot{
      position:absolute;
      right:10px;
      top:10px;
      width:8px;
      height:8px;
      border-radius:999px;
      background:#d11f2a;
      box-shadow: 0 0 0 2px var(--panel);
    }

    /* Start view */
    .start-wrap{
      min-height: min(72vh, 620px);
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 28px 0 6px;
    }
    .start-hero{
      width:100%;
      border:1px solid var(--border);
      background: var(--panel);
      border-radius: calc(var(--radius) + 4px);
      padding: 34px 26px 26px;
      box-shadow: var(--shadow);
      text-align:center;
    }
    .start-kicker{
      font-size:12px;
      letter-spacing:.18em;
      text-transform:uppercase;
      color:var(--muted);
      margin-bottom:10px;
    }
    .start-title{
      margin:0;
      font-size: clamp(40px, 6vw, 64px);
      font-weight: 760;
      letter-spacing: .02em;
      color: var(--accent);
      line-height:1.04;
    }
    .start-sub{
      margin: 14px auto 0;
      max-width: 52ch;
      color: var(--muted);
      font-size: 14px;
      line-height: 1.7;
    }
    .start-actions{
      margin-top: 22px;
      display:flex;
      justify-content:center;
    }
    .start-primary{
      appearance:none;
      border:1px solid rgba(31,42,68,.22);
      background: linear-gradient(180deg, rgba(31,42,68,.10), rgba(31,42,68,.06));
      color: var(--accent);
      border-radius: 999px;
      padding: 12px 18px;
      font-weight: 700;
      letter-spacing: .01em;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:10px;
      box-shadow: 0 10px 24px rgba(17,18,20,.08);
      transition: transform var(--fade) ease, box-shadow var(--fade) ease, background var(--fade) ease, border-color var(--fade) ease;
    }
    .start-primary:hover{
      border-color: rgba(31,42,68,.34);
      box-shadow: 0 12px 30px rgba(17,18,20,.10);
    }
    .start-primary:active{ transform: translateY(1px) scale(.99); }
    .start-note{
      margin-top: 18px;
      display:flex;
      gap:8px;
      justify-content:center;
      flex-wrap:wrap;
    }
    .start-chip{
      font-size:12px;
      color: var(--muted);
      border:1px solid var(--border);
      background: rgba(255,255,255,.72);
      border-radius:999px;
      padding: 6px 10px;
    }

    /* Notifications */
    .notify-sheet{ max-width: 720px; }
    .notify-body{ padding-top: 12px; }
    .notify-list{ display:flex; flex-direction:column; gap:10px; }
    .notify-pane.hidden{ display:none; }
    .notify-item{
      border:1px solid var(--border);
      border-radius: 14px;
      padding: 12px 12px;
      background: rgba(255,255,255,.72);
      box-shadow: 0 2px 10px rgba(17,18,20,.04);
      display:grid;
      gap:8px;
    }
    .notify-item.unread{
      border-color: rgba(31,42,68,.26);
      background: rgba(31,42,68,.04);
    }
    .notify-title{
      font-weight: 720;
      letter-spacing:.01em;
      color: var(--accent);
      margin:0;
      font-size: 14px;
      line-height: 1.35;
    }
    .notify-bodytext{
      margin:6px 0 0;
      color: var(--text);
      font-size: 13px;
      line-height: 1.6;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      word-break: break-word;
    }
    .notify-time{
      margin-top:8px;
      color: var(--muted);
      font-size: 12px;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .notify-actions{
      margin-top: 4px;
      display:flex;
      justify-content:flex-end;
    }
    .notify-detail-wrap{
      display:grid;
      gap:10px;
      min-height: 160px;
    }
    .notify-detail-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap: wrap;
    }
    .notify-detail-title{
      margin:0;
      font-weight: 760;
      color: var(--accent);
      font-size: 16px;
      line-height: 1.4;
    }
    .notify-detail-meta{
      font-size: 12px;
      color: var(--muted);
      display:flex;
      flex-wrap: wrap;
      gap:8px;
    }
    .notify-detail-content{
      display:grid;
      gap:10px;
    }
    .notify-detail-content h3{
      margin: 6px 0 2px;
      font-size: 15px;
      color: var(--accent);
      letter-spacing: .01em;
    }
    .notify-detail-text{
      color: var(--text);
      font-size: 13px;
      line-height: 1.7;
      word-break: break-word;
    }
    .notify-detail-text a{
      color: var(--accent);
      text-decoration: underline;
      text-underline-offset: 2px;
    }
    .notify-invalid{
      font-size: 12px;
      color: #b42318;
      border: 1px solid rgba(180,35,24,.22);
      background: rgba(180,35,24,.06);
      border-radius: 10px;
      padding: 7px 10px;
    }
    .notify-media{
      display:grid;
      gap:6px;
    }
    .notify-media img{
      width:100%;
      max-width:100%;
      height:auto;
      border-radius: 12px;
      border:1px solid var(--border);
      display:block;
      background:#fff;
    }
    .notify-video{
      border:1px solid rgba(17,18,20,.12);
      border-radius: 12px;
      background: #fff;
      overflow: hidden;
    }
    .notify-video-screen{
      width:100%;
      display:block;
      background:#000;
    }
    .notify-video-controls{
      display:grid;
      gap:8px;
      padding:10px;
    }
    .notify-video-row{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap: wrap;
    }
    .notify-video-time{
      font-size:12px;
      color: var(--muted);
      min-width: 76px;
      text-align: right;
      font-variant-numeric: tabular-nums;
    }
    .notify-video-seek{
      width:100%;
    }
    .notify-empty{
      color: var(--muted);
      font-size: 13px;
      padding: 14px 6px;
    }

    main{
      width:100%;
      max-width:980px;
      padding: 0 18px 110px;
      display:flex;
      justify-content:center;
    }

    .stage{
      width:100%;
      max-width:720px;
    }

    .view{ display:none; }
    .view.active{ display:block; }

    /* Title view */
    .hero{
      background: linear-gradient(180deg, rgba(31,42,68,.06), rgba(31,42,68,0) 62%);
      border:1px solid var(--border);
      border-radius: var(--radius);
      padding: 22px 22px 20px;
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }
    .hero::after{
      content:"";
      position:absolute;
      inset:-40% -30%;
      background: radial-gradient(closest-side, rgba(31,42,68,.10), rgba(31,42,68,0));
      opacity:.45;
      pointer-events:none;
    }

    .h1{
      margin:0;
      font-size:26px;
      font-weight:720;
      letter-spacing:.02em;
      color:var(--accent);
    }
    .subtitle{
      margin:10px 0 0;
      color:var(--muted);
      font-size:14px;
      line-height:1.6;
    }

    .section{
      margin-top:14px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .section-title{
      font-size:12px;
      color:var(--muted);
      letter-spacing:.08em;
      text-transform:uppercase;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .section-title .right{
      font-size:12px;
      color:var(--muted);
      letter-spacing:normal;
      text-transform:none;
    }

    .actions{
      margin-top:8px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width:520px){
      .actions{ grid-template-columns:1fr; }
    }

    .btn{
      appearance:none;
      border:1px solid var(--border);
      background:var(--panel);
      color:var(--text);
      border-radius: var(--radius-sm);
      padding: 14px 14px;
      cursor:pointer;
      text-align:left;
      box-shadow: 0 2px 12px rgba(17,18,20,.04);
      transition: transform var(--fade) ease, border-color var(--fade) ease, opacity var(--fade) ease;
      display:flex;
      flex-direction:column;
      gap:4px;
      min-height:58px;
    }
    .btn:hover{ border-color: rgba(31,42,68,.32); }
    .btn:active{ transform: translateY(1px); }
    .btn[disabled]{ opacity:.45; cursor:not-allowed; }

    .btn .label{
      font-weight:650;
      letter-spacing:.01em;
      color:var(--accent);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .btn .desc{
      font-size:12px;
      color:var(--muted);
      line-height:1.5;
    }

    .fineprint{
      margin-top:14px;
      font-size:12px;
      color:var(--muted);
      line-height:1.6;
      display:flex;
      align-items:flex-start;
      gap:8px;
    }
    .badge{
      border:1px solid var(--border);
      background: rgba(255,255,255,.7);
      border-radius:999px;
      padding:2px 8px;
      font-size:11px;
      color:var(--muted);
      white-space:nowrap;
    }

    /* Seg (tabs) */
    .seg{
      display:inline-flex;
      border:1px solid rgba(31,42,68,.18);
      border-radius:999px;
      overflow:hidden;
      background:#fff;
      flex-shrink:0;
    }
    .seg button{
      appearance:none;
      border:0;
      background:transparent;
      padding:9px 12px;
      font-size:12px;
      cursor:pointer;
      color:var(--muted);
      transition: background var(--fade) ease, color var(--fade) ease;
      white-space:nowrap;
    }
    .seg button.active{
      background: rgba(31,42,68,.10);
      color: var(--accent);
      font-weight:650;
    }

    /* Quiz view */
    .quiz-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin: 4px 2px 10px;
    }
    .pill{
      border:1px solid var(--border);
      border-radius:999px;
      padding:6px 10px;
      font-size:12px;
      color:var(--muted);
      background: rgba(255,255,255,.7);
      white-space:nowrap;
    }
    .progress{
      font-size:12px;
      color:var(--muted);
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }
    .progress strong{ color:var(--accent); }

    .card{
      position:relative;
      overflow:hidden;
      border:1px solid var(--border);
      border-radius: var(--radius);
      background:var(--panel);
      box-shadow: var(--shadow);
      padding: 18px 18px 16px;
      transition: opacity var(--fade) ease, transform var(--fade) ease;
    }
    .card.fade-out{
      opacity:0;
      transform: translateY(2px);
    }

    .mark-layer{
      position:absolute;
      top:10px;
      right:10px;
      width:74px;
      height:74px;
      pointer-events:none;
      opacity:0;
      transform: translateY(-2px) scale(.98);
      transition: opacity .18s ease, transform .18s ease;
      filter: drop-shadow(0 8px 18px rgba(17,18,20,.10));
    }
    .mark-layer.show{
      opacity:1;
      transform: translateY(0) scale(1);
    }
    .mark-layer svg{
      width:100%;
      height:100%;
      display:block;
    }
    .mark-layer .ring{
      fill:none;
      stroke: var(--maru);
      stroke-width:8.5;
      stroke-linecap:round;
      stroke-dasharray: 310;
      stroke-dashoffset: 310;
    }
    .mark-layer .xline{
      stroke: var(--batsu);
      stroke-width:9;
      stroke-linecap:round;
      stroke-dasharray: 120;
      stroke-dashoffset: 120;
    }
    .mark-layer.ok .ring{ animation: drawRing .55s ease forwards; }
    .mark-layer.ng .x1{ animation: drawLine .40s ease forwards; }
    .mark-layer.ng .x2{ animation: drawLine .40s .10s ease forwards; }

    @keyframes drawRing{ to{ stroke-dashoffset: 0; } }
    @keyframes drawLine{ to{ stroke-dashoffset: 0; } }

    .meta{
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      gap:10px;
      margin-bottom:10px;
    }
    .no{
      font-size:12px;
      color:var(--muted);
    }
    .dir{
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .judge{
      font-size:11px;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid rgba(31,42,68,.16);
      background: rgba(255,255,255,.7);
      color: var(--muted);
    }
    .judge.ok{
      border-color: rgba(15,81,50,.22);
      background: var(--okbg);
      color: var(--ok);
      font-weight:650;
    }
    .judge.ng{
      border-color: rgba(132,32,41,.22);
      background: var(--ngbg);
      color: var(--ng);
      font-weight:650;
    }

    .prompt{
      font-size:26px;
      font-weight:720;
      letter-spacing:.02em;
      line-height:1.2;
      color:var(--text);
      word-break:break-word;
    }

    .answer-wrap{
      margin-top:14px;
      padding-top:14px;
      border-top:1px dashed rgba(31,42,68,.18);
    }
    .answer-label{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.10em;
      color:var(--muted);
      margin-bottom:6px;
    }
    .answer{
      font-size:18px;
      line-height:1.55;
      color:var(--accent);
      word-break:break-word;
    }
    .hidden{ display:none !important; }

    .hand-wrap{
      margin-top:12px;
      padding-top:12px;
      border-top:1px dashed rgba(31,42,68,.18);
    }
    .hand-title{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.10em;
      color:var(--muted);
      margin-bottom:8px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .hand-title .mini{
      font-size:11px;
      color:var(--muted);
      letter-spacing:normal;
      text-transform:none;
      white-space:nowrap;
    }
    .hand-canvas{
      width:100%;
      height:220px;
      border:1px solid var(--border);
      border-radius:12px;
      background:#fff;
      display:block;
      touch-action:none;
      box-shadow: 0 2px 10px rgba(17,18,20,.04) inset;
    }
    .hand-controls{
      margin-top:8px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }
    .hand-controls .left,
    .hand-controls .right{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .hand-note{
      font-size:12px;
      color:var(--muted);
      line-height:1.5;
    }

    
    .choice-wrap{
      margin-top:12px;
      padding-top:12px;
      border-top:1px dashed rgba(31,42,68,.18);
    }
    .choice-label{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.10em;
      color:var(--muted);
      margin-bottom:8px;
    }
    .choices{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
    }
    .choice-btn{
      appearance:none;
      border:1px solid var(--border);
      background: #fff;
      color: var(--text);
      border-radius: 12px;
      padding: 12px 12px;
      cursor:pointer;
      text-align:left;
      line-height:1.45;
      transition: transform var(--fade) ease, border-color var(--fade) ease, background var(--fade) ease, opacity var(--fade) ease;
      box-shadow: 0 2px 10px rgba(17,18,20,.04);
    }
    .choice-btn:hover{ border-color: rgba(31,42,68,.32); }
    .choice-btn:active{ transform: translateY(1px); }
    .choice-btn[disabled]{ opacity:.70; cursor:not-allowed; }
    .choice-btn.correct{
      border-color: rgba(15,81,50,.24);
      background: var(--okbg);
    }
    .choice-btn.wrong{
      border-color: rgba(132,32,41,.24);
      background: var(--ngbg);
    }
    .choice-btn .k{
      font-size:12px;
      color: var(--muted);
      margin-bottom:4px;
      display:inline-block;
      min-width: 16px;
    }
.spell-wrap{
      margin-top:12px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .spell-row{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .spell-label{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.10em;
      color:var(--muted);
    }
    .spell-input{
      flex:1 1 240px;
      min-width:220px;
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px 12px;
      font-size:18px;
      line-height:1.2;
      outline:none;
      background:#fff;
      box-shadow: 0 2px 10px rgba(17,18,20,.04) inset;
    }
    .spell-input:disabled{ opacity:.65; }

    .controls{
      margin-top:12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .controls .left,
    .controls .right{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }

    .cta{
      appearance:none;
      border:1px solid rgba(31,42,68,.24);
      background: rgba(31,42,68,.06);
      color:var(--accent);
      border-radius: 999px;
      padding: 10px 14px;
      cursor:pointer;
      font-weight:650;
      letter-spacing:.01em;
      transition: transform var(--fade) ease, background var(--fade) ease, opacity var(--fade) ease;
    }
    .cta:hover{ background: rgba(31,42,68,.085); }
    .cta:active{ transform: translateY(1px); }
    .cta[disabled]{ opacity:.50; cursor:not-allowed; }

    .navbtn{
      appearance:none;
      border:1px solid var(--border);
      background:var(--panel);
      color:var(--text);
      border-radius: 999px;
      padding: 10px 14px;
      cursor:pointer;
      transition: transform var(--fade) ease, opacity var(--fade) ease, border-color var(--fade) ease;
    }
    .navbtn:hover{ border-color: rgba(31,42,68,.32); }
    .navbtn:active{ transform: translateY(1px); }
    .navbtn[disabled]{ opacity:.45; cursor:not-allowed; }

    .hint{
      margin-top:10px;
      font-size:12px;
      color:var(--muted);
      line-height:1.6;
      padding-left:2px;
    }

    .debug-bar{
      margin-top:10px;
      font-size:11px;
      color:var(--muted);
      line-height:1.5;
      padding: 10px 12px;
      border:1px dashed rgba(31,42,68,.18);
      border-radius: var(--radius-sm);
      background: rgba(255,255,255,.6);
    }
    .debug-bar strong{ color: var(--accent); }
    .debug-bar:empty{ display:none; }

    /* Result view */
    .result-box{
      margin-top:12px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.70);
      border-radius: var(--radius);
      padding: 14px 14px;
      box-shadow: 0 2px 10px rgba(17,18,20,.04);
    }
    .scoreline{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .scorebig{
      font-size:34px;
      font-weight:760;
      letter-spacing:.01em;
      color: var(--accent);
    }
    .scoresub{
      font-size:12px;
      color: var(--muted);
    }
    details{
      margin-top:12px;
      border:1px dashed rgba(31,42,68,.18);
      border-radius: var(--radius-sm);
      background: rgba(255,255,255,.55);
      padding: 10px 12px;
    }
    summary{
      cursor:pointer;
      color: var(--accent);
      font-weight:650;
      list-style:none;
    }
    summary::-webkit-details-marker{ display:none; }
    .wrong-list{
      margin:10px 0 0;
      padding:0;
      list-style:none;
      display:flex;
      flex-direction:column;
      gap:8px;
      color: var(--text);
    }
    .wrong-item{
      border:1px solid rgba(31,42,68,.10);
      border-radius: 12px;
      padding: 10px 10px;
      background: rgba(31,42,68,.03);
    }
    .wrong-item .top{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:baseline;
      flex-wrap:wrap;
      margin-bottom:6px;
      color: var(--muted);
      font-size:12px;
    }
    .wrong-item .mid{
      font-size:14px;
      line-height:1.55;
    }
    .wrong-item code{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12.5px;
      background: rgba(255,255,255,.7);
      border:1px solid rgba(31,42,68,.12);
      border-radius: 8px;
      padding: 2px 6px;
    }

    /* Overlay settings */
    .overlay{
      position:fixed;
      inset:0;
      background: rgba(17,18,20,.32);
      display:flex;
      justify-content:center;
      align-items:flex-end;
      padding: 18px;
      z-index:50;
      transition: opacity var(--fade) ease;
    }
    .overlay.hidden{ display:none; }

    .sheet{
      width:100%;
      max-width:720px;
      border-radius: var(--radius);
      background: var(--panel);
      border:1px solid var(--border);
      box-shadow: 0 24px 80px rgba(17,18,20,.24);
      overflow:hidden;
      max-height: calc(100vh - 40px);
      display:flex;
      flex-direction:column;
    }
    .sheet-header{
      padding: 14px 16px;
      border-bottom:1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .sheet-title{
      font-weight:700;
      letter-spacing:.02em;
      color:var(--accent);
    }
    .sheet-body{
      padding: 14px 16px 16px;
      display:grid;
      gap:14px;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      flex:1;
      min-height:0;
    }

    .setting{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:14px;
      padding: 12px 12px;
      border:1px solid rgba(31,42,68,.12);
      border-radius: var(--radius-sm);
      background: rgba(31,42,68,.03);
    }
    .setting .text{
      min-width:0;
    }
    .setting .name{
      font-weight:650;
      color:var(--text);
      margin-bottom:3px;
    }
    .setting .note{
      font-size:12px;
      color:var(--muted);
      line-height:1.5;
    }

    .toggle{
      display:flex;
      align-items:center;
      gap:10px;
      flex-shrink:0;
      user-select:none;
    }
    .toggle input{
      width:44px;
      height:26px;
      appearance:none;
      background: rgba(31,42,68,.12);
      border:1px solid rgba(31,42,68,.14);
      border-radius:999px;
      position:relative;
      outline:none;
      cursor:pointer;
      transition: background var(--fade) ease;
    }
    .toggle input::after{
      content:"";
      width:20px;
      height:20px;
      background:#fff;
      border:1px solid rgba(31,42,68,.18);
      border-radius:999px;
      position:absolute;
      top:50%;
      left:3px;
      transform: translateY(-50%);
      box-shadow: 0 4px 14px rgba(17,18,20,.12);
      transition: left var(--fade) ease;
    }
    .toggle input:checked{
      background: rgba(31,42,68,.26);
    }
    .toggle input:checked::after{
      left:21px;
    }

    .sheet-footer{
      padding: 12px 16px;
      border-top:1px solid var(--border);
      display:flex;
      justify-content:flex-end;
      gap:10px;
    }

    .textbtn{
      appearance:none;
      border:1px solid var(--border);
      background:var(--panel);
      color:var(--text);
      border-radius:999px;
      padding:10px 14px;
      cursor:pointer;
      transition: transform var(--fade) ease, border-color var(--fade) ease;
    }
    .textbtn:hover{ border-color: rgba(31,42,68,.32); }
    .textbtn:active{ transform: translateY(1px); }

    /* corner footer */
    .corner{
      position:fixed;
      right:10px;
      bottom:10px;
      z-index:10;
      pointer-events:none;
      opacity:.70;
    }
    .version{
      font-size:11px;
      color:var(--muted);
      text-align:right;
      line-height:1.35;
      background: rgba(255,255,255,.65);
      border:1px solid rgba(31,42,68,.10);
      border-radius:10px;
      padding:7px 9px;
      box-shadow: 0 6px 24px rgba(17,18,20,.06);
      backdrop-filter: blur(6px);
    }

    @media (prefers-reduced-motion: reduce){
      *{ transition:none !important; }
      .mark-layer.ok .ring,
      .mark-layer.ng .x1,
      .mark-layer.ng .x2{ animation:none !important; stroke-dashoffset:0 !important; }
    }
  

/* =========================================================
   Apple Website UI Refresh (UI-only) v13
   - No logic changes
   - Pure CSS overrides + animations
   ========================================================= */

:root{
  --bg:#f5f5f7;
  --panel:#ffffff;
  --text:#1d1d1f;
  --muted:#6e6e73;
  --border: rgba(0,0,0,.10);
  --shadow: 0 24px 70px rgba(0,0,0,.10);
  --accent:#1d1d1f;
  --radius:18px;
  --radius-sm:14px;
  --fade:.32s;
  --ease: cubic-bezier(0.22, 1, 0.36, 1);
  --hairline: rgba(0,0,0,.08);
  --glass: rgba(255,255,255,.65);
  --glass-strong: rgba(255,255,255,.82);
  --focus: rgba(0,113,227,.35);
}

/* Global typography */
body{
  background: var(--bg);
  color: var(--text);
  font-family:
    -apple-system,
    BlinkMacSystemFont,
    "SF Pro Text",
    "SF Pro Display",
    system-ui,
    "Hiragino Sans",
    "Hiragino Kaku Gothic ProN",
    Meiryo,
    sans-serif;
  letter-spacing: -0.01em;
}

a{ color: inherit; }
::selection{ background: rgba(0,0,0,.10); }

/* Layout breathing room */
.topbar{
  padding:18px 18px;
}
.brand-title{
  font-weight: 650;
  letter-spacing: -0.02em;
  color: var(--text);
}
.brand-sub{
  color: var(--muted);
}

/* Apple-like icon button (glass) */
.icon-btn{
  border:1px solid var(--hairline);
  background: var(--glass-strong);
  color: var(--text);
  box-shadow: 0 10px 30px rgba(0,0,0,.10);
  transition:
    transform .25s var(--ease),
    box-shadow .35s var(--ease),
    background .35s var(--ease),
    border-color .35s var(--ease);
}
@supports ((-webkit-backdrop-filter: blur(1px)) or (backdrop-filter: blur(1px))){
  .icon-btn{
    background: var(--glass);
    -webkit-backdrop-filter: blur(14px) saturate(180%);
    backdrop-filter: blur(14px) saturate(180%);
  }
}
.icon-btn:hover{
  transform: translateY(-1px);
  box-shadow: 0 16px 46px rgba(0,0,0,.14);
  border-color: rgba(0,0,0,.12);
}
.icon-btn:active{
  transform: translateY(1px) scale(.98);
}

/* Hero (title/result) */
.hero{
  border:1px solid var(--hairline);
  background:
    radial-gradient(1200px 700px at 20% -18%, rgba(0,0,0,.06), rgba(245,245,247,0) 62%),
    radial-gradient(900px 520px at 85% -12%, rgba(0,0,0,.04), rgba(245,245,247,0) 60%),
    var(--panel);
  box-shadow: var(--shadow);
  padding: 34px 32px 28px;
}
.hero::after{ display:none !important; }

.h1{
  font-size: clamp(32px, 4.6vw, 48px);
  line-height: 1.06;
  font-weight: 780;
  letter-spacing: -0.03em;
  color: var(--text);
}
.subtitle{
  font-size: 15px;
  color: var(--muted);
  margin-top: 14px;
}
.section{ margin-top: 18px; gap:12px; }
.section-title{
  color: var(--muted);
  letter-spacing: .14em;
}

/* Mode cards */
.btn{
  border:1px solid var(--hairline);
  border-radius: 18px;
  background: var(--panel);
  box-shadow: 0 22px 60px rgba(0,0,0,.10);
  padding: 18px 18px;
  min-height: 76px;
  transition:
    transform .25s var(--ease),
    box-shadow .40s var(--ease),
    border-color .40s var(--ease),
    background .40s var(--ease);
  will-change: transform;
}
@media (hover:hover){
  .btn:hover{
    transform: translateY(-2px);
    box-shadow: 0 30px 90px rgba(0,0,0,.14);
    border-color: rgba(0,0,0,.12);
  }
}
.btn:active{
  transform: translateY(0) scale(.99);
}
.btn .label{
  font-size: 15px;
  font-weight: 760;
  letter-spacing: -0.02em;
  color: var(--text);
}
.btn .desc{
  font-size: 13px;
  color: var(--muted);
}

/* Quiz header pills */
.quiz-header{
  display:grid;
  grid-template-columns: 1fr auto 1fr;
  align-items:center;
  gap:12px;
  margin: 10px 0 18px;
}
@media (max-width:520px){
  .quiz-header{
    grid-template-columns: 1fr;
    justify-items: stretch;
    gap:10px;
    margin: 10px 0 14px;
  }
}

.progress, .pill{
  border:1px solid var(--hairline);
  background: var(--glass-strong);
  box-shadow: 0 10px 30px rgba(0,0,0,.10);
}
@supports ((-webkit-backdrop-filter: blur(1px)) or (backdrop-filter: blur(1px))){
  .progress, .pill{
    background: var(--glass);
    -webkit-backdrop-filter: blur(14px) saturate(180%);
    backdrop-filter: blur(14px) saturate(180%);
  }
}
.progress{
  justify-self:start;
  padding: 10px 12px;
  border-radius: 999px;
}
#modePill{
  justify-self:end;
}
#timerPill{
  justify-self:center;
  padding: 12px 18px;
  font-size: clamp(26px, 4.8vw, 46px);
  font-weight: 800;
  letter-spacing: -0.03em;
  border-radius: 999px;
  box-shadow: 0 22px 70px rgba(0,0,0,.16);
}

/* Card */
.card{
  border:1px solid var(--hairline);
  border-radius: var(--radius);
  background: var(--panel);
  box-shadow: 0 30px 90px rgba(0,0,0,.12);
  padding: 26px 24px 22px;
  transition:
    opacity .55s var(--ease),
    transform .55s var(--ease),
    filter .55s var(--ease),
    box-shadow .55s var(--ease);
}
.card.fade-out{
  opacity:0;
  transform: translateY(14px) scale(.985);
  filter: blur(2px);
}
@media (max-width:520px){
  .card{ padding: 22px 18px 18px; }
}

.meta .no{
  font-weight: 650;
  letter-spacing: -0.01em;
}
.prompt{
  font-size: clamp(22px, 4.4vw, 34px);
  font-weight: 760;
  letter-spacing: -0.03em;
  line-height: 1.18;
}

/* Controls */
.controls{ margin-top: 16px; }
.cta{
  border:1px solid rgba(0,0,0,.10);
  background: rgba(255,255,255,.90);
  color: var(--text);
  box-shadow: 0 16px 46px rgba(0,0,0,.10);
  transition:
    transform .22s var(--ease),
    box-shadow .35s var(--ease),
    background .35s var(--ease),
    border-color .35s var(--ease);
}
@supports ((-webkit-backdrop-filter: blur(1px)) or (backdrop-filter: blur(1px))){
  .cta{
    background: var(--glass);
    -webkit-backdrop-filter: blur(14px) saturate(180%);
    backdrop-filter: blur(14px) saturate(180%);
  }
}
@media (hover:hover){
  .cta:hover{
    transform: translateY(-1px);
    box-shadow: 0 22px 64px rgba(0,0,0,.14);
    border-color: rgba(0,0,0,.12);
  }
}
.cta:active{ transform: translateY(1px) scale(.99); }

.navbtn{
  border:1px solid var(--hairline);
  background: var(--glass-strong);
  box-shadow: 0 12px 34px rgba(0,0,0,.10);
  transition:
    transform .22s var(--ease),
    box-shadow .35s var(--ease),
    background .35s var(--ease),
    border-color .35s var(--ease);
}
@supports ((-webkit-backdrop-filter: blur(1px)) or (backdrop-filter: blur(1px))){
  .navbtn{
    background: var(--glass);
    -webkit-backdrop-filter: blur(14px) saturate(180%);
    backdrop-filter: blur(14px) saturate(180%);
  }
}
@media (hover:hover){
  .navbtn:hover{
    transform: translateY(-1px);
    box-shadow: 0 18px 56px rgba(0,0,0,.14);
    border-color: rgba(0,0,0,.12);
  }
}
.navbtn:active{ transform: translateY(1px) scale(.99); }

/* Choices */
.choice-wrap{
  border-top:1px solid rgba(0,0,0,.06);
}
.choice-label{
  letter-spacing: .14em;
}
.choice-btn{
  border:1px solid var(--hairline);
  border-radius: 16px;
  background: var(--panel);
  box-shadow: 0 18px 50px rgba(0,0,0,.10);
  padding: 14px 14px;
  transition:
    transform .22s var(--ease),
    box-shadow .35s var(--ease),
    border-color .35s var(--ease),
    background .35s var(--ease),
    opacity .35s var(--ease);
}
@media (hover:hover){
  .choice-btn:hover{
    transform: translateY(-1px);
    box-shadow: 0 24px 76px rgba(0,0,0,.14);
    border-color: rgba(0,0,0,.12);
  }
}
.choice-btn:active{ transform: translateY(1px) scale(.99); }
.choice-btn.correct{
  background: rgba(209,31,42,.06);
  border-color: rgba(209,31,42,.20);
  animation: choicePop .42s var(--ease) both;
}
.choice-btn.wrong{
  background: rgba(28,79,214,.06);
  border-color: rgba(28,79,214,.20);
  animation: choicePop .42s var(--ease) both;
}

@keyframes choicePop{
  0%{ transform: translateY(0) scale(1); }
  45%{ transform: translateY(-2px) scale(1.015); }
  100%{ transform: translateY(0) scale(1); }
}

/* Mark layer (maru/batsu) */
.mark-layer{
  width:84px;
  height:84px;
  top:12px;
  right:12px;
  filter: drop-shadow(0 18px 46px rgba(0,0,0,.16));
  transition: opacity .35s var(--ease), transform .35s var(--ease);
}
.mark-layer.show{
  transform: translateY(0) scale(1);
  animation: markPop .55s var(--ease) both;
}
@keyframes markPop{
  0%{ opacity:0; transform: translateY(-6px) scale(.92); }
  55%{ opacity:1; transform: translateY(0) scale(1.06); }
  100%{ opacity:1; transform: translateY(0) scale(1); }
}

/* Overlays (settings / time select) */
.overlay{
  background: rgba(0,0,0,.40);
}
@supports ((-webkit-backdrop-filter: blur(1px)) or (backdrop-filter: blur(1px))){
  .overlay{
    -webkit-backdrop-filter: blur(10px) saturate(160%);
    backdrop-filter: blur(10px) saturate(160%);
  }
}
.overlay:not(.hidden){
  animation: overlayIn .45s var(--ease) both;
}
@keyframes overlayIn{
  from{ opacity:0; }
  to{ opacity:1; }
}
.overlay:not(.hidden) .sheet{
  animation: sheetIn .55s var(--ease) both;
}
@keyframes sheetIn{
  from{ transform: translateY(24px) scale(.985); opacity:0; }
  to{ transform: translateY(0) scale(1); opacity:1; }
}
.sheet{
  border:1px solid rgba(255,255,255,.22);
  box-shadow: 0 40px 120px rgba(0,0,0,.35);
}

/* Result view */
.result-box{
  border:1px solid var(--hairline);
  background: var(--glass-strong);
  box-shadow: 0 20px 70px rgba(0,0,0,.12);
}
@supports ((-webkit-backdrop-filter: blur(1px)) or (backdrop-filter: blur(1px))){
  .result-box{
    background: var(--glass);
    -webkit-backdrop-filter: blur(14px) saturate(180%);
    backdrop-filter: blur(14px) saturate(180%);
  }
}
.wrong-item{
  border:1px solid rgba(0,0,0,.06);
  background: rgba(255,255,255,.72);
  box-shadow: 0 14px 40px rgba(0,0,0,.08);
}

/* Focus rings (Apple-like) */
:focus-visible{
  outline: 3px solid var(--focus);
  outline-offset: 3px;
}

/* View entrance animation */
.view.active{
  animation: viewIn .70s var(--ease) both;
}
@keyframes viewIn{
  from{ opacity:0; transform: translateY(14px) scale(.985); }
  to{ opacity:1; transform: translateY(0) scale(1); }
}

/* Stagger inside title view */
#viewTitle.active .hero{ animation: riseIn .85s var(--ease) both; }
#viewTitle.active .actions .btn{
  animation: riseIn .75s var(--ease) both;
}
#viewTitle.active .actions .btn:nth-child(1){ animation-delay: .06s; }
#viewTitle.active .actions .btn:nth-child(2){ animation-delay: .12s; }
#viewTitle.active .actions .btn:nth-child(3){ animation-delay: .18s; }
#viewTitle.active .actions .btn:nth-child(4){ animation-delay: .24s; }

@keyframes riseIn{
  from{ opacity:0; transform: translateY(16px); }
  to{ opacity:1; transform: translateY(0); }
}

/* Stagger inside result view */
#viewResult.active .hero{ animation: riseIn .85s var(--ease) both; }
#viewResult.active .wrong-item{ animation: riseIn .65s var(--ease) both; }
#viewResult.active .wrong-item:nth-child(1){ animation-delay:.06s; }
#viewResult.active .wrong-item:nth-child(2){ animation-delay:.12s; }
#viewResult.active .wrong-item:nth-child(3){ animation-delay:.18s; }
#viewResult.active .wrong-item:nth-child(4){ animation-delay:.24s; }
#viewResult.active .wrong-item:nth-child(5){ animation-delay:.30s; }
#viewResult.active .wrong-item:nth-child(6){ animation-delay:.36s; }
#viewResult.active .wrong-item:nth-child(7){ animation-delay:.42s; }
#viewResult.active .wrong-item:nth-child(8){ animation-delay:.48s; }
#viewResult.active .wrong-item:nth-child(9){ animation-delay:.54s; }
#viewResult.active .wrong-item:nth-child(10){ animation-delay:.60s; }

/* Reduced motion */
@media (prefers-reduced-motion: reduce){
  *{
    animation-duration: 0.001ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.001ms !important;
    scroll-behavior: auto !important;
  }
  .card.fade-out{ filter:none !important; }
}


    /* Preset UI */
    .select{
      appearance:none;
      background: var(--panel);
      border:1px solid var(--border);
      border-radius: 12px;
      padding: 10px 36px 10px 12px;
      font-size: 14px;
      line-height: 1;
      color: var(--text);
      box-shadow: 0 8px 18px rgba(17,18,20,.05);
      background-image: linear-gradient(45deg, transparent 50%, var(--muted) 50%),
                        linear-gradient(135deg, var(--muted) 50%, transparent 50%);
      background-position: calc(100% - 18px) calc(50% - 3px), calc(100% - 12px) calc(50% - 3px);
      background-size: 6px 6px, 6px 6px;
      background-repeat: no-repeat;
      min-width: 220px;
    }
    .select:focus{ outline:none; border-color: rgba(31,42,68,.55); }

    .preset-item{
      border:1px solid rgba(31,42,68,.10);
      border-radius: 12px;
      background: rgba(31,42,68,.03);
      padding: 10px 10px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .preset-item .left{ min-width:0; }
    .preset-item .title{
      font-weight:650;
      color: var(--accent);
      margin-bottom:4px;
      word-break: break-word;
    }
    .preset-item .meta{
      font-size:12px;
      color: var(--muted);
      margin:0;
      word-break: break-word;
    }


    /* ===== Preset empty state ===== */
    .empty-state{
      margin-top:18px;
      padding: 28px 18px;
      text-align:center;
      border-radius: var(--radius);
      background: rgba(255,255,255,.66);
      box-shadow: inset 0 0 0 1px rgba(17,18,20,.06);
      min-height: 180px;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
    }
    .empty-state.hidden{ display:none; }
    .empty-title{
      font-size:18px;
      font-weight:700;
      letter-spacing:.02em;
      color:var(--text);
    }
    .empty-desc{
      margin-top:8px;
      font-size:13px;
      color:var(--muted);
      line-height:1.55;
    }

    /* Keep preset editor actions reachable even with many words */
    .preset-edit-toolbar{
      position: sticky;
      top: 0;
      z-index: 6;
      background: var(--panel);
      padding: 10px 0 12px;
      margin: -6px 0 10px;
      border-bottom: 1px solid rgba(17,18,20,.06);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }

    /* ===== In-app alert / confirm modal ===== */
    .ui-modal{
      position:fixed;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:120;
      pointer-events:none;
      opacity:0;
      transition: opacity .28s cubic-bezier(0.22, 1, 0.36, 1);
    }
    .ui-modal.is-open{
      opacity:1;
      pointer-events:auto;
    }
    .ui-modal-backdrop{
      position:absolute;
      inset:0;
      background: rgba(17,18,20,.38);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      opacity:0;
      transition: opacity .28s cubic-bezier(0.22, 1, 0.36, 1);
    }
    .ui-modal.is-open .ui-modal-backdrop{ opacity:1; }
    .ui-modal-card{
      position:relative;
      width: min(520px, calc(100vw - 44px));
      background: var(--panel);
      border: 1px solid rgba(17,18,20,.08);
      border-radius: 18px;
      box-shadow: 0 24px 90px rgba(0,0,0,.22);
      padding: 18px 18px 16px;
      transform: translateY(18px) scale(.98);
      opacity:0;
      transition:
        transform .42s cubic-bezier(0.22, 1, 0.36, 1),
        opacity .32s cubic-bezier(0.22, 1, 0.36, 1);
    }
    .ui-modal.is-open .ui-modal-card{
      transform: translateY(0) scale(1);
      opacity:1;
    }
    .ui-modal-title{
      font-weight:700;
      font-size:16px;
      color:var(--text);
      letter-spacing:.01em;
    }
    .ui-modal-message{
      margin-top:10px;
      font-size:14px;
      color:var(--text);
      line-height:1.6;
      white-space:pre-wrap;
      word-break:break-word;
    }
    .ui-modal-actions{
      margin-top:16px;
      display:flex;
      gap:10px;
      justify-content:flex-end;
      flex-wrap:wrap;
    }
    .ui-modal-actions .textbtn,
    .ui-modal-actions .navbtn{ min-width: 118px; }
    .ui-modal-card.is-danger .navbtn{
      background: var(--maru);
      border-color: transparent;
      color:#fff;
    }
    .ui-modal-card.is-danger .navbtn:hover{ filter: brightness(0.98); }
    .ui-toast{
      position: fixed;
      left: 50%;
      bottom: 24px;
      transform: translateX(-50%) translateY(10px);
      background: rgba(17,18,20,0.92);
      color: #fff;
      border-radius: 999px;
      padding: 10px 14px;
      font-size: 12px;
      z-index: 2400;
      opacity: 0;
      pointer-events: none;
      transition: opacity .2s ease, transform .2s ease;
    }
    .ui-toast.show{
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    @media (prefers-reduced-motion: reduce){
      .ui-modal,
      .ui-modal-backdrop,
      .ui-modal-card{
        transition:none !important;
      }
      .ui-modal-card{ transform:none !important; }
    }


    /* =========================
       Update Notes
       ========================= */
    .update-sheet .sheet-body{
      max-height: min(68vh, 520px);
      overflow: auto;
      -webkit-overflow-scrolling: touch;
    }
    .update-article{
      padding: 4px 2px 8px;
    }
    .update-headline{
      margin: 0 0 6px;
      font-size: 18px;
      font-weight: 800;
      letter-spacing: -0.02em;
    }
    .update-date{
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 14px;
    }
    .update-content{
      font-size: 13px;
      color: var(--text);
      line-height: 1.65;
    }
    .update-content p{
      margin: 0 0 10px;
    }
    .update-content ul{
      margin: 10px 0 10px 18px;
      padding: 0;
    }
    .update-content li{
      margin: 6px 0;
    }
    .update-note{
      color: var(--muted);
      font-size: 12px;
      margin-top: 10px;
    }
    .update-footer{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
    }
    .checkrow{
      display:flex;
      align-items:center;
      gap: 8px;
      font-size: 12px;
      color: var(--muted);
      user-select: none;
    }
    .checkrow input{
      width: 16px;
      height: 16px;
      accent-color: var(--accent);
    }

    /* =========================
       Insights
       ========================= */
    .icon-btn.insights-btn{
      padding: 0 12px;
      font-size: 12px;
      font-weight: 700;
      letter-spacing: .02em;
    }
    .sheet-sub{
      margin-top: 4px;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.4;
    }
    .insights-sheet{
      width: min(1000px, 94vw);
      max-height: min(86vh, 780px);
      display:flex;
      flex-direction: column;
    }
    .insights-body{
      max-height: none;
      overflow: auto;
      -webkit-overflow-scrolling: touch;
      display:flex;
      flex-direction: column;
      gap: 14px;
    }
    .insights-filters{
      position: sticky;
      top: 0;
      z-index: 2;
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: flex-end;
      padding: 12px;
      border-radius: 12px;
      background: rgba(255,255,255,0.85);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(17,18,20,0.08);
      box-shadow: 0 10px 26px rgba(17,18,20,.04);
    }
    .filter-item{ min-width: 160px; flex: 1; }
    .filter-label{
      font-size: 11px;
      letter-spacing: .08em;
      text-transform: uppercase;
      color: var(--muted);
      margin: 0 0 6px;
    }

    .insights-summary{
      display:grid;
      gap: 10px;
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }
    @media (min-width: 820px){
      .insights-summary{ grid-template-columns: repeat(5, minmax(0, 1fr)); }
    }
    .summary-card{
      border: 1px solid rgba(17,18,20,0.08);
      border-radius: 14px;
      background: rgba(255,255,255,0.86);
      padding: 12px 12px;
      box-shadow: 0 10px 26px rgba(17,18,20,.04);
      min-width: 0;
    }
    .summary-k{
      font-size: 11px;
      color: var(--muted);
      letter-spacing: .06em;
      text-transform: uppercase;
      margin-bottom: 6px;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .summary-v{
      font-size: 16px;
      font-weight: 800;
      color: var(--text);
      letter-spacing: -0.01em;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }

    .insights-grid{
      display:grid;
      gap: 14px;
      grid-template-columns: 1fr;
      padding-bottom: 6px;
    }
    @media (min-width: 900px){
      .insights-grid{ grid-template-columns: 1fr 1fr; }
      .insights-grid .insight-card:nth-child(3){ grid-column: 1 / -1; }
      .insights-grid .insight-card:nth-child(4){ grid-column: 1 / -1; }
    }
    .insight-card{
      border: 1px solid rgba(17,18,20,0.08);
      border-radius: 16px;
      background: rgba(255,255,255,0.86);
      box-shadow: 0 10px 26px rgba(17,18,20,.04);
      padding: 12px 12px;
      min-width: 0;
    }
    .insight-head{
      display:flex;
      align-items:baseline;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 10px;
    }
    .insight-title{
      font-size: 13px;
      font-weight: 800;
      color: var(--text);
      letter-spacing: -0.01em;
    }
    .insight-note{
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .chart{
      width: 100%;
      min-height: 220px;
    }
    .chart svg{ width: 100%; height: 220px; display:block; }
    .chart .grid{ stroke: rgba(17,18,20,0.08); stroke-width: 1; }
    .chart .axis{ stroke: rgba(17,18,20,0.10); stroke-width: 1; }
    .chart .label{ fill: rgba(17,18,20,0.56); font-size: 11px; }
    .chart .line{ stroke: rgba(31,42,68,0.92); stroke-width: 2.2; fill: none; }
    .chart .dot{ fill: rgba(31,42,68,0.92); }
    .chart .bar{ fill: rgba(31,42,68,0.88); }
    .chart .barBg{ fill: rgba(17,18,20,0.08); }

    .weak-list{
      display:flex;
      flex-direction: column;
      gap: 10px;
    }
    .weak-item{
      display:grid;
      grid-template-columns: 1fr 52px;
      gap: 10px;
      align-items:center;
    }
    .weak-left{ min-width: 0; }
    .weak-top{
      display:flex;
      justify-content: space-between;
      gap: 10px;
      align-items: baseline;
      margin-bottom: 6px;
    }
    .weak-word{
      font-weight: 800;
      color: var(--text);
      font-size: 13px;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .weak-no{
      font-size: 11px;
      color: var(--muted);
      white-space: nowrap;
    }
    .weak-bar{
      height: 8px;
      border-radius: 999px;
      background: rgba(17,18,20,0.08);
      overflow:hidden;
    }
    .weak-bar > i{
      display:block;
      height: 100%;
      width: 0%;
      background: rgba(31,42,68,0.88);
      border-radius: 999px;
      transform-origin: left center;
      transition: width .45s cubic-bezier(0.22, 1, 0.36, 1);
    }
    .weak-count{
      text-align:right;
      font-weight: 800;
      color: var(--text);
    }

    .insights-actions{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .table-wrap{
      overflow:auto;
      border: 1px solid rgba(17,18,20,0.08);
      border-radius: 12px;
      background: rgba(255,255,255,0.72);
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.55);
    }
    .insight-table{
      width:100%;
      border-collapse: collapse;
      font-size: 12.5px;
      line-height: 1.45;
    }
    .insight-table th,
    .insight-table td{
      padding: 10px 12px;
      border-bottom: 1px solid rgba(17,18,20,0.07);
      text-align: left;
      white-space: nowrap;
    }
    .insight-table th{
      position: sticky;
      top: 0;
      z-index: 1;
    }
    .insight-table th:not(:first-child),
    .insight-table td:not(:first-child){
      text-align: right;
      font-variant-numeric: tabular-nums;
    }
    .insight-table th{
      font-weight: 800;
      background: rgba(17,18,20,0.06);
      color: var(--muted);
      letter-spacing: .04em;
    }
    .insight-table tbody tr:nth-child(even){
      background: rgba(17,18,20,0.022);
    }
    .insight-table tbody tr:hover{
      background: rgba(31,42,68,0.045);
    }
    .insight-table td.is-delta{
      font-weight: 800;
    }
    .insight-table td.delta-pos{
      color: #198754;
    }
    .insight-table td.delta-neg{
      color: #c92a2a;
    }
    .insight-table td.delta-zero{
      color: var(--muted);
    }
    .insight-table tr:last-child td{ border-bottom: 0; }
    .insight-empty{
      font-size: 12px;
      color: var(--muted);
      line-height: 1.7;
      padding: 10px;
    }
    .memo-check{
      display:flex;
      flex-direction: column;
      gap: 14px;
    }
    .memo-calendar{
      border: 1px solid rgba(17,18,20,0.08);
      border-radius: 14px;
      background: rgba(255,255,255,0.8);
      padding: 12px;
    }
    .memo-cal-head{
      display:flex;
      align-items:center;
      justify-content: space-between;
      margin-bottom: 10px;
      gap: 10px;
    }
    .memo-cal-grid{
      display:grid;
      grid-template-columns: repeat(7, minmax(0,1fr));
      gap: 6px;
    }
    .memo-cal-week{
      font-size: 11px;
      color: var(--muted);
      text-align:center;
      padding: 4px 0;
    }
    .memo-day{
      border: 1px solid rgba(17,18,20,0.08);
      border-radius: 10px;
      min-height: 52px;
      padding: 6px;
      background: rgba(255,255,255,0.92);
      cursor: pointer;
      display:flex;
      flex-direction: column;
      justify-content: space-between;
      gap: 6px;
    }
    .memo-day.is-out{ opacity:.4; }
    .memo-day .d{
      font-size: 12px;
      font-weight: 700;
      color: var(--text);
    }
    .memo-day .dot{
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: rgba(31,42,68,0.92);
      margin-left: auto;
    }
    .memo-block-pool,.memo-slots{
      display:grid;
      gap: 8px;
    }
    .memo-block-pool{
      grid-template-columns: repeat(auto-fill, minmax(140px,1fr));
    }
    .memo-block{
      border: 1px solid rgba(17,18,20,0.12);
      border-radius: 999px;
      padding: 8px 10px;
      font-size: 12px;
      background: #fff;
      text-align: left;
    }
    .memo-block.is-selected{
      border-color: rgba(31,42,68,0.45);
      background: rgba(31,42,68,0.06);
    }
    .memo-slot{
      border: 1px dashed rgba(17,18,20,0.24);
      border-radius: 12px;
      padding: 10px;
      background: rgba(255,255,255,0.86);
    }
    .memo-slot label{
      display:block;
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 6px;
      font-weight: 700;
    }
    .memo-slot textarea{
      width: 100%;
      min-height: 66px;
      border: 1px solid rgba(17,18,20,0.12);
      border-radius: 10px;
      padding: 8px;
      resize: vertical;
      font-size: 13px;
      background: #fff;
    }
    .memo-picked{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-top: 8px;
    }
    .memo-tag{
      border: 1px solid rgba(31,42,68,0.22);
      background: rgba(31,42,68,0.06);
      color: var(--text);
      border-radius: 999px;
      font-size: 11px;
      padding: 4px 8px;
    }
    .memo-reco-list{
      display:flex;
      flex-direction: column;
      gap: 8px;
      max-height: 260px;
      overflow:auto;
    }
    .memo-reco-item{
      border: 1px solid rgba(17,18,20,0.08);
      border-radius: 10px;
      padding: 8px;
      background: rgba(255,255,255,0.92);
      font-size: 12px;
    }

    @keyframes insightsFadeIn{
      from{ opacity: 0; transform: translateY(8px) scale(.99); }
      to{ opacity: 1; transform: translateY(0) scale(1); }
    }
    .overlay:not(.hidden) .insights-sheet{
      animation: insightsFadeIn .48s cubic-bezier(0.22, 1, 0.36, 1) both;
    }
    .draw-line{
      stroke-dasharray: var(--dash, 1000);
      stroke-dashoffset: var(--dash, 1000);
      animation: lineDraw .6s cubic-bezier(0.22, 1, 0.36, 1) forwards;
    }
    @keyframes lineDraw{ to{ stroke-dashoffset: 0; } }

    @media (prefers-reduced-motion: reduce){
      .overlay:not(.hidden) .insights-sheet{ animation:none !important; }
      .draw-line{ animation:none !important; stroke-dasharray:none !important; stroke-dashoffset:0 !important; }
      .weak-bar > i{ transition:none !important; }
    }



/* =========================
   Topbar labels + Notify dropdown
   ========================= */

/* Icon hover labels */
.icon-btn{ position: relative; overflow: visible; }
.icon-btn .icon-label{
  position: absolute;
  top: calc(100% + 8px);
  left: 50%;
  transform: translate(-50%, -4px);
  opacity: 0;
  pointer-events: none;
  white-space: nowrap;
  font-size: 12px;
  letter-spacing: .02em;
  padding: 6px 10px;
  border-radius: 999px;
  background: rgba(255,255,255,.90);
  color: var(--text);
  border: 1px solid rgba(0,0,0,.06);
  box-shadow: 0 10px 26px rgba(0,0,0,.10);
  transition: opacity .22s cubic-bezier(0.22, 1, 0.36, 1), transform .22s cubic-bezier(0.22, 1, 0.36, 1);
  z-index: 50;
}
@media (hover:hover) and (pointer:fine){
  .icon-btn:hover .icon-label,
  .icon-btn:focus-visible .icon-label{
    opacity: 1;
    transform: translate(-50%, 0);
  }
}
@media (hover:none), (pointer:coarse){
  .icon-btn .icon-label{ display:none; }
}

/* Notifications dropdown: show as topbar popover */
#notifyOverlay{
  background: transparent !important;
  align-items: flex-start !important;
  justify-content: flex-end !important;
  padding: calc(var(--topbar-h, 56px) + 10px) 16px 16px !important;
}
#notifyOverlay .notify-sheet{
  width: min(420px, calc(100vw - 24px));
  max-height: min(70vh, 560px);
  border-radius: 18px;
  box-shadow: 0 18px 45px rgba(0,0,0,.18);
  border: 1px solid rgba(0,0,0,.07);
  overflow: hidden;
  transform-origin: top right;
  transform: translateY(-10px) scale(.985);
  opacity: 0;
  transition: transform .26s cubic-bezier(0.22, 1, 0.36, 1), opacity .26s cubic-bezier(0.22, 1, 0.36, 1);
}
#notifyOverlay:not(.hidden) .notify-sheet{
  transform: translateY(0) scale(1);
  opacity: 1;
}
#notifyOverlay .sheet-footer{ display:none; }


/* =========================
   Search dropdown (Topbar)
   ========================= */
#searchOverlay{
  background: transparent !important;
  align-items: flex-start !important;
  justify-content: flex-end !important;
  padding: calc(var(--topbar-h, 56px) + 10px) 16px 16px !important;
}
#searchOverlay.hidden{ display:none !important; }

#searchOverlay .search-sheet{
  width: min(520px, calc(100vw - 24px));
  max-height: min(72vh, 620px);
  border-radius: 18px;
  box-shadow: 0 18px 45px rgba(0,0,0,.18);
  border: 1px solid rgba(0,0,0,.07);
  overflow: hidden;
  transform-origin: top right;
  transform: translateY(-10px) scale(.985);
  opacity: 0;
  transition: transform .26s cubic-bezier(0.22, 1, 0.36, 1), opacity .26s cubic-bezier(0.22, 1, 0.36, 1);
}
#searchOverlay:not(.hidden) .search-sheet{
  transform: translateY(0) scale(1);
  opacity: 1;
}
#searchOverlay .sheet-header{ padding: 16px 16px 10px; }
#searchOverlay .search-body{
  display: grid;
  gap: 10px;
  padding: 10px 12px 14px;
}
#searchOverlay .search-input-wrap{ padding: 0 2px 2px; }
#searchOverlay #searchInput{
  width: 100%;
  border-radius: 14px;
}
#searchOverlay .search-empty{
  padding: 10px 4px 6px;
  color: var(--muted);
  font-size: 13px;
}
#searchOverlay .search-list{
  display: flex;
  flex-direction: column;
  gap: 10px;
  max-height: 360px;
  overflow: auto;
  padding: 4px 2px 0;
  scrollbar-gutter: stable;
}
.search-item{
  width: 100%;
  text-align: left;
  border-radius: 14px;
  padding: 12px 12px;
  border: 1px solid rgba(0,0,0,.06);
  background: rgba(255,255,255,.86);
  box-shadow: 0 10px 24px rgba(0,0,0,.08);
  transition: transform .18s cubic-bezier(0.22, 1, 0.36, 1), box-shadow .18s cubic-bezier(0.22, 1, 0.36, 1), background .18s cubic-bezier(0.22, 1, 0.36, 1);
}
.search-item:focus-visible{ outline: 2px solid rgba(0,0,0,.18); outline-offset: 2px; }
.search-item .row{
  display:flex;
  align-items:baseline;
  justify-content: space-between;
  gap: 10px;
}
.search-item .no{
  font-variant-numeric: tabular-nums;
  color: var(--muted);
  font-size: 12px;
}
.search-item .word{
  font-weight: 650;
  letter-spacing: -0.01em;
  color: var(--text);
  font-size: 14px;
  flex: 1;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.search-item .meaning{
  margin-top: 4px;
  color: var(--muted);
  font-size: 12.5px;
  line-height: 1.35;
  overflow: hidden;
  text-overflow: ellipsis;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
}
@media (hover:hover) and (pointer:fine){
  .search-item:hover{
    transform: translateY(-1px);
    box-shadow: 0 14px 30px rgba(0,0,0,.11);
    background: rgba(255,255,255,.94);
  }
}
.search-item:active{ transform: scale(.985); }


/* 
   Hamburger Menu (stable navigation)
    */
#settingsBtn{ display:none !important; } /* moved into hamburger menu */
#helpBtn{ display:none !important; } /* if exists */

.menu-overlay{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.18);
      opacity: 0;
      pointer-events: none;
      transition: opacity .22s cubic-bezier(.22,1,.36,1);
      z-index: 96;
    }
    .menu-overlay.open{ opacity: 1; pointer-events: auto; }

    .menu-panel{
      position: fixed;
      top: 0;
      right: 0;
      width: min(380px, 92vw);
      height: 100vh;
      max-height: 100vh;
      background: var(--panel);
      border-left: 1px solid var(--border);
      box-shadow: -18px 0 45px rgba(2,8,23,.12);
      transform: translateX(102%);
      transition: transform .24s cubic-bezier(.22,1,.36,1);
      will-change: transform;
      pointer-events: none;
      z-index: 97;
      display: flex;
      flex-direction: column;
    }
    .menu-panel.open{ transform: translateX(0); pointer-events: auto; }
    .menu-overlay.memo-full{
      background: rgba(9,13,22,.32);
    }
    .menu-panel.memo-full{
      left: 0;
      right: 0;
      width: 100vw;
      max-width: 100vw;
      border-left: 0;
      box-shadow: none;
      transform: translateY(102%);
    }
    .menu-panel.memo-full.open{
      transform: translateY(0);
    }
    .menu-panel.memo-full .menu-header{
      padding: 14px 16px;
      border-bottom-color: rgba(17,18,20,.08);
    }
    .menu-panel.memo-full .menu-content{
      padding: 16px;
    }

    .menu-header{
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      border-bottom: 1px solid var(--border);
      background: var(--panel);
      position: sticky;
      top: 0;
      z-index: 1;
    }
    .menu-title{
      flex: 1;
      font-size: 12px;
      font-weight: 800;
      letter-spacing: .12em;
      text-transform: uppercase;
      color: var(--muted);
    }
    .menu-back{
      opacity: 0;
      pointer-events: none;
      transform: translateX(-6px);
      transition: opacity .18s cubic-bezier(.22,1,.36,1), transform .18s cubic-bezier(.22,1,.36,1);
    }
    .menu-panel.has-back .menu-back{
      opacity: 1;
      pointer-events: auto;
      transform: translateX(0);
    }

    .menu-content{
      flex: 1;
      overflow: auto;
      -webkit-overflow-scrolling: touch;
      padding: 14px 14px 20px;
    }
    .menu-content:focus{ outline: none; }

    .menu-list{
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .menu-item{
      display: flex;
      align-items: center;
      gap: 10px;
      width: 100%;
      text-align: left;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 14px;
      background: rgba(255,255,255,.45);
      color: var(--text);
      cursor: pointer;
    }
    .menu-item:hover{ background: rgba(255,255,255,.66); }

    /* Drawer content: compact & scroll-friendly */
    .menu-article{
      line-height: 1.52;
    }
    .menu-article h2{
      margin: 14px 0 8px;
      font-size: 15px;
      letter-spacing: .02em;
    }
    .menu-article h3{
      margin: 12px 0 6px;
      font-size: 13px;
      letter-spacing: .01em;
    }
    .menu-article p{ margin: 8px 0; }
    .menu-article ul{
      margin: 8px 0 10px 18px;
      padding: 0;
    }
    .menu-article li{ margin: 4px 0; }
    .menu-article hr{
      margin: 14px 0;
      border: 0;
      border-top: 1px solid var(--border);
    }
    .menu-article .mini{ font-size: 12px; color: var(--muted); }
    .menu-article .embed{ margin: 10px 0; }
    .drawer-share{
      display: grid;
      gap: 12px;
    }
    .drawer-share-tabs{
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }
    .drawer-share-tab{
      border: 1px solid var(--border);
      border-radius: 12px;
      background: rgba(255,255,255,.5);
      color: var(--text);
      padding: 9px 10px;
      font-weight: 700;
      cursor: pointer;
      text-align: center;
    }
    .drawer-share-tab.active{
      border-color: rgba(31,42,68,.35);
      background: rgba(31,42,68,.08);
    }
    .drawer-share-panel{
      border: 1px solid rgba(17,18,20,.08);
      border-radius: 14px;
      background: rgba(255,255,255,.76);
      padding: 12px;
      display: grid;
      gap: 10px;
    }
    .drawer-share-code{
      font-size: 36px;
      font-weight: 800;
      letter-spacing: .12em;
      text-align: center;
      color: var(--text);
      font-variant-numeric: tabular-nums;
      line-height: 1.1;
    }
    .drawer-share-sub{
      text-align: center;
      font-size: 12px;
      color: var(--muted);
    }
    .drawer-share-qr{
      width: 240px;
      height: 240px;
      max-width: 100%;
      border: 1px solid rgba(17,18,20,.08);
      border-radius: 14px;
      display: none;
      margin: 0 auto;
      background: #fff;
    }
    .drawer-share-link{
      font-size: 12px;
      color: var(--muted);
      line-height: 1.4;
      word-break: break-all;
      text-align: center;
    }
    .drawer-share-actions{
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
    }
    .drawer-share-status{
      font-size: 12px;
      color: var(--muted);
      line-height: 1.5;
    }
    .drawer-share-status.error{
      color: #b42318;
    }
    .drawer-share-status.ok{
      color: #198754;
    }
    .drawer-share-empty{
      font-size: 12px;
      color: var(--muted);
      line-height: 1.6;
      padding: 10px 0;
    }
    .drawer-share-row{
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }
    .menu-article img{
      max-width: 100%;
      height: auto;
      border-radius: 12px;
      border: 1px solid var(--border);
      display: block;
    }
    .menu-article video{
      width: 100%;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: #000;
      display: block;
    }
    .menu-article label{
      display: block;
      font-size: 12px;
      color: var(--muted);
      margin: 2px 0 6px;
    }
    .menu-article textarea.spell-input{
      min-height: 140px;
      resize: vertical;
    }
    .menu-article .row-actions{
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 12px;
    }
    .menu-article .status{
      margin-top: 10px;
      font-size: 12px;
      color: var(--muted);
    }
    .menu-article .status.error{ color: #b91c1c; }
    .menu-article .status.ok{ color: #198754; }
    .admin-settings-card{
      border:1px solid rgba(31,42,68,.14);
      border-radius: 12px;
      background: rgba(31,42,68,.03);
      padding: 12px;
      display:grid;
      gap: 10px;
    }
    .admin-settings-head{
      display:flex;
      flex-wrap: wrap;
      justify-content: space-between;
      gap: 10px;
      align-items: flex-start;
    }
    .admin-settings-actions{
      display:flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .admin-notif-editor{
      border:1px solid rgba(31,42,68,.14);
      border-radius: 12px;
      background: rgba(31,42,68,.03);
      padding: 12px;
      display:grid;
      gap: 12px;
    }
    .admin-editor-actions{
      display:flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .admin-editor-form{
      display:grid;
      gap: 10px;
    }
    .admin-editor-form textarea.spell-input{
      min-height: 120px;
      resize: vertical;
    }
    .admin-editor-grid{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 8px;
    }
    .admin-editor-submit{
      display:flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }
    .admin-notif-list{
      display:grid;
      gap: 10px;
    }
    .admin-notif-item{
      border:1px solid rgba(17,18,20,.1);
      border-radius: 12px;
      background: #fff;
      padding: 10px;
      display:grid;
      gap: 8px;
    }
    .admin-notif-title{
      font-weight: 700;
      color: var(--text);
      line-height: 1.35;
    }
    .admin-notif-meta{
      font-size: 12px;
      color: var(--muted);
      display:flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .admin-notif-body{
      white-space: pre-wrap;
      color: var(--text);
      font-size: 13px;
      line-height: 1.55;
    }
    .admin-notif-item-actions{
      display:flex;
      justify-content: flex-end;
      gap: 8px;
      flex-wrap: wrap;
    }
    .backup-settings-card{
      border:1px solid rgba(31,42,68,.14);
      border-radius: 12px;
      background: rgba(31,42,68,.03);
      padding: 12px;
      display:grid;
      gap: 10px;
    }
    .backup-actions{
      display:flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    @media (max-width: 720px){
      .admin-editor-grid{
        grid-template-columns: 1fr;
      }
    }

    .menu-article pre{
      white-space: pre-wrap;
      word-break: break-word;
      margin: 8px 0;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: rgba(15,23,42,.03);
      font-size: 12px;
      line-height: 1.45;
    }

    .report-done{
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      padding: 24px 8px 10px;
    }
    .report-done .check{
      width: 72px;
      height: 72px;
      margin-bottom: 12px;
    }
    .report-done h2{
      margin: 6px 0 4px;
      font-size: 18px;
      letter-spacing: .01em;
    }
    .report-done p{
      margin: 0;
      color: var(--muted);
      font-size: 13px;
    }

    @media (prefers-reduced-motion: reduce){
  .menu-overlay, .menu-panel{
    transition:none !important;
  }
  /* Help/Tutorial (menu-article) polish */
.menu-article{
  max-width: 820px;
  margin: 0 auto;
  padding: 6px 2px 18px;
  color: #1d1d1f;
  line-height: 1.55;
}

.menu-article h2{
  font-size: 20px;
  letter-spacing: -0.01em;
  margin: 0 0 6px;
}

.menu-article h3{
  font-size: 16px;
  margin: 18px 0 8px;
  letter-spacing: -0.01em;
}

.menu-article h4{
  font-size: 14px;
  margin: 14px 0 6px;
  opacity: .95;
}

.menu-article p{
  margin: 8px 0;
}

.menu-article .mini{
  font-size: 12.5px;
  opacity: .78;
  margin-top: 6px;
}

.menu-article ul, .menu-article ol{
  padding-left: 18px;
  margin: 8px 0 10px;
}

.menu-article li{
  margin: 6px 0;
}

.menu-article hr{
  border: none;
  border-top: 1px solid rgba(0,0,0,.08);
  margin: 16px 0;
}

.menu-article .embed{
  margin: 10px 0 12px;
  border-radius: 14px;
  overflow: hidden;
  background: rgba(0,0,0,.03);
  box-shadow: 0 10px 24px rgba(0,0,0,.10);
}

.menu-article .embed img,
.menu-article .embed video{
  display: block;
  width: 100%;
  height: auto;
}

.menu-article .codeblock{
  white-space: pre-wrap;
  background: #f5f5f7;
  border: 1px solid rgba(0,0,0,.08);
  border-radius: 12px;
  padding: 12px;
  margin: 10px 0 12px;
  font-size: 12.5px;
  line-height: 1.55;
}

}
</style>
</head>
<body>
  <div class="app" id="app">
    
    <header class="topbar" role="banner">
      <div class="topbar-inner">
        <div class="topbar-left">
      <button class="icon-btn" id="menuBtn" aria-label="Menu">
        <span class="ms">menu</span>
        <span class="icon-label"></span>
      </button>
          <button class="icon-btn" id="backBtn" aria-label="" title="" disabled>
            <span class="ms" aria-hidden="true">chevron_left</span>
          </button>

          <div class="brand" aria-label="">
            <div class="brand-title">VocabuQuiz</div>
            <div class="brand-sub">v.1 Public</div>
          </div>
        </div>

        <div class="topbar-actions" aria-label="">
          <button class="icon-btn" id="insightsBtn" aria-label="Insights" title="Insights">
            <span class="ms" aria-hidden="true">query_stats</span>
          
            <span class="icon-label" aria-hidden="true"></span>
          </button>

          <button class="icon-btn" id="topPresetBtn" aria-label="" title="">
            <span class="ms" aria-hidden="true">collections_bookmark</span>
          
            <span class="icon-label" aria-hidden="true"></span>
          </button>


          <button class="icon-btn" id="searchBtn" aria-label="" title="">
            <span class="ms" aria-hidden="true">search</span>
            <span class="icon-label" aria-hidden="true"></span>
          </button>

          <button class="icon-btn" id="notifyBtn" aria-label="" title="">
            <span class="ms" aria-hidden="true">notifications</span>
            <span class="notif-dot hidden" id="notifyDot" aria-hidden="true"></span>
          
            <span class="icon-label" aria-hidden="true"></span>
          </button>

          <button class="icon-btn" id="settingsBtn" aria-label="" title="">
            <span class="ms" aria-hidden="true">settings</span>
          
            <span class="icon-label" aria-hidden="true"></span>
          </button>
        </div>
      </div>
    </header>


  <!-- Hamburger Menu -->
  <div id="menuOverlay" class="menu-overlay" hidden></div>
  <div id="menuPanel" class="menu-panel" hidden role="dialog" aria-label="Menu">
    <div class="menu-header">
      <button class="icon-btn menu-back" type="button" data-menu-action="back" aria-label="Back">
        <span class="ms">arrow_back</span>
      </button>
      <div class="menu-title" id="menuTitle">MENU</div>
      <button class="icon-btn" type="button" data-menu-action="close" aria-label="Close menu">
        <span class="ms">close</span>
      </button>
    </div>
    <div id="menuContent" class="menu-content" tabindex="-1">
      <div class="menu-list" data-menu-view="root">
        <button class="menu-item" type="button" data-menu-action="help">
          <span class="ms">help</span><span></span>
        </button>
        <button class="menu-item" type="button" data-menu-action="settings">
          <span class="ms">settings</span><span></span>
        </button>
        <button class="menu-item" type="button" data-menu-action="memoCheck">
          <span class="ms">edit_calendar</span><span></span>
        </button>
        <button class="menu-item" type="button" data-menu-action="presetShare">
          <span class="ms">share</span><span></span>
        </button>
        <button class="menu-item" type="button" data-menu-action="terms">
          <span class="ms">policy</span><span></span>
        </button>
        <button class="menu-item" type="button" data-menu-action="report">
          <span class="ms">report</span><span>/</span>
        </button>
      </div>
    </div>
  </div>

<main>
      <div class="stage">

        <!-- Start -->
        <section class="view active" id="viewStart" aria-label="">
          <div class="start-wrap">
            <div class="start-hero">
              <div class="start-kicker">version 1</div>
              <h1 class="start-title">VocabuQuiz</h1>
              <p class="start-sub">
                
              </p>
              <div class="start-actions">
                <button class="start-primary" id="startAppBtn" type="button">
                  
                  <span class="ms" aria-hidden="true">arrow_forward</span>
                </button>
              </div>
              <div class="start-note">
                <span class="start-chip">Offline</span>
                <span class="start-chip">Local Save</span>
                <span class="start-chip">No Ads</span>
              </div>
            </div>
          </div>
        </section>

        <!-- Dashboard -->
        <section class="view" id="viewTitle" aria-label="">
          <div class="hero">
            <h1 class="h1">Word Practice 1600</h1>
            <p class="subtitle">
              Vocabu
            </p>

            <div class="section">
              <div class="section-title">
                <span>Preset</span>
                <span class="right" id="deckStatus"></span>
              </div>              <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">

              <div class="seg" role="tablist" aria-label="Vocabu range">
                <button type="button" id="deckABtn" class="active" role="tab" aria-selected="true">0200</button>
                <button type="button" id="deckBBtn" role="tab" aria-selected="false">200400</button>
                <button type="button" id="deckCBtn" role="tab" aria-selected="false">400600</button>
                <button type="button" id="deckAllBtn" role="tab" aria-selected="false">ALL</button>
                <button type="button" id="deckMyBtn" role="tab" aria-selected="false">My</button>
              </div>
                <button class="navbtn" id="presetManageBtn" type="button" title=""></button>
              </div>
              <div id="customPresetRow" class="hint hidden" style="margin-top:10px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                <span style="color:var(--muted); font-size:12px;">My Preset</span>
                <select id="customPresetSelect" class="select" aria-label="My Preset"></select>
                <button class="textbtn" id="customPresetNewBtn" type="button"></button>
              </div>
            </div>

            <div class="section">
              <div class="section-title"><span>Practice</span><span class="right" id="practiceHint"></span></div>

              <div class="actions" id="modeActions">
                <button class="btn" id="startSeqBtn">
                  <div class="label"><span>TURN MODE</span><span class="badge" id="badgeSeq"></span></div>
                  <div class="desc"></div>
                </button>

                <button class="btn" id="startRndBtn">
                  <div class="label"><span>RANDOM MODE</span><span class="badge" id="badgeRnd"></span></div>
                  <div class="desc"></div>
                </button>

                <button class="btn" id="startChoiceBtn">
                  <div class="label"><span>EXAM MODE</span><span class="badge" id="badgeChoice"></span></div>
                  <div class="desc">4/</div>
                </button>

                <button class="btn" id="startHandBtn">
                  <div class="label"><span>WRITE MODE</span><span class="badge" id="badgeHand"></span></div>
                  <div class="desc"></div>
                </button>
</div>

              
              <div class="empty-state hidden" id="emptyState" aria-live="polite">
                <div class="empty-title"></div>
                <div class="empty-desc"></div>
              </div>

<div class="fineprint" id="titleDebug">
                <span class="badge">Data</span>
                <span id="dataStatusText">loading</span>
              </div>
            </div>
          </div>
        </section>

        <!-- Quiz -->
        <section class="view" id="viewQuiz" aria-label="">
          <div class="quiz-header">
            <div class="progress" id="progressWrap">
              <span id="progressText"></span>
            </div>
            <div class="pill hidden" id="timerPill"></div>
            <div class="pill" id="modePill"></div>
          </div>

          <div class="card" id="card">
            <div class="mark-layer hidden" id="markLayer" aria-hidden="true">
              <!-- correct (red circle) -->
              <svg class="svg-ok hidden" id="svgOk" viewBox="0 0 120 120">
                <circle class="ring" cx="60" cy="60" r="44"></circle>
              </svg>
              <!-- wrong (blue cross) -->
              <svg class="svg-ng hidden" id="svgNg" viewBox="0 0 120 120">
                <line class="xline x1" x1="34" y1="34" x2="86" y2="86"></line>
                <line class="xline x2" x1="86" y1="34" x2="34" y2="86"></line>
              </svg>
            </div>

            <div class="meta">
              <div class="no" id="noText">No.</div>
              <div class="dir" id="dirText">
                <span id="dirLabel"></span>
                <span class="judge hidden" id="judgeBadge"></span>
              </div>
            </div>

            <div class="prompt" id="promptText"></div>

            <div class="choice-wrap hidden" id="choiceWrap" aria-label="4">
              <div class="choice-label">CHOICES</div>
              <div class="choices" id="choices"></div>
            </div>

            <div class="spell-wrap hidden" id="spellWrap" aria-label="">
              <div class="spell-label">SPELLING</div>
              <div class="spell-row">
                <input class="spell-input" id="spellInput" type="text"
                       inputmode="latin" autocomplete="off" autocapitalize="none" autocorrect="off" spellcheck="false"
                       placeholder="/" />
                <button class="navbtn hidden" id="readCanvasBtn" title=""></button>
              </div>
            </div>

            <div class="answer-wrap hidden" id="answerWrap">
              <div class="answer-label">ANSWER</div>
              <div class="answer" id="answerText"></div>
              <div class="answer" id="yourText" style="margin-top:6px; color: var(--muted); font-size: 13px;"></div>
            </div>

            <div class="hand-wrap hidden" id="handWrap">
              <div class="hand-title">
                <span>HANDWRITE</span>
                <span class="mini" id="handMini"></span>
              </div>
              <canvas class="hand-canvas" id="handCanvas" width="800" height="400"></canvas>
              <div class="hand-controls">
                <div class="left">
                  <button class="navbtn" id="clearCanvasBtn" title=""></button>
                </div>
                <div class="right">
                  <div class="hand-note"> or Enter </div>
                </div>
              </div>
            </div>
          </div>

          <div class="controls">
            <div class="left">
              <button class="cta" id="primaryBtn"></button>
              <button class="navbtn" id="restartBtn" title=""></button>
              <button class="navbtn hidden" id="newSetBtn" title=""></button>
            </div>

            <div class="right">
              <button class="navbtn" id="prevBtn"></button>
              <button class="navbtn" id="nextBtn"></button>
            </div>
          </div>

          <div class="hint">
            Enter /  / Esc
          </div>

          <div class="debug-bar" id="debugBar"></div>
        </section>

        <!-- Result -->
        <section class="view" id="viewResult" aria-label="">
          <div class="hero">
            <h2 class="h1" style="font-size:22px">Score</h2>
            <p class="subtitle" id="resultSub"></p>

            <div class="result-box">
              <div class="scoreline">
                <div class="scorebig" id="scoreBig"></div>
                <div class="scoresub" id="scoreSub"></div>
              </div>
            </div>

            <details id="wrongDetails">
              <summary id="wrongSummary"></summary>
              <ul class="wrong-list" id="wrongList"></ul>
            </details>

            <div class="actions" style="margin-top:12px;">
              <button class="btn" id="resultRestartBtn">
                <div class="label"></div>
                <div class="desc">100</div>
              </button>
              <button class="btn" id="resultNewSetBtn">
                <div class="label"></div>
                <div class="desc">100</div>
              </button>
              <button class="btn" id="resultTitleBtn">
                <div class="label"></div>
                <div class="desc"></div>
              </button>
              <button class="btn" id="resultReviewBtn">
                <div class="label"></div>
                <div class="desc"></div>
              </button>
            </div>
          </div>
        </section>
      </div>
    </main>


    <!-- Preset Manager -->
    <div class="overlay hidden" id="presetOverlay" role="dialog" aria-modal="true" aria-label="">
      <div class="sheet">
        <div class="sheet-header">
          <div class="sheet-title"></div>
          <button class="icon-btn" id="presetCloseBtn" aria-label="" title=""></button>
        </div>

        <div class="sheet-body" style="gap:14px">
          <div class="setting">
            <div class="text">
              <div class="name"></div>
              <div class="note">0200 / 200400 / ALL</div>
            </div>
            <div style="display:flex; gap:10px; flex-wrap:wrap;">
              <button class="textbtn" id="presetImportBtn" type="button">JSON</button>
              <button class="textbtn" id="presetShareImportBtn" type="button"></button>
              <button class="textbtn" id="presetNewBtn" type="button"></button>
            </div>
            <input id="presetImportFile" type="file" accept="application/json" style="display:none" />
          </div>

          <div class="result-box" style="padding:12px">
            <div id="presetList" style="display:flex; flex-direction:column; gap:10px;"></div>
          </div>

          <div class="setting" style="flex-direction:column; align-items:stretch;">
            <div class="preset-edit-toolbar" style="display:flex; justify-content:space-between; gap:10px; align-items:center; flex-wrap:wrap;">
              <div>
                <div class="name" style="margin:0">My Preset</div>
                <div class="note">ON/OFF</div>
              </div>
              <div style="display:flex; gap:10px; flex-wrap:wrap;">
                <button class="textbtn" id="presetExportBtn" type="button">JSON</button>
                <button class="textbtn" id="presetShareBtn" type="button"></button>
                <button class="textbtn" id="presetDeleteBtn" type="button"></button>
                <button class="textbtn" id="presetSaveBtn" type="button"></button>
              </div>
            </div>

            <div style="display:grid; gap:12px; margin-top:10px;">
              <div>
                <div class="note" style="margin-bottom:6px;"></div>
                <input class="spell-input" id="presetNameInput" type="text" placeholder=" " />
              </div>

              <div>
                <div class="note" style="margin-bottom:6px;"></div>
                <div style="display:flex; gap:12px; flex-wrap:wrap;">
                  <label class="toggle" style="gap:8px;">
                    <span class="note" style="min-width:90px;">TURN MODE</span>
                    <input type="checkbox" id="presetModeSeq" />
                  </label>
                  <label class="toggle" style="gap:8px;">
                    <span class="note" style="min-width:90px;">RANDOM MODE</span>
                    <input type="checkbox" id="presetModeRnd" />
                  </label>
                  <label class="toggle" style="gap:8px;">
                    <span class="note" style="min-width:90px;">WRITE MODE</span>
                    <input type="checkbox" id="presetModeHand" />
                  </label>
                  <label class="toggle" style="gap:8px;">
                    <span class="note" style="min-width:90px;">EXAM MODE</span>
                    <input type="checkbox" id="presetModeChoice" />
                  </label>
                </div>
                <div class="note" style="margin-top:8px;"> OFF</div>
              </div>

              <div class="result-box" style="padding:12px;">
                <div class="note" style="margin-bottom:6px;">/1</div>
                <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
                  <input class="spell-input" id="wordIdInput" inputmode="numeric" placeholder="id" style="max-width:120px;" />
                  <input class="spell-input" id="wordWordInput" placeholder=" / " style="flex:1; min-width:160px;" />
                  <input class="spell-input" id="wordMeaningInput" placeholder="" style="flex:2; min-width:220px;" />
                  <button class="navbtn" id="wordUpsertBtn" type="button">/</button>
                  <button class="textbtn" id="wordClearBtn" type="button"></button>
                </div>
                <div class="note" style="margin-top:8px;"> id</div>
              </div>

              <div class="result-box" style="padding:12px;">
                <div class="note" style="margin-bottom:6px;"> EXAM MODE</div>
                <div class="note" style="margin-bottom:10px;">41</div>

                <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;">
                  <label class="toggle" style="gap:8px;">
                    <span class="note" style="min-width:150px;"></span>
                    <input type="checkbox" id="mcqEnable" />
                  </label>

                  <div style="display:flex; gap:10px; flex-wrap:wrap;">
                    <button class="textbtn" id="mcqFillCorrectBtn" type="button">meaning</button>
                    <button class="textbtn" id="mcqClearBtn" type="button"></button>
                  </div>
                </div>

                <div id="mcqFields" class="hidden" style="margin-top:12px; display:grid; gap:10px;">
                  <div style="display:flex; gap:10px; align-items:center;">
                    <label style="display:flex; align-items:center; gap:8px; min-width:56px;">
                      <input type="radio" name="mcqCorrect" value="0" />
                      <span class="note" style="font-weight:600; color:var(--text);">A</span>
                    </label>
                    <input class="spell-input" id="mcqChoice0" placeholder=" A" style="flex:1; min-width:220px;" />
                  </div>
                  <div style="display:flex; gap:10px; align-items:center;">
                    <label style="display:flex; align-items:center; gap:8px; min-width:56px;">
                      <input type="radio" name="mcqCorrect" value="1" />
                      <span class="note" style="font-weight:600; color:var(--text);">B</span>
                    </label>
                    <input class="spell-input" id="mcqChoice1" placeholder=" B" style="flex:1; min-width:220px;" />
                  </div>
                  <div style="display:flex; gap:10px; align-items:center;">
                    <label style="display:flex; align-items:center; gap:8px; min-width:56px;">
                      <input type="radio" name="mcqCorrect" value="2" />
                      <span class="note" style="font-weight:600; color:var(--text);">C</span>
                    </label>
                    <input class="spell-input" id="mcqChoice2" placeholder=" C" style="flex:1; min-width:220px;" />
                  </div>
                  <div style="display:flex; gap:10px; align-items:center;">
                    <label style="display:flex; align-items:center; gap:8px; min-width:56px;">
                      <input type="radio" name="mcqCorrect" value="3" />
                      <span class="note" style="font-weight:600; color:var(--text);">D</span>
                    </label>
                    <input class="spell-input" id="mcqChoice3" placeholder=" D" style="flex:1; min-width:220px;" />
                  </div>
                </div>
              </div>

              <div>
                <div class="note" style="margin-bottom:6px;"></div>
                <div class="note" style="margin-bottom:6px;"><code>id  </code> 1OK//</div>
                <textarea id="bulkTextarea" style="width:100%; min-height:120px; border:1px solid var(--border); border-radius:12px; padding:12px; font-size:14px; line-height:1.5; outline:none;"></textarea>
                <div style="display:flex; gap:10px; margin-top:8px; flex-wrap:wrap;">
                  <button class="navbtn" id="bulkAddBtn" type="button"></button>
                  <button class="textbtn" id="bulkClearBtn" type="button"></button>
                  <button class="textbtn" id="presetClearWordsBtn" type="button"></button>
                </div>
              </div>

              <div>
                <div class="note" style="margin-bottom:6px;">50</div>
                <div class="result-box" style="padding:12px; max-height:240px; overflow:auto;">
                  <div id="presetWordsPreview" style="display:flex; flex-direction:column; gap:10px;"></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="sheet-footer">
          <button class="textbtn" id="presetCloseBtn2" type="button"></button>
        </div>
      </div>
    </div>

    <div class="overlay hidden" id="settingsOverlay" role="dialog" aria-modal="true" aria-label="">
      <div class="sheet">
        <div class="sheet-header">
          <div class="sheet-title"></div>
          <button class="icon-btn" id="closeSettingsBtn" aria-label="" title=""></button>
        </div>

        <div class="sheet-body">
          <div id="settingsMainPane">
            <div class="setting">
              <div class="text">
                <div class="name"></div>
                <div class="note"> / </div>
              </div>
              <div class="seg" role="tablist" aria-label="">
                <button type="button" id="dirEnJaBtn" class="active" role="tab" aria-selected="true">En  Ja</button>
                <button type="button" id="dirJaEnBtn" role="tab" aria-selected="false">Ja  En</button>
              </div>
            </div>

            <div class="setting">
              <div class="text">
                <div class="name"></div>
                <div class="note"></div>
              </div>
              <label class="toggle" aria-label=" ON/OFF">
                <input type="checkbox" id="animToggle" />
              </label>
            </div>

            <div class="setting">
              <div class="text">
                <div class="name"></div>
                <div class="note">/</div>
              </div>
              <label class="toggle" aria-label=" ON/OFF">
                <input type="checkbox" id="sfxToggle" />
              </label>
            </div>

            <div class="setting">
              <div class="text">
                <div class="name">BGM</div>
                <div class="note"></div>
              </div>
              <label class="toggle" aria-label="BGM ON/OFF">
                <input type="checkbox" id="bgmToggle" />
              </label>
            </div>

            <div class="setting">
              <div class="text">
                <div class="name">BGM </div>
                <div class="note"> /  / </div>
              </div>
              <div class="seg" role="tablist" aria-label="BGM ">
                <button type="button" id="bgmVolLargeBtn" role="tab" aria-selected="false"></button>
                <button type="button" id="bgmVolDefaultBtn" role="tab" aria-selected="false"></button>
                <button type="button" id="bgmVolSmallBtn" role="tab" aria-selected="false"></button>
              </div>
            </div>

            <div class="setting">
              <div class="text">
                <div class="name"></div>
                <div class="note">//</div>
              </div>
              <label class="toggle" aria-label=" ON/OFF">
                <input type="checkbox" id="debugToggle" />
              </label>
            </div>
            <section class="admin-settings-card" id="adminSettingsCard">
              <div class="admin-settings-head">
                <div class="text">
                  <div class="name">Admin</div>
                  <div class="note" id="adminAuthStateLine"></div>
                  <div class="note" id="adminAuthRoleLine">: User</div>
                </div>
                <div class="admin-settings-actions">
                  <button class="textbtn" id="adminLoginBtn" type="button">Admin Login</button>
                  <button class="textbtn" id="adminLogoutBtn" type="button">Logout</button>
                </div>
              </div>
              <div>
                <button class="navbtn hidden" id="adminOpenNotifEditorBtn" type="button"></button>
              </div>
              <div id="adminAuthStatus" class="drawer-share-status" aria-live="polite"></div>
            </section>
            <section class="backup-settings-card" id="backupSettingsCard">
              <div class="text">
                <div class="name"> / </div>
                <div class="note">My Preset</div>
              </div>
              <div class="backup-actions">
                <button class="textbtn" id="backupCreateNowBtn" type="button"></button>
                <button class="textbtn" id="backupExportBtn" type="button">JSON</button>
                <button class="textbtn" id="backupImportBtn" type="button">JSON</button>
                <button class="textbtn" id="backupRestoreLatestBtn" type="button"></button>
                <input id="backupImportFile" type="file" accept="application/json,.json" class="hidden" />
              </div>
              <div id="backupStatus" class="drawer-share-status" aria-live="polite"></div>
            </section>
          </div>

          <section class="admin-notif-editor hidden" id="adminNotifEditor">
            <div class="text">
              <div class="name"></div>
              <div class="note">Firestore: notificationsAdmin</div>
            </div>
            <div class="admin-editor-actions">
              <button class="textbtn" id="adminNotifBackBtn" type="button">Settings</button>
              <button class="textbtn" id="adminNotifReloadBtn" type="button"></button>
            </div>
            <div id="adminNotifStatus" class="drawer-share-status" aria-live="polite"></div>
            <div class="admin-editor-form">
              <input id="adminNotifDocId" type="hidden" />
              <label>
                
                <input class="spell-input" id="adminNotifTitle" type="text" placeholder="" />
              </label>
              <label>
                
                <textarea class="spell-input" id="adminNotifBody" placeholder="## UPDATE&#10;**IMPORTANT**&#10;![img](https://example.com/a.jpg)&#10;[video](https://example.com/a.mp4)&#10;[link](https://example.com)"></textarea>
              </label>
              <div class="note">/</div>
              <div class="admin-editor-grid">
                <label>
                  Category
                  <select class="select" id="adminNotifCategory">
                    <option value="Update">Update</option>
                    <option value="Study">Study</option>
                    <option value="Preset">Preset</option>
                    <option value="System">System</option>
                  </select>
                </label>
                <label>
                  Priority
                  <select class="select" id="adminNotifPriority">
                    <option value="normal">normal</option>
                    <option value="low">low</option>
                    <option value="high">high</option>
                  </select>
                </label>
                <label>
                  PublishedAt
                  <input class="spell-input" id="adminNotifPublishedAt" type="datetime-local" />
                </label>
              </div>
              <div class="admin-editor-submit">
                <button class="navbtn" id="adminNotifSaveBtn" type="button"></button>
                <button class="textbtn" id="adminNotifClearBtn" type="button"></button>
                <button class="textbtn hidden" id="adminNotifCancelEditBtn" type="button"></button>
              </div>
            </div>
            <div class="admin-notif-list" id="adminNotifList"></div>
            <div class="note hidden" id="adminNotifEmpty"></div>
          </section>
        </div>

        <div class="sheet-footer">
          <button class="textbtn" id="closeSettingsBtn2"></button>
        </div>
      
    
      </div>
    </div>

    <div class="overlay hidden" id="timeOverlay" role="dialog" aria-modal="true" aria-label="">
      <div class="sheet">
        <div class="sheet-header">
          <div class="sheet-title">1</div>
          <button class="icon-btn" id="closeTimeBtn" aria-label="" title=""></button>
        </div>

        <div class="sheet-body">
          <div class="section-title" style="margin:0; text-transform:none; letter-spacing:normal;">
            <span></span><span class="right">1</span>
          </div>

          <div class="actions" style="margin-top:0;">
            <button class="btn" id="time5Btn"><div class="label"><span>5</span></div><div class="desc"></div></button>
            <button class="btn" id="time10Btn"><div class="label"><span>10</span></div><div class="desc"></div></button>
            <button class="btn" id="time30Btn"><div class="label"><span>30</span></div><div class="desc"></div></button>
            <button class="btn" id="time60Btn"><div class="label"><span>60</span></div><div class="desc"></div></button>
            <button class="btn" id="timeNoneBtn" style="grid-column:1 / -1;">
              <div class="label"><span></span></div>
              <div class="desc"></div>
            </button>
          </div>

          <div class="fineprint" style="margin-top:0;">
            <span class="badge">Note</span>
            <span></span>
          </div>
        </div>

        <div class="sheet-footer">
          <button class="textbtn" id="cancelTimeBtn"></button>
        </div>
      </div>
    </div>

    <div class="corner">
      <div class="version">
        Version 1.0<br />
         2026 RintyStudio
      </div>
    </div>
  </div>

  

  <!-- Update Notes -->
  <div class="overlay hidden" id="updateOverlay" role="dialog" aria-modal="true" aria-label="">
    <div class="sheet update-sheet">
      <div class="sheet-header">
        <div class="sheet-title">VocabuQuiz</div>
        <button class="icon-btn" id="updateCloseXBtn" aria-label="" title=""></button>
      </div>

      <div class="sheet-body">
        <article class="update-article">
          <h2 class="update-headline">VocabuQuiz</h2>
          <div class="update-date">2026-02-14 0:00</div>

          <div class="update-content">
          <p>VocabuQuiz verv.1.0 </p>
            <ul>
              <li><b></b> <br></br><b> () EXAM MODE  </b> <b></b> </li>
              <li><b></b><b>""</b></li>
            </ul>
            <p class="update-note"> </p>
          </div>
        </article>
      </div>

      <div class="sheet-footer update-footer">
        <label class="checkrow">
          <input type="checkbox" id="updateDontShowChk" />
          <span></span>
        </label>
        <button class="textbtn" id="updateCloseBtn" type="button"></button>
      </div>
    </div>
  </div>
  
  <!-- Insights Dashboard -->
  <div class="overlay hidden" id="insightsOverlay" role="dialog" aria-modal="true" aria-label="Insights">
    <div class="sheet insights-sheet" id="insightsPanel">
      <div class="sheet-header" id="insightsHeader">
        <div>
          <div class="sheet-title"></div>
          <div class="sheet-sub"></div>
        </div>
        <button class="icon-btn" id="insightsCloseBtn" aria-label="" title=""></button>
      </div>

      <div class="sheet-body insights-body" id="insightsBody">
        <div class="insights-filters" id="insightsFilters">
          <div class="filter-item">
            <div class="filter-label"></div>
            <select id="insightsPresetSelect" class="select" aria-label="Preset"></select>
          </div>
          <div class="filter-item">
            <div class="filter-label"></div>
            <select id="insightsModeSelect" class="select" aria-label="Mode">
              <option value="ALL">ALL</option>
              <option value="HAND">WRITE MODE</option>
              <option value="CHOICE">EXAM MODE</option>
              <option value="RND">RANDOM MODE</option>
              <option value="SEQ">TURN MODE</option>
            </select>
          </div>
          <div class="filter-item">
            <div class="filter-label">Range</div>
            <select id="insightsRangeSelect" class="select" aria-label="Range">
              <option value="7D">7D</option>
              <option value="30D" selected>30D</option>
              <option value="ALL">ALL</option>
            </select>
          </div>
        </div>

        <div class="insights-summary" id="insightsSummary"></div>

        <div class="insights-grid">
          <section class="insight-card">
            <div class="insight-head">
              <div class="insight-title"></div>
              <div class="insight-note" id="trendNote"></div>
            </div>
            <div class="chart" id="chartAccuracyTrend"></div>
          </section>

          <section class="insight-card">
            <div class="insight-head">
              <div class="insight-title"> </div>
              <div class="insight-note">A-1</div>
            </div>
            <div class="chart" id="chartDailyVolume"></div>
          </section>

          <section class="insight-card">
            <div class="insight-head">
              <div class="insight-title"> </div>
              <div class="insight-note">A-2</div>
            </div>
            <div class="chart" id="chartDailyAccuracy"></div>
          </section>

          <section class="insight-card">
            <div class="insight-head">
              <div class="insight-title"> </div>
              <div class="insight-note">A-3</div>
            </div>
            <div class="table-wrap" id="tableModeDistribution"></div>
          </section>

          <section class="insight-card" id="modeAccuracyCard">
            <div class="insight-head">
              <div class="insight-title"></div>
              <div class="insight-note"></div>
            </div>
            <div class="chart" id="chartModeAccuracy"></div>
          </section>

          <section class="insight-card">
            <div class="insight-head">
              <div class="insight-title"></div>
              <div class="insight-note">10</div>
            </div>
            <div class="weak-list" id="chartWeakTop10"></div>
          </section>

          <section class="insight-card">
            <div class="insight-head">
              <div class="insight-title"> </div>
              <div class="insight-note">C-1</div>
            </div>
            <div class="chart" id="chartAvgTimeTrend"></div>
          </section>

          <section class="insight-card">
            <div class="insight-head">
              <div class="insight-title"></div>
              <div class="insight-note">C-2</div>
            </div>
            <div class="table-wrap" id="tableTimeoutByMode"></div>
          </section>

          <section class="insight-card">
            <div class="insight-head">
              <div class="insight-title"> vs </div>
              <div class="insight-note">E-1</div>
            </div>
            <div class="table-wrap" id="tableWeekCompare"></div>
          </section>

          <section class="insight-card">
            <div class="insight-head">
              <div class="insight-title">30 vs 30</div>
              <div class="insight-note">E-2</div>
            </div>
            <div class="table-wrap" id="tableMonthCompare"></div>
          </section>

          <section class="insight-card">
            <div class="insight-head">
              <div class="insight-title">Data</div>
              <div class="insight-note">Export / Delete</div>
            </div>
            <div class="insights-actions">
              <button class="textbtn" id="insightsExportBtn" type="button">/JSON</button>
              <button class="textbtn" id="insightsDeleteBtn" type="button">/</button>
            </div>
            <div class="note" style="margin-top:10px; line-height:1.6;">
               
            </div>
          </section>
        </div>
      </div>
    </div>
  </div>


  <!-- In-app Alerts -->
  <div class="ui-modal" id="uiModal" aria-hidden="true">
    <div class="ui-modal-backdrop" data-close="1"></div>
    <div class="ui-modal-card" role="dialog" aria-modal="true" aria-labelledby="uiModalTitle" aria-describedby="uiModalMessage">
      <div class="ui-modal-title" id="uiModalTitle"></div>
      <div class="ui-modal-message" id="uiModalMessage"></div>
      <div class="ui-modal-actions">
        <button class="textbtn" id="uiModalCancel" type="button"></button>
        <button class="navbtn" id="uiModalOk" type="button">OK</button>
      </div>
    </div>
  </div>


  <!-- Notifications -->
  <div class="overlay hidden" id="notifyOverlay" role="dialog" aria-modal="true" aria-label="">
    <div class="sheet notify-sheet">
      <div class="sheet-header">
        <div>
          <div class="sheet-title"></div>
          <div class="sheet-sub">Updates & messages</div>
        </div>
        <button class="icon-btn" id="notifyCloseBtn" aria-label="" title="">
          <span class="ms" aria-hidden="true">close</span>
        </button>
      </div>

      <div class="sheet-body notify-body">
        <div class="notify-pane" id="notifyListPane">
          <div class="notify-empty hidden" id="notifyEmpty"></div>
          <div class="notify-list" id="notifyList"></div>
        </div>
        <div class="notify-pane hidden" id="notifyDetailPane">
          <div class="notify-detail-wrap">
            <div class="notify-detail-head">
              <button class="textbtn" id="notifyDetailBackBtn" type="button"></button>
              <div class="notify-detail-meta" id="notifyDetailMeta"></div>
            </div>
            <h3 class="notify-detail-title" id="notifyDetailTitle"></h3>
            <div id="notifyDetailContent" class="notify-detail-content"></div>
          </div>
        </div>
      </div>

      <div class="sheet-footer">
        <button class="textbtn" id="notifyCloseBtn2" type="button"></button>
      </div>
    </div>
  </div>


  <!-- Search -->
  <div class="overlay hidden" id="searchOverlay" role="dialog" aria-modal="true" aria-label="">
    <div class="sheet search-sheet">
      <div class="sheet-header">
        <div>
          <div class="sheet-title"></div>
          <div class="sheet-sub"></div>
        </div>
        <button class="icon-btn" id="searchCloseBtn" aria-label="" title="">
          <span class="ms" aria-hidden="true">close</span>
        </button>
      </div>

      <div class="sheet-body search-body">
        <div class="search-input-wrap">
          <input id="searchInput" class="spell-input" type="text"
            placeholder="No / word / meaning"
            inputmode="text" autocomplete="off" autocapitalize="none" spellcheck="false" />
        </div>

        <div class="search-empty hidden" id="searchEmpty"></div>
        <div class="search-list" id="searchList" role="listbox" aria-label=""></div>
      </div>
    </div>
  </div>

  <!-- Optional public config fallback. Keep placeholder-only in repo. -->
  <script src="./config.public.example.js"></script>
  <!-- Optional local runtime config (create config.public.js locally; keep it out of git). -->
  <script src="./config.public.js"></script>
  <!-- Optional QR decoding fallback (used only when BarcodeDetector is unavailable). -->
  <script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore-compat.js"></script>
  <script src="https://unpkg.com/jsqr@1.4.0/dist/jsQR.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>

<script>
    ;(() => {
      "use strict";

      // Security: load publish-safe config from config.public.js, legacy globals, meta, and cache.
      const PUBLIC_RUNTIME_CACHE_KEY = "app.public.config.v1";
      function _sanitizePublicConfigValue(v){
        const s = String(v ?? "").trim();
        if (!s) return "";
        if (/^__.+__$/.test(s)) return "";
        if (/^YOUR_[A-Z0-9_]+$/i.test(s)) return "";
        return s;
      }
      function _metaConfigValue(name){
        const el = document.querySelector(`meta[name="${name}"]`);
        if (!el) return "";
        return _sanitizePublicConfigValue(el.getAttribute("content"));
      }
      function _metaConfigValueAny(names){
        for (const name of (Array.isArray(names) ? names : [])){
          const v = _metaConfigValue(name);
          if (v) return v;
        }
        return "";
      }
      function _readPublicRuntimeCache(){
        try{
          const raw = localStorage.getItem(PUBLIC_RUNTIME_CACHE_KEY);
          if (!raw) return {};
          const parsed = JSON.parse(raw);
          return (parsed && typeof parsed === "object") ? parsed : {};
        }catch{
          return {};
        }
      }
      function _savePublicRuntimeCache(cfg){
        try{
          if (!cfg || typeof cfg !== "object") return;
          localStorage.setItem(PUBLIC_RUNTIME_CACHE_KEY, JSON.stringify(cfg));
        }catch{}
      }
      function _normalizeFirebaseConfig(raw){
        const src = (raw && typeof raw === "object") ? raw : {};
        return {
          apiKey: _sanitizePublicConfigValue(src.apiKey || src.piKey || src.API_KEY || src.firebaseApiKey),
          authDomain: _sanitizePublicConfigValue(src.authDomain || src.AUTH_DOMAIN),
          projectId: _sanitizePublicConfigValue(src.projectId || src.projectID || src.PROJECT_ID || src.firebaseProjectId),
          storageBucket: _sanitizePublicConfigValue(src.storageBucket || src.STORAGE_BUCKET),
          messagingSenderId: _sanitizePublicConfigValue(src.messagingSenderId || src.messaging_sender_id || src.MESSAGING_SENDER_ID),
          appId: _sanitizePublicConfigValue(src.appId || src.APP_ID)
        };
      }
      function _normalizeEmailJsConfig(raw){
        const src = (raw && typeof raw === "object") ? raw : {};
        return {
          serviceId: _sanitizePublicConfigValue(src.serviceId),
          templateId: _sanitizePublicConfigValue(src.templateId),
          publicKey: _sanitizePublicConfigValue(src.publicKey)
        };
      }
      function _hasFirebaseConfig(cfg){
        const c = _normalizeFirebaseConfig(cfg);
        return !!(c.apiKey && c.projectId);
      }
      function _hasEmailJsConfig(cfg){
        const c = _normalizeEmailJsConfig(cfg);
        return !!(c.serviceId && c.templateId && c.publicKey);
      }
      function _readPublicRuntimeConfig(){
        const root = (window.__PUBLIC_CONFIG__ && typeof window.__PUBLIC_CONFIG__ === "object")
          ? window.__PUBLIC_CONFIG__
          : {};
        const cache = _readPublicRuntimeCache();
        const firebaseLegacy = (window.__FIREBASE_CONFIG__ && typeof window.__FIREBASE_CONFIG__ === "object")
          ? window.__FIREBASE_CONFIG__
          : ((window.firebaseConfig && typeof window.firebaseConfig === "object")
            ? window.firebaseConfig
            : ((window.__firebaseConfig__ && typeof window.__firebaseConfig__ === "object")
              ? window.__firebaseConfig__
              : {}));
        const emailjsLegacy = (window.__EMAILJS_CONFIG__ && typeof window.__EMAILJS_CONFIG__ === "object")
          ? window.__EMAILJS_CONFIG__
          : {};
        const firebaseRaw = (root.firebase && typeof root.firebase === "object")
          ? root.firebase
          : ((root.firebaseConfig && typeof root.firebaseConfig === "object")
            ? root.firebaseConfig
            : (((root.apiKey || root.projectId) && typeof root === "object") ? root : {}));
        const emailjsRaw = (root.emailjs && typeof root.emailjs === "object")
          ? root.emailjs
          : ((root.emailJs && typeof root.emailJs === "object")
            ? root.emailJs
            : (((root.serviceId || root.templateId || root.publicKey) && typeof root === "object") ? root : {}));
        const firebaseFromCache = (cache.firebase && typeof cache.firebase === "object") ? cache.firebase : {};
        const emailjsFromCache = (cache.emailjs && typeof cache.emailjs === "object") ? cache.emailjs : {};
        const firebase = _normalizeFirebaseConfig({
          apiKey: firebaseRaw.apiKey || firebaseLegacy.apiKey || firebaseFromCache.apiKey || _metaConfigValueAny(["firebase-api-key", "public-api-key"]),
          authDomain: firebaseRaw.authDomain || firebaseLegacy.authDomain || firebaseFromCache.authDomain || _metaConfigValueAny(["firebase-auth-domain", "public-auth-domain"]),
          projectId: firebaseRaw.projectId || firebaseLegacy.projectId || firebaseFromCache.projectId || _metaConfigValueAny(["firebase-project-id", "public-project-id"]),
          storageBucket: firebaseRaw.storageBucket || firebaseLegacy.storageBucket || firebaseFromCache.storageBucket || _metaConfigValueAny(["firebase-storage-bucket", "public-storage-bucket"]),
          messagingSenderId: firebaseRaw.messagingSenderId || firebaseLegacy.messagingSenderId || firebaseFromCache.messagingSenderId || _metaConfigValueAny(["firebase-messaging-sender-id", "public-messaging-sender-id"]),
          appId: firebaseRaw.appId || firebaseLegacy.appId || firebaseFromCache.appId || _metaConfigValueAny(["firebase-app-id", "public-app-id"])
        });
        const emailjs = _normalizeEmailJsConfig({
          serviceId: emailjsRaw.serviceId || emailjsLegacy.serviceId || emailjsFromCache.serviceId || _metaConfigValue("emailjs-service-id"),
          templateId: emailjsRaw.templateId || emailjsLegacy.templateId || emailjsFromCache.templateId || _metaConfigValue("emailjs-template-id"),
          publicKey: emailjsRaw.publicKey || emailjsLegacy.publicKey || emailjsFromCache.publicKey || _metaConfigValue("emailjs-public-key")
        });
        const resolved = { firebase, emailjs };
        if (_hasFirebaseConfig(firebase) || _hasEmailJsConfig(emailjs)){
          _savePublicRuntimeCache(resolved);
        }
        return resolved;
      }
      function _resolveFirebaseConfigNow(){
        const direct = _normalizeFirebaseConfig(window.__FIREBASE_CONFIG__);
        if (_hasFirebaseConfig(direct)) return direct;
        const root = (window.__PUBLIC_CONFIG__ && typeof window.__PUBLIC_CONFIG__ === "object")
          ? window.__PUBLIC_CONFIG__
          : {};
        const fromRootRaw = (root.firebase && typeof root.firebase === "object")
          ? root.firebase
          : ((root.firebaseConfig && typeof root.firebaseConfig === "object")
            ? root.firebaseConfig
            : root);
        const fromRoot = _normalizeFirebaseConfig(fromRootRaw);
        if (_hasFirebaseConfig(fromRoot)){
          window.__FIREBASE_CONFIG__ = fromRoot;
          return fromRoot;
        }
        const runtime = _readPublicRuntimeConfig();
        const fromRuntime = _normalizeFirebaseConfig(runtime.firebase);
        if (_hasFirebaseConfig(fromRuntime)){
          window.__FIREBASE_CONFIG__ = fromRuntime;
          return fromRuntime;
        }
        return null;
      }
      const PUBLIC_RUNTIME_CONFIG = _readPublicRuntimeConfig();
      if (_hasFirebaseConfig(PUBLIC_RUNTIME_CONFIG.firebase)){
        window.__FIREBASE_CONFIG__ = _normalizeFirebaseConfig(PUBLIC_RUNTIME_CONFIG.firebase);
      }

      // =========================
      // Audio (user-provided mp3)
      // =========================
      // Change these paths if you want different filenames/locations.
     const AUDIO_PATHS = {
  bgm: "",
  correct: "",
  wrong: "",
};


      const audio = {
        ready: false,
        bgm: null,
        sfxOk: null,
        sfxNg: null,
      };

      function initAudio(){
        if (audio.ready) return;
        audio.ready = true;

        audio.bgm = new Audio(AUDIO_PATHS.bgm);
        audio.bgm.loop = true;           // BGM must loop
        audio.bgm.preload = "auto";
        audio.bgm.volume = getBgmVolumeValue();

        audio.sfxOk = new Audio(AUDIO_PATHS.correct);
        audio.sfxOk.loop = false;        // SFX must NOT loop
        audio.sfxOk.preload = "auto";

        audio.sfxNg = new Audio(AUDIO_PATHS.wrong);
        audio.sfxNg.loop = false;        // SFX must NOT loop
        audio.sfxNg.preload = "auto";
      }


      const BGM_VOLUME_VALUES = {
        LARGE: 0.70,
        DEFAULT: 0.52,
        SMALL: 0.38
      };

      function getBgmVolumeValue(){
        const k = state.settings.bgmVolume || "DEFAULT";
        return (k in BGM_VOLUME_VALUES) ? BGM_VOLUME_VALUES[k] : BGM_VOLUME_VALUES.DEFAULT;
      }

      function applyBgmVolume(){
        if (!audio.ready || !audio.bgm) return;
        audio.bgm.volume = getBgmVolumeValue();
      }

      function playBgm(){
        if (!state.settings.bgm) return;
        initAudio();
        if (!audio.bgm) return;
        applyBgmVolume();
        if (!audio.bgm.paused) return;

        const p = audio.bgm.play();
        if (p && p.catch) p.catch(() => {});
      }

      function stopBgm(reset=false){
        if (!audio.ready || !audio.bgm) return;
        audio.bgm.pause();
        if (reset){
          try{ audio.bgm.currentTime = 0; } catch {}
        }
      }

      function syncBgmToView(){
        if (!state.settings.bgm) { stopBgm(); return; }
        if (state.view === "QUIZ") playBgm();
        else stopBgm();
      }

      function playSfx(kind){
        if (!state.settings.sfx) return;
        initAudio();
        const a = (kind === "ok") ? audio.sfxOk : audio.sfxNg;
        if (!a) return;

        try{
          a.pause();
          a.currentTime = 0;
        } catch {}

        const p = a.play();
        if (p && p.catch) p.catch(() => {});
      }

      // =========================
      // RAW_DATA (confirmed)
      // =========================
      const RAW_DATA_1_200 = `
1 ability  51 maker  101 defeat  151 eager 
2 ad  52 match  102 destroy  152 engaged 
3 agenda  53 merchant  103 disappoint  153 exclusive 
4 alternative  54 mixture  104 do me a favor  154 expensive 
5 ankle  55 nature  105 dump  155 fat 
6 architect  56 obligation  106 encounter  156 friendly 
7 assistance  57 opportunity  107 escape  157 harsh 
8 automobile  58 pain  108 exist  158 immediate 
9 benefit / 59 path  109 extend  159 initial 
10 breast  60 period  110 flow  160 latter 
11 candidate  61 pit  111 gather  161 medium 
12 chairman  62 politician  112 graduate  162 naked 
13 circuit  63 prayer  113 hate  163 nuclear 
14 coal  64 principle  114 imitate  164 numerous 
15 commission  65 profit  115 inform  165 overwhelming 
16 compassion  66 proverb  116 interrupt  166 plain 
17 condition  67 quantity  117 keep in mind  167 precious 
18 constitution  68 reduction  118 live on  168 prompt 
19 contribution  69 representative  119 lose  169 raw 
20 court  70 restriction  120 manufacturing  170 responsible 
21 criticism  71 rumor  121 nod  171 secondhand 
22 deadline  72 secretary  122 originate  172 smart 
23 delivery  73 sign  123 pitch  173 stupid 
24 destination  74 souvenir  124 preserve / 174 talented 
25 dignity  75 stock / 125 prove  175 tough 
26 disorder  76 substance  126 put together  176 uncomfortable 
27 doubt  77 supply  127 recognize  177 urgent 
28 economics  78 tale  128 release  178 vital 
29 emergency  79 term  129 reply  179 adequate 
30 environment  80 tissue  130 retire  180 aloud 
31 evidence  81 trait  131 run away  181 bravely 
32 expectation  82 truth  132 select  182 especially 
33 extent  83 variation  133 slip  183 forward 
34 fame  84 vocabulary  134 spread  184 immediately 
35 fellow  85 wisdom  135 strain  185 later 
36 flood  86 abandon  136 summon  186 nevertheless 
37 fraction  87 acquaint  137 take after  187 particularly 
38 gene  88 affect  138 transfer  188 rapidly 
39 grace  89 answer for  139 undertake  189 sincerely 
40 harbor  90 argue  140 wear  190 terribly 
41 hemisphere  91 astonish  141 wrap  191 as far as I know 
42 humidity  92 beat  142 wrong  192 at one time 
43 impact  93 bleed  143 aggressive  193 be familiar with 
44 industry  94 break out  144 agricultural  194 before long 
45 injection  95 capture  145 artificial  195 for example  
46 insurance  96 civilize  146 biological  196 in advance 
47 joint  97 commute  147 civil  197 in practice , 
48 laboratory  98 concern  148 concrete  198 not yet 
49 layer  99 contain  149 creative  199 on the way to 
50 litter  100 criticize  150 desirable  200 to start with 
      `;

      const RAW_DATA_201_400 = `
201 abortion  251 male  301 defend  351 economic 
202 addition  252 mate  302 detect  352 enormous 
203 agent  253 mess  303 discover  353 expired 
204 altitude  254 moment  304 do well  354 famous 
205 anniversary  255 navy  305 earn  355 favorite 
206 argument  256 observation  306 encourage  356 frightened 
207 association  257 opposition  307 establish  357 historical 
208 avenue  258 palm  308 expand  358 imperial 
209 beverage  259 patience  309 face / 359 innocent 
210 breath  260 permission  310 focus on  360 lazy 
211 capacity  261 planet  311 gaze  361 mental 
212 chamber  262 politics  312 greet  362 narrow 
213 circumstance  263 predator  313 hear from  363 obvious 
214 coast  264 priority  314 immigrate  364 overall 
215 commissioner  265 progress  315 insist  365 own 
216 competition  266 province  316 introduce  366 pleasant 
217 conduct  267 quarrel  317 keep up with  367 precise 
218 construction  268 reference  318 load / 368 proper 
219 conversation  269 republic  319 made of  369 rear 
220 crack  270 result  320 mean  370 reverse 
221 critics  271 sacrifice  321 notice / 371 senior /
222 dealer  272 seed  322 overcome  372 social 
223 demand / 273 silence  323 play a role in  373 subtle 
224 destruction  274 species  324 pretend  374 technical 
225 direction  275 stomach  325 provide  375 toxic 
226 distance  276 suburb  326 put up with  376 unexpected 
227 dozen 12 277 supporter  327 recommend  377 useful 
228 economy  278 talent  328 relieve  378 vivid 
229 emperor  279 terror  329 represent  379 accustomed 
230 envy  280 toe  330 reuse  380 altogether 
231 evolution  281 transition  331 run out of  381 briefly 
232 expense  282 tuition  332 settle down  382 essentially 
233 extinction  283 vehicle  333 smell  383 frequently , 
234 famine  284 voyage  334 squeeze  384 increasingly 
235 female  285 witness / 335 strengthen  385 literally 
236 focus  286 abolish  336 suppose  386 newly 
237 fragment  287 acquire  337 take care  387 partly 
238 generation  288 afford  338 transform  388 rarely 
239 grammar  289 apologize  339 urge  389 slightly 
240 harm / 290 arise  340 weigh  390 therefore 
241 heritage  291 attach to  341 yell  391 as if 
242 hunger  292 beg  342 absolute  392 at present 
243 implication  293 blink  343 alike  393 be filled with 
244 infant  294 breathe  344 armed  394 by chance 
245 injury  295 carry out  345 ashamed  395 for free 
246 intelligence  296 climb  346 bitter  396 in case 
247 journal  297 compare  347 civilized  397 in reality 
248 lack  298 conclude  348 confident  398 nursery school 
249 lecture  299 continue  349 criminal  399 one day 
250 location  300 cruise  350 detailed  400 up to 
      `;

      const RAW_DATA_401_600 = `
401 absence  451 mammal  501 delay  551 entire 
402 address  452 material  502 determine  552 extensive 
403 aggression  453 metal  503 discuss  553 federal 
404 ambition  454 motive  504 dominate  554 frequent 
405 anxiety  455 necessity  505 educate  555 fundamental 
406 arms  456 observer  506 end up  556 holy 
407 assumption  457 orbit ,  507 estimate  557 impossible 
408 award  458 pan  508 expect  558 intelligent 
409 bill  459 patient  509 fail  559 legal 
410 breeze  460 personality  510 fold  560 mere 
411 capital  461 plant  511 generate  561 national 
412 chapter  462 pollution  512 guarantee / 562 odd 
413 citizen  463 preference  513 hesitate  563 painful 
414 collaboration  464 prison  514 imply  564 physical 
415 commitment  465 promotion  515 insist on  565 polite 
416 competitor  466 psychology  516 invade  566 pregnant 
417 conference  467 quarter  517 laugh at  567 proud 
418 consumer  468 reflection  518 locate  568 reasonable 
419 cooperation  469 reputation  519 maintain  569 ridiculous 
420 craft  470 retail  520 measure / 570 sensitive 
421 crop  471 salary  521 obey  571 sole 
422 debate  472 separation  522 overlap  572 sudden 
423 democracy  473 similarity  523 plenty of  573 temporary 
424 detail  474 spectator  524 prevent  574 traditional 
425 director  475 storage  525 publish  575 unique 
426 distinction  476 success  526 qualify  576 useless 
427 drift  477 surface  527 recover  577 warm 
428 edge  478 task  528 rely on  578 abroad 
429 emphasis  479 theory  529 require  579 annually 
430 equality  480 toll  530 reveal  580 certainly 
431 examination  481 translation  531 rush  581 eventually 
432 experiment  482 tumor  532 share / 582 fully 
433 eyesight  483 vending machine  533 snap  583 indeed 
434 fancy  484 wage  534 stand out  584 luckily 
435 fertilizer  485 Muslim  535 stretch  585 normally 
436 folk  486 absorb  536 surround  586 permanently 
437 frown  487 adapt  537 take over ,  587 rather 
438 genius  488 agree with  538 translate  588 socially 
439 grant  489 appeal  539 utilize  589 totally 
440 harmony  490 arrange  540 welcome  590 a bunch of 
441 hesitation  491 attend  541 abstract  591 as well 
442 ideal  492 behave  542 alive  592 at that time 
443 impression  493 block  543 asleep  593 be good at 
444 infection  494 breed  544 bare  594 by heart 
445 inquiry  495 cast  545 bloody  595 for instance  
446 intention  496 clip / 546 classical  596 in charge of 
447 journey  497 compete  547 conscious  597 in response 
448 landscape  498 confess  548 critical  598 off duty 
449 leftover  499 contribute  549 distant ,  599 out of date 
450 log  500 cure  550 educational  600 out of stock 
`;

      const RAW_DATA_ALL = RAW_DATA_1_200 + "\n" + RAW_DATA_201_400 + "\n" + RAW_DATA_401_600;

      // =========================
      // Parse (robust)
      // =========================
      const jpRegex = /[---]/;

      function parseWords(raw, maxId){
        const normalized = String(raw).replace(/\s+/g, " ").trim();

        // id boundary: 1..600 followed by spaces + ASCII letter (avoid "12" etc)
        const idRegex = /(^|\s)(600|[1-5]\d{2}|[1-9]\d|[1-9])(?=\s+[A-Za-z])/g;
        const matches = [];
        for (const m of normalized.matchAll(idRegex)){
          const lead = m[1] || "";
          const idStr = m[2];
          const start = (m.index ?? 0) + lead.length;
          const id = Number(idStr);
          if (Number.isFinite(id) && id >= 1 && id <= maxId){
            matches.push({ id, start });
          }
        }

        const found = [];
        const parseErrors = [];

        for (let i = 0; i < matches.length; i++){
          const start = matches[i].start;
          const end = (i + 1 < matches.length) ? matches[i + 1].start : normalized.length;
          const chunk = normalized.slice(start, end).trim();
          const mm = chunk.match(/^(\d+)\s+(.+)$/);
          if (!mm) continue;

          const id = Number(mm[1]);
          if (!(id >= 1 && id <= maxId)) continue;

          const rest = mm[2] ?? "";
          const jpIndex = rest.search(PRESET_JP_REGEX);

          let word = "";
          let meaning = "";

          if (jpIndex === -1){
            word = rest.trim();
            meaning = "";
            parseErrors.push(id);
          } else {
            // meaning should start at token containing first JP char (so "12" keeps 12)
            const prevSpace = rest.lastIndexOf(" ", jpIndex);
            const meaningStart = (prevSpace === -1) ? 0 : (prevSpace + 1);

            word = rest.slice(0, meaningStart).trim();
            meaning = rest.slice(meaningStart).trim();
            if (!word || !meaning) parseErrors.push(id);
          }

          found.push({ id, word, meaning });
        }

        found.sort((a,b) => a.id - b.id);

        const byId = new Map();
        const duplicates = [];
        for (const item of found){
          if (byId.has(item.id)){
            duplicates.push(item.id);
            continue;
          }
          byId.set(item.id, item);
        }

        const missing = [];
        for (let id = 1; id <= maxId; id++){
          if (!byId.has(id)) missing.push(id);
        }

        const parseErrorsUnique = Array.from(new Set(parseErrors)).sort((a,b)=>a-b);
        const words = Array.from(byId.values()).sort((a,b)=>a.id - b.id);

        return {
          maxId,
          words,
          byId,
          missing,
          duplicates: Array.from(new Set(duplicates)).sort((a,b)=>a-b),
          parseErrors: parseErrorsUnique
        };
      }

      function shuffle(arr){
        const a = arr.slice();
        for (let i = a.length - 1; i > 0; i--){
          const j = Math.floor(Math.random() * (i + 1));
          [a[i], a[j]] = [a[j], a[i]];
        }
        return a;
      }

      function uniq(arr){
        return Array.from(new Set(arr));
      }

      function clamp(n, min, max){
        return Math.max(min, Math.min(max, n));
      }

      // =========================
      // Presets (user editable)
      // =========================
      const PRESETS_KEY = "wordPractice400.presets.v1";
      let __presetsRev = 0;
      let __searchIndexCache = { rev: -1, items: [] };
      const ACTIVE_PRESET_KEY = "wordPractice400.activePresetId.v1";
      const PRESET_JP_REGEX = /[---]/;

      // =========================
      // In-app alert / confirm (no window.alert/confirm)
      // =========================
      const uiModal = {
        root: document.getElementById("uiModal"),
        backdrop: document.querySelector("#uiModal .ui-modal-backdrop"),
        card: document.querySelector("#uiModal .ui-modal-card"),
        title: document.getElementById("uiModalTitle"),
        message: document.getElementById("uiModalMessage"),
        ok: document.getElementById("uiModalOk"),
        cancel: document.getElementById("uiModalCancel"),
      };

      let _modalResolver = null;
      let _modalType = "alert"; // "alert" | "confirm"
      let _modalOnClose = null;
      let _modalQueue = Promise.resolve();

      function uiModalOnClose(fn){ _modalOnClose = (typeof fn === "function") ? fn : null; }

      function _openModal(payload){
        if (!uiModal.root) return;
        const { type, title, message, okText, cancelText, danger } = payload;
        _modalType = type;

        uiModal.root.classList.add("is-open");
        uiModal.root.setAttribute("aria-hidden", "false");

        if (uiModal.title) uiModal.title.textContent = title || (type === "confirm" ? "" : "");
        if (uiModal.message){
          const htmlStr = payload.html;
          if (htmlStr != null){
            uiModal.message.innerHTML = String(htmlStr);
            uiModal.message.classList.add("is-html");
          }else{
            uiModal.message.textContent = String(message ?? "");
            uiModal.message.classList.remove("is-html");
          }
        }

        if (uiModal.ok) uiModal.ok.textContent = okText || "OK";
        if (uiModal.cancel) uiModal.cancel.textContent = cancelText || "";
        if (uiModal.cancel) uiModal.cancel.style.display = (type === "confirm") ? "" : "none";
        if (uiModal.card) uiModal.card.classList.toggle("is-danger", !!danger);

        // Focus
        setTimeout(() => {
          (uiModal.ok || uiModal.cancel)?.focus?.();
        }, 0);
      }

      function _closeModal(result){
        if (!uiModal.root) return;
        uiModal.root.classList.remove("is-open");
        uiModal.root.setAttribute("aria-hidden", "true");
        try{ if (typeof _modalOnClose === "function") _modalOnClose(); }catch{}
        _modalOnClose = null;
        const r = _modalResolver;
        _modalResolver = null;
        if (typeof r === "function") r(result);
      }

      function uiAlert(message, opts = {}){
        const payload = {
          type: "alert",
          title: opts.title || "",
          message: String(message ?? ""),
          okText: opts.okText || "OK",
          cancelText: "",
          danger: false
        };
        _modalQueue = _modalQueue.then(() => new Promise((resolve) => {
          _modalResolver = () => resolve(true);
          _openModal(payload);
        }));
        return _modalQueue.then(() => {});
      }

      function uiConfirm(message, opts = {}){
        const payload = {
          type: "confirm",
          title: opts.title || "",
          message: String(message ?? ""),
          okText: opts.okText || "OK",
          cancelText: opts.cancelText || "",
          danger: !!opts.danger
        };
        _modalQueue = _modalQueue.then(() => new Promise((resolve) => {
          _modalResolver = resolve;
          _openModal(payload);
        }));
        return _modalQueue;
      }

      function uiHtml(html, opts = {}){
        const payload = {
          type: "alert",
          title: opts.title || "",
          message: "",
          html: String(html ?? ""),
          okText: opts.okText || "",
          cancelText: "",
          danger: false
        };
        _modalQueue = _modalQueue.then(() => new Promise((resolve) => {
          _modalResolver = () => resolve(true);
          _openModal(payload);
        }));
        return _modalQueue.then(() => {});
      }

      function uiConfirmHtml(html, opts = {}){
        const payload = {
          type: "confirm",
          title: opts.title || "",
          message: "",
          html: String(html ?? ""),
          okText: opts.okText || "OK",
          cancelText: opts.cancelText || "",
          danger: !!opts.danger
        };
        _modalQueue = _modalQueue.then(() => new Promise((resolve) => {
          _modalResolver = (r) => resolve(!!r);
          _openModal(payload);
        }));
        return _modalQueue.then((r) => r);
      }

      let _toastTimer = null;
      function uiToast(message){
        const text = String(message ?? "").trim();
        if (!text) return;
        let elToast = document.getElementById("uiToast");
        if (!elToast){
          elToast = document.createElement("div");
          elToast.id = "uiToast";
          elToast.className = "ui-toast";
          document.body.appendChild(elToast);
        }
        elToast.textContent = text;
        elToast.classList.add("show");
        if (_toastTimer) clearTimeout(_toastTimer);
        _toastTimer = setTimeout(() => elToast.classList.remove("show"), 1800);
      }


      uiModal.ok?.addEventListener("click", () => _closeModal(true));
      uiModal.cancel?.addEventListener("click", () => _closeModal(false));
      uiModal.backdrop?.addEventListener("click", () => _closeModal(false));

      document.addEventListener("keydown", (e) => {
        if (!uiModal.root || !uiModal.root.classList.contains("is-open")) return;

        if (e.key === "Escape"){
          e.preventDefault();
          _closeModal(false);
          return;
        }

        if (e.key === "Enter" && _modalType === "confirm"){
          const tag = (document.activeElement?.tagName || "").toLowerCase();
          if (tag === "textarea") return;
          if (tag === "input"){
            const t = (document.activeElement?.type || "").toLowerCase();
            if (t && t !== "button" && t !== "submit") return;
          }
          e.preventDefault();
          _closeModal(true);
        }
      });

function loadPresets(){
        try{
          const raw = localStorage.getItem(PRESETS_KEY);
          if (!raw) return [];
          const arr = JSON.parse(raw);
          return Array.isArray(arr) ? arr.filter(p => p && typeof p.id === "string") : [];
        }catch{ return []; }
      }
      function savePresets(arr){
        localStorage.setItem(PRESETS_KEY, JSON.stringify(arr));
        __presetsRev++;
        __searchIndexCache.rev = -1;
      }
      function loadActivePresetId(fallbackDeck){
        const fb = fallbackDeck || "A";
        return localStorage.getItem(ACTIVE_PRESET_KEY) || `builtin:${fb}`;
      }
      function saveActivePresetId(id){
        localStorage.setItem(ACTIVE_PRESET_KEY, id);
      }

      function isBuiltinPreset(id){
        return String(id||"").startsWith("builtin:");
      }
      function builtinNameFromDeck(deckKey){
        if (deckKey === "A") return "0200";
        if (deckKey === "B") return "200400";
        if (deckKey === "C") return "400600";
        return "ALL";
      }
      function deckFromBuiltinId(pid){
        const k = String(pid).split(":")[1];
        if (k === "A" || k === "B" || k === "C" || k === "ALL") return k;
        return "A";
      }

      function getPresetById(pid){
        if (isBuiltinPreset(pid)){
          const dk = deckFromBuiltinId(pid);
          return { id: pid, builtin:true, name: builtinNameFromDeck(dk), modes: {SEQ:true,RND:true,HAND:true,CHOICE:true} };
        }
        const list = loadPresets();
        return list.find(p => p.id === pid) || null;
      }

      function normalizeWordEntry(e){
        const id = Number(e?.id);
        const word = String(e?.word ?? "").trim();
        const meaning = String(e?.meaning ?? "").trim();
        if (!Number.isFinite(id) || id <= 0) return null;
        if (!word || !meaning) return null;

        // Optional: custom 4-choice config (for user presets)
        let mcq = null;
        const rawMcq = e?.mcq;
        if (rawMcq && typeof rawMcq === "object"){
          const rawChoices = Array.isArray(rawMcq.choices) ? rawMcq.choices : [];
          const seen = new Set();
          const choices = [];
          for (const v of rawChoices.slice(0,4)){
            const s = String(v ?? "").trim();
            if (!s) continue;
            if (seen.has(s)) continue;
            seen.add(s);
            choices.push(s);
          }
          if (choices.length >= 2){
            let ci = Number(rawMcq.correctIndex);
            if (!Number.isInteger(ci)) ci = -1;
            if (ci < 0 || ci >= choices.length){
              const f = choices.findIndex(x => x === meaning);
              ci = f >= 0 ? f : 0;
            }
            // Enforce strict: correct choice must exactly equal meaning
            if (choices[ci] !== meaning){
              const f = choices.findIndex(x => x === meaning);
              if (f >= 0){
                ci = f;
              } else {
                choices[ci] = meaning;
              }
            }
            mcq = { choices, correctIndex: ci };
          }
        }

        return mcq ? { id, word, meaning, mcq } : { id, word, meaning };
      }

      function getPresetWords(pid){
        if (isBuiltinPreset(pid)){
          const dk = deckFromBuiltinId(pid);
          return data.words.filter(w => (
            dk === "A" ? (w.id >= 1 && w.id <= 200) :
            dk === "B" ? (w.id >= 201 && w.id <= 400) :
            dk === "C" ? (w.id >= 401 && w.id <= 600) : true
          ));
        }
        const p = getPresetById(pid);
        const list = Array.isArray(p?.words) ? p.words : [];
        const map = new Map();
        for (const it of list){
          const n = normalizeWordEntry(it);
          if (!n) continue;
          map.set(n.id, n);
        }
        return Array.from(map.values()).sort((a,b)=>a.id-b.id);
      }

      function getPresetModes(pid){
        if (isBuiltinPreset(pid)) return {SEQ:true,RND:true,HAND:true,CHOICE:true};
        const p = getPresetById(pid);
        const m = p?.modes || {};
        return { SEQ:!!m.SEQ, RND:!!m.RND, HAND:!!m.HAND, CHOICE:!!m.CHOICE };
      }

      function getActivePresetId(){
        return state.presetId || `builtin:${state.deck}`;
      }

      function setActivePreset(pid){
        _clearRecommendScope();
        state.presetId = pid;
        saveActivePresetId(pid);
        if (isBuiltinPreset(pid)){
          const dk = deckFromBuiltinId(pid);
          state.deck = dk;
          saveDeck(dk);
        }
        if (state.view === "TITLE") renderAll();
      }

      function getActiveWords(){
        return getPresetWords(getActivePresetId());
      }
      function buildActiveById(){
        const m = new Map();
        for (const w of getActiveWords()) m.set(w.id, w);
        return m;
      }

      // Override getDeckWords to use active preset when custom is selected.
      const _origGetDeckWords = getDeckWords;
      getDeckWords = function(deckKey){
        const pid = getActivePresetId();
        if (!isBuiltinPreset(pid)) return getActiveWords();
        return _origGetDeckWords(deckKey);
      };

      // Use presetId as cache key for 100-question sets on custom presets.
      function getSetKey(deckKey){
        const pid = getActivePresetId();
        if (!isBuiltinPreset(pid)) return pid;
        return deckKey;
      }

      function applyModeVisibility(){
        const pid = getActivePresetId();
        const modes = getPresetModes(pid);
        const count = getActiveWords().length;
        const hasWords = count > 0;

        const canSeq = !!modes.SEQ && hasWords;
        const canRnd = !!modes.RND && hasWords;
        const canHand = !!modes.HAND && hasWords;
        const canChoice = !!modes.CHOICE && hasWords;

        const setDisp = (btn, ok) => { if (!btn) return; btn.style.display = ok ? "" : "none"; };
        setDisp(el.startSeqBtn, canSeq);
        setDisp(el.startRndBtn, canRnd);
        setDisp(el.startHandBtn, canHand);
        setDisp(el.startChoiceBtn, canChoice);

        const any = canSeq || canRnd || canHand || canChoice;
        if (el.modeActions) el.modeActions.classList.toggle("hidden", !any);
        if (el.emptyState) el.emptyState.classList.toggle("hidden", any);
      }

      function syncPresetUI(){
        const pid = getActivePresetId();
        const isMy = !isBuiltinPreset(pid);
        const dk = state.deck;

        el.deckABtn.classList.toggle("active", !isMy && dk === "A");
        el.deckBBtn.classList.toggle("active", !isMy && dk === "B");
        if (el.deckCBtn) el.deckCBtn.classList.toggle("active", !isMy && dk === "C");
        el.deckAllBtn.classList.toggle("active", !isMy && dk === "ALL");
        if (el.deckMyBtn){
          el.deckMyBtn.classList.toggle("active", isMy);
          el.deckMyBtn.setAttribute("aria-selected", String(isMy));
        }
        el.deckABtn.setAttribute("aria-selected", String(!isMy && dk === "A"));
        el.deckBBtn.setAttribute("aria-selected", String(!isMy && dk === "B"));
        if (el.deckCBtn) el.deckCBtn.setAttribute("aria-selected", String(!isMy && dk === "C"));
        el.deckAllBtn.setAttribute("aria-selected", String(!isMy && dk === "ALL"));

        const words = _getSearchIndexAll();
        const name = isMy ? (getPresetById(pid)?.name || "My") : builtinNameFromDeck(dk);
        el.deckStatus.textContent = `${name}${words.length}`;

        if (el.customPresetRow){
          el.customPresetRow.classList.toggle("hidden", !isMy);
        }

        if (el.customPresetSelect){
          const list = loadPresets();
          el.customPresetSelect.innerHTML = "";
          if (!list.length){
            const opt = document.createElement("option");
            opt.value = "";
            opt.textContent = "";
            el.customPresetSelect.appendChild(opt);
            el.customPresetSelect.disabled = true;
          } else {
            el.customPresetSelect.disabled = false;
            for (const p of list){
              const opt = document.createElement("option");
              opt.value = p.id;
              opt.textContent = p.name || "My Preset";
              el.customPresetSelect.appendChild(opt);
            }
            el.customPresetSelect.value = list.some(p => p.id === pid) ? pid : list[0].id;
          }
        }

        applyModeVisibility();
      }

      // =========================
      // Data
      // =========================
      const data = parseWords(RAW_DATA_ALL, 600);

      // =========================
      // Settings
      // =========================
      const SETTINGS_KEY = "wordPractice400.settings.v2";
      const DECK_KEY = "wordPractice400.deck.v1";
      const EXAM_SET_KEY_PREFIX = "wordPractice400.examSet.v1"; // + ":" + deckKey
      const UPDATE_NOTES_DISMISS_KEY = "wordPractice400.updateNotes.dismissed.v1";

      const defaultSettings = {
        direction: "EN_JA",     // EN_JA or JA_EN
        animations: true,
        debug: true,
        sfx: true,
        bgm: true,
        bgmVolume: "DEFAULT"    // LARGE | DEFAULT | SMALL
      };

      function loadSettings(){
        try{
          const raw = localStorage.getItem(SETTINGS_KEY);
          if (!raw) return { ...defaultSettings };
          const parsed = JSON.parse(raw);
          return {
            direction: (parsed.direction === "JA_EN") ? "JA_EN" : "EN_JA",
            animations: ("animations" in parsed) ? !!parsed.animations : defaultSettings.animations,
            debug: ("debug" in parsed) ? !!parsed.debug : defaultSettings.debug,
            sfx: ("sfx" in parsed) ? !!parsed.sfx : defaultSettings.sfx,
            bgm: ("bgm" in parsed) ? !!parsed.bgm : defaultSettings.bgm,
            bgmVolume: (parsed.bgmVolume === "LARGE" || parsed.bgmVolume === "SMALL" || parsed.bgmVolume === "DEFAULT")
              ? parsed.bgmVolume
              : defaultSettings.bgmVolume
          };
        } catch {
          return { ...defaultSettings };
        }
      }
      function saveSettings(s){
        localStorage.setItem(SETTINGS_KEY, JSON.stringify(s));
      }

      function loadDeck(){
        const v = localStorage.getItem(DECK_KEY);
        if (v === "B" || v === "C" || v === "ALL") return v;
        return "A";
      }
      function saveDeck(d){
        localStorage.setItem(DECK_KEY, d);
      }

      // =========================
      // App state
      // =========================
      const state = {
        settings: loadSettings(),
        view: "TITLE",  // TITLE | QUIZ | RESULT
        resultKind: null, // HAND | CHOICE
        deck: loadDeck(), // A | B | ALL

        mode: null,     // SEQ | RND | CHOICE | HAND | REVIEW_WRONG
        order: [],
        index: 0,

        showAnswer: false,
        done: false,

        // hand mode
        hand: {
          checked: false,
          correct: null,
          input: "",
          busy: false,
          results: [], // {id, expected, given, correct, promptMeaning}
          scoreCorrect: 0
        },
        choice: {
          timeLimitSec: 0,      // 0 means none
          remainingMs: 0,
          timerId: null,
          endAt: 0,
          locked: false,
          options: [],
          correctIndex: -1,
          lastCorrectIndex: -1,
          correctCount: 0,
          results: []
        },

        // review wrong deck (as order)
        wrongOrder: [],

        // memo-check recommended scoped run
        _recommendScopeIds: null,
        _recommendScopedActive: false
      };
      function _clearRecommendScope(){
        state._recommendScopeIds = null;
        state._recommendScopedActive = false;
      }
      function _setRecommendScope(ids){
        const list = Array.from(new Set((Array.isArray(ids) ? ids : [])
          .map(Number)
          .filter(n => Number.isFinite(n))));
        state._recommendScopeIds = list.length ? list : null;
        state._recommendScopedActive = list.length > 0;
      }
      // =========================
      // Preset selection init (after state exists)
      // =========================
      state.presetId = loadActivePresetId(state.deck);

      // If stored custom preset doesn't exist anymore, fallback safely.
      if (!isBuiltinPreset(state.presetId)){
        const list = loadPresets();
        if (!list.some(p => p.id === state.presetId)){
          state.presetId = list[0]?.id || `builtin:${state.deck}`;
        }
      }

      // If builtin preset, ensure deck follows it.
      if (isBuiltinPreset(state.presetId)){
        const dk = deckFromBuiltinId(state.presetId);
        state.deck = dk;
        saveDeck(dk);
      }

      saveActivePresetId(state.presetId);



      // =========================
      // Elements
      // =========================
      const el = {
        backBtn: document.getElementById("backBtn"),
        settingsBtn: document.getElementById("settingsBtn"),
        insightsBtn: document.getElementById("insightsBtn"),
        notifyBtn: document.getElementById("notifyBtn"),
        notifyDot: document.getElementById("notifyDot"),
        notifyOverlay: document.getElementById("notifyOverlay"),
        notifyCloseBtn: document.getElementById("notifyCloseBtn"),
        notifyCloseBtn2: document.getElementById("notifyCloseBtn2"),
        notifyList: document.getElementById("notifyList"),
        notifyEmpty: document.getElementById("notifyEmpty"),
        notifyListPane: document.getElementById("notifyListPane"),
        notifyDetailPane: document.getElementById("notifyDetailPane"),
        notifyDetailBackBtn: document.getElementById("notifyDetailBackBtn"),
        notifyDetailTitle: document.getElementById("notifyDetailTitle"),
        notifyDetailMeta: document.getElementById("notifyDetailMeta"),
        notifyDetailContent: document.getElementById("notifyDetailContent"),
        topPresetBtn: document.getElementById("topPresetBtn"),
        searchBtn: document.getElementById("searchBtn"),
        searchOverlay: document.getElementById("searchOverlay"),
        searchCloseBtn: document.getElementById("searchCloseBtn"),
        searchInput: document.getElementById("searchInput"),
        searchList: document.getElementById("searchList"),
        searchEmpty: document.getElementById("searchEmpty"),

        viewStart: document.getElementById("viewStart"),
        startAppBtn: document.getElementById("startAppBtn"),

        viewTitle: document.getElementById("viewTitle"),
        viewQuiz: document.getElementById("viewQuiz"),
        viewResult: document.getElementById("viewResult"),

        deckABtn: document.getElementById("deckABtn"),
        deckBBtn: document.getElementById("deckBBtn"),
        deckCBtn: document.getElementById("deckCBtn"),
        deckAllBtn: document.getElementById("deckAllBtn"),
        deckMyBtn: document.getElementById("deckMyBtn"),
        presetManageBtn: document.getElementById("presetManageBtn"),
        customPresetRow: document.getElementById("customPresetRow"),
        customPresetSelect: document.getElementById("customPresetSelect"),
        customPresetNewBtn: document.getElementById("customPresetNewBtn"),
        deckStatus: document.getElementById("deckStatus"),
        practiceHint: document.getElementById("practiceHint"),

        modeActions: document.getElementById("modeActions"),
        emptyState: document.getElementById("emptyState"),

        startSeqBtn: document.getElementById("startSeqBtn"),
        startRndBtn: document.getElementById("startRndBtn"),
        startChoiceBtn: document.getElementById("startChoiceBtn"),
        startHandBtn: document.getElementById("startHandBtn"),

        badgeSeq: document.getElementById("badgeSeq"),
        badgeRnd: document.getElementById("badgeRnd"),
        badgeChoice: document.getElementById("badgeChoice"),
        badgeHand: document.getElementById("badgeHand"),

        dataStatusText: document.getElementById("dataStatusText"),

        progressText: document.getElementById("progressText"),
        timerPill: document.getElementById("timerPill"),
        modePill: document.getElementById("modePill"),
        noText: document.getElementById("noText"),
        dirLabel: document.getElementById("dirLabel"),
        judgeBadge: document.getElementById("judgeBadge"),
        promptText: document.getElementById("promptText"),
        choiceWrap: document.getElementById("choiceWrap"),
        choices: document.getElementById("choices"),
        answerWrap: document.getElementById("answerWrap"),
        answerText: document.getElementById("answerText"),
        yourText: document.getElementById("yourText"),

        // marks
        markLayer: document.getElementById("markLayer"),
        svgOk: document.getElementById("svgOk"),
        svgNg: document.getElementById("svgNg"),

        spellWrap: document.getElementById("spellWrap"),
        spellInput: document.getElementById("spellInput"),
        readCanvasBtn: document.getElementById("readCanvasBtn"),

        handWrap: document.getElementById("handWrap"),
        handCanvas: document.getElementById("handCanvas"),
        handMini: document.getElementById("handMini"),
        clearCanvasBtn: document.getElementById("clearCanvasBtn"),

        primaryBtn: document.getElementById("primaryBtn"),
        prevBtn: document.getElementById("prevBtn"),
        nextBtn: document.getElementById("nextBtn"),
        restartBtn: document.getElementById("restartBtn"),
        newSetBtn: document.getElementById("newSetBtn"),

        debugBar: document.getElementById("debugBar"),
        card: document.getElementById("card"),

        // settings
        settingsOverlay: document.getElementById("settingsOverlay"),
        updateOverlay: document.getElementById("updateOverlay"),
        updateCloseBtn: document.getElementById("updateCloseBtn"),
        updateCloseXBtn: document.getElementById("updateCloseXBtn"),
        updateDontShowChk: document.getElementById("updateDontShowChk"),
        timeOverlay: document.getElementById("timeOverlay"),
        closeTimeBtn: document.getElementById("closeTimeBtn"),
        cancelTimeBtn: document.getElementById("cancelTimeBtn"),
        time5Btn: document.getElementById("time5Btn"),
        time10Btn: document.getElementById("time10Btn"),
        time30Btn: document.getElementById("time30Btn"),
        time60Btn: document.getElementById("time60Btn"),
        timeNoneBtn: document.getElementById("timeNoneBtn"),
        closeSettingsBtn: document.getElementById("closeSettingsBtn"),
        closeSettingsBtn2: document.getElementById("closeSettingsBtn2"),
        dirEnJaBtn: document.getElementById("dirEnJaBtn"),
        dirJaEnBtn: document.getElementById("dirJaEnBtn"),
        animToggle: document.getElementById("animToggle"),
        sfxToggle: document.getElementById("sfxToggle"),
        bgmToggle: document.getElementById("bgmToggle"),
        bgmVolLargeBtn: document.getElementById("bgmVolLargeBtn"),
        bgmVolDefaultBtn: document.getElementById("bgmVolDefaultBtn"),
        bgmVolSmallBtn: document.getElementById("bgmVolSmallBtn"),
        debugToggle: document.getElementById("debugToggle"),
        backupCreateNowBtn: document.getElementById("backupCreateNowBtn"),
        backupExportBtn: document.getElementById("backupExportBtn"),
        backupImportBtn: document.getElementById("backupImportBtn"),
        backupRestoreLatestBtn: document.getElementById("backupRestoreLatestBtn"),
        backupImportFile: document.getElementById("backupImportFile"),
        backupStatus: document.getElementById("backupStatus"),

        // result
        resultSub: document.getElementById("resultSub"),
        scoreBig: document.getElementById("scoreBig"),
        scoreSub: document.getElementById("scoreSub"),
        wrongDetails: document.getElementById("wrongDetails"),
        wrongSummary: document.getElementById("wrongSummary"),
        wrongList: document.getElementById("wrongList"),
        resultRestartBtn: document.getElementById("resultRestartBtn"),
        resultNewSetBtn: document.getElementById("resultNewSetBtn"),
        resultTitleBtn: document.getElementById("resultTitleBtn"),
        resultReviewBtn: document.getElementById("resultReviewBtn")
      };

      // =========================
      // Debug summary UI
      // =========================
      function formatList(ids, max = 14){
        if (!ids.length) return "";
        const head = ids.slice(0, max).join(", ");
        const tail = ids.length > max ? ` (+${ids.length - max})` : "";
        return head + tail;
      }

      function updateDataStatus(){
        const ok = (data.words.length === data.maxId) && data.missing.length === 0 && data.duplicates.length === 0 && data.parseErrors.length === 0;
        const parts = [];
        parts.push(ok ? `OK${data.words.length}/${data.maxId}` : `${data.words.length}/${data.maxId}`);
        if (data.missing.length) parts.push(`: ${formatList(data.missing)}`);
        if (data.duplicates.length) parts.push(`: ${formatList(data.duplicates)}`);
        if (data.parseErrors.length) parts.push(`: ${formatList(data.parseErrors)}`);
        el.dataStatusText.textContent = parts.join(" / ");
      }

      function updateDebugBar(){
        if (!state.settings.debug){
          el.debugBar.textContent = "";
          return;
        }
        const lines = [];
        if (data.missing.length) lines.push(`: ${formatList(data.missing)}`);
        if (data.duplicates.length) lines.push(`: ${formatList(data.duplicates)}`);
        if (data.parseErrors.length) lines.push(`: ${formatList(data.parseErrors)}`);

        if (!lines.length){
          el.debugBar.textContent = "";
          return;
        }
        el.debugBar.innerHTML = `<strong>Data check</strong>  ${lines.join(" / ")}`;
      }

      // =========================
      // Deck
      // =========================
      function deckLabel(deckKey){
        if (deckKey === "A") return "0200";
        if (deckKey === "B") return "200400";
        return "ALL";
      }

      function getDeckWords(deckKey){
        if (deckKey === "A") return data.words.filter(w => w.id >= 1 && w.id <= 200);
        if (deckKey === "B") return data.words.filter(w => w.id >= 201 && w.id <= 400);
        if (deckKey === "C") return data.words.filter(w => w.id >= 401 && w.id <= 600);
        return data.words.slice();
      }

      function deckSize(deckKey){
        return getDeckWords(deckKey).length;
      }

      // =========================
      // Mode labels
      // =========================
      
      function modeLabel(){
        switch (state.mode){
          case "SEQ": return "";
          case "RND": return "1";
          case "CHOICE": return "4100";
          case "HAND": return "100";
          case "REVIEW_WRONG": return "";
          default: return "";
        }
      }

      function dirLabel(){
        if (state.mode === "HAND") return "  ";
        if (state.mode === "CHOICE") return "  4";
        return state.settings.direction === "EN_JA" ? "  " : "  ";
      }
// =========================
      // View + render helpers
      // =========================
      function setView(next){
        state.view = next;

        if (el.viewStart) el.viewStart.classList.toggle("active", next === "START");
        el.viewTitle.classList.toggle("active", next === "TITLE");
        el.viewQuiz.classList.toggle("active", next === "QUIZ");
        el.viewResult.classList.toggle("active", next === "RESULT");

        el.backBtn.disabled = (next === "START" || next === "TITLE");

        // keep BGM synced to view (quiz only)
        syncBgmToView();
      }

      function animateCardSwap(fnRender){
        if (!state.settings.animations){
          fnRender();
          return;
        }
        el.card.classList.add("fade-out");
        window.setTimeout(() => {
          fnRender();
          el.card.classList.remove("fade-out");
        }, 140);
      }

      function getCurrent(){
        if (!state.order.length) return null;
        return state.order[state.index] || null;
      }

      // =========================
      // Build order
      // =========================
      const EXAM_SET_KEY = () => `${EXAM_SET_KEY_PREFIX}:${state.deck}`;

      function sampleIdsUnique(ids, n){
        return shuffle(ids).slice(0, Math.min(n, ids.length));
      }

      function loadExamSetIds(deckKey){
        try{
          const raw = localStorage.getItem(`${EXAM_SET_KEY_PREFIX}:${deckKey}`);
          if (!raw) return null;
          const obj = JSON.parse(raw);
          if (!obj || !Array.isArray(obj.ids)) return null;
          const ids = obj.ids.map(Number).filter(n => Number.isFinite(n));
          return ids.length ? ids : null;
        } catch {
          return null;
        }
      }

      function saveExamSetIds(deckKey, ids){
        const payload = { ids: ids.slice(), createdAt: Date.now() };
        localStorage.setItem(`${EXAM_SET_KEY_PREFIX}:${deckKey}`, JSON.stringify(payload));
      }

      function createExamSetIds(deckKey, forceNew = false){
        const scopedIdsRaw = Array.isArray(state._recommendScopeIds) ? state._recommendScopeIds : null;
        const scopedSet = (scopedIdsRaw && scopedIdsRaw.length)
          ? new Set(scopedIdsRaw.map(Number).filter(n => Number.isFinite(n)))
          : null;
        const deck = (scopedSet && scopedSet.size)
          ? data.words.filter(w => scopedSet.has(Number(w.id)))
          : getDeckWords(deckKey);
        const baseIds = deck.map(w => w.id);
        const want = Math.min(100, baseIds.length);
        if (scopedSet && scopedSet.size){
          return sampleIdsUnique(baseIds, want);
        }
        const existing = loadExamSetIds(deckKey);
        if (!forceNew && existing && existing.length){
          const set = existing.filter(id => baseIds.includes(id));
          if (set.length) return set.slice(0, want);
        }
        const ids = sampleIdsUnique(baseIds, want);
        saveExamSetIds(deckKey, ids);
        return ids;
      }

      
      const CHOICE_SET_KEY_PREFIX = "wordPractice400.choiceSet.v1";

      function loadChoiceSetIds(deckKey){
        try{
          const raw = localStorage.getItem(`${CHOICE_SET_KEY_PREFIX}:${deckKey}`);
          if (!raw) return null;
          const obj = JSON.parse(raw);
          if (!obj || !Array.isArray(obj.ids)) return null;
          const ids = obj.ids.map(Number).filter(n => Number.isFinite(n));
          return ids.length ? ids : null;
        } catch {
          return null;
        }
      }

      function saveChoiceSetIds(deckKey, ids){
        const payload = { ids: ids.slice(), createdAt: Date.now() };
        localStorage.setItem(`${CHOICE_SET_KEY_PREFIX}:${deckKey}`, JSON.stringify(payload));
      }

      function createChoiceSetIds(deckKey, forceNew = false){
        const scopedIdsRaw = Array.isArray(state._recommendScopeIds) ? state._recommendScopeIds : null;
        const scopedSet = (scopedIdsRaw && scopedIdsRaw.length)
          ? new Set(scopedIdsRaw.map(Number).filter(n => Number.isFinite(n)))
          : null;
        const deck = (scopedSet && scopedSet.size)
          ? data.words.filter(w => scopedSet.has(Number(w.id)))
          : getDeckWords(deckKey);
        const baseIds = deck.map(w => w.id);
        const want = Math.min(100, baseIds.length);
        if (scopedSet && scopedSet.size){
          return sampleIdsUnique(baseIds, want);
        }
        const existing = loadChoiceSetIds(deckKey);
        if (!forceNew && existing && existing.length){
          const set = existing.filter(id => baseIds.includes(id));
          if (set.length) return set.slice(0, want);
        }
        const ids = sampleIdsUnique(baseIds, want);
        saveChoiceSetIds(deckKey, ids);
        return ids;
      }

      function buildOrder(mode){
        const base = getDeckWords(state.deck);

        if (mode === "SEQ") return base.slice();
        if (mode === "RND") return shuffle(base);

        if (mode === "HAND"){
          const key = getSetKey(state.deck);
          const ids = createExamSetIds(key, false);
          const scopedIdsRaw = Array.isArray(state._recommendScopeIds) ? state._recommendScopeIds : null;
          const scopedSet = (scopedIdsRaw && scopedIdsRaw.length)
            ? new Set(scopedIdsRaw.map(Number).filter(n => Number.isFinite(n)))
            : null;
          const globalMap = (data && data.byId instanceof Map) ? data.byId : new Map();
          const activeMap = buildActiveById();
          const out = [];
          for (const id of ids){
            const w = (scopedSet && scopedSet.size)
              ? (globalMap.get(id) || activeMap.get(id))
              : activeMap.get(id);
            if (w) out.push(w);
          }
          return out;
        }

        if (mode === "CHOICE"){
          const key = getSetKey(state.deck);
          const ids = createChoiceSetIds(key, false);
          const scopedIdsRaw = Array.isArray(state._recommendScopeIds) ? state._recommendScopeIds : null;
          const scopedSet = (scopedIdsRaw && scopedIdsRaw.length)
            ? new Set(scopedIdsRaw.map(Number).filter(n => Number.isFinite(n)))
            : null;
          const globalMap = (data && data.byId instanceof Map) ? data.byId : new Map();
          const activeMap = buildActiveById();
          const out = [];
          for (const id of ids){
            const w = (scopedSet && scopedSet.size)
              ? (globalMap.get(id) || activeMap.get(id))
              : activeMap.get(id);
            if (w) out.push(w);
          }
          return out;
        }

        if (mode === "REVIEW_WRONG"){
          return state.wrongOrder.slice();
        }

        return base.slice();
      }
// =========================
      // Prompt/Answer
      // =========================
      function displayPromptAnswer(wordObj){
        if (state.mode === "HAND"){
          return { prompt: wordObj.meaning, answer: wordObj.word };
        }
        const isEnJa = state.settings.direction === "EN_JA";
        return { prompt: isEnJa ? wordObj.word : wordObj.meaning, answer: isEnJa ? wordObj.meaning : wordObj.word };
      }

      
      // =========================
      // Choice exam (4) helpers
      // =========================
      function resetChoiceSession(timeLimitSec){
        state.choice.timeLimitSec = Number(timeLimitSec) || 0;
        state.choice.remainingMs = 0;
        state.choice.timerId = null;
        state.choice.endAt = 0;
        state.choice.locked = false;
        state.choice.options = [];
        state.choice.correctIndex = -1;
        state.choice.lastCorrectIndex = -1;
        state.choice.correctCount = 0;
        state.choice.results = [];
      }

      function clearChoiceTimer(){
        if (state.choice.timerId){
          clearInterval(state.choice.timerId);
          state.choice.timerId = null;
        }
        state.choice.endAt = 0;
        state.choice.remainingMs = 0;
      }

      function setTimerPill(sec){
        if (!el.timerPill) return;
        if (!sec || sec <= 0){
          el.timerPill.classList.add("hidden");
          el.timerPill.textContent = "";
          return;
        }
        el.timerPill.classList.remove("hidden");
        el.timerPill.textContent = ` ${sec} `;
      }

      function startChoiceTimer(){
        clearChoiceTimer();
        const limit = state.choice.timeLimitSec || 0;
        if (!limit || limit <= 0){
          setTimerPill(0);
          return;
        }
        const now = Date.now();
        state.choice.endAt = now + (limit * 1000);
        state.choice.remainingMs = limit * 1000;
        setTimerPill(limit);

        state.choice.timerId = setInterval(() => {
          const ms = Math.max(0, state.choice.endAt - Date.now());
          state.choice.remainingMs = ms;
          const sec = Math.ceil(ms / 1000);
          setTimerPill(sec);

          if (ms <= 0){
            clearChoiceTimer();
            if (!state.choice.locked && state.view === "QUIZ" && state.mode === "CHOICE"){
              handleChoiceTimeout();
            }
          }
        }, 80);
      }

      function pickDummyMeanings(curId, correctMeaning, count){
        const deckPool = getDeckWords(state.deck)
          .filter(w => w.id !== curId && w.meaning && w.meaning !== correctMeaning)
          .map(w => w.meaning);

        // Fallback pool: always allow enough choices even for small custom presets.
        const globalPool = data.words
          .filter(w => w.id !== curId && w.meaning && w.meaning !== correctMeaning)
          .map(w => w.meaning);

        const pool = deckPool.concat(globalPool);

        const dummies = [];
        const seen = new Set([correctMeaning]);

        for (const m of shuffle(pool)){
          if (seen.has(m)) continue;
          seen.add(m);
          dummies.push(m);
          if (dummies.length >= count) break;
        }
        return dummies;
      }


function shuffleWithNoConsecutiveSameCorrect(options, correctMeaning){
        let tries = 0;
        let out = options.slice();
        let correctIndex = -1;
        while (tries < 10){
          out = shuffle(out);
          correctIndex = out.indexOf(correctMeaning);
          if (correctIndex !== state.choice.lastCorrectIndex) break;
          tries++;
        }
        if (correctIndex === state.choice.lastCorrectIndex && out.length > 1){
          // rotate once to avoid consecutive same
          out = out.slice(1).concat(out.slice(0,1));
          correctIndex = out.indexOf(correctMeaning);
        }
        return { out, correctIndex };
      }

      function buildChoiceOptionsForCurrent(){
        const cur = getCurrent();
        if (!cur) return;
        const correctMeaning = cur.meaning; // MUST be exact string

        // Base choices:
        // - If cur has custom MCQ config (user preset), use it (up to 4).
        // - Otherwise, generate from deck meanings (3 dummies).
        let base = null;

        if (cur.mcq && Array.isArray(cur.mcq.choices) && cur.mcq.choices.length){
          const raw = cur.mcq.choices.slice(0,4).map(v => String(v ?? "").trim()).filter(Boolean);
          const seen = new Set();
          const cleaned = [];
          for (const s of raw){
            if (seen.has(s)) continue;
            seen.add(s);
            cleaned.push(s);
          }
          if (cleaned.length){
            // Ensure exact correct meaning is included (strict)
            if (!cleaned.includes(correctMeaning)){
              const idx = Number(cur.mcq.correctIndex);
              if (Number.isInteger(idx) && idx >= 0 && idx < cleaned.length){
                cleaned[idx] = correctMeaning;
              } else if (cleaned.length < 4){
                cleaned.unshift(correctMeaning);
              } else {
                cleaned[0] = correctMeaning;
              }
            }
            base = cleaned;
          }
        }

        if (!base){
          base = [correctMeaning, ...pickDummyMeanings(cur.id, correctMeaning, 3)];
        }

        // Fill to 4 (avoid duplicates)
        const deckPool = getDeckWords(state.deck)
          .filter(w => w.id !== cur.id && w.meaning && w.meaning !== correctMeaning)
          .map(w => w.meaning);

        const globalPool = data.words
          .filter(w => w.id !== cur.id && w.meaning && w.meaning !== correctMeaning)
          .map(w => w.meaning);

        const pool = deckPool.concat(globalPool);

        const uniq = [];
        const seen = new Set();
        for (const s of base){
          const k = String(s ?? "").trim();
          if (!k) continue;
          if (seen.has(k)) continue;
          seen.add(k);
          uniq.push(k);
        }
        base = uniq;

        for (const m of shuffle(pool)){
          if (base.length >= 4) break;
          if (seen.has(m)) continue;
          seen.add(m);
          base.push(m);
        }

        // Safety: ensure correct meaning present
        if (!base.includes(correctMeaning)){
          if (base.length) base[0] = correctMeaning;
          else base = [correctMeaning];
        }

        if (base.length > 4){
          base = base.slice(0,4);
          if (!base.includes(correctMeaning)){
            base[base.length - 1] = correctMeaning;
          }
        }

        if (base.length < 4){
          // Fallback to default generation
          const dummies = pickDummyMeanings(cur.id, correctMeaning, 3);
          base = [correctMeaning, ...dummies];
        }

        const { out, correctIndex } = shuffleWithNoConsecutiveSameCorrect(base, correctMeaning);
        state.choice.options = out;
        state.choice.correctIndex = correctIndex;
        state.choice.locked = false;
      }

function renderChoiceOptions(){
        if (!el.choices) return;
        const options = state.choice.options || [];
        const labels = ["A", "B", "C", "D"];

        el.choices.innerHTML = "";
        for (let i = 0; i < options.length; i++){
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "choice-btn";
          btn.dataset.idx = String(i);
          btn.innerHTML = `<span class="k">${labels[i] || (i+1)}</span> ${escapeHtml(options[i])}`;
          el.choices.appendChild(btn);
        }
      }

      function lockChoiceButtons(){
        const btns = el.choices ? el.choices.querySelectorAll("button.choice-btn") : [];
        btns.forEach(b => b.disabled = true);
      }

      function markChoiceButtons(selectedIndex, correctIndex){
        const btns = el.choices ? el.choices.querySelectorAll("button.choice-btn") : [];
        btns.forEach((b) => {
          const i = Number(b.dataset.idx);
          b.classList.remove("correct","wrong");
          if (i === correctIndex) b.classList.add("correct");
          if (selectedIndex !== null && i === selectedIndex && selectedIndex !== correctIndex) b.classList.add("wrong");
        });
      }

      function pushChoiceResult(cur, selectedIndex, timedOut){
        const correctMeaning = cur.meaning;
        const chosen = (selectedIndex === null) ? "" : (state.choice.options[selectedIndex] || "");
        const correct = (!timedOut) ? (selectedIndex === state.choice.correctIndex) : false;

        state.choice.results.push({
          id: cur.id,
          word: cur.word,
          correctMeaning: correctMeaning,
          chosenMeaning: timedOut ? "(TIMEOUT)" : (chosen || "(NO SELECT)"),
          correct: correct,
          timedOut: !!timedOut
        });

        if (correct) state.choice.correctCount += 1;
        return correct;
      }

      function scheduleChoiceNext(){
        const delay = 720; // 0.60.8 sec
        window.setTimeout(() => {
          if (state.mode !== "CHOICE" || state.view !== "QUIZ") return;

          if (state.index >= state.order.length - 1){
            goResult("CHOICE");
            return;
          }

          state.index += 1;
          state.showAnswer = false;
          state.done = false;

          // Prepare next question (prompt/options)
          buildChoiceOptionsForCurrent();

          // Render next question with a small fade
          animateCardSwap(() => {
            renderAll();
            startChoiceTimer();
          });
        }, delay);
      }

      function renderChoiceHeaderExtras(){
        // show/hide timer pill based on timeLimit and question state
        if (state.mode !== "CHOICE"){
          setTimerPill(0);
          return;
        }
        const limit = state.choice.timeLimitSec || 0;
        if (!limit || limit <= 0){
          setTimerPill(0);
        } else {
          const ms = state.choice.remainingMs || (limit * 1000);
          const sec = Math.ceil(ms / 1000);
          setTimerPill(sec);
        }
      }

      function handleChoiceSelect(selectedIndex){
        const cur = getCurrent();
        if (!cur) return;
        if (state.mode !== "CHOICE") return;
        if (state.choice.locked) return;

        state.choice.locked = true;
        clearChoiceTimer();
        lockChoiceButtons();

        const isCorrect = pushChoiceResult(cur, selectedIndex, false);

        markChoiceButtons(selectedIndex, state.choice.correctIndex);
        showMark(isCorrect);
        playSfx(isCorrect ? "ok" : "ng");

        // show correct meaning briefly
        el.answerWrap.classList.remove("hidden");
        el.answerText.textContent = cur.meaning;

        scheduleChoiceNext();
        renderHeaderOnly();
      }

      function handleChoiceTimeout(){
        const cur = getCurrent();
        if (!cur) return;
        if (state.mode !== "CHOICE") return;
        if (state.choice.locked) return;

        state.choice.locked = true;
        clearChoiceTimer();
        lockChoiceButtons();

        pushChoiceResult(cur, null, true);
        markChoiceButtons(null, state.choice.correctIndex);
        showMark(false);
        playSfx("ng");

        // show correct meaning briefly
        el.answerWrap.classList.remove("hidden");
        el.answerText.textContent = cur.meaning;

        scheduleChoiceNext();
        renderHeaderOnly();
      }

      function openTimeSelect(){
        if (!el.timeOverlay) return;
        el.timeOverlay.classList.remove("hidden");
      }

      function closeTimeSelect(){
        if (!el.timeOverlay) return;
        el.timeOverlay.classList.add("hidden");
      }
// =========================
      // Handwriting helpers
      // =========================
      let canvasCtx = null;
      let drawing = false;

      function ensureCanvasReady(){
        if (!el.handCanvas) return;
        if (!canvasCtx){
          canvasCtx = el.handCanvas.getContext("2d", { alpha: false });
        }
        resizeCanvasToCSS();
        primeCanvasStyle();
      }

      function primeCanvasStyle(){
        if (!canvasCtx) return;
        canvasCtx.lineCap = "round";
        canvasCtx.lineJoin = "round";
        canvasCtx.strokeStyle = "#111214";
        canvasCtx.lineWidth = 3.2;
      }

      function resizeCanvasToCSS(){
        if (!el.handCanvas || !canvasCtx) return;
        const rect = el.handCanvas.getBoundingClientRect();
        const dpr = window.devicePixelRatio || 1;

        const w = Math.max(1, Math.round(rect.width * dpr));
        const h = Math.max(1, Math.round(rect.height * dpr));

        if (el.handCanvas.width !== w || el.handCanvas.height !== h){
          el.handCanvas.width = w;
          el.handCanvas.height = h;
          canvasCtx.setTransform(dpr, 0, 0, dpr, 0, 0);
          clearCanvas();
          primeCanvasStyle();
        }
      }

      function clearCanvas(){
        if (!canvasCtx || !el.handCanvas) return;
        canvasCtx.save();
        canvasCtx.setTransform(1,0,0,1,0,0);
        canvasCtx.fillStyle = "#ffffff";
        canvasCtx.fillRect(0,0, el.handCanvas.width, el.handCanvas.height);
        canvasCtx.restore();
        primeCanvasStyle();
      }

      function canvasPointFromEvent(e){
        const r = el.handCanvas.getBoundingClientRect();
        return { x: e.clientX - r.left, y: e.clientY - r.top };
      }

      function bindCanvasEvents(){
        if (!el.handCanvas) return;

        el.handCanvas.addEventListener("pointerdown", (e) => {
          if (state.mode !== "HAND") return;
          ensureCanvasReady();
          drawing = true;
          el.handCanvas.setPointerCapture(e.pointerId);
          const p = canvasPointFromEvent(e);
          canvasCtx.beginPath();
          canvasCtx.moveTo(p.x, p.y);
        });

        el.handCanvas.addEventListener("pointermove", (e) => {
          if (state.mode !== "HAND") return;
          if (!drawing) return;
          const p = canvasPointFromEvent(e);
          canvasCtx.lineTo(p.x, p.y);
          canvasCtx.stroke();
        });

        const end = () => { drawing = false; };
        el.handCanvas.addEventListener("pointerup", end);
        el.handCanvas.addEventListener("pointercancel", end);
        el.handCanvas.addEventListener("pointerleave", end);

        window.addEventListener("resize", () => {
          if (state.mode === "HAND"){
            ensureCanvasReady();
          }
        });
      }

      function normalizeCompare(s){
        return String(s || "")
          .toLowerCase()
          .trim()
          .replace(/\s+/g, " ");
      }

      function normalizeNoSpace(s){
        return normalizeCompare(s).replace(/\s+/g, "");
      }

      function computeCorrect(expected, given){
        const a = normalizeCompare(expected);
        const b = normalizeCompare(given);
        if (!a || !b) return false;
        if (a === b) return true;
        // allow ignoring spaces (helps recognition for phrases)
        return normalizeNoSpace(a) === normalizeNoSpace(b);
      }

      function resetHandPerQuestion(){
        state.hand.checked = false;
        state.hand.correct = null;
        state.hand.input = "";
        state.hand.busy = false;

        el.spellInput.value = "";
        el.spellInput.disabled = false;

        // judge badge
        el.judgeBadge.classList.add("hidden");
        el.judgeBadge.classList.remove("ok","ng");
        el.judgeBadge.textContent = "";

        // answer area
        el.yourText.textContent = "";

        // marks
        hideMark();

        // buttons
        el.primaryBtn.disabled = false;
        el.primaryBtn.textContent = "";

        ensureCanvasReady();
        clearCanvas();
      }

      function escapeHtml(s){
        return String(s ?? "")
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }

      // =========================
      // OCR (TextDetector) with preprocessing
      // =========================
      function hasTextDetector(){
        return ("TextDetector" in window);
      }

      function cleanOCRText(raw){
        // keep letters and spaces; normalize spaces
        return String(raw || "")
          .replace(/[^A-Za-z\s]/g, " ")
          .replace(/\s+/g, " ")
          .trim();
      }

      function levenshtein(a, b){
        a = normalizeNoSpace(a);
        b = normalizeNoSpace(b);
        const n = a.length;
        const m = b.length;
        if (n === 0) return m;
        if (m === 0) return n;
        const dp = new Array(m + 1);
        for (let j = 0; j <= m; j++) dp[j] = j;

        for (let i = 1; i <= n; i++){
          let prev = dp[0];
          dp[0] = i;
          for (let j = 1; j <= m; j++){
            const tmp = dp[j];
            const cost = a[i - 1] === b[j - 1] ? 0 : 1;
            dp[j] = Math.min(
              dp[j] + 1,
              dp[j - 1] + 1,
              prev + cost
            );
            prev = tmp;
          }
        }
        return dp[m];
      }

      function cropAndScaleForOCR(srcCanvas){
        const w = srcCanvas.width;
        const h = srcCanvas.height;

        const tmp = document.createElement("canvas");
        tmp.width = w;
        tmp.height = h;
        const tctx = tmp.getContext("2d", { alpha: false });
        tctx.drawImage(srcCanvas, 0, 0);

        const img = tctx.getImageData(0, 0, w, h);
        const d = img.data;

        let minX = w, minY = h, maxX = 0, maxY = 0;
        let found = false;

        const step = 2;
        const thr = 235;
        for (let y = 0; y < h; y += step){
          for (let x = 0; x < w; x += step){
            const i = (y * w + x) * 4;
            const r = d[i], g = d[i+1], b = d[i+2];
            const lum = 0.2126*r + 0.7152*g + 0.0722*b;
            if (lum < thr){
              found = true;
              if (x < minX) minX = x;
              if (y < minY) minY = y;
              if (x > maxX) maxX = x;
              if (y > maxY) maxY = y;
            }
          }
        }

        if (!found){
          return srcCanvas;
        }

        const pad = Math.round(Math.min(w, h) * 0.05) + 14;
        const sx = clamp(minX - pad, 0, w - 1);
        const sy = clamp(minY - pad, 0, h - 1);
        const ex = clamp(maxX + pad, 0, w - 1);
        const ey = clamp(maxY + pad, 0, h - 1);
        const sw = Math.max(1, ex - sx);
        const sh = Math.max(1, ey - sy);

        const scale = 2.0;
        const out = document.createElement("canvas");
        out.width = Math.max(1, Math.round(sw * scale));
        out.height = Math.max(1, Math.round(sh * scale));
        const octx = out.getContext("2d", { alpha: false });

        octx.fillStyle = "#ffffff";
        octx.fillRect(0,0,out.width,out.height);
        octx.imageSmoothingEnabled = true;
        octx.drawImage(srcCanvas, sx, sy, sw, sh, 0, 0, out.width, out.height);

        const oimg = octx.getImageData(0,0,out.width,out.height);
        const od = oimg.data;
        let sum = 0;
        const count = out.width * out.height;
        for (let i = 0; i < od.length; i += 4){
          const lum = 0.2126*od[i] + 0.7152*od[i+1] + 0.0722*od[i+2];
          sum += lum;
        }
        const avg = sum / count;
        const th2 = clamp(avg - 18, 175, 238);

        for (let i = 0; i < od.length; i += 4){
          const lum = 0.2126*od[i] + 0.7152*od[i+1] + 0.0722*od[i+2];
          const v = lum < th2 ? 0 : 255;
          od[i] = od[i+1] = od[i+2] = v;
          od[i+3] = 255;
        }
        octx.putImageData(oimg, 0, 0);

        return out;
      }

      async function detectTextFromCanvasProcessed(){
        if (!hasTextDetector()) return null;
        try{
          const detector = new TextDetector();
          const processed = cropAndScaleForOCR(el.handCanvas);
          const results = await detector.detect(processed);
          const raw = results.map(r => r.rawValue).join(" ").trim();
          return raw || null;
        } catch {
          return null;
        }
      }

      function pickBestCandidate(raw, expected){
        const cleaned = cleanOCRText(raw);
        if (!cleaned) return null;

        const candidates = new Set();
        candidates.add(cleaned);

        const tokens = cleaned.split(" ").filter(Boolean);
        if (tokens.length) {
          candidates.add(tokens.join(" "));
          candidates.add(tokens.join(""));
        }
        if (tokens.length >= 1){
          candidates.add(tokens[0]);
          candidates.add(tokens[tokens.length - 1]);
        }

        let best = null;
        let bestDist = Infinity;
        for (const c of candidates){
          const dist = levenshtein(expected, c);
          if (dist < bestDist){
            bestDist = dist;
            best = c;
          }
        }
        return best || cleaned;
      }

      async function readCanvasIntoInput(expected){
        const raw = await detectTextFromCanvasProcessed();
        if (!raw) return null;
        const best = pickBestCandidate(raw, expected);
        if (!best) return null;
        el.spellInput.value = best;
        return best;
      }

      // =========================
      // Marks (maru/batsu)
      // =========================
      function hideMark(){
        el.markLayer.classList.add("hidden");
        el.markLayer.classList.remove("show","ok","ng");
        el.svgOk.classList.add("hidden");
        el.svgNg.classList.add("hidden");
      }

      function showMark(isCorrect){
        el.markLayer.classList.remove("ok","ng");
        el.markLayer.classList.remove("show");
        el.markLayer.classList.remove("hidden");

        el.svgOk.classList.toggle("hidden", !isCorrect);
        el.svgNg.classList.toggle("hidden", isCorrect);

        void el.markLayer.offsetWidth;

        el.markLayer.classList.add(isCorrect ? "ok" : "ng");
        el.markLayer.classList.add("show");

        window.setTimeout(() => {
          el.markLayer.classList.remove("show");
          window.setTimeout(() => {
            el.markLayer.classList.add("hidden");
          }, 220);
        }, 900);
      }

      // =========================
      // Check (hand mode)
      // =========================
      async function checkHand(){
        const cur = getCurrent();
        if (!cur) return;
        if (state.hand.checked) return;
        if (state.hand.busy) return;

        state.hand.busy = true;
        el.primaryBtn.disabled = true;

        // If input empty and detector exists, try OCR automatically
        let given = (el.spellInput.value || "").trim();
        if (!given && hasTextDetector()){
          el.primaryBtn.textContent = "";
          await readCanvasIntoInput(cur.word);
          given = (el.spellInput.value || "").trim();
        }

        const expected = cur.word;
        const correct = computeCorrect(expected, given);

        // sound (SFX only, never loop)
        playSfx(correct ? "ok" : "ng");

        state.hand.checked = true;
        state.hand.correct = correct;
        state.hand.input = given;

        state.hand.results.push({
          id: cur.id,
          expected: cur.word,
          given: given,
          correct: correct,
          promptMeaning: cur.meaning
        });

        if (correct) state.hand.scoreCorrect += 1;

        // UI
        el.spellInput.disabled = true;

        el.judgeBadge.classList.remove("hidden");
        el.judgeBadge.classList.toggle("ok", correct);
        el.judgeBadge.classList.toggle("ng", !correct);
        el.judgeBadge.textContent = correct ? "Correct" : "Wrong";

        showMark(correct);

        el.answerWrap.classList.remove("hidden");
        el.answerText.textContent = cur.word;
        el.yourText.textContent = given ? `${given}` : "";

        el.primaryBtn.textContent = "";
        el.primaryBtn.disabled = true;

        state.hand.busy = false;

        renderHeaderOnly();
      }

      // =========================
      // Render
      // =========================
      
      function renderTitleHeader(){
        const d = state.deck;
        el.deckABtn.classList.toggle("active", d === "A");
        el.deckABtn.setAttribute("aria-selected", String(d === "A"));
        el.deckBBtn.classList.toggle("active", d === "B");
        el.deckBBtn.setAttribute("aria-selected", String(d === "B"));
        el.deckAllBtn.classList.toggle("active", d === "ALL");
        el.deckAllBtn.setAttribute("aria-selected", String(d === "ALL"));

        const sizeA = deckSize("A");
        const sizeB = deckSize("B");
        const sizeAll = deckSize("ALL");
        el.deckStatus.textContent = `0200: ${sizeA} / 200   |   200400: ${sizeB} / 200   |   ALL: ${sizeAll} / 400`;

        const curSize = deckSize(state.deck);
        el.practiceHint.textContent = `${deckLabel(state.deck)}${curSize}`;

        el.badgeSeq.textContent = `${curSize}`;
        el.badgeRnd.textContent = `${curSize}`;
        el.badgeChoice.textContent = `${Math.min(100, curSize)}`;
        el.badgeHand.textContent = `${Math.min(100, curSize)}`;

        const can = curSize > 0;
        el.startSeqBtn.disabled = !can;
        el.startRndBtn.disabled = !can;
        el.startChoiceBtn.disabled = !can;
        el.startHandBtn.disabled = !can;
      
        syncPresetUI();
      }

      function renderHeaderOnly(){
        const total = state.order.length || 0;
        const qIndex = clamp(state.index + 1, 0, total);

        if (state.mode === "HAND"){
          const corr = state.hand.scoreCorrect;
          el.progressText.innerHTML = `<strong>${qIndex}</strong> / ${total} ${corr}`;
        } else if (state.mode === "CHOICE"){
          const corr = state.choice.correctCount;
          el.progressText.innerHTML = `<strong>${qIndex}</strong> / ${total} ${corr}`;
        } else {
          el.progressText.innerHTML = `<strong>${qIndex}</strong> / ${total}`;
        }

        el.modePill.textContent = `${deckLabel(state.deck)}  ${modeLabel()}`;
        el.dirLabel.textContent = dirLabel();

        if (state.mode !== "CHOICE") setTimerPill(0);
      }
function renderQuestion(){
        const cur = getCurrent();
        if (!cur){
          el.noText.textContent = "No.";
          el.promptText.textContent = "";
          el.answerText.textContent = "";
          el.answerWrap.classList.add("hidden");
          el.spellWrap.classList.add("hidden");
          el.handWrap.classList.add("hidden");
          el.choiceWrap.classList.add("hidden");
          hideMark();
          setTimerPill(0);
          return;
        }

        renderHeaderOnly();
        el.noText.textContent = `No.${cur.id}`;

        const isHand = (state.mode === "HAND");
        const isChoice = (state.mode === "CHOICE");

        // prompt
        if (isChoice){
          el.promptText.textContent = cur.word;
        } else {
          const { prompt, answer } = displayPromptAnswer(cur);
          el.promptText.textContent = prompt;
          el.answerText.textContent = answer;
        }

        // Prev only for SEQ/REVIEW_WRONG
        const allowPrev = (state.mode === "SEQ" || state.mode === "REVIEW_WRONG");
        el.prevBtn.classList.toggle("hidden", !allowPrev);
        el.prevBtn.disabled = !allowPrev || state.index === 0;

        // next button visibility
        el.nextBtn.classList.toggle("hidden", isChoice);
        el.nextBtn.disabled = false;

        // new set button: hand only
        el.newSetBtn.classList.toggle("hidden", !(state.mode === "HAND"));

        // primary button: hidden for choice
        el.primaryBtn.classList.toggle("hidden", isChoice);

        // Hand UI
        el.spellWrap.classList.toggle("hidden", !isHand);
        el.handWrap.classList.toggle("hidden", !isHand);

        // Choice UI
        el.choiceWrap.classList.toggle("hidden", !isChoice);

        if (isChoice){
          // setup options/timer per question if not ready
          if (!state.choice.options || state.choice.options.length !== 4){
            buildChoiceOptionsForCurrent();
          }
          renderChoiceOptions();
          renderChoiceHeaderExtras();

          // answer hidden until resolved
          el.answerWrap.classList.add("hidden");
          el.answerText.textContent = "";
          el.yourText.textContent = "";
          el.judgeBadge.classList.add("hidden");
          el.judgeBadge.classList.remove("ok","ng");
          el.judgeBadge.textContent = "";
          hideMark();

          // controls
          el.restartBtn.classList.remove("hidden");
        } else if (isHand){
          el.handMini.textContent = hasTextDetector() ? "" : "";
          el.readCanvasBtn.classList.toggle("hidden", !hasTextDetector());

          el.primaryBtn.textContent = state.hand.checked ? "" : (state.hand.busy ? "" : "");
          el.primaryBtn.disabled = state.hand.checked || state.hand.busy;

          if (!state.hand.checked){
            el.answerWrap.classList.add("hidden");
            hideMark();
          } else {
            el.answerWrap.classList.remove("hidden");
          }

          if (!state.hand.checked){
            el.judgeBadge.classList.add("hidden");
            el.judgeBadge.classList.remove("ok","ng");
            el.judgeBadge.textContent = "";
          }

          // timer off
          setTimerPill(0);

        } else {
          // Study modes
          setTimerPill(0);
          el.readCanvasBtn.classList.add("hidden");
          hideMark();

          el.primaryBtn.disabled = false;
          if (state.showAnswer){
            el.answerWrap.classList.remove("hidden");
            el.primaryBtn.textContent = "";
          } else {
            el.answerWrap.classList.add("hidden");
            el.primaryBtn.textContent = "";
          }

          el.judgeBadge.classList.add("hidden");
          el.judgeBadge.classList.remove("ok","ng");
          el.judgeBadge.textContent = "";
        }

        // next button text (non-choice)
        if (!isChoice){
          if (state.mode === "HAND"){
            el.nextBtn.textContent = (state.index >= state.order.length - 1) ? "" : "";
          } else if (state.done){
            el.nextBtn.textContent = "";
          } else {
            el.nextBtn.textContent = (state.index >= state.order.length - 1) ? "" : "";
          }
        }
      }

      function renderResult(){
        const kind = state.resultKind || state.mode || "HAND";

        let total = 0;
        let correct = 0;
        let wrongItems = [];

        if (kind === "CHOICE"){
          total = state.choice.results.length;
          correct = state.choice.correctCount;
          wrongItems = state.choice.results.filter(r => !r.correct);
          const pct = total ? Math.round((correct / total) * 1000) / 10 : 0;

          el.resultSub.textContent = `${deckLabel(state.deck)}  ${total}`;
          el.scoreBig.textContent = `${correct} / ${total}`;
          el.scoreSub.textContent = ` ${pct}%`;

          el.wrongSummary.textContent = `${wrongItems.length}`;
          el.wrongList.innerHTML = "";

          if (wrongItems.length === 0){
            el.wrongList.innerHTML = `<li class="wrong-item"><div class="mid"></div></li>`;
            el.wrongDetails.open = false;
          } else {
            for (const r of wrongItems){
              const li = document.createElement("li");
              li.className = "wrong-item";
              li.innerHTML = `
                <div class="top"><span>No.${r.id}</span><span>4</span></div>
                <div class="mid">
                  <div style="margin-bottom:6px;"><strong>${escapeHtml(r.word)}</strong></div>
                  <div><code>${escapeHtml((r.chosenMeaning || "").trim() || "")}</code></div>
                  <div><code>${escapeHtml(r.correctMeaning)}</code></div>
                </div>
              `;
              el.wrongList.appendChild(li);
            }
            el.wrongDetails.open = true;
          }

        } else {
          total = state.hand.results.length;
          correct = state.hand.scoreCorrect;
          wrongItems = state.hand.results.filter(r => !r.correct);
          const pct = total ? Math.round((correct / total) * 1000) / 10 : 0;

          el.resultSub.textContent = `${deckLabel(state.deck)}  ${total}`;
          el.scoreBig.textContent = `${correct} / ${total}`;
          el.scoreSub.textContent = ` ${pct}%`;

          el.wrongSummary.textContent = `${wrongItems.length}`;
          el.wrongList.innerHTML = "";

          if (wrongItems.length === 0){
            el.wrongList.innerHTML = `<li class="wrong-item"><div class="mid"></div></li>`;
            el.wrongDetails.open = false;
          } else {
            for (const r of wrongItems){
              const li = document.createElement("li");
              li.className = "wrong-item";
              li.innerHTML = `
                <div class="top"><span>No.${r.id}</span><span></span></div>
                <div class="mid">
                  <div style="margin-bottom:6px; color: var(--muted);">${escapeHtml(r.promptMeaning)}</div>
                  <div><code>${escapeHtml((r.given || "").trim() || "")}</code></div>
                  <div><code>${escapeHtml(r.expected)}</code></div>
                </div>
              `;
              el.wrongList.appendChild(li);
            }
            el.wrongDetails.open = true;
          }
        }

        // Review button visibility (hide if no wrong)
        if (wrongItems.length === 0){
          el.resultReviewBtn.disabled = true;
          el.resultReviewBtn.style.opacity = "0.55";
        } else {
          el.resultReviewBtn.disabled = false;
          el.resultReviewBtn.style.opacity = "";
        }
      }
function renderAll(){
        updateDataStatus();
        updateDebugBar();

        const isEnJa = state.settings.direction === "EN_JA";
        el.dirEnJaBtn.classList.toggle("active", isEnJa);
        el.dirEnJaBtn.setAttribute("aria-selected", String(isEnJa));
        el.dirJaEnBtn.classList.toggle("active", !isEnJa);
        el.dirJaEnBtn.setAttribute("aria-selected", String(!isEnJa));

        el.animToggle.checked = state.settings.animations;
        el.sfxToggle.checked = state.settings.sfx;
        el.bgmToggle.checked = state.settings.bgm;
        // BGM volume buttons
        const bv = state.settings.bgmVolume || "DEFAULT";
        el.bgmVolLargeBtn.classList.toggle("active", bv === "LARGE");
        el.bgmVolLargeBtn.setAttribute("aria-selected", String(bv === "LARGE"));
        el.bgmVolDefaultBtn.classList.toggle("active", bv === "DEFAULT");
        el.bgmVolDefaultBtn.setAttribute("aria-selected", String(bv === "DEFAULT"));
        el.bgmVolSmallBtn.classList.toggle("active", bv === "SMALL");
        el.bgmVolSmallBtn.setAttribute("aria-selected", String(bv === "SMALL"));

        el.debugToggle.checked = state.settings.debug;
        if (el.settingsOverlay && !el.settingsOverlay.classList.contains("hidden")){
          _adminRenderUI();
        }

        if (state.view === "TITLE"){
          renderTitleHeader();
        } else if (state.view === "QUIZ"){
          renderQuestion();
        } else if (state.view === "RESULT"){
          renderResult();
        }
      }

      // =========================
      // Navigation
      // =========================
      
      function startMode(mode, jumpId){
        state.mode = mode;
        state.index = 0;
        state.showAnswer = false;
        state.done = false;

        clearChoiceTimer();

        if (mode === "HAND"){
          state.hand.checked = false;
          state.hand.correct = null;
          state.hand.input = "";
          state.hand.busy = false;
          state.hand.results = [];
          state.hand.scoreCorrect = 0;
        }

        state.order = buildOrder(mode);

        // optional: jump to a specific word id (used by Search)
        if (mode === "SEQ" && jumpId != null){
          const jid = Number(jumpId);
          const idx = state.order.findIndex(w => w && Number(w.id) === jid);
          if (idx >= 0) state.index = idx;
        }

        setView("QUIZ");
        if (mode === "HAND") resetHandPerQuestion();

        syncBgmToView();
        animateCardSwap(renderAll);
      }

      function startChoiceMode(timeLimitSec){
        closeTimeSelect();

        state.mode = "CHOICE";
        state.index = 0;
        state.showAnswer = false;
        state.done = false;

        resetChoiceSession(timeLimitSec);

        // Always create a fresh random set for each start
        createChoiceSetIds(getSetKey(state.deck), true);

        state.order = buildOrder("CHOICE");

        // prepare first question
        buildChoiceOptionsForCurrent();
        renderChoiceOptions();

        setView("QUIZ");
        syncBgmToView();
        startChoiceTimer();

        animateCardSwap(renderAll);
      }
function goTitle(){
        stopBgm(true);
        clearChoiceTimer();
        closeTimeSelect();
        _clearRecommendScope();
        state.mode = null;
        state.order = [];
        state.index = 0;
        state.showAnswer = false;
        state.done = false;
        setView("TITLE");
        renderAll();
      }

      function goResult(kind){
        clearChoiceTimer();
        state.resultKind = kind || state.mode || null;
        setView("RESULT");
        renderAll();
      }

function next(){
        if (state.view !== "QUIZ") return;

        if (state.mode === "HAND"){
          // IMPORTANT: NO auto-judge here.
          if (!state.hand.checked) return;

          if (state.index >= state.order.length - 1){
            goResult("HAND");
            return;
          }

          state.index += 1;
          resetHandPerQuestion();
          animateCardSwap(renderAll);
          return;
        }

        if (state.done){
          goTitle();
          return;
        }

        if (state.index >= state.order.length - 1){
          state.done = true;
          state.showAnswer = true;
          animateCardSwap(renderAll);
          return;
        }

        state.index += 1;
        state.showAnswer = false;
        animateCardSwap(renderAll);
      }

      function prev(){
        if (state.view !== "QUIZ") return;

        const allowPrev = (state.mode === "SEQ" || state.mode === "REVIEW_WRONG");
        if (!allowPrev) return;
        if (state.index <= 0) return;

        state.index -= 1;
        state.showAnswer = false;

        animateCardSwap(renderAll);
      }

      function primaryAction(){
        if (state.view !== "QUIZ") return;

        if (state.mode === "HAND"){
          checkHand();
          return;
        }

        state.showAnswer = !state.showAnswer;
        animateCardSwap(renderAll);
      }

      
      function restart(){
        if (state.view !== "QUIZ") return;

        clearChoiceTimer();

        state.index = 0;
        state.done = false;
        state.showAnswer = false;

        if (state.mode === "RND"){
          state.order = buildOrder("RND");

        } else if (state.mode === "HAND"){
          state.hand.checked = false;
          state.hand.correct = null;
          state.hand.input = "";
          state.hand.busy = false;
          state.hand.results = [];
          state.hand.scoreCorrect = 0;
          state.order = buildOrder("HAND");
          resetHandPerQuestion();

        } else if (state.mode === "CHOICE"){
          // keep chosen timeLimitSec; reset score/results
          const t = state.choice.timeLimitSec || 0;
          resetChoiceSession(t);
          state.order = buildOrder("CHOICE");
          buildChoiceOptionsForCurrent();
          renderChoiceOptions();
          startChoiceTimer();

        } else if (state.mode === "SEQ"){
          state.order = buildOrder("SEQ");

        } else if (state.mode === "REVIEW_WRONG"){
          state.order = buildOrder("REVIEW_WRONG");
        }

        animateCardSwap(renderAll);
      }

      function newHandSet(){
        createExamSetIds(getSetKey(state.deck), true);
        if (state.mode !== "HAND"){
          startMode("HAND");
          return;
        }
        restart();
      }

      function newChoiceSet(){
        createChoiceSetIds(getSetKey(state.deck), true);
        if (state.mode !== "CHOICE"){
          // keep current chosen time if exists; otherwise ask
          const t = state.choice.timeLimitSec || 0;
          startChoiceMode(t);
          return;
        }
        restart();
      }
function setDeck(deckKey){
        _clearRecommendScope();
        state.deck = deckKey;
        saveDeck(deckKey);
        state.presetId = `builtin:${deckKey}`;
        saveActivePresetId(state.presetId);
        renderAll();
      }

      // =========================
      // Settings overlay
      // =========================
      function openSettings(){
        if (!el.settingsOverlay){
          uiToast("Settings UI");
          return;
        }
        el.settingsOverlay.classList.remove("hidden");
        _adminEnsureAuthWatcher();
        _adminRenderUI();
      }
      function closeSettings(){
        if (!el.settingsOverlay){
          uiToast("Settings UI");
          return;
        }
        _adminShowEditor(false);
        el.settingsOverlay.classList.add("hidden");
      }

      function openUpdateNotes(){ if (el.updateOverlay) el.updateOverlay.classList.remove("hidden"); }
      function closeUpdateNotes(){
        try{
          if (el.updateDontShowChk && el.updateDontShowChk.checked){
            localStorage.setItem(UPDATE_NOTES_DISMISS_KEY, "1");
          }
        }catch{}
        if (el.updateOverlay) el.updateOverlay.classList.add("hidden");
      }
      function maybeShowUpdateNotes(){
        try{
          if (localStorage.getItem(UPDATE_NOTES_DISMISS_KEY) === "1") return;
        }catch{}
        openUpdateNotes();
      }

      function setDirection(dir){
        state.settings.direction = (dir === "JA_EN") ? "JA_EN" : "EN_JA";
        saveSettings(state.settings);
        renderAll();
      }
      function setAnimations(on){
        state.settings.animations = !!on;
        saveSettings(state.settings);
        renderAll();
      }
      function setSfx(on){
        state.settings.sfx = !!on;
        saveSettings(state.settings);
        renderAll();
      }
      function setBgm(on){
        state.settings.bgm = !!on;
        saveSettings(state.settings);
        if (!on) stopBgm(false);
        else applyBgmVolume();
        syncBgmToView(); // start/stop immediately
        renderAll();
      }

      function setBgmVolume(level){
        const v = (level === "LARGE" || level === "SMALL" || level === "DEFAULT") ? level : "DEFAULT";
        state.settings.bgmVolume = v;
        saveSettings(state.settings);
        applyBgmVolume();
        renderAll();
      }

      function setDebug(on){
        state.settings.debug = !!on;
        saveSettings(state.settings);
        renderAll();
      }

      // =========================
      // Result actions
      // =========================
      
      function buildWrongOrderFromResults(){
        const kind = state.resultKind || state.mode || "HAND";
        const wrongIds = (kind === "CHOICE")
          ? state.choice.results.filter(r => !r.correct).map(r => r.id)
          : state.hand.results.filter(r => !r.correct).map(r => r.id);

        const ids = uniq(wrongIds);
        const out = [];
        const byId = buildActiveById();
        for (const id of ids){
          const w = byId.get(id);
          if (w) out.push(w);
        }
        out.sort((a,b)=>a.id-b.id);
        return out;
      }
function reviewWrong(){
        const wrong = buildWrongOrderFromResults();
        state.wrongOrder = wrong;
        if (!wrong.length){
          goTitle();
          return;
        }
        state.mode = "REVIEW_WRONG";
        state.order = wrong;
        state.index = 0;
        state.showAnswer = false;
        state.done = false;
        setView("QUIZ");
        animateCardSwap(renderAll);
      }


      // =========================
      // Notifications (local)
      // =========================
      const NOTIF_KEY = "app.notifications.v1";
      const NOTIF_SEEN_KEY = "app.notifications.seenAt.v1";
      const ADMIN_EMAIL = "Matsushiri20pc@gmail.com";
      const NOTIF_MAX = 200;
      const _adminState = {
        authWatchStarted: false,
        auth: null,
        db: null,
        user: null,
        isAdmin: false,
        editorOpen: false,
        notifItems: [],
        loading: false
      };

      function _fmt2(n){ return String(n).padStart(2,"0"); }
      function formatDateTime(ts){
        try{
          const d = new Date(ts);
          const y = d.getFullYear();
          const m = _fmt2(d.getMonth()+1);
          const da = _fmt2(d.getDate());
          const hh = _fmt2(d.getHours());
          const mm = _fmt2(d.getMinutes());
          return `${y}-${m}-${da} ${hh}:${mm}`;
        } catch {
          return "";
        }
      }
      function _toLocalDateTimeInput(ms){
        const n = Number(ms) || 0;
        if (!n) return "";
        const d = new Date(n);
        const pad = (x) => String(x).padStart(2, "0");
        return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
      }
      function _parseLocalDateTimeInput(v){
        const s = String(v || "").trim();
        if (!s) return 0;
        const ms = new Date(s).getTime();
        return Number.isFinite(ms) ? ms : 0;
      }
      function _notifTsToMs(v){
        if (!v) return 0;
        if (typeof v.toMillis === "function") return Number(v.toMillis()) || 0;
        if (typeof v.seconds === "number"){
          return (Number(v.seconds) * 1000) + Math.floor(Number(v.nanoseconds || 0) / 1e6);
        }
        const n = Number(v);
        return Number.isFinite(n) ? n : 0;
      }
      function _notifNormalizeCategory(v){
        const s = String(v || "Update");
        if (s === "Study" || s === "Preset" || s === "System") return s;
        return "Update";
      }
      function _notifNormalizePriority(v){
        const s = String(v || "normal");
        if (s === "low" || s === "high") return s;
        return "normal";
      }
      function _notifNormalizeItem(raw){
        const id = String(raw?.id || "").trim();
        if (!id) return null;
        const title = String(raw?.title || "").trim();
        const body = String(raw?.body || "");
        const publishedAtMs = _notifTsToMs(raw?.publishedAtMs || raw?.publishedAt);
        const createdAtMs = _notifTsToMs(raw?.createdAtMs || raw?.createdAt);
        const updatedAtMs = _notifTsToMs(raw?.updatedAtMs || raw?.updatedAt);
        const ts = _notifTsToMs(raw?.ts) || publishedAtMs || createdAtMs || updatedAtMs || 0;
        return {
          id,
          title,
          body,
          category: _notifNormalizeCategory(raw?.category),
          priority: _notifNormalizePriority(raw?.priority),
          publishedAtMs,
          createdAtMs,
          updatedAtMs,
          ts
        };
      }
      function _notifFromDoc(doc){
        const raw = (doc && typeof doc.data === "function") ? (doc.data() || {}) : {};
        return _notifNormalizeItem({
          id: doc?.id || "",
          title: raw.title,
          body: raw.body,
          category: raw.category,
          priority: raw.priority,
          publishedAt: raw.publishedAt,
          createdAt: raw.createdAt,
          updatedAt: raw.updatedAt
        });
      }
      function _notifSeenAt(){
        try{
          const n = Number(localStorage.getItem(NOTIF_SEEN_KEY) || 0);
          return Number.isFinite(n) ? n : 0;
        }catch{
          return 0;
        }
      }
      function _notifSetSeenAt(ts){
        const n = Number(ts) || 0;
        if (!n) return;
        try{ localStorage.setItem(NOTIF_SEEN_KEY, String(n)); }catch{}
      }
      function _notifMarkSeenByList(list){
        const maxTs = (Array.isArray(list) ? list : []).reduce((mx, n) => Math.max(mx, Number(n?.ts) || 0), 0);
        if (maxTs > 0) _notifSetSeenAt(maxTs);
      }

      function loadNotifications(){
        try{
          const raw = localStorage.getItem(NOTIF_KEY);
          if (!raw) return [];
          const arr = JSON.parse(raw);
          if (!Array.isArray(arr)) return [];
          return arr
            .map(_notifNormalizeItem)
            .filter(Boolean)
            .sort((a,b) => (b.ts || 0) - (a.ts || 0))
            .slice(0, NOTIF_MAX);
        }catch{
          return [];
        }
      }
      function saveNotifications(list){
        try{
          const arr = (Array.isArray(list) ? list : [])
            .map(_notifNormalizeItem)
            .filter(Boolean)
            .slice(0, NOTIF_MAX)
            .map(n => ({
              id: n.id,
              title: n.title,
              body: n.body,
              category: n.category,
              priority: n.priority,
              publishedAtMs: n.publishedAtMs || 0,
              createdAtMs: n.createdAtMs || 0,
              updatedAtMs: n.updatedAtMs || 0,
              ts: n.ts || 0
            }));
          localStorage.setItem(NOTIF_KEY, JSON.stringify(arr));
        }catch{}
      }
      function ensureDemoNotification(){
        return loadNotifications();
      }

      function _adminSetStatus(msg, kind){
        const elx = document.getElementById("adminAuthStatus");
        if (!elx){
          if (msg) uiToast(String(msg));
          return;
        }
        elx.textContent = String(msg || "");
        elx.classList.remove("ok", "error");
        if (kind === "ok") elx.classList.add("ok");
        if (kind === "error") elx.classList.add("error");
      }
      function _adminSetNotifStatus(msg, kind){
        const elx = document.getElementById("adminNotifStatus");
        if (!elx){
          if (msg) uiToast(String(msg));
          return;
        }
        elx.textContent = String(msg || "");
        elx.classList.remove("ok", "error");
        if (kind === "ok") elx.classList.add("ok");
        if (kind === "error") elx.classList.add("error");
      }
      function _adminUserIsAdmin(user){
        const email = String(user?.email || "").trim().toLowerCase();
        return !!email && email === String(ADMIN_EMAIL).trim().toLowerCase();
      }
      function _adminGetDb(){
        if (_adminState.db) return _adminState.db;
        _adminState.db = _drawerShareGetDb();
        return _adminState.db;
      }
      function _adminGetAuth(){
        if (_adminState.auth) return _adminState.auth;
        if (!window.firebase || typeof window.firebase.auth !== "function"){
          throw new Error("Firebase Auth SDK ");
        }
        _adminGetDb(); // app
        _adminState.auth = window.firebase.auth();
        return _adminState.auth;
      }
      function _adminCheckAuthEnvironment(){
        const proto = String(location.protocol || "");
        if (!/^https?:$/.test(proto) && proto !== "chrome-extension:"){
          return {
            ok: false,
            reason: `Googleprotocol=${proto || "unknown"}https`
          };
        }
        try{
          const k = "__admin_auth_probe__";
          localStorage.setItem(k, "1");
          localStorage.removeItem(k);
        }catch{
          return {
            ok: false,
            reason: "Web StorageCookie/"
          };
        }
        return { ok: true, reason: "" };
      }
      async function _adminHandleRedirectResult(){
        let auth;
        try{
          auth = _adminGetAuth();
        }catch{
          return;
        }
        if (!auth || typeof auth.getRedirectResult !== "function") return;
        try{
          const result = await auth.getRedirectResult();
          if (result && result.user){
            _adminSetStatus("Google", "ok");
          }
        }catch(err){
          const code = String(err?.code || "AUTH_ERROR");
          const msg = String(err?.message || "");
          _adminSetStatus(`: ${code} / ${msg}`, "error");
        }
      }
      function _adminRenderUI(){
        const stateLine = document.getElementById("adminAuthStateLine");
        const roleLine = document.getElementById("adminAuthRoleLine");
        const loginBtn = document.getElementById("adminLoginBtn");
        const logoutBtn = document.getElementById("adminLogoutBtn");
        const openEditorBtn = document.getElementById("adminOpenNotifEditorBtn");
        const mainPane = document.getElementById("settingsMainPane");
        const editorPane = document.getElementById("adminNotifEditor");
        const email = String(_adminState.user?.email || "").trim();
        if (stateLine){
          stateLine.textContent = email ? `: ${email}` : "";
        }
        if (roleLine){
          roleLine.textContent = _adminState.isAdmin ? ": Admin" : ": User";
        }
        if (loginBtn) loginBtn.disabled = !!email;
        if (logoutBtn) logoutBtn.disabled = !email;
        if (openEditorBtn) openEditorBtn.classList.toggle("hidden", !_adminState.isAdmin);
        if (!_adminState.isAdmin && _adminState.editorOpen){
          _adminState.editorOpen = false;
        }
        if (mainPane && editorPane){
          mainPane.classList.toggle("hidden", !!_adminState.editorOpen);
          editorPane.classList.toggle("hidden", !_adminState.editorOpen);
        }
      }
      function _adminEnsureAuthWatcher(){
        if (_adminState.authWatchStarted) return;
        try{
          const auth = _adminGetAuth();
          _adminState.authWatchStarted = true;
          _adminHandleRedirectResult();
          auth.onAuthStateChanged((user) => {
            _adminState.user = user || null;
            _adminState.isAdmin = _adminUserIsAdmin(user);
            _adminRenderUI();
          });
        }catch(err){
          _adminSetStatus(`Admin: ${String(err?.message || err)}`, "error");
        }
      }
      function _adminShowEditor(open){
        const mainPane = document.getElementById("settingsMainPane");
        const editorPane = document.getElementById("adminNotifEditor");
        if (!mainPane || !editorPane){
          _adminSetStatus("UI", "error");
          return false;
        }
        if (open && !_adminState.isAdmin){
          _adminSetStatus("Admin", "error");
          return false;
        }
        _adminState.editorOpen = !!open;
        _adminRenderUI();
        return true;
      }
      function _adminClearNotifForm(){
        const idEl = document.getElementById("adminNotifDocId");
        const titleEl = document.getElementById("adminNotifTitle");
        const bodyEl = document.getElementById("adminNotifBody");
        const categoryEl = document.getElementById("adminNotifCategory");
        const priorityEl = document.getElementById("adminNotifPriority");
        const publishedEl = document.getElementById("adminNotifPublishedAt");
        const saveBtn = document.getElementById("adminNotifSaveBtn");
        const cancelBtn = document.getElementById("adminNotifCancelEditBtn");
        if (idEl) idEl.value = "";
        if (titleEl) titleEl.value = "";
        if (bodyEl) bodyEl.value = "";
        if (categoryEl) categoryEl.value = "Update";
        if (priorityEl) priorityEl.value = "normal";
        if (publishedEl) publishedEl.value = "";
        if (saveBtn) saveBtn.textContent = "";
        if (cancelBtn) cancelBtn.classList.add("hidden");
      }
      function _adminFillNotifForm(item){
        const n = _notifNormalizeItem(item);
        if (!n) return;
        const idEl = document.getElementById("adminNotifDocId");
        const titleEl = document.getElementById("adminNotifTitle");
        const bodyEl = document.getElementById("adminNotifBody");
        const categoryEl = document.getElementById("adminNotifCategory");
        const priorityEl = document.getElementById("adminNotifPriority");
        const publishedEl = document.getElementById("adminNotifPublishedAt");
        const saveBtn = document.getElementById("adminNotifSaveBtn");
        const cancelBtn = document.getElementById("adminNotifCancelEditBtn");
        if (idEl) idEl.value = n.id;
        if (titleEl) titleEl.value = n.title;
        if (bodyEl) bodyEl.value = n.body;
        if (categoryEl) categoryEl.value = n.category;
        if (priorityEl) priorityEl.value = n.priority;
        if (publishedEl) publishedEl.value = _toLocalDateTimeInput(n.publishedAtMs || n.ts || Date.now());
        if (saveBtn) saveBtn.textContent = "";
        if (cancelBtn) cancelBtn.classList.remove("hidden");
      }
      function _adminReadNotifForm(){
        const idEl = document.getElementById("adminNotifDocId");
        const titleEl = document.getElementById("adminNotifTitle");
        const bodyEl = document.getElementById("adminNotifBody");
        const categoryEl = document.getElementById("adminNotifCategory");
        const priorityEl = document.getElementById("adminNotifPriority");
        const publishedEl = document.getElementById("adminNotifPublishedAt");
        if (!idEl || !titleEl || !bodyEl || !categoryEl || !priorityEl || !publishedEl){
          throw new Error("UI");
        }
        const title = String(titleEl.value || "").trim();
        const body = String(bodyEl.value || "").trim();
        if (!title) throw new Error("title ");
        if (!body) throw new Error("body ");
        const publishedAtMs = _parseLocalDateTimeInput(publishedEl.value) || Date.now();
        return {
          id: String(idEl.value || "").trim(),
          title,
          body,
          category: _notifNormalizeCategory(categoryEl.value),
          priority: _notifNormalizePriority(priorityEl.value),
          publishedAtMs
        };
      }
      function _adminRenderNotifList(){
        const listEl = document.getElementById("adminNotifList");
        const emptyEl = document.getElementById("adminNotifEmpty");
        if (!listEl || !emptyEl){
          _adminSetNotifStatus("UI", "error");
          return;
        }
        const list = Array.isArray(_adminState.notifItems) ? _adminState.notifItems.slice() : [];
        listEl.innerHTML = "";
        if (!list.length){
          emptyEl.classList.remove("hidden");
          return;
        }
        emptyEl.classList.add("hidden");
        const frag = document.createDocumentFragment();
        for (const n of list){
          const item = document.createElement("article");
          item.className = "admin-notif-item";
          const title = document.createElement("div");
          title.className = "admin-notif-title";
          title.textContent = n.title || "(untitled)";
          const meta = document.createElement("div");
          meta.className = "admin-notif-meta";
          const publishedText = n.ts ? formatDateTime(n.ts) : "";
          meta.innerHTML = `<span>${escapeHtml(n.category || "Update")}</span><span>${escapeHtml(n.priority || "normal")}</span><span>${escapeHtml(publishedText)}</span>`;
          const body = document.createElement("div");
          body.className = "admin-notif-body";
          body.textContent = String(n.body || "");
          const actions = document.createElement("div");
          actions.className = "admin-notif-item-actions";
          const editBtn = document.createElement("button");
          editBtn.type = "button";
          editBtn.className = "textbtn";
          editBtn.textContent = "";
          editBtn.dataset.adminNotifAction = "edit";
          editBtn.dataset.id = n.id;
          const delBtn = document.createElement("button");
          delBtn.type = "button";
          delBtn.className = "textbtn";
          delBtn.textContent = "";
          delBtn.dataset.adminNotifAction = "delete";
          delBtn.dataset.id = n.id;
          actions.appendChild(editBtn);
          actions.appendChild(delBtn);
          item.appendChild(title);
          item.appendChild(meta);
          item.appendChild(body);
          item.appendChild(actions);
          frag.appendChild(item);
        }
        listEl.appendChild(frag);
      }
      async function _fetchNotificationsFromFirestore(){
        const db = _adminGetDb();
        const map = new Map();
        let successCount = 0;
        const tryQuery = async (field) => {
          try{
            const snap = await db.collection("notifications").orderBy(field, "desc").limit(NOTIF_MAX).get();
            successCount++;
            snap.forEach((doc) => {
              const item = _notifFromDoc(doc);
              if (!item) return;
              map.set(item.id, item);
            });
          }catch(_){}
        };
        await tryQuery("publishedAt");
        await tryQuery("createdAt");
        if (!successCount){
          const snap = await db.collection("notifications").limit(NOTIF_MAX).get();
          snap.forEach((doc) => {
            const item = _notifFromDoc(doc);
            if (!item) return;
            map.set(item.id, item);
          });
        }
        const list = Array.from(map.values())
          .filter(n => n && n.id)
          .sort((a,b) => (b.ts || 0) - (a.ts || 0))
          .slice(0, NOTIF_MAX);
        saveNotifications(list);
        return list;
      }
      async function _refreshNotificationsFromFirestore(options){
        const opt = options || {};
        const list = await _fetchNotificationsFromFirestore();
        updateNotifyDot();
        if (el.notifyOverlay && !el.notifyOverlay.classList.contains("hidden")){
          renderNotifyList();
          _notifMarkSeenByList(list);
          renderNotifyList();
          updateNotifyDot();
        }
        if (opt.forAdmin){
          _adminState.notifItems = list.slice();
          _adminRenderNotifList();
        }
        return list;
      }
      function updateNotifyDot(){
        if (!el.notifyDot) return;
        const seenAt = _notifSeenAt();
        const list = loadNotifications();
        const unread = list.some(n => (Number(n?.ts) || 0) > seenAt);
        el.notifyDot.classList.toggle("hidden", !unread);
      }
      const _notifyDetailState = {
        activeId: "",
        players: [],
        cleanups: []
      };
      function _notifySafeUrl(raw){
        const s = String(raw || "").trim();
        if (!s) return "";
        try{
          const u = new URL(s, location.href);
          const p = String(u.protocol || "").toLowerCase();
          if (p === "http:" || p === "https:"){
            return u.href;
          }
        }catch{
          // noop
        }
        return "";
      }
      function _notifyPreviewText(body){
        let txt = String(body || "");
        txt = txt.replace(/\r\n?/g, "\n");
        txt = txt.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, "$1");
        txt = txt.replace(/\[video\]\(([^)]+)\)/gi, "[video]");
        txt = txt.replace(/\[([^\]]+)\]\(([^)]+)\)/g, "$1");
        txt = txt.replace(/^##\s+/gm, "");
        txt = txt.replace(/\*\*([^*]+)\*\*/g, "$1");
        txt = txt.replace(/\s+/g, " ").trim();
        return txt;
      }
      function _notifyTimeText(sec){
        const n = Number(sec);
        if (!Number.isFinite(n) || n < 0) return "00:00";
        const s = Math.floor(n);
        const mm = String(Math.floor(s / 60)).padStart(2, "0");
        const ss = String(s % 60).padStart(2, "0");
        return `${mm}:${ss}`;
      }
      function _notifyAddCleanup(fn){
        if (typeof fn !== "function") return;
        _notifyDetailState.cleanups.push(fn);
      }
      function _notifyPauseOtherVideos(exceptVideo){
        for (const p of _notifyDetailState.players){
          if (!p || !p.video || p.video === exceptVideo) continue;
          try{ p.video.pause(); }catch{}
          try{ if (p.playBtn) p.playBtn.textContent = ""; }catch{}
        }
      }
      function _notifyDestroyDetailMedia(){
        for (const p of _notifyDetailState.players){
          if (!p || !p.video) continue;
          try{ p.video.pause(); }catch{}
          try{ p.video.removeAttribute("src"); p.video.load(); }catch{}
        }
        _notifyDetailState.players = [];
        for (const fn of _notifyDetailState.cleanups){
          try{ fn(); }catch{}
        }
        _notifyDetailState.cleanups = [];
      }
      function _notifyShowListPane(){
        _notifyDestroyDetailMedia();
        _notifyDetailState.activeId = "";
        if (el.notifyDetailContent) el.notifyDetailContent.replaceChildren();
        if (el.notifyDetailTitle) el.notifyDetailTitle.textContent = "";
        if (el.notifyDetailMeta) el.notifyDetailMeta.textContent = "";
        if (el.notifyListPane) el.notifyListPane.classList.remove("hidden");
        if (el.notifyDetailPane) el.notifyDetailPane.classList.add("hidden");
      }
      function _notifyAppendInlineMarkdown(parent, text){
        const src = String(text || "");
        const tokenRe = /(\*\*([^*]+)\*\*|\[([^\]]+)\]\(([^)]+)\))/g;
        let last = 0;
        let m;
        while ((m = tokenRe.exec(src))){
          if (m.index > last){
            parent.appendChild(document.createTextNode(src.slice(last, m.index)));
          }
          if (m[2] != null){
            const strong = document.createElement("strong");
            strong.textContent = m[2];
            parent.appendChild(strong);
          } else {
            const label = String(m[3] || "");
            const url = _notifySafeUrl(m[4] || "");
            if (!url){
              const bad = document.createElement("span");
              bad.className = "notify-invalid";
              bad.textContent = `: ${label || "link"}`;
              parent.appendChild(bad);
            } else {
              const a = document.createElement("a");
              a.href = url;
              a.target = "_blank";
              a.rel = "noopener noreferrer";
              a.textContent = label || url;
              parent.appendChild(a);
            }
          }
          last = tokenRe.lastIndex;
        }
        if (last < src.length){
          parent.appendChild(document.createTextNode(src.slice(last)));
        }
      }
      function _notifyCreateImageBlock(alt, rawUrl){
        const wrap = document.createElement("div");
        wrap.className = "notify-media";
        const safe = _notifySafeUrl(rawUrl);
        if (!safe){
          const bad = document.createElement("div");
          bad.className = "notify-invalid";
          bad.textContent = "URL";
          wrap.appendChild(bad);
          return wrap;
        }
        const img = document.createElement("img");
        img.loading = "lazy";
        img.decoding = "async";
        img.alt = String(alt || "");
        img.src = safe;
        const err = document.createElement("div");
        err.className = "notify-invalid hidden";
        err.textContent = "";
        const onErr = () => {
          err.classList.remove("hidden");
          img.classList.add("hidden");
        };
        img.addEventListener("error", onErr);
        _notifyAddCleanup(() => img.removeEventListener("error", onErr));
        wrap.appendChild(img);
        wrap.appendChild(err);
        return wrap;
      }
      function _notifyCreateVideoBlock(rawUrl){
        const safe = _notifySafeUrl(rawUrl);
        const wrap = document.createElement("div");
        wrap.className = "notify-video";
        if (!safe){
          const bad = document.createElement("div");
          bad.className = "notify-invalid";
          bad.textContent = "URL";
          wrap.appendChild(bad);
          return wrap;
        }
        const video = document.createElement("video");
        video.className = "notify-video-screen";
        video.src = safe;
        video.preload = "metadata";
        video.playsInline = true;
        video.setAttribute("playsinline", "");
        const controls = document.createElement("div");
        controls.className = "notify-video-controls";
        const row = document.createElement("div");
        row.className = "notify-video-row";
        const playBtn = document.createElement("button");
        playBtn.type = "button";
        playBtn.className = "textbtn";
        playBtn.textContent = "";
        const muteBtn = document.createElement("button");
        muteBtn.type = "button";
        muteBtn.className = "textbtn";
        muteBtn.textContent = "";
        const time = document.createElement("div");
        time.className = "notify-video-time";
        time.textContent = "00:00 / 00:00";
        const seek = document.createElement("input");
        seek.type = "range";
        seek.className = "notify-video-seek";
        seek.min = "0";
        seek.max = "1000";
        seek.step = "1";
        seek.value = "0";
        const err = document.createElement("div");
        err.className = "notify-invalid hidden";
        err.textContent = "";

        const updateTime = () => {
          const cur = Number(video.currentTime) || 0;
          const dur = Number(video.duration);
          const durTxt = Number.isFinite(dur) && dur > 0 ? _notifyTimeText(dur) : "00:00";
          time.textContent = `${_notifyTimeText(cur)} / ${durTxt}`;
          if (Number.isFinite(dur) && dur > 0){
            seek.value = String(Math.max(0, Math.min(1000, Math.round((cur / dur) * 1000))));
          } else {
            seek.value = "0";
          }
        };
        const onPlay = () => {
          _notifyPauseOtherVideos(video);
          playBtn.textContent = "";
        };
        const onPause = () => { playBtn.textContent = ""; };
        const onEnded = () => {
          playBtn.textContent = "";
          seek.value = "0";
        };
        const onErr = () => { err.classList.remove("hidden"); };
        const onPlayClick = async () => {
          try{
            if (video.paused) await video.play();
            else video.pause();
          }catch{}
        };
        const onMuteClick = () => {
          video.muted = !video.muted;
          muteBtn.textContent = video.muted ? "" : "";
        };
        const onSeekInput = () => {
          const dur = Number(video.duration);
          if (!Number.isFinite(dur) || dur <= 0) return;
          const ratio = (Number(seek.value) || 0) / 1000;
          video.currentTime = Math.max(0, Math.min(dur, dur * ratio));
          updateTime();
        };

        playBtn.addEventListener("click", onPlayClick);
        muteBtn.addEventListener("click", onMuteClick);
        seek.addEventListener("input", onSeekInput);
        video.addEventListener("loadedmetadata", updateTime);
        video.addEventListener("durationchange", updateTime);
        video.addEventListener("timeupdate", updateTime);
        video.addEventListener("play", onPlay);
        video.addEventListener("pause", onPause);
        video.addEventListener("ended", onEnded);
        video.addEventListener("error", onErr);

        _notifyAddCleanup(() => playBtn.removeEventListener("click", onPlayClick));
        _notifyAddCleanup(() => muteBtn.removeEventListener("click", onMuteClick));
        _notifyAddCleanup(() => seek.removeEventListener("input", onSeekInput));
        _notifyAddCleanup(() => video.removeEventListener("loadedmetadata", updateTime));
        _notifyAddCleanup(() => video.removeEventListener("durationchange", updateTime));
        _notifyAddCleanup(() => video.removeEventListener("timeupdate", updateTime));
        _notifyAddCleanup(() => video.removeEventListener("play", onPlay));
        _notifyAddCleanup(() => video.removeEventListener("pause", onPause));
        _notifyAddCleanup(() => video.removeEventListener("ended", onEnded));
        _notifyAddCleanup(() => video.removeEventListener("error", onErr));

        row.appendChild(playBtn);
        row.appendChild(muteBtn);
        row.appendChild(time);
        controls.appendChild(row);
        controls.appendChild(seek);
        wrap.appendChild(video);
        wrap.appendChild(controls);
        wrap.appendChild(err);
        _notifyDetailState.players.push({ video, playBtn });
        return wrap;
      }
      function _notifyRenderDetailContent(bodyRaw){
        const root = document.createDocumentFragment();
        const text = String(bodyRaw || "").replace(/\r\n?/g, "\n");
        const lines = text.split("\n");
        let paraLines = [];
        const flushParagraph = () => {
          if (!paraLines.length) return;
          const p = document.createElement("div");
          p.className = "notify-detail-text";
          paraLines.forEach((line, idx) => {
            if (idx > 0) p.appendChild(document.createElement("br"));
            _notifyAppendInlineMarkdown(p, line);
          });
          root.appendChild(p);
          paraLines = [];
        };
        for (const lineRaw of lines){
          const line = String(lineRaw || "");
          const h = line.match(/^##\s+(.+)$/);
          const img = line.match(/^!\[([^\]]*)\]\(([^)]+)\)\s*$/);
          const vid = line.match(/^\[video\]\(([^)]+)\)\s*$/i);
          if (h){
            flushParagraph();
            const heading = document.createElement("h3");
            _notifyAppendInlineMarkdown(heading, h[1]);
            root.appendChild(heading);
            continue;
          }
          if (img){
            flushParagraph();
            root.appendChild(_notifyCreateImageBlock(img[1], img[2]));
            continue;
          }
          if (vid){
            flushParagraph();
            root.appendChild(_notifyCreateVideoBlock(vid[1]));
            continue;
          }
          paraLines.push(line);
        }
        flushParagraph();
        if (!root.childNodes.length){
          const empty = document.createElement("div");
          empty.className = "notify-empty";
          empty.textContent = "";
          root.appendChild(empty);
        }
        return root;
      }
      function _notifyOpenDetail(idRaw){
        const id = String(idRaw || "").trim();
        if (!id || !el.notifyDetailPane || !el.notifyListPane){
          if (el.notifyEmpty){
            el.notifyEmpty.textContent = "UI";
            el.notifyEmpty.classList.remove("hidden");
          }
          return;
        }
        const list = loadNotifications();
        const item = list.find(n => String(n?.id || "") === id);
        if (!item){
          if (el.notifyEmpty){
            el.notifyEmpty.textContent = "";
            el.notifyEmpty.classList.remove("hidden");
          }
          return;
        }
        _notifyDestroyDetailMedia();
        _notifyDetailState.activeId = id;
        if (el.notifyDetailTitle) el.notifyDetailTitle.textContent = item.title || "(untitled)";
        if (el.notifyDetailMeta){
          const timeTxt = item.ts ? formatDateTime(item.ts) : "";
          el.notifyDetailMeta.innerHTML =
            `<span>${escapeHtml(item.category || "Update")}</span>` +
            `<span>${escapeHtml(item.priority || "normal")}</span>` +
            `<span>${escapeHtml(timeTxt)}</span>`;
        }
        if (el.notifyDetailContent){
          el.notifyDetailContent.replaceChildren();
          el.notifyDetailContent.appendChild(_notifyRenderDetailContent(item.body || ""));
        }
        el.notifyListPane.classList.add("hidden");
        el.notifyDetailPane.classList.remove("hidden");
      }
      function renderNotifyList(){
        if (!el.notifyList || !el.notifyEmpty) return;
        const seenAt = _notifSeenAt();
        const list = loadNotifications().sort((a,b) => (b.ts || 0) - (a.ts || 0));
        el.notifyList.replaceChildren();
        if (!list.length){
          el.notifyEmpty.textContent = "";
          el.notifyEmpty.classList.remove("hidden");
          return;
        }
        el.notifyEmpty.classList.add("hidden");
        const frag = document.createDocumentFragment();
        for (const n of list){
          const unread = (Number(n.ts) || 0) > seenAt;
          const item = document.createElement("div");
          item.className = "notify-item" + (unread ? " unread" : "");
          const h = document.createElement("h3");
          h.className = "notify-title";
          h.textContent = n.title || "(untitled)";
          const p = document.createElement("p");
          p.className = "notify-bodytext";
          p.textContent = _notifyPreviewText(n.body || "");
          const t = document.createElement("div");
          t.className = "notify-time";
          const timeTxt = n.ts ? formatDateTime(n.ts) : "";
          t.innerHTML = `<span class="ms" aria-hidden="true" style="font-size:16px; opacity:.8;">schedule</span><span>${escapeHtml(timeTxt)}</span>`;
          const actions = document.createElement("div");
          actions.className = "notify-actions";
          const detailBtn = document.createElement("button");
          detailBtn.type = "button";
          detailBtn.className = "textbtn";
          detailBtn.textContent = "";
          detailBtn.dataset.notifyAction = "detail";
          detailBtn.dataset.id = String(n.id || "");
          actions.appendChild(detailBtn);
          item.appendChild(h);
          item.appendChild(p);
          item.appendChild(t);
          item.appendChild(actions);
          frag.appendChild(item);
        }
        el.notifyList.appendChild(frag);
      }
      function openNotify(){
        if (!el.notifyOverlay){
          uiToast("UI");
          return;
        }
        _notifyShowListPane();
        el.notifyOverlay.classList.remove("hidden");
        renderNotifyList();
        const cached = loadNotifications();
        _notifMarkSeenByList(cached);
        renderNotifyList();
        updateNotifyDot();
        _refreshNotificationsFromFirestore()
          .catch((err) => {
            const msg = String(err?.message || err || "unknown error");
            if (el.notifyEmpty && (!cached || !cached.length)){
              el.notifyEmpty.textContent = `: ${msg}`;
              el.notifyEmpty.classList.remove("hidden");
            }
          });
      }
      function closeNotify(){
        if (!el.notifyOverlay) return;
        _notifyShowListPane();
        el.notifyOverlay.classList.add("hidden");
      }
      const BACKUP_LATEST_KEY = "app.backup.latest.v1";
      const BACKUP_LAST_RUN_DATE_KEY = "app.backup.lastRunDate.v1";
      const BACKUP_SCHEMA_VERSION = 1;
      const BACKUP_MAX_SESSIONS = 500;
      function _backupSetStatus(msg, kind){
        if (!el.backupStatus){
          if (msg) uiToast(String(msg));
          return;
        }
        el.backupStatus.textContent = String(msg || "");
        el.backupStatus.classList.remove("ok", "error");
        if (kind === "ok") el.backupStatus.classList.add("ok");
        if (kind === "error") el.backupStatus.classList.add("error");
      }
      function _backupYmd(ts){
        const n = Number(ts) || Date.now();
        const d = new Date(n);
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, "0");
        const da = String(d.getDate()).padStart(2, "0");
        return `${y}-${m}-${da}`;
      }
      function _backupDeepClone(v){
        try{
          return JSON.parse(JSON.stringify(v));
        }catch{
          return null;
        }
      }
      function _backupBuildPayload(){
        const presets = _backupDeepClone(loadPresets()) || [];
        const settings = _backupDeepClone(state.settings || loadSettings()) || { ...defaultSettings };
        const sessions = _backupDeepClone(_insightsLoadSessions()) || [];
        const shareCache = _backupDeepClone(_shareCacheLoad()) || {};
        const activePresetId = String((typeof getActivePresetId === "function" ? getActivePresetId() : state.presetId) || "");
        const seenAt = _notifSeenAt();
        const appVersion = (typeof APP_VERSION === "string" && APP_VERSION) ? APP_VERSION : "v26";
        return {
          schemaVersion: BACKUP_SCHEMA_VERSION,
          createdAt: Date.now(),
          appVersion,
          data: {
            presets,
            activePresetId,
            settings,
            sessions: Array.isArray(sessions) ? sessions.slice(-BACKUP_MAX_SESSIONS) : [],
            shareCache,
            notificationReadState: { seenAt: Number(seenAt) || 0 },
            deck: String(state.deck || loadDeck() || "A")
          }
        };
      }
      function _backupWriteLatest(payload, updateLastRunDate){
        if (!payload || typeof payload !== "object"){
          throw new Error("");
        }
        localStorage.setItem(BACKUP_LATEST_KEY, JSON.stringify(payload));
        if (updateLastRunDate){
          localStorage.setItem(BACKUP_LAST_RUN_DATE_KEY, _backupYmd(payload.createdAt || Date.now()));
        }
      }
      function _backupReadLatest(){
        try{
          const raw = localStorage.getItem(BACKUP_LATEST_KEY);
          if (!raw) return null;
          return JSON.parse(raw);
        }catch{
          return null;
        }
      }
      function _backupNormalizePayload(raw){
        if (!raw || typeof raw !== "object"){
          throw new Error("JSON");
        }
        const schemaVersion = Number(raw.schemaVersion || 0);
        if (schemaVersion !== BACKUP_SCHEMA_VERSION){
          throw new Error(`schemaVersion : ${schemaVersion}`);
        }
        const dataRaw = raw.data;
        if (!dataRaw || typeof dataRaw !== "object"){
          throw new Error("data ");
        }
        const presets = Array.isArray(dataRaw.presets) ? dataRaw.presets : [];
        const activePresetId = String(dataRaw.activePresetId || "");
        const settings = (dataRaw.settings && typeof dataRaw.settings === "object")
          ? dataRaw.settings
          : { ...defaultSettings };
        const sessions = Array.isArray(dataRaw.sessions) ? dataRaw.sessions.slice(-BACKUP_MAX_SESSIONS) : [];
        const shareCache = (dataRaw.shareCache && typeof dataRaw.shareCache === "object") ? dataRaw.shareCache : {};
        const seenAt = Number(dataRaw.notificationReadState?.seenAt || 0);
        const deckRaw = String(dataRaw.deck || "");
        const deck = (deckRaw === "A" || deckRaw === "B" || deckRaw === "C" || deckRaw === "ALL") ? deckRaw : "";
        return {
          schemaVersion: BACKUP_SCHEMA_VERSION,
          createdAt: Number(raw.createdAt || Date.now()) || Date.now(),
          appVersion: String(raw.appVersion || "v26"),
          data: {
            presets,
            activePresetId,
            settings,
            sessions,
            shareCache,
            notificationReadState: { seenAt: Number.isFinite(seenAt) ? seenAt : 0 },
            deck
          }
        };
      }
      function _backupCreateNow(options = {}){
        const payload = _backupBuildPayload();
        _backupWriteLatest(payload, !!options.updateLastRunDate);
        const stamp = formatDateTime(payload.createdAt);
        _backupSetStatus(`: ${stamp}`, "ok");
        if (!options.silentToast){
          uiToast(options.toastText || "");
        }
        return payload;
      }
      function _backupDownloadJson(payload){
        const obj = payload || _backupReadLatest() || _backupCreateNow({ silentToast: true, updateLastRunDate: false });
        const text = JSON.stringify(obj, null, 2);
        const blob = new Blob([text], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const d = new Date();
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, "0");
        const da = String(d.getDate()).padStart(2, "0");
        const hh = String(d.getHours()).padStart(2, "0");
        const mm = String(d.getMinutes()).padStart(2, "0");
        const a = document.createElement("a");
        a.href = url;
        a.download = `vocabuquiz_backup_${y}${m}${da}_${hh}${mm}.json`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      }
      function _backupApplyPayload(payload){
        const normalized = _backupNormalizePayload(payload);
        const dataObj = normalized.data;
        localStorage.setItem(PRESETS_KEY, JSON.stringify(dataObj.presets || []));
        if (dataObj.activePresetId){
          localStorage.setItem(ACTIVE_PRESET_KEY, dataObj.activePresetId);
        }
        localStorage.setItem(SETTINGS_KEY, JSON.stringify(dataObj.settings || { ...defaultSettings }));
        localStorage.setItem(INSIGHTS_SESSIONS_KEY, JSON.stringify(Array.isArray(dataObj.sessions) ? dataObj.sessions.slice(-BACKUP_MAX_SESSIONS) : []));
        localStorage.setItem(SHARE_CACHE_KEY, JSON.stringify(dataObj.shareCache || {}));
        const seenAt = Number(dataObj.notificationReadState?.seenAt || 0);
        if (seenAt > 0) localStorage.setItem(NOTIF_SEEN_KEY, String(seenAt));
        else localStorage.removeItem(NOTIF_SEEN_KEY);

        let deck = dataObj.deck || "";
        if (!deck){
          const pid = String(dataObj.activePresetId || "");
          if (pid.startsWith("builtin:")){
            const maybe = pid.split(":")[1] || "";
            if (maybe === "A" || maybe === "B" || maybe === "C" || maybe === "ALL") deck = maybe;
          }
        }
        if (deck){
          localStorage.setItem(DECK_KEY, deck);
        }
        _backupWriteLatest(normalized, true);
      }
      async function _backupRestoreWithConfirm(payload, sourceLabel){
        const stamp = formatDateTime(Number(payload?.createdAt || Date.now()));
        const ok = await uiConfirm(
          `${sourceLabel} \n\n: ${stamp}\n\n`,
          {
            title: "",
            okText: "",
            cancelText: "",
            danger: true
          }
        );
        if (!ok) return false;
        try{
          _backupApplyPayload(payload);
          _backupSetStatus("", "ok");
          uiToast("");
          setTimeout(() => location.reload(), 120);
          return true;
        }catch(err){
          _backupSetStatus(`: ${String(err?.message || err)}`, "error");
          return false;
        }
      }
      async function _backupImportFromFile(file){
        if (!file) throw new Error("JSON");
        const text = await file.text();
        let parsed;
        try{
          parsed = JSON.parse(text);
        }catch{
          throw new Error("JSON");
        }
        const normalized = _backupNormalizePayload(parsed);
        return _backupRestoreWithConfirm(normalized, "JSON");
      }
      function _backupRunAutoDaily(){
        const today = _backupYmd(Date.now());
        const last = String(localStorage.getItem(BACKUP_LAST_RUN_DATE_KEY) || "");
        if (last === today) return false;
        const payload = _backupCreateNow({
          silentToast: true,
          updateLastRunDate: true
        });
        _backupSetStatus(`: ${formatDateTime(payload.createdAt)}`, "ok");
        uiToast("");
        return true;
      }
      function _backupScheduleAuto(){
        const run = () => {
          try{
            _backupRunAutoDaily();
          }catch(err){
            _backupSetStatus(`: ${String(err?.message || err)}`, "error");
          }
        };
        if (typeof requestIdleCallback === "function"){
          requestIdleCallback(() => run(), { timeout: 1500 });
        }else{
          setTimeout(run, 1200);
        }
      }
      async function _adminReloadNotifications(silent){
        if (!_adminState.isAdmin){
          _adminSetNotifStatus("Admin", "error");
          return;
        }
        if (_adminState.loading) return;
        _adminState.loading = true;
        if (!silent) _adminSetNotifStatus("");
        try{
          const list = await _refreshNotificationsFromFirestore({ forAdmin: true });
          _adminState.notifItems = list.slice();
          _adminRenderNotifList();
          if (!silent) _adminSetNotifStatus(`: ${list.length}`, "ok");
        }catch(err){
          _adminSetNotifStatus(`: ${String(err?.code || "ERROR")} / ${String(err?.message || err)}`, "error");
        }finally{
          _adminState.loading = false;
        }
      }
      async function _adminSaveNotification(){
        if (!_adminState.isAdmin){
          _adminSetNotifStatus("Admin", "error");
          return;
        }
        let form;
        try{
          form = _adminReadNotifForm();
        }catch(err){
          _adminSetNotifStatus(String(err?.message || err), "error");
          return;
        }
        _adminSetNotifStatus(form.id ? "" : "");
        try{
          const db = _adminGetDb();
          const fs = window.firebase?.firestore;
          if (!fs || !fs.FieldValue || !fs.Timestamp){
            throw new Error("Firestore SDK ");
          }
          const payloadBase = {
            title: form.title,
            body: form.body,
            category: form.category,
            priority: form.priority,
            publishedAt: fs.Timestamp.fromMillis(form.publishedAtMs || Date.now()),
            updatedAt: fs.FieldValue.serverTimestamp()
          };
          if (form.id){
            await db.collection("notifications").doc(form.id).set(payloadBase, { merge: true });
          }else{
            await db.collection("notifications").add({
              ...payloadBase,
              createdAt: fs.FieldValue.serverTimestamp()
            });
          }
          _adminClearNotifForm();
          await _adminReloadNotifications(true);
          _adminSetNotifStatus(form.id ? "" : "", "ok");
          uiToast(form.id ? "" : "");
        }catch(err){
          _adminSetNotifStatus(`: ${String(err?.code || "ERROR")} / ${String(err?.message || err)}`, "error");
        }
      }
      async function _adminDeleteNotification(docId){
        const id = String(docId || "").trim();
        if (!id){
          _adminSetNotifStatus("ID", "error");
          return;
        }
        if (!_adminState.isAdmin){
          _adminSetNotifStatus("Admin", "error");
          return;
        }
        const ok = await uiConfirm("", {
          title: "",
          okText: "",
          cancelText: "",
          danger: true
        });
        if (!ok) return;
        _adminSetNotifStatus("");
        try{
          const db = _adminGetDb();
          await db.collection("notifications").doc(id).delete();
          const currentId = String(document.getElementById("adminNotifDocId")?.value || "");
          if (currentId && currentId === id){
            _adminClearNotifForm();
          }
          await _adminReloadNotifications(true);
          _adminSetNotifStatus("", "ok");
          uiToast("");
        }catch(err){
          _adminSetNotifStatus(`: ${String(err?.code || "ERROR")} / ${String(err?.message || err)}`, "error");
        }
      }

      // =========================
      // Search dropdown
      // =========================
      let _searchDebTimer = null;
      let _searchResults = [];

      function _extractSearchId(q){
        const s = String(q||"").trim();
        if (!s) return null;
        const m = s.match(/^(?:no\.?|#)?\s*(\d+)\s*$/i);
        if (!m) return null;
        const n = Number(m[1]);
        return Number.isFinite(n) ? n : null;
      }

      function _searchNormalize(s){
        return String(s ?? "").toLowerCase();
      }

      function _presetLabelForSearch(preset){
        if (!preset) return "";
        if (preset.builtin){
          if (preset.id === "builtin:A") return "Preset: 0-200";
          if (preset.id === "builtin:B") return "Preset: 200-400";
          if (preset.id === "builtin:C") return "Preset: 400-600";
          return "Preset: ALL";
        }
        return `My: ${preset.name || "My Preset"}`;
      }

      function _buildSearchIndexAll(){
        const items = [];
        const presetIds = ["builtin:A", "builtin:B", "builtin:C"];
        const user = loadPresets();
        for (const p of user) presetIds.push(p.id);

        const seen = new Set();
        for (const pid of presetIds){
          const preset = getPresetById(pid);
          if (!preset) continue;
          const label = _presetLabelForSearch(preset);
          const words = getPresetWords(pid) || [];
          for (const w of words){
            const key = `${pid}:${w.id}`;
            if (seen.has(key)) continue;
            seen.add(key);
            items.push({
              presetId: pid,
              presetLabel: label,
              id: w.id,
              word: w.word,
              meaning: w.meaning
            });
          }
        }
        items.sort((a,b)=> (a.id - b.id) || String(a.presetLabel).localeCompare(String(b.presetLabel)));
        return items;
      }

      function _getSearchIndexAll(){
        if (__searchIndexCache.rev === __presetsRev && Array.isArray(__searchIndexCache.items) && __searchIndexCache.items.length){
          return __searchIndexCache.items;
        }
        const items = _buildSearchIndexAll();
        __searchIndexCache = { rev: __presetsRev, items };
        return items;
      }

      function openSearch(){
        if (!el.searchOverlay) return;
        // Close notify if open to avoid overlap
        if (el.notifyOverlay && !el.notifyOverlay.classList.contains("hidden")) closeNotify();

        el.searchOverlay.classList.remove("hidden");
        if (el.searchEmpty) el.searchEmpty.classList.add("hidden");
        if (el.searchList) el.searchList.replaceChildren();

        if (el.searchInput){
          el.searchInput.value = "";
          // Render initial items (top 20)
          renderSearchResults("");
          setTimeout(() => { try{ el.searchInput.focus(); }catch{} }, 0);
        }
      }

      function closeSearch(){
        if (!el.searchOverlay) return;
        el.searchOverlay.classList.add("hidden");
        if (_searchDebTimer){ clearTimeout(_searchDebTimer); _searchDebTimer = null; }
        _searchResults = [];
      }

      function scheduleSearch(){
        if (_searchDebTimer) clearTimeout(_searchDebTimer);
        _searchDebTimer = setTimeout(() => {
          renderSearchResults(el.searchInput?.value || "");
        }, 100);
      }

      function renderSearchResults(query){
        const listEl = el.searchList;
        const emptyEl = el.searchEmpty;
        if (!listEl || !emptyEl) return;

        const words = getActiveWords();
        listEl.replaceChildren();
        _searchResults = [];

        if (!words || words.length === 0){
          emptyEl.textContent = "";
          emptyEl.classList.remove("hidden");
          return;
        }

        const q = String(query||"").trim();
        let results = [];

        const asId = _extractSearchId(q);
        if (asId != null){
          results = words.filter(w => Number(w.id) === asId).slice(0, 20);
        }else if (!q){
          results = words.slice(0, 20);
        }else{
          const ql = _searchNormalize(q);
          for (const w of words){
            const wl = _searchNormalize(w.word);
            const ml = _searchNormalize(w.meaning);
            if (wl.includes(ql) || ml.includes(ql)){
              results.push(w);
              if (results.length >= 20) break;
            }
          }
        }

        if (!results.length){
          emptyEl.textContent = "";
          emptyEl.classList.remove("hidden");
          return;
        }
        emptyEl.classList.add("hidden");

        _searchResults = results.slice();

        const frag = document.createDocumentFragment();
        for (const w of results){
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "search-item";
          btn.dataset.id = String(w.id);

          const row = document.createElement("div");
          row.className = "row";

          const no = document.createElement("div");
          no.className = "no";
          no.textContent = `No.${w.id}`;

          const word = document.createElement("div");
          word.className = "word";
          word.textContent = String(w.word || "");

          row.appendChild(no);
          row.appendChild(word);

          const meaning = document.createElement("div");
          meaning.className = "meaning";
          meaning.textContent = String(w.meaning || "");

          const preset = document.createElement("div");
          preset.className = "preset";
          preset.textContent = String(w.presetLabel || "");

          btn.appendChild(row);
          btn.appendChild(meaning);
          btn.appendChild(preset);
          frag.appendChild(btn);
        }
        listEl.appendChild(frag);
      }

      
      function openWordDetailFromSearch(w){
        if (!w) return;
        const dir = (state.settings && state.settings.direction) ? state.settings.direction : "EN_JA";
        const frontLabel = (dir === "JA_EN") ? "" : "";
        const backLabel  = (dir === "JA_EN") ? "" : "";
        const frontText = (dir === "JA_EN") ? String(w.meaning || "") : String(w.word || "");
        const backText  = (dir === "JA_EN") ? String(w.word || "") : String(w.meaning || "");

        const htmlStr = `
          <div style="display:grid; gap:12px;">
            <div style="display:flex; align-items:baseline; justify-content:space-between; gap:10px;">
              <div style="font-weight:800; letter-spacing:.01em;">No.${w.id}</div>
              <div style="font-size:12px; color:var(--muted);">Search</div>
            </div>

            <div style="display:grid; gap:10px;">
              <div style="font-size:12px; color:var(--muted);">${frontLabel}</div>
              <div style="font-size:22px; font-weight:800; line-height:1.25; letter-spacing:.01em;">${escapeHtml(frontText)}</div>

              <div style="margin-top:4px; padding:12px; border:1px solid rgba(17,18,20,.08); border-radius:14px; background:rgba(17,18,20,.03);">
                <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
                  <div style="font-size:12px; color:var(--muted);">${backLabel}</div>
                  <button id="wdToggleBtn" type="button" class="textbtn"></button>
                </div>
                <div id="wdAnswer" style="margin-top:8px; display:none;">
                  <div style="font-size:16px; line-height:1.5;">${escapeHtml(backText)}</div>
                </div>
              </div>
            </div>
          </div>
        `;

        uiHtml(htmlStr, { title:"", okText:"" });

        _runIdle(() => {
          const btn = document.getElementById("wdToggleBtn");
          const ans = document.getElementById("wdAnswer");
          if (!btn || !ans) return;

          let shown = false;
          btn.onclick = () => {
            shown = !shown;
            ans.style.display = shown ? "" : "none";
            btn.textContent = shown ? "" : "";
          };

          // When closing, restore focus back to search input if search is open
          uiModalOnClose(() => {
            try{
              if (el.searchOverlay && !el.searchOverlay.classList.contains("hidden") && el.searchInput){
                el.searchInput.focus();
              }
            }catch{}
            uiModalOnClose(null);
          });
        });
      }

function _openSearchResultByIndex(i){
        const w = _searchResults[i];
        if (!w) return;
        openWordDetailFromSearch(w);
      }


      // =========================
      // Events
      // =========================
      el.deckABtn.addEventListener("click", () => setDeck("A"));
      el.deckBBtn.addEventListener("click", () => setDeck("B"));
      if (el.deckCBtn) el.deckCBtn.addEventListener("click", () => setDeck("C"));
      el.deckAllBtn.addEventListener("click", () => setDeck("ALL"));

      // Preset: My / Manage
      if (el.deckMyBtn){
        el.deckMyBtn.addEventListener("click", () => {
          const list = loadPresets();
          if (!list.length){
            openPresetManager(false);
            return;
          }
          const pid = getActivePresetId();
          const next = (!isBuiltinPreset(pid) && list.some(p=>p.id===pid)) ? pid : list[0].id;
          setActivePreset(next);
          if (el.customPresetSelect) el.customPresetSelect.value = next;
        });
      }
      if (el.customPresetSelect){
        el.customPresetSelect.addEventListener("change", () => {
          const id = el.customPresetSelect.value;
          if (id) setActivePreset(id);
        });
      }
      if (el.customPresetNewBtn){
        el.customPresetNewBtn.addEventListener("click", () => openPresetManager(true));
      }
      if (el.presetManageBtn){
        el.presetManageBtn.addEventListener("click", () => openPresetManager(false));
      }


      el.startSeqBtn.addEventListener("click", () => startMode("SEQ"));
      el.startRndBtn.addEventListener("click", () => startMode("RND"));
      el.startChoiceBtn.addEventListener("click", () => openTimeSelect());
      el.startHandBtn.addEventListener("click", () => startMode("HAND"));

      if (el.startAppBtn){
        el.startAppBtn.addEventListener("click", () => {
          setView("TITLE");
          renderAll();
        });
      }

      if (el.topPresetBtn){
        el.topPresetBtn.addEventListener("click", () => openPresetManager(false));
      }

      el.backBtn.addEventListener("click", goTitle);
      el.primaryBtn.addEventListener("click", primaryAction);
      el.nextBtn.addEventListener("click", next);
      el.prevBtn.addEventListener("click", prev);
      el.restartBtn.addEventListener("click", restart);
      el.newSetBtn.addEventListener("click", newHandSet);

      el.clearCanvasBtn.addEventListener("click", () => {
        if (state.mode === "HAND"){
          ensureCanvasReady();
          clearCanvas();
        }
      });

      el.readCanvasBtn.addEventListener("click", async () => {
        if (state.mode !== "HAND") return;
        const cur = getCurrent();
        if (!cur) return;
        await readCanvasIntoInput(cur.word);
      });
      // Choice options click (tap only)
      el.choices.addEventListener("click", (e) => {
        if (state.mode !== "CHOICE") return;
        const btn = e.target.closest("button.choice-btn");
        if (!btn) return;
        const idx = Number(btn.dataset.idx);
        if (!Number.isFinite(idx)) return;
        handleChoiceSelect(idx);
      });



      el.settingsBtn.addEventListener("click", openSettings);

      // Search dropdown
      if (el.searchBtn) el.searchBtn.addEventListener("click", () => {
        if (el.searchOverlay && !el.searchOverlay.classList.contains("hidden")) closeSearch();
        else openSearch();
      });
      if (el.searchCloseBtn) el.searchCloseBtn.addEventListener("click", closeSearch);
      if (el.searchOverlay) el.searchOverlay.addEventListener("click", (e) => {
        if (e.target === el.searchOverlay) closeSearch();
      });
      if (el.searchInput){
        el.searchInput.addEventListener("input", scheduleSearch);
        el.searchInput.addEventListener("keydown", (e) => {
          if (e.key === "Escape"){
            e.preventDefault();
            closeSearch();
            return;
          }
          if (e.key === "Enter"){
            e.preventDefault();
            _openSearchResultByIndex(0);
            return;
          }
        });
      }
      if (el.searchList){
        el.searchList.addEventListener("click", (e) => {
          const btn = e.target && e.target.closest ? e.target.closest(".search-item") : null;
          if (!btn) return;
          const id = Number(btn.dataset.id);
          if (!Number.isFinite(id)) return;
          const w = (_searchResults && _searchResults.find) ? (_searchResults.find(x => x && x.id === id) || null) : null;
          if (w) openWordDetailFromSearch(w);
          else{
            const words = getActiveWords();
            const ww = (words && words.find) ? words.find(x => x && x.id === id) : null;
            if (ww) openWordDetailFromSearch(ww);
          }
        });
      }


      if (el.notifyBtn) el.notifyBtn.addEventListener("click", () => {
        if (el.searchOverlay && !el.searchOverlay.classList.contains("hidden")) closeSearch();
        if (el.notifyOverlay && !el.notifyOverlay.classList.contains("hidden")) closeNotify();
        else openNotify();
      });
      if (el.notifyCloseBtn) el.notifyCloseBtn.addEventListener("click", closeNotify);
      if (el.notifyCloseBtn2) el.notifyCloseBtn2.addEventListener("click", closeNotify);
      if (el.notifyDetailBackBtn) el.notifyDetailBackBtn.addEventListener("click", _notifyShowListPane);
      if (el.notifyList){
        el.notifyList.addEventListener("click", (e) => {
          const btn = e.target && e.target.closest ? e.target.closest("[data-notify-action='detail']") : null;
          if (!btn) return;
          const id = String(btn.dataset.id || "").trim();
          if (!id){
            if (el.notifyEmpty){
              el.notifyEmpty.textContent = "ID";
              el.notifyEmpty.classList.remove("hidden");
            }
            return;
          }
          _notifyOpenDetail(id);
        });
      }
      if (el.notifyOverlay) el.notifyOverlay.addEventListener("click", (e) => {
        if (e.target === el.notifyOverlay) closeNotify();
      });
      el.closeSettingsBtn.addEventListener("click", closeSettings);
      el.closeSettingsBtn2.addEventListener("click", closeSettings);

      el.closeTimeBtn.addEventListener("click", closeTimeSelect);
      el.cancelTimeBtn.addEventListener("click", closeTimeSelect);
      el.timeOverlay.addEventListener("click", (e) => {
        if (e.target === el.timeOverlay) closeTimeSelect();
      });

      // Per-question time (seconds). ()
      el.time5Btn.addEventListener("click", () => startChoiceMode(5));
      el.time10Btn.addEventListener("click", () => startChoiceMode(10));
      el.time30Btn.addEventListener("click", () => startChoiceMode(30));
      el.time60Btn.addEventListener("click", () => startChoiceMode(60));
      el.timeNoneBtn.addEventListener("click", () => startChoiceMode(0));
      el.settingsOverlay.addEventListener("click", (e) => {
        if (e.target === el.settingsOverlay) closeSettings();
      });

      // Update Notes
      el.updateCloseBtn?.addEventListener("click", closeUpdateNotes);
      el.updateCloseXBtn?.addEventListener("click", closeUpdateNotes);
      el.updateOverlay?.addEventListener("click", (e) => {
        if (e.target === el.updateOverlay) closeUpdateNotes();
      });

      el.dirEnJaBtn.addEventListener("click", () => setDirection("EN_JA"));
      el.dirJaEnBtn.addEventListener("click", () => setDirection("JA_EN"));
      el.animToggle.addEventListener("change", (e) => setAnimations(e.target.checked));
      el.sfxToggle.addEventListener("change", (e) => setSfx(e.target.checked));
      el.bgmToggle.addEventListener("change", (e) => setBgm(e.target.checked));
      el.bgmVolLargeBtn.addEventListener("click", () => setBgmVolume("LARGE"));
      el.bgmVolDefaultBtn.addEventListener("click", () => setBgmVolume("DEFAULT"));
      el.bgmVolSmallBtn.addEventListener("click", () => setBgmVolume("SMALL"));
      el.debugToggle.addEventListener("change", (e) => setDebug(e.target.checked));

      document.addEventListener("click", async (e) => {
        const backupCreateBtn = e.target.closest("#backupCreateNowBtn");
        if (backupCreateBtn){
          e.preventDefault();
          try{
            _backupCreateNow({ updateLastRunDate: true, silentToast: false });
          }catch(err){
            _backupSetStatus(`: ${String(err?.message || err)}`, "error");
          }
          return;
        }

        const backupExportBtn = e.target.closest("#backupExportBtn");
        if (backupExportBtn){
          e.preventDefault();
          try{
            const latest = _backupReadLatest() || _backupCreateNow({ updateLastRunDate: true, silentToast: true });
            _backupDownloadJson(latest);
            _backupSetStatus("JSON", "ok");
            uiToast("JSON");
          }catch(err){
            _backupSetStatus(`: ${String(err?.message || err)}`, "error");
          }
          return;
        }

        const backupImportBtn = e.target.closest("#backupImportBtn");
        if (backupImportBtn){
          e.preventDefault();
          if (!el.backupImportFile){
            _backupSetStatus("UI", "error");
            return;
          }
          el.backupImportFile.value = "";
          el.backupImportFile.click();
          return;
        }

        const backupRestoreLatestBtn = e.target.closest("#backupRestoreLatestBtn");
        if (backupRestoreLatestBtn){
          e.preventDefault();
          const latest = _backupReadLatest();
          if (!latest){
            _backupSetStatus("", "error");
            return;
          }
          try{
            await _backupRestoreWithConfirm(latest, "");
          }catch(err){
            _backupSetStatus(`: ${String(err?.message || err)}`, "error");
          }
          return;
        }

        const loginBtn = e.target.closest("#adminLoginBtn");
        if (loginBtn){
          e.preventDefault();
          _adminEnsureAuthWatcher();
          const env = _adminCheckAuthEnvironment();
          if (!env.ok){
            _adminSetStatus(env.reason, "error");
            return;
          }
          let auth;
          try{
            auth = _adminGetAuth();
          }catch(err){
            _adminSetStatus(`Firebase: ${String(err?.message || err)}`, "error");
            return;
          }
          try{
            loginBtn.disabled = true;
            _adminSetStatus("Google");
            const provider = new window.firebase.auth.GoogleAuthProvider();
            await auth.signInWithPopup(provider);
            _adminSetStatus("", "ok");
          }catch(err){
            const code = String(err?.code || "AUTH_ERROR");
            const msg = String(err?.message || "");
            const fallbackCodes = new Set([
              "auth/popup-blocked",
              "auth/web-storage-unsupported",
              "auth/operation-not-supported-in-this-environment"
            ]);
            if (fallbackCodes.has(code) && typeof auth.signInWithRedirect === "function"){
              try{
                _adminSetStatus(` (${code})`);
                const provider = new window.firebase.auth.GoogleAuthProvider();
                await auth.signInWithRedirect(provider);
                return;
              }catch(err2){
                const code2 = String(err2?.code || "AUTH_ERROR");
                const msg2 = String(err2?.message || "");
                _adminSetStatus(`: ${code2} / ${msg2}`, "error");
              }
            } else {
              _adminSetStatus(`: ${code} / ${msg}`, "error");
            }
          }finally{
            loginBtn.disabled = false;
            _adminRenderUI();
          }
          return;
        }

        const logoutBtn = e.target.closest("#adminLogoutBtn");
        if (logoutBtn){
          e.preventDefault();
          let auth;
          try{
            auth = _adminGetAuth();
          }catch(err){
            _adminSetStatus(`Firebase: ${String(err?.message || err)}`, "error");
            return;
          }
          try{
            logoutBtn.disabled = true;
            await auth.signOut();
            _adminSetStatus("", "ok");
          }catch(err){
            _adminSetStatus(`: ${String(err?.code || "AUTH_ERROR")} / ${String(err?.message || err)}`, "error");
          }finally{
            logoutBtn.disabled = false;
            _adminRenderUI();
          }
          return;
        }

        const openEditorBtn = e.target.closest("#adminOpenNotifEditorBtn");
        if (openEditorBtn){
          e.preventDefault();
          if (!_adminShowEditor(true)) return;
          _adminClearNotifForm();
          _adminReloadNotifications(false);
          return;
        }

        const backEditorBtn = e.target.closest("#adminNotifBackBtn");
        if (backEditorBtn){
          e.preventDefault();
          _adminShowEditor(false);
          return;
        }

        const reloadBtn = e.target.closest("#adminNotifReloadBtn");
        if (reloadBtn){
          e.preventDefault();
          _adminReloadNotifications(false);
          return;
        }

        const saveBtn = e.target.closest("#adminNotifSaveBtn");
        if (saveBtn){
          e.preventDefault();
          _adminSaveNotification();
          return;
        }

        const clearBtn = e.target.closest("#adminNotifClearBtn");
        if (clearBtn){
          e.preventDefault();
          _adminClearNotifForm();
          _adminSetNotifStatus("");
          return;
        }

        const cancelEditBtn = e.target.closest("#adminNotifCancelEditBtn");
        if (cancelEditBtn){
          e.preventDefault();
          _adminClearNotifForm();
          _adminSetNotifStatus("");
          return;
        }

        const rowActionBtn = e.target.closest("[data-admin-notif-action]");
        if (rowActionBtn){
          const action = rowActionBtn.dataset.adminNotifAction || "";
          const id = rowActionBtn.dataset.id || "";
          if (!action || !id){
            _adminSetNotifStatus("", "error");
            return;
          }
          e.preventDefault();
          if (action === "edit"){
            const hit = _adminState.notifItems.find(n => String(n?.id || "") === String(id));
            if (!hit){
              _adminSetNotifStatus("", "error");
              return;
            }
            _adminFillNotifForm(hit);
            _adminSetNotifStatus(`: ${hit.title || hit.id}`);
            return;
          }
          if (action === "delete"){
            _adminDeleteNotification(id);
            return;
          }
        }
      });
      if (el.backupImportFile){
        el.backupImportFile.addEventListener("change", async (e) => {
          const input = e.target;
          const file = input && input.files && input.files[0] ? input.files[0] : null;
          if (!file){
            _backupSetStatus("", "error");
            return;
          }
          _backupSetStatus("");
          try{
            await _backupImportFromFile(file);
          }catch(err){
            _backupSetStatus(`: ${String(err?.message || err)}`, "error");
          }finally{
            try{ input.value = ""; }catch{}
          }
        });
      }


      el.resultRestartBtn.addEventListener("click", () => {
        const kind = state.resultKind || state.mode || "HAND";

        if (kind === "CHOICE"){
          // restart same set, same time limit
          const t = state.choice.timeLimitSec || 0;
          resetChoiceSession(t);
          state.order = buildOrder("CHOICE"); // uses stored ids
          state.index = 0;
          state.showAnswer = false;
          state.done = false;

          buildChoiceOptionsForCurrent();
          renderChoiceOptions();

          setView("QUIZ");
          syncBgmToView();
          startChoiceTimer();
          animateCardSwap(renderAll);
          return;
        }

        // HAND
        state.mode = "HAND";
        state.order = buildOrder("HAND"); // uses stored ids
        state.index = 0;
        state.showAnswer = false;
        state.done = false;

        state.hand.checked = false;
        state.hand.correct = null;
        state.hand.input = "";
        state.hand.busy = false;
        state.hand.results = [];
        state.hand.scoreCorrect = 0;

        setView("QUIZ");
        resetHandPerQuestion();
        animateCardSwap(renderAll);
      });

      el.resultNewSetBtn.addEventListener("click", () => {
        const kind = state.resultKind || state.mode || "HAND";
        if (kind === "CHOICE"){
          createChoiceSetIds(getSetKey(state.deck), true);
          const t = state.choice.timeLimitSec || 0;
          startChoiceMode(t);
          return;
        }
        // HAND
        createExamSetIds(getSetKey(state.deck), true);
        startMode("HAND");
      });
      el.resultTitleBtn.addEventListener("click", goTitle);
      el.resultReviewBtn.addEventListener("click", reviewWrong);

      // keyboard
      
      // keyboard
      document.addEventListener("keydown", (e) => {
        // If modal is open, let it handle keys (avoid accidental dropdown closes)
        if (uiModal.root && uiModal.root.classList.contains("is-open")) return;

        // settings open: only Esc
        if (el.settingsOverlay && !el.settingsOverlay.classList.contains("hidden")){
          if (e.key === "Escape"){
            e.preventDefault();
            closeSettings();
          }
          return;
        }

        // time select open: only Esc
        if (el.timeOverlay && !el.timeOverlay.classList.contains("hidden")){
          if (e.key === "Escape"){
            e.preventDefault();
            closeTimeSelect();
          }
          return;
        }

        // search dropdown open: Esc closes + do not hijack keys while focusing inside
        if (el.searchOverlay && !el.searchOverlay.classList.contains("hidden")){
          if (e.key === "Escape"){
            e.preventDefault();
            closeSearch();
            return;
          }
          const aeSearch = document.activeElement;
          if (aeSearch && el.searchOverlay.contains(aeSearch)){
            return;
          }
        }

        // notify dropdown open: Esc closes
        if (el.notifyOverlay && !el.notifyOverlay.classList.contains("hidden")){
          if (e.key === "Escape"){
            e.preventDefault();
            closeNotify();
            return;
          }
        }


        // typing focus: do not hijack keys
        const ae = document.activeElement;
        const isTyping = ae && (ae.tagName === "INPUT" || ae.tagName === "TEXTAREA" || ae.isContentEditable);

        // global escape to title
        if (e.key === "Escape"){
          if (isTyping) return;
          if (state.view !== "TITLE"){
            e.preventDefault();
            goTitle();
          }
          return;
        }

        if (state.view !== "QUIZ") return;

        // Choice mode: no keyboard answering (tap/click only), no Space toggles, no Enter actions.
        if (state.mode === "CHOICE"){
          return;
        }

        // Hand mode: only Enter triggers judge (or Enter again to go next). NO SPACE judge.
        if (state.mode === "HAND"){
          if (e.key === "Enter"){
            e.preventDefault();
            if (!state.hand.checked) checkHand();
            else next();
            return;
          }

          if (isTyping) return;

          // optional shortcut: clear canvas with C only when not typing
          if (e.key && e.key.toLowerCase() === "c"){
            e.preventDefault();
            ensureCanvasReady();
            clearCanvas();
            return;
          }

          if (e.key === "ArrowRight"){
            e.preventDefault();
            next();
            return;
          }
          if (e.key === "ArrowLeft"){
            e.preventDefault();
            prev();
            return;
          }

          return;
        }

        // Study modes
        if (isTyping) return;

        if (e.key === " "){
          e.preventDefault();
          primaryAction();
          return;
        }
        if (e.key === "ArrowRight"){
          e.preventDefault();
          next();
          return;
        }
        if (e.key === "ArrowLeft"){
          e.preventDefault();
          prev();
          return;
        }
      });


      // canvas init
      bindCanvasEvents();

      // =========================
      // Preset Manager (UI)
      // =========================
      const presetOverlay = document.getElementById("presetOverlay");
      const presetCloseBtn = document.getElementById("presetCloseBtn");
      const presetCloseBtn2 = document.getElementById("presetCloseBtn2");
      const presetListEl = document.getElementById("presetList");
      const presetNewBtn = document.getElementById("presetNewBtn");
      const presetSaveBtn = document.getElementById("presetSaveBtn");
      const presetDeleteBtn = document.getElementById("presetDeleteBtn");
      const presetExportBtn = document.getElementById("presetExportBtn");
      const presetShareBtn = document.getElementById("presetShareBtn");
      const presetShareImportBtn = document.getElementById("presetShareImportBtn");
      const presetImportBtn = document.getElementById("presetImportBtn");
      const presetImportFile = document.getElementById("presetImportFile");

      const presetNameInput = document.getElementById("presetNameInput");
      const presetModeSeq = document.getElementById("presetModeSeq");
      const presetModeRnd = document.getElementById("presetModeRnd");
      const presetModeHand = document.getElementById("presetModeHand");
      const presetModeChoice = document.getElementById("presetModeChoice");

      const wordIdInput = document.getElementById("wordIdInput");
      const wordWordInput = document.getElementById("wordWordInput");
      const wordMeaningInput = document.getElementById("wordMeaningInput");
      const wordUpsertBtn = document.getElementById("wordUpsertBtn");
      const wordClearBtn = document.getElementById("wordClearBtn");

      // Custom 4-choice config (for user presets)
      const mcqEnable = document.getElementById("mcqEnable");
      const mcqFields = document.getElementById("mcqFields");
      const mcqFillCorrectBtn = document.getElementById("mcqFillCorrectBtn");
      const mcqClearBtn = document.getElementById("mcqClearBtn");
      const mcqChoices = [
        document.getElementById("mcqChoice0"),
        document.getElementById("mcqChoice1"),
        document.getElementById("mcqChoice2"),
        document.getElementById("mcqChoice3"),
      ];
      const mcqRadios = Array.from(document.querySelectorAll('input[name="mcqCorrect"]'));

      function setMcqVisible(on){
        if (!mcqFields) return;
        mcqFields.classList.toggle("hidden", !on);
      }
      function clearMcqForm(){
        if (mcqEnable) mcqEnable.checked = false;
        setMcqVisible(false);
        for (const i of mcqChoices){ if (i) i.value = ""; }
        for (const r of mcqRadios){ r.checked = false; }
      }
      function fillMcqCorrectFromMeaning(){
        if (!mcqEnable) return;
        if (!mcqEnable.checked){
          mcqEnable.checked = true;
          setMcqVisible(true);
        }
        const meaning = (wordMeaningInput?.value ?? "").trim();
        if (!meaning){
          uiAlert("meaning");
          return;
        }
        let idx = mcqRadios.findIndex(r => r.checked);
        if (idx < 0){
          idx = 0;
          if (mcqRadios[0]) mcqRadios[0].checked = true;
        }
        if (mcqChoices[idx]) mcqChoices[idx].value = meaning;
      }
      function getMcqFromForm(meaning){
        if (!mcqEnable || !mcqEnable.checked) return null;

        const vals = mcqChoices.map(i => (i?.value ?? "").trim());
        let last = -1;
        for (let i=0;i<vals.length;i++){
          if (vals[i]) last = i;
        }
        if (last < 0) return null;

        for (let i=0;i<=last;i++){
          if (!vals[i]){
            uiAlert("");
            return { __invalid:true };
          }
        }
        const choices = vals.slice(0, last+1);

        if (choices.length < 2){
          uiAlert("2");
          return { __invalid:true };
        }
        const seen = new Set();
        for (const c of choices){
          if (seen.has(c)){
            uiAlert("");
            return { __invalid:true };
          }
          seen.add(c);
        }
        let correctIndex = mcqRadios.findIndex(r => r.checked);
        if (correctIndex < 0){
          uiAlert("AD1");
          return { __invalid:true };
        }
        if (correctIndex > last){
          uiAlert("");
          return { __invalid:true };
        }
        if (choices[correctIndex] !== meaning){
          uiAlert("meaning");
          return { __invalid:true };
        }
        return { choices, correctIndex };
      }

      mcqEnable?.addEventListener("change", ()=>{
        setMcqVisible(!!mcqEnable.checked);
      });
      mcqFillCorrectBtn?.addEventListener("click", fillMcqCorrectFromMeaning);
      mcqClearBtn?.addEventListener("click", clearMcqForm);

      const bulkTextarea = document.getElementById("bulkTextarea");
      const bulkAddBtn = document.getElementById("bulkAddBtn");
      const bulkClearBtn = document.getElementById("bulkClearBtn");
      const presetClearWordsBtn = document.getElementById("presetClearWordsBtn");
      const presetWordsPreview = document.getElementById("presetWordsPreview");

      let editingPresetId = null;


      // =========================
      // Preset Share (Code + QR) via bundled Worker API (10 min TTL)
      // =========================
      const APP_VERSION = "v26";
      const SHARE_VALID_MS = 10 * 60 * 1000;
      const SHARE_CACHE_KEY = "app.share.cache.v1";
      const SHARE_API_FALLBACK = "http://127.0.0.1:8787"; // wrangler dev
      const SHARE_QR_IMG = "https://api.qrserver.com/v1/create-qr-code/?size=240x240&data=";

      function _shareApiBase(){
        try{
          if (location && location.origin && location.origin !== "null" && location.protocol !== "file:") {
            return String(location.origin).replace(/\/+$/, "");
          }
        }catch(_){/* ignore */}
        return SHARE_API_FALLBACK;
      }
      function _shareApiReady(){
        const b = _shareApiBase();
        return !!b && /^https?:\/\//i.test(String(b));
      }
      function _shareUrlFromCode(code){
        return `${_shareApiBase()}/s/${encodeURIComponent(String(code || "").toUpperCase())}`;
      }
      function fetchWithTimeout(url, opts, ms){
        const ctrl = new AbortController();
        const id = setTimeout(()=>ctrl.abort(), ms||5000);
        const o = Object.assign({}, opts||{}, { signal: ctrl.signal });
        return fetch(url, o).finally(()=>clearTimeout(id));
      }
      async function safeJson(res){
        const ct = (res.headers.get("content-type") || "").toLowerCase();
        const text = await res.text();
        if (!ct.includes("application/json")){
          throw new Error("NON_JSON_RESPONSE: " + text.slice(0,200));
        }
        try { return JSON.parse(text); } catch (e) { throw new Error("JSON_PARSE_FAILED: " + text.slice(0,200)); }
      }
      function _shareCreateUrl(){
        return `${_shareApiBase()}/api/share/create`;
      }

      function _shareGetUrl(code){
        return `${_shareApiBase()}/api/share/get?code=${encodeURIComponent(String(code || "").toUpperCase())}&appVersion=${encodeURIComponent(APP_VERSION)}`;
      }

      function _extractShareCode(raw){
        const s = String(raw || "").trim().toUpperCase();
        if (!s) return "";
        let m = s.match(/\/S\/([A-Z0-9]{6})(?:\b|\/|$)/);
        if (m) return m[1];
        m = s.match(/[?&]CODE=([A-Z0-9]{6})\b/);
        if (m) return m[1];
        m = s.match(/\b([A-Z0-9]{6})\b/);
        if (m) return m[1];
        return s.replace(/[^A-Z0-9]/g,"").slice(0,6);
      }

      async function _copyText(text){
        const t = String(text || "");
        try{
          if (navigator.clipboard && navigator.clipboard.writeText){
            await navigator.clipboard.writeText(t);
            return true;
          }
        }catch{}
        try{
          const ta = document.createElement("textarea");
          ta.value = t;
          ta.setAttribute("readonly","");
          ta.style.position = "fixed";
          ta.style.left = "-9999px";
          ta.style.top = "-9999px";
          document.body.appendChild(ta);
          ta.select();
          document.execCommand("copy");
          ta.remove();
          return true;
        }catch{
          return false;
        }
      }

      function _runIdle(fn){
        if (typeof requestIdleCallback === "function"){
          requestIdleCallback(() => { try{ fn(); }catch{} }, { timeout: 900 });
        }else{
          setTimeout(() => { try{ fn(); }catch{} }, 120);
        }
      }

      async function _fetchJsonWithTimeout(url, opts = {}, ms = 12000){
        const ctrl = new AbortController();
        const t = setTimeout(() => ctrl.abort(), ms);
        try{
          const res = await fetch(url, { ...opts, signal: ctrl.signal });
          const txt = await res.text();
          let data = null;
          try{ data = txt ? JSON.parse(txt) : null; }catch{}
          if (!res.ok){
            const msg = (data && (data.message || data.error)) || `${res.status} ${res.statusText}`;
            throw new Error(msg);
          }
          return data;
        }finally{
          clearTimeout(t);
        }
      }

      function _shareCacheLoad(){
        try{
          const raw = localStorage.getItem(SHARE_CACHE_KEY);
          const obj = raw ? JSON.parse(raw) : {};
          return obj && typeof obj === "object" ? obj : {};
        }catch{ return {}; }
      }
      function _shareCacheSave(obj){
        try{ localStorage.setItem(SHARE_CACHE_KEY, JSON.stringify(obj || {})); }catch{}
      }
      function _shareCacheGet(presetId){
        const c = _shareCacheLoad();
        const e = c && c[presetId];
        if (!e || !e.code || !e.shareUrl || typeof e.expiresAt !== "number") return null;
        return e;
      }
      function _shareCacheSet(presetId, entry){
        const c = _shareCacheLoad();
        c[presetId] = entry;
        _shareCacheSave(c);
      }

      function _uniquePresetName(base, existing){
        const names = new Set(existing.map(p => String(p.name || "")));
        if (!names.has(base)) return base;
        let i = 2;
        while (names.has(`${base} (${i})`)) i++;
        return `${base} (${i})`;
      }

      function _formatMMSS(ms){
        const s = Math.max(0, Math.floor((ms || 0) / 1000));
        const mm = String(Math.floor(s / 60)).padStart(2, "0");
        const ss = String(s % 60).padStart(2, "0");
        return `${mm}:${ss}`;
      }

      function _shareModalHtml(presetName){
        const today = (() => {
          try{
            const d = new Date();
            const y = d.getFullYear();
            const m = String(d.getMonth()+1).padStart(2,"0");
            const da = String(d.getDate()).padStart(2,"0");
            return `${y}-${m}-${da}`;
          }catch{ return ""; }
        })();

        return `
          <div style="display:grid; gap:12px;">
            <div style="color:var(--muted); font-size:12px; display:flex; gap:10px; flex-wrap:wrap;">
              <div>${today}</div>
              <div style="opacity:.7;">${_escHtml(presetName)}</div>
            </div>

            <div style="text-align:center; padding:10px 0 2px;">
              <div id="shareCode" style="font-weight:800; font-size:44px; letter-spacing:.14em; font-variant-numeric:tabular-nums; color:var(--text);"></div>
              <div id="shareCodeSub" style="margin-top:6px; font-size:12px; color:var(--muted);"><div class="note" id="shareStatusMsg"></div></div>
            </div>

            <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:center;">
              <button class="navbtn" id="shareCopyCodeBtn" type="button" disabled></button>
              <button class="textbtn" id="shareCopyUrlBtn" type="button" disabled>URL</button>
            </div>

            <div style="display:grid; gap:8px; justify-items:center; padding-top:6px;">
              <div id="shareQrStatus" style="font-size:12px; color:var(--muted);">QR</div>
              <img id="shareQrImg" alt="QR" style="width:240px; height:240px; border-radius:16px; border:1px solid rgba(0,0,0,.06); box-shadow:0 12px 30px rgba(0,0,0,.10); display:none;" />
              <div id="shareUrlText" style="font-size:12px; color:var(--muted); max-width: 520px; word-break: break-all; text-align:center;"></div>
              <div id="shareTtl" style="font-size:12px; color:var(--muted);"><span id="shareExpires">Expires in --:--</span></div>
            </div>

            <div id="shareErr" style="display:none; font-size:12px; color:#b42318; background:rgba(180,35,24,.08); border:1px solid rgba(180,35,24,.18); padding:10px 12px; border-radius:12px;"></div>
            <div id="shareDebug" style="margin-top:10px; padding:8px 10px; border-radius:12px; border:1px dashed rgba(0,0,0,.18); background:rgba(0,0,0,.03); color:rgba(0,0,0,.65); font-size:12px; line-height:1.35; white-space:pre-wrap; word-break:break-word;">Debug: -</div>

            <div style="font-size:12px; color:var(--muted); line-height:1.55; text-align:center; padding-top:4px;">
              QR
            </div>
          </div>
        `;
      }

      function _importModalHtml(){
        const canCam = !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia);
        const canDecode = ("BarcodeDetector" in window) || (typeof window.jsQR === "function");
        return `
          <div style="display:grid; gap:12px;">
            <div style="font-size:12px; color:var(--muted); line-height:1.6;">
              QRURL/s/XXXXXX6
            </div>

            <div>
              <div class="note" style="margin-bottom:6px;">6</div>
              <input id="shareImportCode" class="spell-input" type="text"
                placeholder="4K7X2Q"
                inputmode="text" autocomplete="one-time-code" autocapitalize="characters" spellcheck="false" />
            </div>

            <div style="display:flex; gap:10px; flex-wrap:wrap;">
              <button class="navbtn" id="shareImportFetchBtn" type="button"></button>
              <button class="textbtn" id="shareImportCamBtn" type="button" ${canCam ? "" : "disabled"}>${canCam ? (canDecode ? "" : "") : ""}</button>
              <button class="textbtn hidden" id="shareImportCamStopBtn" type="button"></button>
            </div>

            <div id="shareImportStatus" style="font-size:12px; color:var(--muted);"></div>

            <div id="shareCamWrap" class="hidden" style="margin-top:6px; border-radius:16px; overflow:hidden; border:1px solid rgba(0,0,0,.08); box-shadow:0 12px 30px rgba(0,0,0,.10);">
              <video id="shareCamVideo" playsinline muted style="width:100%; height:240px; object-fit:cover; display:block;"></video>
            </div>

            <div style="font-size:12px; color:var(--muted); line-height:1.55;">
               QRURL/
            </div>
          </div>
        `;
      }

      function _escHtml(s){
        return String(s ?? "")
          .replaceAll("&","&amp;")
          .replaceAll("<","&lt;")
          .replaceAll(">","&gt;")
          .replaceAll('"',"&quot;")
          .replaceAll("'","&#39;");
      }

      function _setShareError(msg){
        const elErr = document.getElementById("shareErr");
        if (!elErr) return;
        elErr.textContent = String(msg || "");
        elErr.style.display = msg ? "block" : "none";
      }

      function _setShareStatus(txt){
        const sub = document.getElementById("shareCodeSub");
        if (sub) sub.textContent = String(txt || "");
      }

      let _shareTimerId = null;

      async function shareCurrentPreset(presetId){
        // Accept being used as an event handler
        if (presetId && typeof presetId === "object") presetId = null;

        // Resolve preset
        let presetObj = presetId ? getPresetById(presetId) : null;
        if (!presetId){
          const fallbackId = (typeof getActivePresetId === "function") ? getActivePresetId() : (state.activePresetId || state.presetId || state.preset);
          if (fallbackId){
            presetId = fallbackId;
            presetObj = getPresetById(presetId);
          }
        }

        // Always open UI first (no silent failures)
        const nameForUi = (presetObj && presetObj.name) ? presetObj.name : "My Preset";
        uiHtml(_shareModalHtml(nameForUi, _isoDate()), { title: "Share Preset", wide: true });

        // Elements
        const codeEl = document.getElementById("shareCode");
        const expiresEl = document.getElementById("shareExpires");
        const qrImgEl = document.getElementById("shareQrImg");
        const qrStatusEl = document.getElementById("shareQrStatus");
        const errEl = document.getElementById("shareErr");
        const statusEl = document.getElementById("shareStatusMsg");
        const copyCodeBtn = document.getElementById("shareCopyCode");
        const copyUrlBtn = document.getElementById("shareCopyUrl");
        const debugEl = document.getElementById("shareDebug");

        const setErr = (msg) => {
          if (!errEl) return;
          const m = (msg || "").trim();
          if (!m){
            errEl.style.display = "none";
            errEl.textContent = "";
            return;
          }
          errEl.style.display = "block";
          errEl.textContent = m;
        };
        const setStatus = (msg) => {
          if (!statusEl) return;
          statusEl.textContent = msg || "";
        };

        const dbg = {
          presetId: String(presetId || ""),
          endpoint: _shareCreateUrl(),
          fetch: "idle",
          status: "-",
          preview: "",
          rendered: false,
        };
        const dbgRender = () => {
          if (!debugEl) return;
          debugEl.textContent =
            "Debug\n" +
            "presetId: " + (dbg.presetId || "-") + "\n" +
            "create: " + (dbg.endpoint || "-") + "\n" +
            "fetch: " + dbg.fetch + "\n" +
            "status: " + dbg.status + "\n" +
            "preview: " + (dbg.preview || "-") + "\n" +
            "rendered: " + (dbg.rendered ? "true" : "false");
        };
        dbgRender();

        // Bind copy buttons (overwrite each open)
        if (copyCodeBtn){
          copyCodeBtn.onclick = async () => {
            const code = (codeEl && codeEl.textContent) ? codeEl.textContent.trim() : "";
            if (!code || code.includes("") || code.includes("") || code.includes("")){
              uiToast("");
              return;
            }
            const ok = await _copyText(code);
            uiToast(ok ? "" : "");
          };
        }
        if (copyUrlBtn){
          copyUrlBtn.onclick = async () => {
            const url = (window.__shareCurrentUrl || "").trim();
            if (!url){
              uiToast("URL");
              return;
            }
            const ok = await _copyText(url);
            uiToast(ok ? "" : "");
          };
        }

        // Reset UI state
        setStatus("");
        setErr("");
        if (codeEl) codeEl.textContent = " ";
        if (expiresEl) expiresEl.textContent = "Expires in --:--";
        if (qrStatusEl) qrStatusEl.style.display = "block";
        if (qrImgEl) qrImgEl.style.display = "none";
        window.__shareCurrentUrl = "";
        if (copyCodeBtn) copyCodeBtn.disabled = true;
        if (copyUrlBtn) copyUrlBtn.disabled = true;

        try {
          // Validate preset
          if (!presetId || !presetObj){
            throw new Error("");
          }
          if (presetObj.builtin){
            throw new Error(" My Preset ");
          }
          dbg.presetId = String(presetId);
          dbgRender();

          // Cache
          const cached = _shareCacheGet(presetId);
          if (cached && cached.code && cached.shareUrl && cached.expiresAt && cached.expiresAt > Date.now() + 2000){
            dbg.fetch = "cache";
            dbg.status = "cached";
            dbg.preview = JSON.stringify({ code: cached.code, expiresAt: cached.expiresAt }).slice(0, 120);
            window.__shareCurrentUrl = cached.shareUrl;
            _renderShareResult(cached.code, cached.shareUrl, cached.expiresAt);
            if (copyCodeBtn) copyCodeBtn.disabled = false;
            if (copyUrlBtn) copyUrlBtn.disabled = false;
            dbg.rendered = true;
            dbgRender();
            _startShareTimer(presetId);
            return;
          }

          // Create
          dbg.fetch = "started";
          dbgRender();
          const payload = {
            schemaVersion: 1,
            appVersion: APP_VERSION,
            createdAt: Date.now(),
            preset: { name: presetObj.name, modes: presetObj.modes, words: presetObj.words }
          };

          const res = await fetchWithTimeout(_shareCreateUrl(), {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          }, 8000);

          const text = await res.text();
          dbg.status = String(res.status);
          dbg.preview = text.slice(0, 120);
          dbgRender();

          if (!res.ok){
            throw new Error(`HTTP ${res.status}: ${text.slice(0, 200)}`);
          }

          let resp;
          try { resp = JSON.parse(text); } catch (e) { throw new Error("JSON parse failed: " + text.slice(0, 200)); }
          if (!resp || !resp.code || !resp.shareUrl || !resp.expiresAt){
            throw new Error("Invalid response: " + text.slice(0, 200));
          }

          _shareCacheSet(presetId, { code: resp.code, shareUrl: resp.shareUrl, expiresAt: resp.expiresAt, createdAt: Date.now() });
          window.__shareCurrentUrl = resp.shareUrl;
          _renderShareResult(resp.code, resp.shareUrl, resp.expiresAt);
          if (copyCodeBtn) copyCodeBtn.disabled = false;
          if (copyUrlBtn) copyUrlBtn.disabled = false;

          dbg.fetch = "ok";
          dbg.rendered = true;
          dbgRender();
          _startShareTimer(presetId);
        } catch (e){
          dbg.fetch = "failed";
          dbg.preview = String((e && (e.message || e)) || "error").slice(0, 120);
          dbgRender();
          setStatus("");
          setErr(String((e && (e.message || e)) || e));
        }
      }

      function _renderShareResult(code, shareUrl, expiresAt){
        const codeEl = document.getElementById("shareCode");
        if (codeEl){
          const c = String(code).toUpperCase();
          codeEl.textContent = (c.slice(0,3) + " " + c.slice(3));
        }
        window.__shareExpiresAt = Number(expiresAt) || 0;
        _setShareStatus("");
        _updateShareCountdown();
        _renderShareQR(shareUrl);
      }

      function _renderShareQR(shareUrl){
        const img = document.getElementById("shareQrImg");
        const status = document.getElementById("shareQrStatus");
        if (!img) return;
        if (status) status.textContent = "QR";
        img.style.display = "none";
        const url = "https://api.qrserver.com/v1/create-qr-code/?size=240x240&data=" + encodeURIComponent(String(shareUrl));
        let done = false;
        const to = setTimeout(() => {
          if (done) return;
          done = true;
          img.style.display = "none";
          if (status) status.textContent = "QR";
        }, 5000);
        img.onload = () => {
          if (done) return;
          done = true;
          clearTimeout(to);
          img.style.display = "";
          if (status) status.textContent = "";
        };
        img.onerror = () => {
          if (done) return;
          done = true;
          clearTimeout(to);
          img.style.display = "none";
          if (status) status.textContent = "QR";
        };
        img.src = url;
      }

      function _updateShareCountdown(){
        const expEl = document.getElementById("shareExpires");
        if (!expEl) return;
        const exp = Number(window.__shareExpiresAt) || 0;
        if (!exp){ expEl.textContent = "Expires in --:--"; return; }
        const ms = exp - Date.now();
        if (ms <= 0){ expEl.textContent = "Expires in 00:00"; return; }
        const s = Math.floor(ms/1000);
        const mm = String(Math.floor(s/60)).padStart(2,"0");
        const ss = String(s%60).padStart(2,"0");
        expEl.textContent = "Expires in " + mm + ":" + ss;
      }

      function _startShareTimer(presetId){
        _stopShareTimer();
        if (!presetId) return;

        const tick = () => {
          try {
            if (!(uiModal && uiModal.root && uiModal.root.classList.contains("is-open"))){
              _stopShareTimer();
              return;
            }
            const entry = _shareCacheGet(presetId);
            if (!entry || !entry.expiresAt){
              _stopShareTimer();
              return;
            }
            _updateShareCountdown(entry.expiresAt);
            if (entry.expiresAt <= Date.now()){
              _shareCacheSet(presetId, null);
              _stopShareTimer();
              // Auto regenerate while the panel is open
              shareCurrentPreset(presetId);
            }
          } catch (e){
            _stopShareTimer();
          }
        };

        tick();
        _shareTimerId = setInterval(tick, 1000);
      }

      function _stopShareTimer(){
        if (_shareTimerId){
          clearInterval(_shareTimerId);
          _shareTimerId = null;
        }
      }

      async function importPresetByCode(codeRaw){
        const code = _extractShareCode(codeRaw);
        if (!/^[A-Z0-9]{6}$/.test(code)){
          throw new Error("6");
        }
        const data = await _fetchJsonWithTimeout(_shareGetUrl(code), { method:"GET" }, 12000);
        if (data && data.error){
          const err = String(data.error || "");
          if (err === "VERSION_MISMATCH") throw new Error("");
          if (err === "EXPIRED") throw new Error("");
          if (err === "NOT_FOUND") throw new Error("");
          throw new Error("");
        }
        const preset = data?.preset;
        if (!preset || typeof preset !== "object") throw new Error("");

        const list = loadPresets();
        const nameBase = String(preset.name || "Shared Preset");
        const name = _uniquePresetName(nameBase, list);

        const wordsRaw = Array.isArray(preset.words) ? preset.words : [];
        const words = [];
        for (const w of wordsRaw){
          const n = normalizeWordEntry(w);
          if (n) words.push(n);
        }
        words.sort((a,b)=>a.id-b.id);

        const modes = preset.modes && typeof preset.modes === "object" ? preset.modes : { SEQ:true, RND:true, HAND:true, CHOICE:true };

        const newPreset = {
          id: newId(),
          name,
          builtin: false,
          modes: { SEQ:!!modes.SEQ, RND:!!modes.RND, HAND:!!modes.HAND, CHOICE:!!modes.CHOICE },
          words
        };
        list.unshift(newPreset);
        savePresets(list);
        refreshPresetList();
        selectPresetForEdit(newPreset.id);
        setActivePreset(newPreset.id);
        return newPreset;
      }

      function openShareImport(){
        uiHtml(_importModalHtml(), { title:"Import Preset", okText:"" });

        _runIdle(() => {
          const input = document.getElementById("shareImportCode");
          const fetchBtn = document.getElementById("shareImportFetchBtn");
          const camBtn = document.getElementById("shareImportCamBtn");
          const camStopBtn = document.getElementById("shareImportCamStopBtn");
          const status = document.getElementById("shareImportStatus");
          const camWrap = document.getElementById("shareCamWrap");
          const video = document.getElementById("shareCamVideo");

          let stream = null;
          let loopTimer = null;
          let camTimeout = null;

          const stopCam = () => {
            try{ if (loopTimer) clearInterval(loopTimer); }catch{}
            loopTimer = null;
            try{ if (camTimeout) clearTimeout(camTimeout); }catch{}
            camTimeout = null;
            try{
              if (stream){
                for (const t of stream.getTracks()) t.stop();
              }
            }catch{}
            stream = null;
            if (camWrap) camWrap.classList.add("hidden");
            if (camStopBtn) camStopBtn.classList.add("hidden");
            if (camBtn) camBtn.classList.remove("hidden");
            if (status) status.textContent = "";
          };

          uiModalOnClose(stopCam);

          if (input){
            input.addEventListener("input", () => {
              const raw = input.value;
              input.value = _extractShareCode(raw);
            });
            setTimeout(()=>{ try{ input.focus(); }catch{} }, 0);
          }

          const doImport = async () => {
            if (!status) return;
            const raw = input ? input.value : "";
            const code = _extractShareCode(raw);
            status.textContent = "";
            try{
              const p = await importPresetByCode(code);
              status.textContent = `${p.name}`;
            }catch(err){
              status.textContent = "";
              uiAlert((err && err.message) ? err.message : "", { title:"Import Preset" });
            }
          };

          if (fetchBtn){
            fetchBtn.onclick = () => { doImport(); };
          }

          if (camBtn && camWrap && video && camStopBtn){
            camBtn.onclick = async () => {
              try{
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
                  uiAlert("", { title:"Import Preset" });
                  return;
                }
                if (status) status.textContent = "";
                stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }, audio: false });
                video.srcObject = stream;
                await video.play();

                camWrap.classList.remove("hidden");
                camBtn.classList.add("hidden");
                camStopBtn.classList.remove("hidden");
                if (status) status.textContent = "";

                const hasBd = ("BarcodeDetector" in window);
                const hasJsqr = (typeof window.jsQR === "function");
                let detector = null;
                if (hasBd){
                  try{ detector = new BarcodeDetector({ formats: ["qr_code"] }); }catch{}
                }
                if (!detector && !hasJsqr){
                  stopCam();
                  uiAlert("QR", { title:"Import Preset" });
                  return;
                }

                const cv = document.createElement("canvas");
                const ctx = cv.getContext("2d", { willReadFrequently:true });

                loopTimer = setInterval(async () => {
                  if (!video || video.readyState < 2) return;
                  try{
                    let rawVal = "";
                    if (detector){
                      const codes = await detector.detect(video);
                      if (codes && codes.length) rawVal = codes[0].rawValue || "";
                    } else if (hasJsqr && ctx){
                      const w = video.videoWidth || 0;
                      const h = video.videoHeight || 0;
                      if (!w || !h) return;
                      cv.width = w;
                      cv.height = h;
                      ctx.drawImage(video, 0, 0, w, h);
                      const img = ctx.getImageData(0, 0, w, h);
                      const qr = window.jsQR(img.data, w, h, { inversionAttempts: "dontInvert" });
                      if (qr && qr.data) rawVal = qr.data;
                    }
                    const code = _extractShareCode(rawVal);
                    if (code){
                      if (input) input.value = code;
                      stopCam();
                      if (status) status.textContent = "";
                      doImport();
                    }
                  }catch{}
                }, detector ? 320 : 420);

                camTimeout = setTimeout(() => {
                  stopCam();
                  uiAlert("", { title:"Import Preset" });
                }, 20000);

              }catch(err){
                stopCam();
                uiAlert("", { title:"Import Preset" });
              }
            };

            camStopBtn.onclick = () => stopCam();
          }
        });
      }


      function openPresetManager(createNew){
        presetOverlay.classList.remove("hidden");
        refreshPresetList();

        const list = loadPresets();

        // If no user presets exist yet, create one immediately so the editor is usable.
        if (!list.length){
          createNewPreset();
          return;
        }

        if (createNew){
          createNewPreset();
          return;
        }

        const pid = getActivePresetId();
        if (!isBuiltinPreset(pid) && list.some(p => p.id === pid)){
          selectPresetForEdit(pid);
        } else {
          selectPresetForEdit(list[0].id);
        }
      }
      function closePresetManager(){
        presetOverlay.classList.add("hidden");
      }

      presetCloseBtn?.addEventListener("click", closePresetManager);
      presetCloseBtn2?.addEventListener("click", closePresetManager);
      presetOverlay?.addEventListener("click", (e)=>{ if (e.target === presetOverlay) closePresetManager(); });

      function newId(){
        return "custom:" + Math.random().toString(36).slice(2,10) + Date.now().toString(36).slice(-4);
      }

      function presetMetaText(p){
        const m = p.modes || {};
        const parts = [];
        if (m.SEQ) parts.push("");
        if (m.RND) parts.push("");
        if (m.HAND) parts.push("");
        if (m.CHOICE) parts.push("");
        return parts.length ? parts.join(" / ") : "";
      }

      function refreshPresetList(){
        const list = loadPresets();
        presetListEl.innerHTML = "";

        const builtins = [
          {id:"builtin:A", name:"0200"},
          {id:"builtin:B", name:"200400"},
          {id:"builtin:C", name:"400600"},
          {id:"builtin:ALL", name:"ALL"}
        ];
        for (const b of builtins){
          const row = document.createElement("div");
          row.className = "preset-item";
          row.innerHTML = `
            <div class="left">
              <div class="title">${escapeHtml(b.name)}</div>
              <p class="meta"></p>
            </div>
            <div style="display:flex; gap:8px;">
              <button class="textbtn" data-use="${b.id}"></button>
            </div>`;
          presetListEl.appendChild(row);
        }

        if (!list.length){
          const empty = document.createElement("div");
          empty.className = "preset-item";
          empty.innerHTML = `<div class="left"><div class="title">My Preset </div><p class="meta"></p></div></div>`;
          presetListEl.appendChild(empty);
        } else {
          for (const p of list){
            const wc = Array.isArray(p.words) ? p.words.length : 0;
            const row = document.createElement("div");
            row.className = "preset-item";
            row.innerHTML = `
              <div class="left">
                <div class="title">${escapeHtml(p.name || "My Preset")}</div>
                <p class="meta">: ${wc} / : ${escapeHtml(presetMetaText(p))}</p>
              </div>
              <div style="display:flex; gap:8px; align-items:center;">
                <button class="textbtn" data-use="${p.id}"></button>
                <button class="textbtn" data-edit="${p.id}"></button>
              </div>`;
            presetListEl.appendChild(row);
          }
        }

        presetListEl.querySelectorAll("button[data-use]").forEach(btn=>{
          btn.addEventListener("click", ()=>{
            const id = btn.getAttribute("data-use");
            if (id === "builtin:A") setDeck("A");
            else if (id === "builtin:B") setDeck("B");
            else if (id === "builtin:ALL") setDeck("ALL");
            else setActivePreset(id);
            closePresetManager();
          });
        });
        presetListEl.querySelectorAll("button[data-edit]").forEach(btn=>{
          btn.addEventListener("click", ()=> selectPresetForEdit(btn.getAttribute("data-edit")));
        });

        syncPresetUI();
      }

      function createNewPreset(){
        const list = loadPresets();
        const id = newId();
        const p = {
          id,
          name: "My Preset",
          builtin: false,
          modes: { SEQ:true, RND:true, HAND:true, CHOICE:true },
          words: []
        };
        list.unshift(p);
        savePresets(list);
        refreshPresetList();
        selectPresetForEdit(id);
      }

      presetNewBtn?.addEventListener("click", createNewPreset);

      function selectPresetForEdit(pid){
        const list = loadPresets();
        const p = list.find(x=>x.id===pid) || null;
        editingPresetId = p ? p.id : null;

        presetNameInput.value = p ? (p.name || "") : "";
        const m = p?.modes || {SEQ:true,RND:true,HAND:true,CHOICE:true};
        presetModeSeq.checked = !!m.SEQ;
        presetModeRnd.checked = !!m.RND;
        presetModeHand.checked = !!m.HAND;
        presetModeChoice.checked = !!m.CHOICE;

        wordIdInput.value = "";
        wordWordInput.value = "";
        wordMeaningInput.value = "";
        clearMcqForm();
        bulkTextarea.value = "";

        const disabled = !p;
        presetSaveBtn.disabled = disabled;
        presetDeleteBtn.disabled = disabled;
        presetExportBtn.disabled = disabled;
        presetClearWordsBtn.disabled = disabled;
        bulkAddBtn.disabled = disabled;
        wordUpsertBtn.disabled = disabled;

        renderWordsPreview(p ? p.words : []);

        if (presetShareBtn) presetShareBtn.disabled = !p || !!p.builtin;
      }

      function renderWordsPreview(words){
        const list = Array.isArray(words) ? words : [];
        const map = new Map();
        for (const it of list){
          const n = normalizeWordEntry(it);
          if (!n) continue;
          map.set(n.id, n);
        }
        const arr = Array.from(map.values()).sort((a,b)=>a.id-b.id);
        presetWordsPreview.innerHTML = "";
        if (!arr.length){
          presetWordsPreview.innerHTML = `<div class="note"></div>`;
          return;
        }
        for (const w of arr.slice(0,50)){
          const row = document.createElement("div");
          row.className = "preset-item";
          row.innerHTML = `
            <div class="left">
              <div class="title">No.${w.id}  ${escapeHtml(w.word)}</div>
              <p class="meta">${escapeHtml(w.meaning)}</p>
            </div>
            <div style="display:flex; gap:8px; flex-wrap:wrap;">
              <button class="textbtn" data-editword="${w.id}"></button>
              <button class="textbtn" data-delword="${w.id}"></button>
            </div>`;
          presetWordsPreview.appendChild(row);
        }

        presetWordsPreview.querySelectorAll("button[data-delword]").forEach(btn=>{
          btn.addEventListener("click", ()=>{
            if (!editingPresetId) return;
            const delId = Number(btn.getAttribute("data-delword"));
            if (!Number.isFinite(delId)) return;
            const list = loadPresets();
            const p = list.find(x=>x.id===editingPresetId);
            if (!p) return;
            p.words = (p.words || []).filter(x => Number(x.id) !== delId);
            savePresets(list);
            selectPresetForEdit(editingPresetId);
            refreshPresetList();
          });
        });
        presetWordsPreview.querySelectorAll("button[data-editword]").forEach(btn=>{
          btn.addEventListener("click", ()=>{
            if (!editingPresetId) return;
            const id = Number(btn.getAttribute("data-editword"));
            const list = loadPresets();
            const p = list.find(x=>x.id===editingPresetId);
            if (!p) return;
            const map = new Map();
            for (const it of (p.words || [])){
              const n = normalizeWordEntry(it);
              if (n) map.set(n.id, n);
            }
            const w = map.get(id);
            if (!w) return;
            wordIdInput.value = String(w.id);
            wordWordInput.value = w.word;
            wordMeaningInput.value = w.meaning;
            clearMcqForm();
            if (w.mcq && Array.isArray(w.mcq.choices) && w.mcq.choices.length){
              if (mcqEnable) mcqEnable.checked = true;
              setMcqVisible(true);
              for (let i=0;i<mcqChoices.length;i++){
                const v = w.mcq.choices?.[i];
                if (mcqChoices[i]) mcqChoices[i].value = (v == null ? "" : String(v));
              }
              const ci = Number(w.mcq.correctIndex);
              if (Number.isInteger(ci) && mcqRadios[ci]) mcqRadios[ci].checked = true;
            }
          });
        });
      }

      presetSaveBtn?.addEventListener("click", ()=>{
        if (!editingPresetId) return;
        const list = loadPresets();
        const p = list.find(x=>x.id===editingPresetId);
        if (!p) return;
        p.name = presetNameInput.value.trim() || "My Preset";
        p.modes = {
          SEQ: !!presetModeSeq.checked,
          RND: !!presetModeRnd.checked,
          HAND: !!presetModeHand.checked,
          CHOICE: !!presetModeChoice.checked
        };
        savePresets(list);
        refreshPresetList();
        if (getActivePresetId() === editingPresetId) renderAll();
      });

      presetDeleteBtn?.addEventListener("click", async ()=>{
        if (!editingPresetId) return;
        const ok = await uiConfirm("", { title: "", okText: "", cancelText: "", danger: true });
        if (!ok) return;
        const list = loadPresets().filter(x => x.id !== editingPresetId);
        savePresets(list);
        if (getActivePresetId() === editingPresetId){
          setDeck("A");
        }
        editingPresetId = null;
        selectPresetForEdit(null);
        refreshPresetList();
      });

      presetExportBtn?.addEventListener("click", ()=>{
        if (!editingPresetId) return;
        const list = loadPresets();
        const p = list.find(x=>x.id===editingPresetId);
        if (!p) return;
        const blob = new Blob([JSON.stringify(p, null, 2)], {type:"application/json"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = (p.name || "preset").replace(/[^\w\-]+/g,"_") + ".json";
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      });

      presetImportBtn?.addEventListener("click", ()=> presetImportFile?.click());
      presetShareBtn?.addEventListener("click", ()=> shareCurrentPreset(editingPresetId));
      presetShareImportBtn?.addEventListener("click", openShareImport);
      presetImportFile?.addEventListener("change", async ()=>{
        const file = presetImportFile.files && presetImportFile.files[0];
        if (!file) return;
        try{
          const text = await file.text();
          const obj = JSON.parse(text);
          const list = loadPresets();
          let p = null;
          if (Array.isArray(obj)){
            p = { id:newId(), name:"Imported Preset", builtin:false, modes:{SEQ:true,RND:true,HAND:true,CHOICE:true}, words:obj };
          } else if (obj && typeof obj === "object"){
            p = {
              id: newId(),
              name: String(obj.name || "Imported Preset"),
              builtin: false,
              modes: obj.modes && typeof obj.modes === "object" ? {
                SEQ: !!obj.modes.SEQ, RND: !!obj.modes.RND, HAND: !!obj.modes.HAND, CHOICE: !!obj.modes.CHOICE
              } : {SEQ:true,RND:true,HAND:true,CHOICE:true},
              words: Array.isArray(obj.words) ? obj.words : []
            };
          }
          if (!p) throw new Error("invalid");
          list.unshift(p);
          savePresets(list);
          refreshPresetList();
          selectPresetForEdit(p.id);
        }catch{
          uiAlert("JSON");
        }finally{
          presetImportFile.value = "";
        }
      });

      function parseLineToWord(line){
        const s = String(line||"").trim();
        if (!s) return null;
        const m = s.match(/^(\d+)\s+(.+)$/);
        if (!m) return null;
        const id = Number(m[1]);
        const rest = m[2];

        // Split at the earliest likely start of meaning:
        // - first Japanese character, OR
        // - the '' marker (commonly used at the beginning of meanings like "")
        const jp = rest.search(PRESET_JP_REGEX);
        const tilde = rest.indexOf("");
        let idx = jp;
        if (tilde !== -1 && (idx === -1 || tilde < idx)) idx = tilde;

        if (idx <= 0) return null;
        const word = rest.slice(0, idx).trim();
        const meaning = rest.slice(idx).trim();
        return normalizeWordEntry({id, word, meaning});
      }

      bulkAddBtn?.addEventListener("click", ()=>{
        if (!editingPresetId) return;
        const lines = bulkTextarea.value.split(/\r?\n/);
        const adds = [];
        for (const ln of lines){
          const w = parseLineToWord(ln);
          if (w) adds.push(w);
        }
        if (!adds.length) return;
        const list = loadPresets();
        const p = list.find(x=>x.id===editingPresetId);
        if (!p) return;
        const map = new Map();
        for (const it of (p.words || [])){
          const n = normalizeWordEntry(it);
          if (n) map.set(n.id, n);
        }
        for (const a of adds) map.set(a.id, a);
        p.words = Array.from(map.values()).sort((a,b)=>a.id-b.id);
        savePresets(list);
        selectPresetForEdit(editingPresetId);
        refreshPresetList();
      });

      bulkClearBtn?.addEventListener("click", ()=>{ bulkTextarea.value=""; });

      presetClearWordsBtn?.addEventListener("click", async ()=>{
        if (!editingPresetId) return;
        const ok = await uiConfirm("", { title: "", okText: "", cancelText: "", danger: true });
        if (!ok) return;
        const list = loadPresets();
        const p = list.find(x=>x.id===editingPresetId);
        if (!p) return;
        p.words = [];
        savePresets(list);
        selectPresetForEdit(editingPresetId);
        refreshPresetList();
      });

      wordClearBtn?.addEventListener("click", ()=>{
        wordIdInput.value = "";
        wordWordInput.value = "";
        wordMeaningInput.value = "";
        clearMcqForm();
      });

      wordUpsertBtn?.addEventListener("click", ()=>{
        if (!editingPresetId) return;
        const id = Number(wordIdInput.value.trim());
        const word = wordWordInput.value.trim();
        const meaning = wordMeaningInput.value.trim();

        const mcq = getMcqFromForm(meaning);
        if (mcq && mcq.__invalid) return;

        const n = normalizeWordEntry({id, word, meaning, mcq});
        if (!n){ uiAlert("id//"); return; }
        const list = loadPresets();
        const p = list.find(x=>x.id===editingPresetId);
        if (!p) return;
        const map = new Map();
        for (const it of (p.words || [])){
          const nn = normalizeWordEntry(it);
          if (nn) map.set(nn.id, nn);
        }
        map.set(n.id, n);
        p.words = Array.from(map.values()).sort((a,b)=>a.id-b.id);
        savePresets(list);
        wordIdInput.value = "";
        wordWordInput.value = "";
        wordMeaningInput.value = "";
        clearMcqForm();
        selectPresetForEdit(editingPresetId);
        refreshPresetList();
      });

      // =========================
      // Insights (analytics + dashboard)
      // =========================
      const INSIGHTS_SESSIONS_KEY = "wordPractice.analytics.sessions.v1";
      const INSIGHTS_MAX = 500;

      const insights = {
        open: false,
        preset: "CURRENT",
        mode: "ALL",
        range: "30D",
        currentPresetId: null,
        reduceMotion: window.matchMedia && window.matchMedia("(prefers-reduced-motion: reduce)").matches
      };

      let _insightsSessionsCache = null;
      let _insightsSessionsRev = 0;
      let _insightsFilteredCacheKey = "";
      let _insightsFilteredCache = null;
      const _insightsFilterCacheMap = new Map();

      function _insightsLoadSessions(){
        if (_insightsSessionsCache) return _insightsSessionsCache;
        try{
          const raw = localStorage.getItem(INSIGHTS_SESSIONS_KEY);
          const arr = raw ? JSON.parse(raw) : [];
          const list = Array.isArray(arr) ? arr : [];
          list.sort((a,b)=>(Number(a?.ts)||0)-(Number(b?.ts)||0));
          _insightsSessionsCache = list.slice(-INSIGHTS_MAX);
          _insightsSessionsRev++;
          return _insightsSessionsCache;
        }catch{
          _insightsSessionsCache = [];
          _insightsSessionsRev++;
          return _insightsSessionsCache;
        }
      }
      function _insightsSaveSessions(arr){
        try{
          const list = Array.isArray(arr) ? arr.slice(-INSIGHTS_MAX) : [];
          list.sort((a,b)=>(Number(a?.ts)||0)-(Number(b?.ts)||0));
          _insightsSessionsCache = list;
          _insightsSessionsRev++;
          _insightsFilteredCacheKey = "";
          _insightsFilteredCache = null;
          _insightsFilterCacheMap.clear();
          localStorage.setItem(INSIGHTS_SESSIONS_KEY, JSON.stringify(list));
        }catch{}
      }
      function _insightsMakeId(){
        return Math.random().toString(36).slice(2, 10);
      }
      function _insightsYmd(ts){
        try{
          const d = new Date(ts);
          const y = d.getFullYear();
          const m = String(d.getMonth()+1).padStart(2,"0");
          const da = String(d.getDate()).padStart(2,"0");
          return `${y}-${m}-${da}`;
        }catch{ return ""; }
      }
      function _insightsFormatTs(ts){
        try{
          const d = new Date(ts);
          const ymd = _insightsYmd(ts);
          const hh = String(d.getHours()).padStart(2,"0");
          const mm = String(d.getMinutes()).padStart(2,"0");
          return `${ymd} ${hh}:${mm}`;
        }catch{ return ""; }
      }
      function _insightsClamp(n,min,max){ return Math.max(min, Math.min(max, n)); }

      function _insightsGetPresetMeta(){
        let presetId = null;
        try{
          presetId = (typeof getActivePresetId === "function") ? getActivePresetId() : (state.presetId || `builtin:${state.deck}`);
        }catch{
          presetId = state.presetId || `builtin:${state.deck}`;
        }
        let presetName = "";
        try{
          if (typeof getPresetById === "function"){
            presetName = getPresetById(presetId)?.name || "";
          }
        }catch{}
        if (!presetName){
          try{ presetName = deckLabel(state.deck); }catch{}
        }
        return { presetId, presetName };
      }

      function _insightsAppendSession(session){
        const sessions = _insightsLoadSessions();
        sessions.push(session);
        while (sessions.length > INSIGHTS_MAX) sessions.shift();
        _insightsSaveSessions(sessions);
      }

      function _insightsStartSession(mode){
        state._insightsStartTs = Date.now();
        state._insightsLogged = false;
        state._insightsStartMode = mode;
        const meta = _insightsGetPresetMeta();
        state._insightsStartPresetId = meta.presetId;
        state._insightsStartPresetName = meta.presetName;
      }

      function _insightsTryLogResult(kind){
        const mode = kind || state.mode;
        if (mode !== "HAND" && mode !== "CHOICE") return;
        if (state._insightsLogged) return;

        let total = 0;
        let correct = 0;
        let wrongIds = [];

        if (mode === "CHOICE"){
          total = state.choice?.results?.length || 0;
          correct = state.choice?.correctCount || 0;
          const wrong = (state.choice?.results || []).filter(r => !r.correct);
          wrongIds = wrong.map(r => Number(r.id)).filter(n => Number.isFinite(n));
        } else {
          total = state.hand?.results?.length || 0;
          correct = state.hand?.scoreCorrect || 0;
          const wrong = (state.hand?.results || []).filter(r => !r.correct);
          wrongIds = wrong.map(r => Number(r.id)).filter(n => Number.isFinite(n));
        }

        const startTs = Number(state._insightsStartTs);
        const durationMs = Number.isFinite(startTs) ? Math.max(0, Date.now() - startTs) : null;

        const presetId = state._insightsStartPresetId || _insightsGetPresetMeta().presetId;
        const presetName = state._insightsStartPresetName || _insightsGetPresetMeta().presetName;

        const accuracy = total > 0 ? (correct / total) : null;

        const sess = {
          id: _insightsMakeId(),
          ts: Date.now(),
          date: _insightsYmd(Date.now()),
          presetId: String(presetId || ""),
          presetName: String(presetName || ""),
          mode: String(mode),
          total: Number(total) || 0,
          correct: Number(correct) || 0,
          accuracy: (accuracy == null ? null : Number(accuracy)),
          durationMs: (durationMs == null ? null : Number(durationMs)),
          wrongIds: Array.isArray(wrongIds) ? wrongIds : [],
          timedOutCount: (mode === "CHOICE")
            ? (state.choice?.results || []).filter(r => !!r && r.timedOut === true).length
            : null
        };

        _insightsAppendSession(sess);
        state._insightsLogged = true;
      }

      // Hook: start timestamps
      const _startModeOrig = startMode;
      startMode = function(mode){
        if (mode === "HAND") _insightsStartSession("HAND");
        return _startModeOrig(mode);
      };
      const _startChoiceModeOrig = startChoiceMode;
      startChoiceMode = function(timeLimitSec){
        _insightsStartSession("CHOICE");
        return _startChoiceModeOrig(timeLimitSec);
      };

      // Hook: log at result transition
      const _goResultOrig = goResult;
      goResult = function(kind){
        try{ _insightsTryLogResult(kind || state.mode); }catch{}
        return _goResultOrig(kind);
      };

      // Dashboard elements
      const insightsEl = {
        btn: document.getElementById("insightsBtn"),
        overlay: document.getElementById("insightsOverlay"),
        close: document.getElementById("insightsCloseBtn"),
        presetSel: document.getElementById("insightsPresetSelect"),
        modeSel: document.getElementById("insightsModeSelect"),
        rangeSel: document.getElementById("insightsRangeSelect"),
        summary: document.getElementById("insightsSummary"),
        trend: document.getElementById("chartAccuracyTrend"),
        trendNote: document.getElementById("trendNote"),
        modeCard: document.getElementById("modeAccuracyCard"),
        modeChart: document.getElementById("chartModeAccuracy"),
        weak: document.getElementById("chartWeakTop10"),
        dailyVolume: document.getElementById("chartDailyVolume"),
        dailyAccuracy: document.getElementById("chartDailyAccuracy"),
        modeDistribution: document.getElementById("tableModeDistribution"),
        avgTimeTrend: document.getElementById("chartAvgTimeTrend"),
        timeoutByMode: document.getElementById("tableTimeoutByMode"),
        weekCompare: document.getElementById("tableWeekCompare"),
        monthCompare: document.getElementById("tableMonthCompare"),
        exportBtn: document.getElementById("insightsExportBtn"),
        deleteBtn: document.getElementById("insightsDeleteBtn"),
      };

      function _insightsIsOpen(){ return insightsEl.overlay && !insightsEl.overlay.classList.contains("hidden"); }

      function _insightsOpen(){
        if (!insightsEl.overlay) return;
        insights.open = true;

        insights.preset = "CURRENT";
        insights.mode = "ALL";
        insights.range = "30D";

        insights.currentPresetId = _insightsGetPresetMeta().presetId;

        _insightsBuildPresetOptions();
        if (insightsEl.modeSel) insightsEl.modeSel.value = "ALL";
        if (insightsEl.rangeSel) insightsEl.rangeSel.value = "30D";

        insightsEl.overlay.classList.remove("hidden");
        insightsEl.overlay.setAttribute("aria-hidden", "false");

        _insightsRenderAll();
      }

      function _insightsClose(){
        if (!insightsEl.overlay) return;
        insights.open = false;
        insightsEl.overlay.classList.add("hidden");
        insightsEl.overlay.setAttribute("aria-hidden", "true");
      }

      function _insightsBuildPresetOptions(){
        if (!insightsEl.presetSel) return;
        const sessions = _insightsLoadSessions();

        const ids = new Map();
        for (const s of sessions){
          if (s && typeof s.presetId === "string") ids.set(s.presetId, s.presetName || s.presetId);
        }

        const cur = insights.currentPresetId || _insightsGetPresetMeta().presetId;
        if (cur) ids.set(cur, _insightsGetPresetMeta().presetName || cur);

        const builtins = ["builtin:A","builtin:B","builtin:C","builtin:ALL"];
        for (const b of builtins){
          if (!ids.has(b)){
            try{
              const name = (typeof getPresetById === "function") ? (getPresetById(b)?.name || "") : "";
              if (name) ids.set(b, name);
            }catch{}
          }
        }

        insightsEl.presetSel.innerHTML = "";
        const optCur = document.createElement("option");
        optCur.value = "CURRENT";
        optCur.textContent = "CURRENT";
        insightsEl.presetSel.appendChild(optCur);

        const optAll = document.createElement("option");
        optAll.value = "ALL";
        optAll.textContent = "ALL";
        insightsEl.presetSel.appendChild(optAll);

        const sep = document.createElement("option");
        sep.disabled = true;
        sep.textContent = "";
        insightsEl.presetSel.appendChild(sep);

        const arr = Array.from(ids.entries()).map(([id,name]) => ({id, name}));
        arr.sort((a,b)=>{
          const ab = a.id.startsWith("builtin:");
          const bb = b.id.startsWith("builtin:");
          if (ab && !bb) return -1;
          if (!ab && bb) return 1;
          return String(a.name).localeCompare(String(b.name), "ja");
        });

        for (const it of arr){
          const o = document.createElement("option");
          o.value = it.id;
          o.textContent = it.name || it.id;
          insightsEl.presetSel.appendChild(o);
        }

        insightsEl.presetSel.value = "CURRENT";
      }

      function _insightsGetFilteredSessions(){
        const opts = {
          preset: insights.preset,
          mode: insights.mode,
          range: insights.range,
          currentPresetId: insights.currentPresetId || _insightsGetPresetMeta().presetId
        };
        return _insightsGetFilteredSessionsBy(opts);
      }

      function _insightsGetFilteredSessionsBy(opts = {}){
        const preset = String(opts.preset || "ALL");
        const mode = String(opts.mode || "ALL");
        const range = String(opts.range || "30D");
        const currentPresetId = String(opts.currentPresetId || _insightsGetPresetMeta().presetId || "");
        const pid = (preset === "CURRENT") ? currentPresetId : preset;
        const key = `${_insightsSessionsRev}|${range}|${pid}|${mode}`;
        if (_insightsFilterCacheMap.has(key)) return _insightsFilterCacheMap.get(key);

        let sessions = _insightsLoadSessions();
        const now = Date.now();
        let cutoff = null;
        if (range === "7D") cutoff = now - 7*86400000;
        if (range === "30D") cutoff = now - 30*86400000;
        if (cutoff != null) sessions = sessions.filter(s => (s?.ts ?? 0) >= cutoff);

        if (preset && preset !== "ALL"){
          sessions = sessions.filter(s => String(s?.presetId || "") === String(pid || ""));
        }
        if (mode && mode !== "ALL"){
          sessions = sessions.filter(s => String(s?.mode || "") === mode);
        }

        _insightsFilterCacheMap.set(key, sessions);
        _insightsFilteredCacheKey = key;
        _insightsFilteredCache = sessions;
        return sessions;
      }
      function _insightsRenderSummary(sessions){
        if (!insightsEl.summary) return;

        const count = sessions.length;
        const totalAnswers = sessions.reduce((acc,s)=>acc+(Number(s.total)||0),0);
        const totalCorrect = sessions.reduce((acc,s)=>acc+(Number(s.correct)||0),0);

        let avgAcc = null;
        if (totalAnswers > 0) avgAcc = totalCorrect / totalAnswers;

        const modeCounts = new Map();
        for (const s of sessions){
          const m = String(s.mode||"");
          if (!m) continue;
          modeCounts.set(m, (modeCounts.get(m)||0)+1);
        }
        let topMode = "";
        let topN = 0;
        for (const [m,n] of modeCounts.entries()){
          if (n > topN){ topN = n; topMode = m; }
        }

        const lastTs = sessions.reduce((mx,s)=>Math.max(mx, Number(s.ts)||0), 0);
        const lastText = lastTs ? _insightsFormatTs(lastTs) : "";

        const avgPct = (avgAcc == null) ? "" : `${Math.round(avgAcc*1000)/10}%`;

        insightsEl.summary.innerHTML = `
          <div class="summary-card"><div class="summary-k">Sessions</div><div class="summary-v">${count}</div></div>
          <div class="summary-card"><div class="summary-k">Answers</div><div class="summary-v">${totalAnswers}</div></div>
          <div class="summary-card"><div class="summary-k">Accuracy</div><div class="summary-v">${avgPct}</div></div>
          <div class="summary-card"><div class="summary-k">Top mode</div><div class="summary-v">${escapeHtml(topMode || "")}</div></div>
          <div class="summary-card"><div class="summary-k">Last</div><div class="summary-v">${escapeHtml(lastText)}</div></div>
        `;
      }

      function _svg(tag){ return document.createElementNS("http://www.w3.org/2000/svg", tag); }
      function _insModeName(m){
        if (m === "SEQ") return "TURN MODE";
        if (m === "RND") return "RUNDOM MODE";
        if (m === "CHOICE") return "EXAM MODE";
        if (m === "HAND") return "WRITE MODE";
        return String(m || "");
      }
      function _insNum(n){ return Number.isFinite(Number(n)) ? Number(n) : 0; }
      function _insFmtPct(num, den){
        if (!den) return "";
        return `${Math.round((num/den)*1000)/10}%`;
      }
      function _insFmtSec(v){
        if (!Number.isFinite(v)) return "";
        return `${Math.round(v*10)/10}`;
      }
      function _insBuildDaily(sessions){
        const map = new Map();
        for (const s of sessions){
          const ymd = String(s?.date || _insightsYmd(s?.ts || Date.now()));
          if (!ymd) continue;
          const b = map.get(ymd) || { ymd, sessions:0, total:0, correct:0, durationMs:0, durationAnswers:0, measuredTimeCount:0 };
          const t = _insNum(s?.total);
          const c = _insNum(s?.correct);
          b.sessions += 1;
          b.total += t;
          b.correct += c;
          const d = Number(s?.durationMs);
          if (Number.isFinite(d) && d > 0 && t > 0){
            b.durationMs += d;
            b.durationAnswers += t;
            b.measuredTimeCount += 1;
          }
          map.set(ymd, b);
        }
        return Array.from(map.values()).sort((a,b)=>String(a.ymd).localeCompare(String(b.ymd)));
      }
      function _insRenderLineChart(container, points, opts = {}){
        if (!container) return;
        container.innerHTML = "";
        if (!Array.isArray(points) || !points.length){
          container.innerHTML = `<div class="insight-empty">${escapeHtml(opts.emptyText || "")}</div>`;
          return;
        }
        const w=600, h=220;
        const padL=44, padR=14, padT=16, padB=34;
        const plotW = w - padL - padR;
        const plotH = h - padT - padB;
        const minY = Number.isFinite(opts.minY) ? opts.minY : 0;
        const maxY = Number.isFinite(opts.maxY) ? opts.maxY : 100;
        const svg = _svg("svg");
        svg.setAttribute("viewBox", `0 0 ${w} ${h}`);
        for (const gv of (opts.gridValues || [minY, (minY+maxY)/2, maxY])){
          const y = padT + (1 - ((gv-minY)/(maxY-minY||1)))*plotH;
          const line = _svg("line");
          line.setAttribute("x1", padL); line.setAttribute("x2", w-padR);
          line.setAttribute("y1", y); line.setAttribute("y2", y);
          line.setAttribute("class", "grid");
          svg.appendChild(line);
          const t = _svg("text");
          t.setAttribute("x", 10); t.setAttribute("y", y+4); t.setAttribute("class", "label");
          t.textContent = (typeof opts.yLabel === "function") ? opts.yLabel(gv) : String(Math.round(gv));
          svg.appendChild(t);
        }
        const ax = _svg("line");
        ax.setAttribute("x1", padL); ax.setAttribute("x2", padL);
        ax.setAttribute("y1", padT); ax.setAttribute("y2", h-padB); ax.setAttribute("class","axis");
        svg.appendChild(ax);
        const bx = _svg("line");
        bx.setAttribute("x1", padL); bx.setAttribute("x2", w-padR);
        bx.setAttribute("y1", h-padB); bx.setAttribute("y2", h-padB); bx.setAttribute("class","axis");
        svg.appendChild(bx);
        const n = points.length;
        const xFor = (idx)=> padL + (n===1 ? plotW/2 : (idx/(n-1))*plotW);
        const yFor = (v)=> padT + (1 - ((v-minY)/(maxY-minY||1)))*plotH;
        let d = "";
        for (let i=0;i<n;i++){
          const x = xFor(i);
          const y = yFor(points[i].v);
          d += (i===0 ? `M ${x} ${y}` : ` L ${x} ${y}`);
        }
        const path = _svg("path");
        path.setAttribute("d", d);
        path.setAttribute("class", "line");
        svg.appendChild(path);
        for (let i=0;i<n;i++){
          const c = _svg("circle");
          c.setAttribute("cx", xFor(i)); c.setAttribute("cy", yFor(points[i].v));
          c.setAttribute("r", 3); c.setAttribute("class", "dot");
          svg.appendChild(c);
        }
        const left = _svg("text");
        left.setAttribute("x", padL); left.setAttribute("y", h-10); left.setAttribute("class","label");
        left.textContent = points[0].label || "";
        svg.appendChild(left);
        const right = _svg("text");
        right.setAttribute("x", w-padR); right.setAttribute("y", h-10);
        right.setAttribute("text-anchor","end"); right.setAttribute("class","label");
        right.textContent = points[n-1].label || "";
        svg.appendChild(right);
        container.appendChild(svg);
      }
      function _insRenderBarChart(container, bars, opts = {}){
        if (!container) return;
        container.innerHTML = "";
        if (!Array.isArray(bars) || !bars.length){
          container.innerHTML = `<div class="insight-empty">${escapeHtml(opts.emptyText || "")}</div>`;
          return;
        }
        const maxV = Math.max(1, ...bars.map(x => Number(x.v) || 0));
        const w=600, h=220;
        const padL=44, padR=14, padT=16, padB=34;
        const plotW = w - padL - padR;
        const plotH = h - padT - padB;
        const svg = _svg("svg");
        svg.setAttribute("viewBox", `0 0 ${w} ${h}`);
        for (const gv of [0, Math.round(maxV/2), maxV]){
          const y = padT + (1 - (gv/maxV))*plotH;
          const line = _svg("line");
          line.setAttribute("x1", padL); line.setAttribute("x2", w-padR);
          line.setAttribute("y1", y); line.setAttribute("y2", y);
          line.setAttribute("class", "grid");
          svg.appendChild(line);
        }
        const cnt = bars.length;
        const gap = 8;
        const bw = Math.max(8, (plotW - gap*(cnt-1)) / cnt);
        for (let i=0;i<cnt;i++){
          const x = padL + i*(bw+gap);
          const v = Number(bars[i].v) || 0;
          const bh = (v/maxV) * plotH;
          const y = padT + (plotH - bh);
          const rect = _svg("rect");
          rect.setAttribute("x", x); rect.setAttribute("y", y);
          rect.setAttribute("width", bw); rect.setAttribute("height", bh);
          rect.setAttribute("rx", 8); rect.setAttribute("class", "bar");
          svg.appendChild(rect);
          const lbl = _svg("text");
          lbl.setAttribute("x", x+bw/2); lbl.setAttribute("y", h-10);
          lbl.setAttribute("text-anchor","middle"); lbl.setAttribute("class","label");
          lbl.textContent = bars[i].label || "";
          svg.appendChild(lbl);
        }
        container.appendChild(svg);
      }
      function _insRenderTable(container, headers, rows, emptyText){
        if (!container) return;
        if (!Array.isArray(rows) || !rows.length){
          container.innerHTML = `<div class="insight-empty">${escapeHtml(emptyText || "")}</div>`;
          return;
        }
        const _td = (cell) => {
          let text = cell;
          let className = "";
          if (cell && typeof cell === "object" && !Array.isArray(cell)){
            text = ("text" in cell) ? cell.text : "";
            className = String(cell.className || "");
          }
          const safeClass = className
            .split(/\s+/)
            .filter(t => /^[a-zA-Z0-9_-]+$/.test(t))
            .join(" ");
          const clsAttr = safeClass ? ` class="${safeClass}"` : "";
          return `<td${clsAttr}>${escapeHtml(String(text ?? ""))}</td>`;
        };
        const thead = `<thead><tr>${headers.map(h => `<th>${escapeHtml(h)}</th>`).join("")}</tr></thead>`;
        const tbody = `<tbody>${rows.map(r => `<tr>${r.map(c => _td(c)).join("")}</tr>`).join("")}</tbody>`;
        container.innerHTML = `<table class="insight-table">${thead}${tbody}</table>`;
      }

      function _insightsRenderTrend(sessions){
        if (!insightsEl.trend) return;
        const points = sessions
          .filter(s => typeof s.accuracy === "number" && isFinite(s.accuracy))
          .map((s,i)=>({i, pct: _insightsClamp(s.accuracy*100, 0, 100), date: s.date || ""}));

        insightsEl.trend.innerHTML = "";

        if (!points.length){
          insightsEl.trend.innerHTML = `<div class="note"></div>`;
          if (insightsEl.trendNote) insightsEl.trendNote.textContent = "";
          return;
        }

        if (insightsEl.trendNote){
          const last = points[points.length-1];
          insightsEl.trendNote.textContent = `latest ${Math.round(last.pct*10)/10}%`;
        }

        const w=600, h=220;
        const padL=44, padR=14, padT=16, padB=34;
        const plotW = w - padL - padR;
        const plotH = h - padT - padB;

        const svg = _svg("svg");
        svg.setAttribute("viewBox", `0 0 ${w} ${h}`);
        svg.setAttribute("aria-label", "Accuracy trend");

        for (const v of [0,25,50,75,100]){
          const y = padT + (1 - v/100)*plotH;
          const line = _svg("line");
          line.setAttribute("x1", padL);
          line.setAttribute("x2", w - padR);
          line.setAttribute("y1", y);
          line.setAttribute("y2", y);
          line.setAttribute("class", "grid");
          svg.appendChild(line);

          const t = _svg("text");
          t.setAttribute("x", 10);
          t.setAttribute("y", y+4);
          t.setAttribute("class", "label");
          t.textContent = `${v}%`;
          svg.appendChild(t);
        }

        const ax = _svg("line");
        ax.setAttribute("x1", padL);
        ax.setAttribute("x2", padL);
        ax.setAttribute("y1", padT);
        ax.setAttribute("y2", h-padB);
        ax.setAttribute("class", "axis");
        svg.appendChild(ax);

        const ax2 = _svg("line");
        ax2.setAttribute("x1", padL);
        ax2.setAttribute("x2", w-padR);
        ax2.setAttribute("y1", h-padB);
        ax2.setAttribute("y2", h-padB);
        ax2.setAttribute("class", "axis");
        svg.appendChild(ax2);

        const n = points.length;
        const xFor = (idx) => padL + (n===1 ? plotW/2 : (idx/(n-1))*plotW);
        const yFor = (pct) => padT + (1 - pct/100)*plotH;

        let d = "";
        for (let i=0;i<n;i++){
          const x = xFor(i);
          const y = yFor(points[i].pct);
          d += (i===0 ? `M ${x} ${y}` : ` L ${x} ${y}`);
        }

        const path = _svg("path");
        path.setAttribute("d", d);
        path.setAttribute("class", "line");
        svg.appendChild(path);

        for (let i=0;i<n;i++){
          const c = _svg("circle");
          c.setAttribute("cx", xFor(i));
          c.setAttribute("cy", yFor(points[i].pct));
          c.setAttribute("r", 3.2);
          c.setAttribute("class", "dot");
          svg.appendChild(c);
        }

        const first = points[0].date || "";
        const last = points[n-1].date || "";
        const tx1 = _svg("text");
        tx1.setAttribute("x", padL);
        tx1.setAttribute("y", h-10);
        tx1.setAttribute("class", "label");
        tx1.textContent = first;
        svg.appendChild(tx1);

        const tx2 = _svg("text");
        tx2.setAttribute("x", w-padR);
        tx2.setAttribute("y", h-10);
        tx2.setAttribute("text-anchor", "end");
        tx2.setAttribute("class", "label");
        tx2.textContent = last;
        svg.appendChild(tx2);

        insightsEl.trend.appendChild(svg);

        try{
          if (!insights.reduceMotion){
            const len = path.getTotalLength();
            path.style.setProperty("--dash", String(Math.ceil(len)));
            path.classList.add("draw-line");
          }
        }catch{}
      }

      function _insightsRenderModeBars(sessions){
        if (!insightsEl.modeChart || !insightsEl.modeCard) return;

        if (insights.mode !== "ALL"){
          insightsEl.modeCard.style.display = "none";
          return;
        }
        insightsEl.modeCard.style.display = "";

        const modes = ["HAND","CHOICE","RND","SEQ"];
        const sums = new Map(modes.map(m=>[m,{c:0,t:0}]));
        for (const s of sessions){
          const m = String(s.mode||"");
          if (!sums.has(m)) continue;
          const t = Number(s.total)||0;
          const c = Number(s.correct)||0;
          if (t<=0) continue;
          const bucket = sums.get(m);
          bucket.t += t;
          bucket.c += c;
        }
        const vals = modes.map(m=>{
          const b = sums.get(m);
          const pct = (b && b.t>0) ? (b.c/b.t)*100 : 0;
          return {m, pct: _insightsClamp(pct,0,100)};
        });

        insightsEl.modeChart.innerHTML = "";

        const w=600, h=220;
        const padL=44, padR=14, padT=16, padB=34;
        const plotW = w - padL - padR;
        const plotH = h - padT - padB;

        const svg = _svg("svg");
        svg.setAttribute("viewBox", `0 0 ${w} ${h}`);
        svg.setAttribute("aria-label", "Accuracy by mode");

        for (const v of [0,50,100]){
          const y = padT + (1 - v/100)*plotH;
          const line = _svg("line");
          line.setAttribute("x1", padL);
          line.setAttribute("x2", w - padR);
          line.setAttribute("y1", y);
          line.setAttribute("y2", y);
          line.setAttribute("class", "grid");
          svg.appendChild(line);

          const t = _svg("text");
          t.setAttribute("x", 10);
          t.setAttribute("y", y+4);
          t.setAttribute("class", "label");
          t.textContent = `${v}%`;
          svg.appendChild(t);
        }

        const ax = _svg("line");
        ax.setAttribute("x1", padL);
        ax.setAttribute("x2", w-padR);
        ax.setAttribute("y1", h-padB);
        ax.setAttribute("y2", h-padB);
        ax.setAttribute("class", "axis");
        svg.appendChild(ax);

        const gap = 14;
        const bw = (plotW - gap*(vals.length-1)) / vals.length;
        const x0 = padL;
        for (let i=0;i<vals.length;i++){
          const x = x0 + i*(bw+gap);
          const barH = (vals[i].pct/100)*plotH;
          const y = padT + (plotH - barH);

          const bg = _svg("rect");
          bg.setAttribute("x", x);
          bg.setAttribute("y", padT);
          bg.setAttribute("width", bw);
          bg.setAttribute("height", plotH);
          bg.setAttribute("rx", 10);
          bg.setAttribute("class", "barBg");
          svg.appendChild(bg);

          const rect = _svg("rect");
          rect.setAttribute("x", x);
          rect.setAttribute("y", y);
          rect.setAttribute("width", bw);
          rect.setAttribute("height", barH);
          rect.setAttribute("rx", 10);
          rect.setAttribute("class", "bar");
          if (!insights.reduceMotion){
            rect.style.transformOrigin = `${x + bw/2}px ${h-padB}px`;
            rect.style.transform = "scaleY(0)";
            rect.style.transition = "transform .55s cubic-bezier(0.22, 1, 0.36, 1)";
            requestAnimationFrame(()=>{ rect.style.transform = "scaleY(1)"; });
          }
          svg.appendChild(rect);

          const lbl = _svg("text");
          lbl.setAttribute("x", x + bw/2);
          lbl.setAttribute("y", h-10);
          lbl.setAttribute("text-anchor", "middle");
          lbl.setAttribute("class", "label");
          lbl.textContent = vals[i].m;
          svg.appendChild(lbl);

          const val = _svg("text");
          val.setAttribute("x", x + bw/2);
          val.setAttribute("y", y - 6);
          val.setAttribute("text-anchor", "middle");
          val.setAttribute("class", "label");
          val.textContent = `${Math.round(vals[i].pct)}%`;
          svg.appendChild(val);
        }

        insightsEl.modeChart.appendChild(svg);
      }

      function _insightsRenderWeakTop10(sessions){
        if (!insightsEl.weak) return;
        insightsEl.weak.innerHTML = "";

        const freq = new Map();
        for (const s of sessions){
          const ids = Array.isArray(s.wrongIds) ? s.wrongIds : [];
          for (const id of ids){
            const n = Number(id);
            if (!Number.isFinite(n)) continue;
            freq.set(n, (freq.get(n)||0)+1);
          }
        }

        const arr = Array.from(freq.entries()).map(([id,c])=>({id, c}));
        arr.sort((a,b)=>b.c-a.c);
        const top = arr.slice(0,10);

        if (!top.length){
          insightsEl.weak.innerHTML = `<div class="note">ID</div>`;
          return;
        }

        const maxC = top.reduce((m,x)=>Math.max(m,x.c),1);
        const byId = (data && data.byId) ? data.byId : null;

        for (const it of top){
          let word = "";
          try{
            const w = byId ? byId.get(it.id) : null;
            word = w ? w.word : "";
          }catch{}
          if (!word) word = "(unknown)";

          const row = document.createElement("div");
          row.className = "weak-item";
          row.innerHTML = `
            <div class="weak-left">
              <div class="weak-top">
                <div class="weak-word">${escapeHtml(word)}</div>
                <div class="weak-no">No.${it.id}</div>
              </div>
              <div class="weak-bar"><i style="width:${Math.round((it.c/maxC)*100)}%"></i></div>
            </div>
            <div class="weak-count">${it.c}</div>
          `;
          insightsEl.weak.appendChild(row);
        }

        if (!insights.reduceMotion){
          requestAnimationFrame(()=>{
            insightsEl.weak.querySelectorAll(".weak-bar > i").forEach((el)=>{ /* transition kicks in */ });
          });
        }
      }

      function _insightsRenderDailyVolume(sessions, container){
        const daily = _insBuildDaily(sessions);
        const bars = daily.map(d => ({ label: d.ymd.slice(5), v: d.total || d.sessions }));
        _insRenderBarChart(container || insightsEl.dailyVolume, bars, { emptyText: "" });
      }
      function _insightsRenderDailyAccuracy(sessions, container){
        const daily = _insBuildDaily(sessions)
          .filter(d => d.total > 0)
          .map(d => ({ label: d.ymd.slice(5), v: (d.correct/d.total) * 100 }));
        _insRenderLineChart(container || insightsEl.dailyAccuracy, daily, {
          minY: 0, maxY: 100, gridValues:[0,25,50,75,100], yLabel:(v)=>`${Math.round(v)}%`,
          emptyText: ""
        });
      }
      function _insightsRenderModeDistribution(sessions, container){
        const modes = ["SEQ","RND","CHOICE","HAND"];
        const rows = [];
        for (const m of modes){
          const arr = sessions.filter(s => String(s?.mode || "") === m);
          const ses = arr.length;
          const total = arr.reduce((a,s)=>a+_insNum(s?.total),0);
          const correct = arr.reduce((a,s)=>a+_insNum(s?.correct),0);
          const dur = arr.filter(s => Number.isFinite(Number(s?.durationMs)) && _insNum(s?.total) > 0);
          const durMs = dur.reduce((a,s)=>a+Number(s.durationMs||0),0);
          const durAns = dur.reduce((a,s)=>a+_insNum(s.total),0);
          rows.push([
            _insModeName(m),
            String(ses),
            String(total),
            _insFmtPct(correct, total),
            durAns > 0 ? _insFmtSec((durMs/1000)/durAns) : ""
          ]);
        }
        _insRenderTable(
          container || insightsEl.modeDistribution,
          ["Mode","","","","(/)"],
          rows
        );
      }
      function _insightsRenderAvgTimeTrend(sessions, container){
        const daily = _insBuildDaily(sessions)
          .filter(d => d.durationAnswers > 0)
          .map(d => ({ label: d.ymd.slice(5), v: (d.durationMs/1000)/d.durationAnswers }));
        if (daily.length < 2){
          _insRenderLineChart(container || insightsEl.avgTimeTrend, [], { emptyText: "durationMs " });
          return;
        }
        const maxY = Math.max(5, ...daily.map(x => x.v)) * 1.1;
        _insRenderLineChart(container || insightsEl.avgTimeTrend, daily, {
          minY:0, maxY, gridValues:[0, maxY/2, maxY], yLabel:(v)=>`${Math.round(v*10)/10}s`
        });
      }
      function _insightsRenderTimeoutByMode(sessions, container){
        const modes = ["SEQ","RND","CHOICE","HAND"];
        const rows = [];
        for (const m of modes){
          const arr = sessions.filter(s => String(s?.mode || "") === m);
          const answers = arr.reduce((a,s)=>a+_insNum(s?.total),0);
          const measured = arr.filter(s => Number.isFinite(Number(s?.timedOutCount)));
          const timeoutCount = measured.reduce((a,s)=>a+_insNum(s?.timedOutCount),0);
          const measuredAnswers = measured.reduce((a,s)=>a+_insNum(s?.total),0);
          rows.push([
            _insModeName(m),
            measured.length ? String(timeoutCount) : "",
            String(answers),
            measuredAnswers > 0 ? _insFmtPct(timeoutCount, measuredAnswers) : ""
          ]);
        }
        _insRenderTable(container || insightsEl.timeoutByMode, ["Mode","","",""], rows);
      }
      function _insightsRangeMetrics(sessions, fromTs, toTs){
        const f = sessions.filter(s => {
          const ts = Number(s?.ts) || 0;
          return ts >= fromTs && ts < toTs;
        });
        const answers = f.reduce((a,s)=>a+_insNum(s?.total),0);
        const correct = f.reduce((a,s)=>a+_insNum(s?.correct),0);
        const durationMs = f.reduce((a,s)=>a+(Number(s?.durationMs)||0),0);
        return { sessions: f.length, answers, correct, durationMs };
      }
      function _insightsRenderCompareTable(container, titleCurrent, cur, prev){
        const _deltaCell = (v, suffix = "", digits = 0) => {
          if (!Number.isFinite(v)){
            return { text: "", className: "is-delta delta-zero" };
          }
          const p = Math.pow(10, Math.max(0, digits));
          const rounded = Math.round(v * p) / p;
          const text = `${rounded > 0 ? "+" : ""}${rounded}${suffix}`;
          const cls = rounded > 0 ? "is-delta delta-pos" : (rounded < 0 ? "is-delta delta-neg" : "is-delta delta-zero");
          return { text, className: cls };
        };
        const curAcc = cur.answers ? (cur.correct / cur.answers) * 100 : null;
        const prevAcc = prev.answers ? (prev.correct / prev.answers) * 100 : null;
        const accDelta = (curAcc == null || prevAcc == null) ? null : (curAcc - prevAcc);
        const rows = [
          ["", cur.answers, prev.answers, _deltaCell(cur.answers - prev.answers)],
          ["", _insFmtPct(cur.correct, cur.answers), _insFmtPct(prev.correct, prev.answers), _deltaCell(accDelta, "%", 1)],
          ["", cur.sessions, prev.sessions, _deltaCell(cur.sessions - prev.sessions)],
          ["", `${Math.round(cur.durationMs/60000)}`, `${Math.round(prev.durationMs/60000)}`,
            _deltaCell((cur.durationMs - prev.durationMs) / 60000, "")]
        ];
        _insRenderTable(container, ["", titleCurrent, "", ""], rows);
      }
      function _insightsRenderComparisons(sessions, weekContainer, monthContainer){
        const now = new Date();
        const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
        const weekStart = todayStart - 7*86400000;
        const prevWeekStart = todayStart - 14*86400000;
        const curWeek = _insightsRangeMetrics(sessions, weekStart, todayStart + 86400000);
        const prevWeek = _insightsRangeMetrics(sessions, prevWeekStart, weekStart);
        _insightsRenderCompareTable(weekContainer || insightsEl.weekCompare, "", curWeek, prevWeek);

        const d30Start = todayStart - 30*86400000;
        const prev30Start = todayStart - 60*86400000;
        const cur30 = _insightsRangeMetrics(sessions, d30Start, todayStart + 86400000);
        const prev30 = _insightsRangeMetrics(sessions, prev30Start, d30Start);
        _insightsRenderCompareTable(monthContainer || insightsEl.monthCompare, "30", cur30, prev30);
      }
      function _insightsRenderACE(sessions, targets = {}){
        _insightsRenderDailyVolume(sessions, targets.dailyVolume || insightsEl.dailyVolume);
        _insightsRenderDailyAccuracy(sessions, targets.dailyAccuracy || insightsEl.dailyAccuracy);
        _insightsRenderModeDistribution(sessions, targets.modeDistribution || insightsEl.modeDistribution);
        _insightsRenderAvgTimeTrend(sessions, targets.avgTimeTrend || insightsEl.avgTimeTrend);
        _insightsRenderTimeoutByMode(sessions, targets.timeoutByMode || insightsEl.timeoutByMode);
        _insightsRenderComparisons(sessions, targets.weekCompare || insightsEl.weekCompare, targets.monthCompare || insightsEl.monthCompare);
      }

      let _insightsRenderQueued = false;
      function _insightsRenderAll(){
        if (!_insightsIsOpen()) return;
        if (_insightsRenderQueued) return;
        _insightsRenderQueued = true;
        requestAnimationFrame(() => {
          _insightsRenderQueued = false;
          if (!_insightsIsOpen()) return;
          const sessions = _insightsGetFilteredSessions();
          _insightsRenderSummary(sessions);
          _insightsRenderTrend(sessions);
          _insightsRenderACE(sessions);
          _insightsRenderModeBars(sessions);
          _insightsRenderWeakTop10(sessions);
        });
      }
      // Events
      insightsEl.btn?.addEventListener("click", () => _insightsOpen());
      insightsEl.close?.addEventListener("click", () => _insightsClose());

      document.addEventListener("keydown", (e) => {
        if (!_insightsIsOpen()) return;
        const ae = document.activeElement;
        const typing = ae && (ae.tagName === "INPUT" || ae.tagName === "TEXTAREA" || ae.tagName === "SELECT" || ae.isContentEditable);
        if (typing) return;
        if (e.key === "Escape"){
          e.preventDefault();
          _insightsClose();
        }
      });

      insightsEl.presetSel?.addEventListener("change", () => {
        insights.preset = insightsEl.presetSel.value;
        _insightsRenderAll();
      });
      insightsEl.modeSel?.addEventListener("change", () => {
        insights.mode = insightsEl.modeSel.value;
        _insightsRenderAll();
      });
      insightsEl.rangeSel?.addEventListener("change", () => {
        insights.range = insightsEl.rangeSel.value;
        _insightsRenderAll();
      });

      insightsEl.exportBtn?.addEventListener("click", async () => {
        try{
          const sessions = _insightsLoadSessions();
          const blob = new Blob([JSON.stringify(sessions, null, 2)], {type:"application/json"});
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          const d = new Date();
          const y = d.getFullYear();
          const m = String(d.getMonth()+1).padStart(2,"0");
          const da = String(d.getDate()).padStart(2,"0");
          a.download = `wordpractice_sessions_${y}${m}${da}.json`;
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);
          uiAlert("", {title:"Insights"});
        }catch{
          uiAlert("", {title:"Insights"});
        }
      });

      insightsEl.deleteBtn?.addEventListener("click", async () => {
        const ok = await uiConfirm("", {
          title: "Insights",
          okText: "",
          cancelText: "",
          danger: true
        });
        if (!ok) return;
        try{
          localStorage.removeItem(INSIGHTS_SESSIONS_KEY);
          _insightsSessionsCache = [];
          _insightsSessionsRev++;
          _insightsFilteredCacheKey = "";
          _insightsFilteredCache = null;
          _insightsFilterCacheMap.clear();
          _insightsRenderAll();
          uiAlert("", {title:"Insights"});
        }catch{
          uiAlert("", {title:"Insights"});
        }
      });

      // Boot
      ensureDemoNotification();
      updateNotifyDot();
      setView("START");
      renderAll();
      maybeShowUpdateNotes();
      _backupScheduleAuto();
    
      // =========================
      // Hamburger Menu (stable navigation)
      // =========================
      const REPORT_ENDPOINT = ""; // Optional (e.g.) "https://formspree.io/f/xxxxxx"
      const REPORT_TO_EMAIL = ""; // Optional mailto fallback (e.g.) "your@email.com"

      const _menu = { open:false, inited:false };

      function _isTyping(el){
        if (!el) el = document.activeElement;
        if (!el) return false;
        const tag = (el.tagName || "").toLowerCase();
        if (tag === "input" || tag === "textarea" || tag === "select") return true;
        if (el.isContentEditable) return true;
        return false;
      }

      
      function _menuEls(){
        return {
          btn: document.getElementById("menuBtn"),
          overlay: document.getElementById("menuOverlay"),
          panel: document.getElementById("menuPanel"),
          title: document.getElementById("menuTitle"),
          content: document.getElementById("menuContent"),
        };
      }

      const EMAILJS_SERVICE_ID = PUBLIC_RUNTIME_CONFIG.emailjs.serviceId;
      const EMAILJS_TEMPLATE_ID = PUBLIC_RUNTIME_CONFIG.emailjs.templateId;
      const EMAILJS_PUBLIC_KEY = PUBLIC_RUNTIME_CONFIG.emailjs.publicKey;

      const _menuState = {
        inited: false,
        view: "root",
        rootHtml: "",
        reportDraft: { email: "", subject: "", message: "" },
        sending: false,
        emailjsReady: false,
        memoCheck: {
          currentDate: "",
          monthBaseTs: Date.now(),
          selectedBlock: "",
          draftBlocks: []
        },
        presetShare: {
          tab: "share", // share | import
          selectedPresetId: "",
          entry: null,
          creating: false,
          importing: false,
          hashCode: "",
          hashTried: false,
          timerId: null
        }
      };
      const MEMO_CHECK_KEY = "app.memoCheck.v1";
      const MEMO_DEFAULT_BLOCKS = [
        "EXAM",
        "EXAM",
        "EXAM",
        "WRITE",
        "WRITE",
        "WRITE/",
        "WRITE",
        ""
      ];

      function _escapeHtml(s){
        return String(s ?? "")
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#39;");
      }

      function _fmtLocalSentAt(){
        const d = new Date();
        const pad = (n)=> String(n).padStart(2,"0");
        return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
      }

      function _isValidEmail(email){
        // Simple but practical
        return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(email || "").trim());
      }

      function _ensureEmailJSInit(){
        if(_menuState.emailjsReady) return true;
        if(!EMAILJS_PUBLIC_KEY || !EMAILJS_SERVICE_ID || !EMAILJS_TEMPLATE_ID){
          return false;
        }
        if(!window.emailjs || typeof window.emailjs.init !== "function") return false;
        try{
          window.emailjs.init(EMAILJS_PUBLIC_KEY);
          _menuState.emailjsReady = true;
          return true;
        }catch(err){
          console.warn("[EmailJS] init failed:", err);
          return false;
        }
      }

      function _setReportStatus(msg, isError){
        const el = document.getElementById("reportStatus");
        if(!el) return;
        el.textContent = msg || "";
        el.classList.toggle("error", !!isError);
      }

      function _renderHelpHTML(){
        return `
        
<div class="menu-article">
  <h2>VocabuQuiz </h2>
  <p class="mini">
     <strong></strong>  <strong>FAQ</strong> 1<br>
    0) OK
  </p>

  <hr>

  <h3>0) 3</h3>
  <p class="mini">
    <strong>  TURN MODE  EXAM MODE  WRITE MODE</strong><br>
    
  </p>
  <ul>
    <li><strong>TURN MODE</strong></li>
    <li><strong>EXAM MODE</strong></li>
    <li><strong>WRITE MODE</strong></li>
  </ul>

  <p class="mini"><strong></strong></p>
  <div class="embed">
    <img src="https://mail.google.com/mail/u/0/?ui=2&ik=5414973210&attid=0.1&permmsgid=msg-a:r1347859470090037985&th=19c57c69f5c349e4&view=fimg&disp=thd&attbid=ANGjdJ8jUssELVfvB9fQ6uHDMRdKUlwX8tF2wGbt3KB8Dg3RnX_oW29hDh0eVisldMtCum8YEQF0QMihr-9ulkbzVJdHkK5Jzn_9GrAPu0ER53eY98RKUDMbBMKhZ2o&ats=2524608000000&sz=w3456-h1814&auditContext=forDisplay" alt="TURNEXAMWRITE">
  </div>

  <hr>

  <h3>1) </h3>
  <p class="mini">
    
  </p>
  <ul>
    <li><strong> </strong></li>
    <li><strong> TURN MODE</strong>No</li>
    <li><strong> EXAM MODE</strong></li>
    <li><strong> WRITE MODE</strong></li>
    <li><strong> </strong></li>
  </ul>

  <p class="mini"><strong>URL</strong> /4/</p>
  <div class="embed">
    <img src="URL" alt="">
  </div>

  <p class="mini"><strong>URL</strong> EXAM MODE</p>
  <div class="embed">
    <video src="https://d.kuku.lu/sb22z6ndp" controls playsinline preload="metadata"></video>
  </div>

  <hr>

  <h3>2) builtin / My Preset</h3>
  <p class="mini">
    <strong> = </strong><br>
    1200 / 100 
  </p>
  <ul>
    <li><strong>builtin</strong></li>
    <li><strong>My Preset</strong></li>
  </ul>

  <hr>

  <h3>3) My Preset</h3>
  <p class="mini">
    My Preset
  </p>
  <ul>
    <li> <strong>My Preset </strong></li>
    <li></li>
    <li>TURN / RUNDOM / EXAM / WRITE</li>
  </ul>

  <p class="mini">11</p>
  <pre class="codeblock">
401 example 
402 abandon 
403 result 
  </pre>

  <p class="mini"><strong>URL</strong> My Preset</p>
  <div class="embed">
    <img src="URL" alt="My Preset/">
  </div>

  <hr>

  <h3>4) </h3>
  <p class="mini"></p>
  <ul>
    <li><strong>TURN MODE</strong></li>
    <li><strong>RUNDOM MODE</strong></li>
    <li><strong>EXAM MODE</strong>4</li>
    <li><strong>WRITE MODE</strong></li>
  </ul>

  <hr>

  <h3>5) QR / 6</h3>
  <p class="mini"></p>
  <ul>
    <li><strong></strong>My Preset   6 or QR </li>
    <li><strong></strong> 6QR </li>
    <li class="mini"></li>
  </ul>

  <p class="mini"><strong>URL</strong> 6QR</p>
  <div class="embed">
    <img src="URL" alt="">
  </div>

  <hr>

  <h3>FAQ</h3>

  <h4>Q1) </h4>
  <p class="mini"><strong>A</strong>  <strong>TURN MODE  EXAM MODE  WRITE MODE</strong> OK</p>

  <h4>Q2) </h4>
  <p class="mini"><strong>A</strong> </p>
  <ul>
    <li>10</li>
    <li>O/0I/1</li>
    <li></li>
  </ul>

  <h4>Q3) </h4>
  <p class="mini"><strong>A</strong>  <strong>Report</strong> </p>

  <hr>

  <h3></h3>
  <p class="mini">
    URL<br>
    <strong>URL</strong>  <strong>URL</strong> 
  </p>

  <p class="mini"><strong>URL</strong></p>
  <div class="embed">
    <img src="URL" alt="help image example">
  </div>

  <p class="mini"><strong>URL</strong></p>
  <div class="embed">
    <video src="https://d.kuku.lu/sb22z6ndp" controls playsinline preload="metadata"></video>
  </div>
</div>

        `;
      }

      function _renderTermsHTML(){
        return `
          <div class="menu-article">
            <h2></h2>
            <p class="mini">${_escapeHtml(new Date().toISOString().slice(0,10))}</p>

            <h3>1. </h3>
            <p></p>

            <h3>2. </h3>
            <ul>
              <li></li>
              <li></li>
              <li></li>
              <li></li>
            </ul>

            <h3>3. </h3>
            <p></p>

            <h3>4. </h3>
            <p>localStorage</p>

            <h3>5. </h3>
            <p>/QR</p>

            <h3>6. </h3>
            <p></p>

            <h3>7. /</h3>
            <p></p>

            <h3>8. </h3>
            <p></p>

            <h3>9. </h3>
            <p></p>

            <h3>10. </h3>
            <p></p>

            <h3>11. </h3>
            <p></p>

            <h3>12. </h3>
            <p></p>

            <h3>13. </h3>
            <p></p>
          </div>
        `;
      }

      function _renderReportFormHTML(){
        const d = _menuState.reportDraft || { email:"", subject:"", message:"" };
        return `
          <div class="menu-article">
            <h2> / </h2>
            <p class="mini"></p>

            <div id="reportStatus" class="status" aria-live="polite"></div>

            <div class="form-grid">
              <div>
                <label for="reportEmail"></label>
                <input id="reportEmail" class="spell-input" type="email" inputmode="email" autocomplete="email" spellcheck="false"
                  placeholder="you@example.com" value="${_escapeHtml(d.email)}">
              </div>

              <div>
                <label for="reportSubject"></label>
                <input id="reportSubject" class="spell-input" type="text" autocomplete="off" spellcheck="false"
                  placeholder="" value="${_escapeHtml(d.subject)}">
              </div>

              <div>
                <label for="reportMessage"></label>
                <textarea id="reportMessage" class="spell-input" autocomplete="off" spellcheck="false"
                  placeholder="">${_escapeHtml(d.message)}</textarea>
              </div>
            </div>

            <div class="row-actions">
              <button class="btn" type="button" data-report-action="goConfirm"></button>
            </div>
          </div>
        `;
      }

      function _renderReportConfirmHTML(){
        const d = _menuState.reportDraft || { email:"", subject:"", message:"" };
        return `
          <div class="menu-article">
            <h2></h2>
            <p class="mini"></p>

            <div id="reportStatus" class="status" aria-live="polite"></div>

            <h3></h3>
            <pre>${_escapeHtml(d.email)}</pre>

            <h3></h3>
            <pre>${_escapeHtml(d.subject)}</pre>

            <h3></h3>
            <pre>${_escapeHtml(d.message)}</pre>

            <div class="row-actions">
              <button class="btn" type="button" data-report-action="backEdit"></button>
              <button class="btn" type="button" data-report-action="sendConfirm"></button>
            </div>
          </div>
        `;
      }

      function _renderReportDoneHTML(){
        return `
          <div class="menu-article">
            <div class="report-done">
              <svg class="check" viewBox="0 0 96 96" aria-hidden="true">
                <circle cx="48" cy="48" r="38" fill="none" stroke="rgba(34,197,94,.95)" stroke-width="8"></circle>
                <path d="M30 50 L42 62 L68 36" fill="none" stroke="rgba(34,197,94,.95)" stroke-width="8" stroke-linecap="round" stroke-linejoin="round"></path>
              </svg>
              <h2></h2>
              <p></p>

              <div class="row-actions" style="justify-content:center;">
                <button class="btn" type="button" data-report-action="doneClose"></button>
              </div>
            </div>
          </div>
        `;
      }

      function _renderPresetShareHTML(){
        return `
          <div class="menu-article drawer-share">
            <h2></h2>
            <p class="mini">My Preset 6</p>

            <div class="drawer-share-tabs">
              <button class="drawer-share-tab" type="button" id="drawerShareTabSend" data-share-tab="share"></button>
              <button class="drawer-share-tab" type="button" id="drawerShareTabImport" data-share-tab="import"></button>
            </div>

            <section class="drawer-share-panel" id="drawerShareSendPanel">
              <div>
                <div class="note" style="margin-bottom:6px;"> My Preset</div>
                <select id="drawerSharePresetSelect" class="select" aria-label=""></select>
              </div>

              <div class="drawer-share-row">
                <button class="btn" type="button" id="drawerShareCreateBtn" data-share-action="create"></button>
              </div>
              <div id="drawerShareCreateState" class="drawer-share-status">create status: idle</div>

              <div id="drawerShareSendStatus" class="drawer-share-status" aria-live="polite"></div>

              <div class="drawer-share-code" id="drawerShareCode">---</div>
              <div class="drawer-share-sub" id="drawerShareExpires">Expires in --:--</div>

              <div class="drawer-share-actions">
                <button class="textbtn" type="button" id="drawerShareCopyCodeBtn" data-share-action="copyCode" disabled></button>
                <button class="textbtn" type="button" id="drawerShareCopyLinkBtn" data-share-action="copyLink" disabled></button>
              </div>

              <div id="drawerShareQrStatus" class="drawer-share-status">QR</div>
              <img id="drawerShareQrImg" class="drawer-share-qr" alt="Share QR" />
              <div id="drawerShareLinkText" class="drawer-share-link"></div>
            </section>

            <section class="drawer-share-panel hidden" id="drawerShareImportPanel">
              <div>
                <div class="note" style="margin-bottom:6px;">6</div>
                <input id="drawerShareImportCode" class="spell-input" type="text"
                  placeholder="ABC123"
                  inputmode="latin" autocomplete="one-time-code" autocapitalize="characters" spellcheck="false" />
              </div>

              <div class="drawer-share-row">
                <button class="btn" type="button" id="drawerShareImportBtn" data-share-action="import"></button>
              </div>
              <div id="drawerShareImportStatus" class="drawer-share-status" aria-live="polite"></div>
            </section>
          </div>
        `;
      }

      function _memoLoadAll(){
        try{
          const raw = localStorage.getItem(MEMO_CHECK_KEY);
          const obj = raw ? JSON.parse(raw) : {};
          return (obj && typeof obj === "object") ? obj : {};
        }catch{ return {}; }
      }
      function _memoSaveAll(obj){
        try{ localStorage.setItem(MEMO_CHECK_KEY, JSON.stringify(obj || {})); }catch{}
      }
      function _memoToYmd(ts){
        const d = new Date(ts);
        const y = d.getFullYear();
        const m = String(d.getMonth()+1).padStart(2,"0");
        const da = String(d.getDate()).padStart(2,"0");
        return `${y}-${m}-${da}`;
      }
      function _memoGetDailyStudyCountMap(){
        const map = new Map();
        const sessions = _insightsLoadSessions();
        for (const s of sessions){
          const ymd = String(s?.date || _memoToYmd(s?.ts || Date.now()));
          const v = _insNum(s?.total);
          map.set(ymd, (map.get(ymd) || 0) + v);
        }
        return map;
      }
      function _memoRenderInsightsTop(){
        const presetSel = document.getElementById("memoInsightsPresetSelect");
        const modeSel = document.getElementById("memoInsightsModeSelect");
        const rangeSel = document.getElementById("memoInsightsRangeSelect");
        const currentPresetId = _insightsGetPresetMeta().presetId;
        const opts = {
          preset: (presetSel && presetSel.value) || "CURRENT",
          mode: (modeSel && modeSel.value) || "ALL",
          range: (rangeSel && rangeSel.value) || "30D",
          currentPresetId
        };
        const sessions = _insightsGetFilteredSessionsBy(opts);
        _insightsRenderACE(sessions, {
          dailyVolume: document.getElementById("memoChartDailyVolume"),
          dailyAccuracy: document.getElementById("memoChartDailyAccuracy"),
          modeDistribution: document.getElementById("memoTableModeDistribution"),
          avgTimeTrend: document.getElementById("memoChartAvgTimeTrend"),
          timeoutByMode: document.getElementById("memoTableTimeout"),
          weekCompare: document.getElementById("memoTableWeekCompare"),
          monthCompare: document.getElementById("memoTableMonthCompare"),
        });
      }
      function _renderMemoCheckHTML(){
        const base = new Date(_menuState.memoCheck.monthBaseTs || Date.now());
        const ym = `${base.getFullYear()}-${String(base.getMonth()+1).padStart(2,"0")}`;
        return `
          <div class="memo-check">
            <section class="insight-card">
              <div class="insight-head">
                <div class="insight-title"> Insights</div>
                <div class="insight-note">A / C / E</div>
              </div>
              <div class="insights-filters" style="position:static; padding:10px;">
                <div class="filter-item">
                  <div class="filter-label"></div>
                  <select id="memoInsightsPresetSelect" class="select"></select>
                </div>
                <div class="filter-item">
                  <div class="filter-label"></div>
                  <select id="memoInsightsModeSelect" class="select">
                    <option value="ALL">ALL</option>
                    <option value="HAND">WRITE MODE</option>
                    <option value="CHOICE">EXAM MODE</option>
                    <option value="RND">RANDOM MODE</option>
                    <option value="SEQ">TURN MODE</option>
                  </select>
                </div>
                <div class="filter-item">
                  <div class="filter-label">Range</div>
                  <select id="memoInsightsRangeSelect" class="select">
                    <option value="7D">7D</option>
                    <option value="30D" selected>30D</option>
                    <option value="ALL">ALL</option>
                  </select>
                </div>
              </div>
              <div class="insights-grid" style="margin-top:10px;">
                <section class="insight-card"><div class="insight-head"><div class="insight-title"> </div></div><div class="chart" id="memoChartDailyVolume"></div></section>
                <section class="insight-card"><div class="insight-head"><div class="insight-title"> </div></div><div class="chart" id="memoChartDailyAccuracy"></div></section>
                <section class="insight-card"><div class="insight-head"><div class="insight-title"> </div></div><div class="table-wrap" id="memoTableModeDistribution"></div></section>
                <section class="insight-card"><div class="insight-head"><div class="insight-title"> </div></div><div class="chart" id="memoChartAvgTimeTrend"></div></section>
                <section class="insight-card"><div class="insight-head"><div class="insight-title"></div></div><div class="table-wrap" id="memoTableTimeout"></div></section>
                <section class="insight-card"><div class="insight-head"><div class="insight-title"> vs </div></div><div class="table-wrap" id="memoTableWeekCompare"></div></section>
                <section class="insight-card"><div class="insight-head"><div class="insight-title">30 vs 30</div></div><div class="table-wrap" id="memoTableMonthCompare"></div></section>
              </div>
            </section>
            <section class="memo-calendar">
              <div class="memo-cal-head">
                <button class="textbtn" type="button" data-memo-action="monthPrev"></button>
                <div id="memoMonthLabel">${_escapeHtml(ym)}</div>
                <button class="textbtn" type="button" data-memo-action="monthNext"></button>
              </div>
              <div class="memo-cal-grid" id="memoWeekHeader"></div>
              <div class="memo-cal-grid" id="memoCalendarGrid"></div>
            </section>
          </div>
        `;
      }
      function _memoRenderCalendar(){
        const header = document.getElementById("memoWeekHeader");
        const grid = document.getElementById("memoCalendarGrid");
        const label = document.getElementById("memoMonthLabel");
        if (!grid || !header || !label) return;
        const w = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
        header.innerHTML = w.map(x => `<div class="memo-cal-week">${x}</div>`).join("");
        const base = new Date(_menuState.memoCheck.monthBaseTs || Date.now());
        const y = base.getFullYear();
        const m = base.getMonth();
        label.textContent = `${y}-${String(m+1).padStart(2,"0")}`;
        const first = new Date(y,m,1);
        const start = new Date(y,m,1-first.getDay());
        const daily = _memoGetDailyStudyCountMap();
        const allMemo = _memoLoadAll();
        const maxCount = Math.max(1, ...Array.from(daily.values()));
        const frag = document.createDocumentFragment();
        for (let i=0;i<42;i++){
          const d = new Date(start.getFullYear(), start.getMonth(), start.getDate()+i);
          const ymd = _memoToYmd(d.getTime());
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "memo-day" + (d.getMonth() !== m ? " is-out" : "");
          btn.dataset.memoDate = ymd;
          const c = daily.get(ymd) || 0;
          const alpha = c > 0 ? (0.08 + (c/maxCount)*0.36) : 0.03;
          btn.style.background = `rgba(31,42,68,${alpha.toFixed(3)})`;
          btn.innerHTML = `<div class="d">${d.getDate()}</div>${allMemo[ymd] ? `<div class="dot"></div>` : ``}`;
          frag.appendChild(btn);
        }
        grid.innerHTML = "";
        grid.appendChild(frag);
      }
      function _renderMemoDayHTML(dateYmd){
        const all = _memoLoadAll();
        const rec = all[dateYmd] || {};
        const slots = rec.slots || {};
        const blocks = Array.isArray(rec.blocks) ? rec.blocks : [];
        _menuState.memoCheck.draftBlocks = blocks.slice();
        return `
          <div class="memo-check">
            <section class="insight-card">
              <div class="insight-head">
                <div class="insight-title"></div>
                <div class="insight-note">${_escapeHtml(dateYmd)}</div>
              </div>
              <div class="row-actions" style="justify-content:space-between;">
                <button class="textbtn" type="button" data-memo-action="backCalendar"></button>
                <div class="mini">PC: DnD / Mobile: </div>
              </div>
              <div class="memo-block-pool" id="memoBlockPool">
                ${MEMO_DEFAULT_BLOCKS.map(t => `<button class="memo-block" draggable="true" type="button" data-memo-block="${_escapeHtml(t)}">${_escapeHtml(t)}</button>`).join("")}
              </div>
              <div style="display:flex; gap:8px; margin-top:8px;">
                <input id="memoCustomBlockInput" class="spell-input" type="text" placeholder="" />
                <button class="textbtn" type="button" data-memo-action="addCustomBlock"></button>
              </div>
              <div class="memo-picked" id="memoPickedBlocks">
                ${blocks.map(t => `<span class="memo-tag">${_escapeHtml(t)}</span>`).join("")}
              </div>
              <div class="memo-slots" style="margin-top:10px;">
                <div class="memo-slot" data-memo-slot="rangeText"><label>1) /</label><textarea id="memoRangeText">${_escapeHtml(slots.rangeText || "")}</textarea></div>
                <div class="memo-slot" data-memo-slot="weakText"><label>2) /</label><textarea id="memoWeakText">${_escapeHtml(slots.weakText || "")}</textarea></div>
                <div class="memo-slot" data-memo-slot="reasonText"><label>3) </label><textarea id="memoReasonText">${_escapeHtml(slots.reasonText || "")}</textarea></div>
                <div class="memo-slot" data-memo-slot="memoText"><label>4) </label><textarea id="memoMemoText">${_escapeHtml(slots.memoText || "")}</textarea></div>
              </div>
              <div class="row-actions">
                <button class="btn" type="button" data-memo-action="saveDay"></button>
                <button class="textbtn" type="button" data-memo-action="clearDay"></button>
                <button class="textbtn" type="button" data-memo-action="analyzeDay"></button>
              </div>
            </section>
            <section class="insight-card">
              <div class="insight-head">
                <div class="insight-title"></div>
                <div class="insight-note" id="memoRecommendedNote">${rec.recommended?.ids?.length ? `${rec.recommended.ids.length}` : ""}</div>
              </div>
              <div style="display:flex; gap:8px; margin-bottom:8px;">
                <select id="memoRecommendedMode" class="select" style="max-width:180px;">
                  <option value="AUTO"></option>
                  <option value="CHOICE">EXAM</option>
                  <option value="HAND">WRITE</option>
                </select>
                <button class="btn" type="button" data-memo-action="startRecommended"></button>
              </div>
              <div class="memo-reco-list" id="memoRecoList"></div>
            </section>
          </div>
        `;
      }
      function _memoCollectDayDraft(){
        return {
          rangeText: (document.getElementById("memoRangeText")?.value || "").trim(),
          weakText: (document.getElementById("memoWeakText")?.value || "").trim(),
          reasonText: (document.getElementById("memoReasonText")?.value || "").trim(),
          memoText: (document.getElementById("memoMemoText")?.value || "").trim(),
        };
      }
      function _memoAddPickedBlock(text){
        const t = String(text || "").trim();
        if (!t) return;
        if (!_menuState.memoCheck.draftBlocks.includes(t)){
          _menuState.memoCheck.draftBlocks.push(t);
          const p = document.getElementById("memoPickedBlocks");
          if (p){
            const tag = document.createElement("span");
            tag.className = "memo-tag";
            tag.textContent = t;
            p.appendChild(tag);
          }
        }
      }
      function _memoInsertToSlot(slotName, text){
        const map = { rangeText:"memoRangeText", weakText:"memoWeakText", reasonText:"memoReasonText", memoText:"memoMemoText" };
        const ta = document.getElementById(map[slotName] || "");
        if (!ta) return;
        const cur = ta.value.trim();
        ta.value = cur ? `${cur}\n${text}` : text;
      }
      function _memoAnalyze(dateYmd){
        const all = _memoLoadAll();
        const rec = all[dateYmd] || {};
        const slots = _memoCollectDayDraft();
        const joined = [slots.rangeText, slots.weakText, slots.reasonText, slots.memoText, (_menuState.memoCheck.draftBlocks || []).join(" ")].join("\n");
        const idSet = new Set();
        for (const m of joined.matchAll(/(?:No\.?|#)?\s*(\d{1,4})/gi)){
          const n = Number(m[1]);
          if (Number.isFinite(n)) idSet.add(n);
        }
        const enSet = new Set((joined.match(/\b[a-zA-Z][a-zA-Z'-]{1,}\b/g) || []).map(x => x.toLowerCase()));
        const jpSet = new Set(joined.match(/[---]{2,}/g) || []);
        const words = Array.isArray(data?.words) ? data.words : [];
        const score = new Map();
        const addScore = (id, v) => score.set(id, (score.get(id) || 0) + v);
        for (const w of words){
          const id = Number(w?.id);
          if (!Number.isFinite(id)) continue;
          const word = String(w?.word || "").toLowerCase();
          const meaning = String(w?.meaning || "");
          if (idSet.has(id)) addScore(id, 6);
          for (const t of enSet){ if (t && (word.includes(t) || String(w?.word || "").toLowerCase() === t)) addScore(id, 2); }
          for (const t of jpSet){ if (t && meaning.includes(t)) addScore(id, 2); }
        }
        const sessions = _insightsLoadSessions();
        const wrongFreq = new Map();
        for (const s of sessions){
          const ids = Array.isArray(s?.wrongIds) ? s.wrongIds : [];
          for (const id of ids){
            const n = Number(id);
            if (Number.isFinite(n)) wrongFreq.set(n, (wrongFreq.get(n) || 0) + 1);
          }
        }
        const hasReason = !!(slots.weakText || slots.reasonText);
        if (hasReason){
          for (const [id,c] of wrongFreq.entries()){
            addScore(id, c * 1.8);
          }
        }
        const list = Array.from(score.entries()).map(([id,s])=>({id, score:s})).sort((a,b)=>b.score-a.score).slice(0,50);
        const ids = list.map(x => x.id);
        const reasonText = `${slots.reasonText} ${_menuState.memoCheck.draftBlocks.join(" ")}`;
        let mode = "CHOICE";
        if (/|||||write/i.test(reasonText)) mode = "HAND";
        if (/|||exam/i.test(reasonText)) mode = "CHOICE";
        const recommended = { ids, mode, computedAt: Date.now() };
        all[dateYmd] = {
          blocks: _menuState.memoCheck.draftBlocks.slice(),
          slots,
          recommended,
          updatedAt: Date.now()
        };
        _memoSaveAll(all);
        _memoRenderRecoList(dateYmd);
        const note = document.getElementById("memoRecommendedNote");
        if (note) note.textContent = `${ids.length}`;
      }
      function _memoRenderRecoList(dateYmd){
        const listEl = document.getElementById("memoRecoList");
        if (!listEl) return;
        const all = _memoLoadAll();
        const rec = all[dateYmd]?.recommended || { ids: [] };
        const ids = Array.isArray(rec.ids) ? rec.ids : [];
        if (!ids.length){
          listEl.innerHTML = `<div class="insight-empty"></div>`;
          return;
        }
        const byId = data?.byId || new Map();
        listEl.innerHTML = "";
        const frag = document.createDocumentFragment();
        for (const id of ids.slice(0,50)){
          const w = byId.get(id);
          const row = document.createElement("div");
          row.className = "memo-reco-item";
          row.textContent = `No.${id} ${w?.word || "(unknown)"} / ${w?.meaning || ""}`;
          frag.appendChild(row);
        }
        listEl.appendChild(frag);
      }
      function _memoStartRecommended(dateYmd){
        const all = _memoLoadAll();
        const rec = all[dateYmd]?.recommended;
        const ids = Array.isArray(rec?.ids) ? rec.ids.slice(0, 50) : [];
        if (!ids.length){
          uiAlert("", { title: "" });
          return;
        }
        const sel = document.getElementById("memoRecommendedMode");
        const selected = (sel?.value || "AUTO");
        const mode = (selected === "AUTO") ? (rec.mode || "CHOICE") : selected;
        closeMenu();
        _setRecommendScope(ids);
        if (mode === "HAND") startMode("HAND");
        else startChoiceMode(0);
      }
      const DRAWER_SHARE_TTL_MS = 10 * 60 * 1000;
      let _drawerShareDb = null;

      function _drawerShareSanitizeCode(raw){
        return String(raw || "").toUpperCase().replace(/[^A-Z0-9]/g, "").slice(0, 6);
      }
      function _drawerShareMakeLink(code){
        const c = _drawerShareSanitizeCode(code);
        try{
          if (location && location.origin && location.pathname){
            return `${location.origin}${location.pathname}#share=${encodeURIComponent(c)}`;
          }
        }catch{
          // fall through
        }
        return `#share=${encodeURIComponent(c)}`;
      }
      function _drawerShareCodeFromHash(){
        try{
          const h = String(location.hash || "");
          const m = h.match(/(?:^#|[?&#])share=([A-Za-z0-9]+)/i);
          if (!m) return "";
          return _drawerShareSanitizeCode(m[1]);
        }catch{ return ""; }
      }
      function _drawerShareClearHash(){
        try{
          const clean = `${location.pathname}${location.search || ""}`;
          history.replaceState(null, "", clean);
        }catch{}
      }
      function _drawerShareSetStatus(elId, msg, kind){
        const elx = document.getElementById(elId);
        if (!elx) return;
        elx.textContent = String(msg || "");
        elx.classList.remove("ok","error");
        if (kind === "ok") elx.classList.add("ok");
        if (kind === "error") elx.classList.add("error");
      }
      function _drawerShareSetCreateState(state, detail, isError){
        const elx = document.getElementById("drawerShareCreateState");
        if (!elx) return;
        const base = `create status: ${String(state || "idle")}`;
        elx.textContent = detail ? `${base} / ${String(detail)}` : base;
        elx.classList.remove("ok","error");
        if (isError) elx.classList.add("error");
        else if (state === "saved" || state === "ui-updated") elx.classList.add("ok");
      }
      function _drawerShareCacheGet(presetId){
        const pid = String(presetId || "");
        if (!pid) return null;
        const cache = _shareCacheLoad();
        const e = cache && cache[pid];
        if (!e || typeof e !== "object") return null;
        const code = _drawerShareSanitizeCode(e.code || "");
        const shareLink = String(e.shareLink || e.shareUrl || "");
        const expiresAt = Number(e.expiresAt) || 0;
        if (!/^[A-Z0-9]{6}$/.test(code) || !shareLink || !expiresAt) return null;
        const remain = expiresAt - Date.now();
        if (remain > (DRAWER_SHARE_TTL_MS + 30000)) return null;
        return { code, shareLink, expiresAt };
      }
      function _drawerShareCacheSet(presetId, entry){
        const pid = String(presetId || "");
        if (!pid) return;
        const cache = _shareCacheLoad();
        if (!entry){
          delete cache[pid];
          _shareCacheSave(cache);
          return;
        }
        cache[pid] = {
          code: _drawerShareSanitizeCode(entry.code || ""),
          shareLink: String(entry.shareLink || ""),
          shareUrl: String(entry.shareLink || ""),
          expiresAt: Number(entry.expiresAt) || 0
        };
        _shareCacheSave(cache);
      }
      function _drawerShareGetDb(){
        if (_drawerShareDb) return _drawerShareDb;
        if (!window.firebase || typeof window.firebase.initializeApp !== "function" || !window.firebase.firestore){
          throw new Error("Firebase SDK ");
        }
        // If Firebase app is already initialized elsewhere, reuse it without re-checking config fields.
        if (window.firebase.apps && window.firebase.apps.length){
          _drawerShareDb = window.firebase.app().firestore();
          return _drawerShareDb;
        }
        const cfg = _resolveFirebaseConfigNow();
        if (!cfg || typeof cfg !== "object" || !cfg.apiKey || !cfg.projectId){
          const configured = _normalizeFirebaseConfig(window.__FIREBASE_CONFIG__);
          const missing = [];
          if (!configured.apiKey) missing.push("apiKey");
          if (!configured.projectId) missing.push("projectId");
          const hasPublicRoot = !!(window.__PUBLIC_CONFIG__ && typeof window.__PUBLIC_CONFIG__ === "object");
          throw new Error(`firebaseConfig config.public.js  meta missing=${missing.join(",") || "unknown"} hasPublicConfig=${hasPublicRoot ? "yes" : "no"}`);
        }
        window.firebase.initializeApp(cfg);
        _drawerShareDb = window.firebase.firestore();
        return _drawerShareDb;
      }
      function _drawerShareGenerateCode(){
        const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
        let out = "";
        for (let i=0;i<6;i++){
          out += chars[Math.floor(Math.random() * chars.length)];
        }
        return out;
      }
      function _drawerSharePresetPayload(preset){
        const modesRaw = (preset && preset.modes && typeof preset.modes === "object")
          ? preset.modes
          : { SEQ:true, RND:true, HAND:true, CHOICE:true };
        const modes = {
          SEQ: !!modesRaw.SEQ,
          RND: !!modesRaw.RND,
          HAND: !!modesRaw.HAND,
          CHOICE: !!modesRaw.CHOICE
        };
        const wordsRaw = Array.isArray(preset?.words) ? preset.words : [];
        const words = [];
        for (const w of wordsRaw){
          const n = normalizeWordEntry(w);
          if (!n) continue;
          words.push({ id: n.id, word: n.word, meaning: n.meaning });
        }
        words.sort((a,b)=>a.id-b.id);
        return {
          name: String(preset?.name || "My Preset"),
          modes,
          words
        };
      }
      async function _drawerShareCreateEntry(presetId){
        const pid = String(presetId || "");
        const preset = getPresetById(pid);
        if (!preset || preset.builtin){
          throw new Error(" My Preset ");
        }

        const cached = _drawerShareCacheGet(pid);
        if (cached && cached.expiresAt > Date.now() + 1000){
          return { ...cached, reused: true };
        }

        const db = _drawerShareGetDb();
        const payloadPreset = _drawerSharePresetPayload(preset);
        const appVersion = (typeof APP_VERSION === "string" && APP_VERSION) ? APP_VERSION : "v26";
        const expiresAtMs = Date.now() + DRAWER_SHARE_TTL_MS;
        const expiresAtTs = window.firebase.firestore.Timestamp.fromMillis(expiresAtMs);
        const createdAtTs = window.firebase.firestore.FieldValue.serverTimestamp();

        for (let i=0;i<10;i++){
          const code = _drawerShareGenerateCode();
          const ref = db.collection("shares").doc(code);
          try{
            const exists = await ref.get();
            if (exists && exists.exists){
              _drawerShareSetCreateState("collision", `retry ${i+1}/10`);
              continue;
            }
            await ref.set({
              appVersion,
              schemaVersion: 1,
              createdAt: createdAtTs,
              expiresAt: expiresAtTs,
              preset: payloadPreset
            });
            const entry = {
              code,
              shareLink: _drawerShareMakeLink(code),
              shareUrl: _drawerShareMakeLink(code),
              expiresAt: expiresAtMs
            };
            _drawerShareCacheSet(pid, entry);
            _drawerShareSetCreateState("saved");
            return { ...entry, reused: false };
          }catch(err){
            const s = String(err?.code || err?.message || "").toLowerCase();
            if (/already[-_ ]exists|alread[y_ -]?exists/.test(s)){
              _drawerShareSetCreateState("collision", `retry ${i+1}/10`);
              continue;
            }
            if (/permission[-_ ]denied/.test(s)){
              try{
                const again = await ref.get();
                if (again && again.exists){
                  _drawerShareSetCreateState("collision", `retry ${i+1}/10`);
                  continue;
                }
              }catch{}
            }
            throw err;
          }
        }
        const e = new Error("CODE_GEN_FAILED");
        e.kind = "CODE_GEN_FAILED";
        throw e;
      }
      function _drawerShareTsToMs(v){
        if (!v) return 0;
        if (typeof v.toMillis === "function") return Number(v.toMillis()) || 0;
        if (typeof v.seconds === "number"){
          const ns = Number(v.nanoseconds || 0);
          return (Number(v.seconds) * 1000) + Math.floor(ns / 1e6);
        }
        return Number(v) || 0;
      }
      async function _drawerShareFetchByCode(codeRaw){
        const code = _drawerShareSanitizeCode(codeRaw);
        if (!/^[A-Z0-9]{6}$/.test(code)){
          const e = new Error("INVALID_CODE");
          e.kind = "INVALID_CODE";
          throw e;
        }
        const db = _drawerShareGetDb();
        const snap = await db.collection("shares").doc(code).get();
        if (!snap.exists){
          const e = new Error("NOT_FOUND");
          e.kind = "NOT_FOUND";
          throw e;
        }
        const body = snap.data() || {};
        const expMs = _drawerShareTsToMs(body.expiresAt);
        if (!expMs || expMs <= Date.now()){
          const e = new Error("EXPIRED");
          e.kind = "EXPIRED";
          throw e;
        }
        const appVersion = (typeof APP_VERSION === "string" && APP_VERSION) ? APP_VERSION : "v26";
        if (String(body.appVersion || "") !== String(appVersion) || Number(body.schemaVersion || 0) !== 1){
          const e = new Error("VERSION_MISMATCH");
          e.kind = "VERSION_MISMATCH";
          throw e;
        }
        return { code, expMs, body };
      }
      function _drawerShareImportErrorText(err){
        const k = String(err?.kind || err?.message || "");
        if (k === "INVALID_CODE") return "6";
        if (k === "NOT_FOUND") return "NOT_FOUND: ";
        if (k === "EXPIRED") return "EXPIRED: ";
        if (k === "VERSION_MISMATCH") return "VERSION_MISMATCH: ";
        return "";
      }
      function _drawerShareImportPreset(body){
        const src = body && body.preset;
        if (!src || typeof src !== "object"){
          throw new Error("");
        }
        const list = loadPresets();
        const baseName = String(src.name || "Shared Preset");
        const name = _uniquePresetName(baseName, list);
        const wordsRaw = Array.isArray(src.words) ? src.words : [];
        const words = [];
        for (const w of wordsRaw){
          const n = normalizeWordEntry(w);
          if (n) words.push(n);
        }
        words.sort((a,b)=>a.id-b.id);

        const m = (src.modes && typeof src.modes === "object")
          ? src.modes
          : { SEQ:true, RND:true, HAND:true, CHOICE:true };
        const preset = {
          id: newId(),
          name,
          builtin: false,
          modes: {
            SEQ: !!m.SEQ,
            RND: !!m.RND,
            HAND: !!m.HAND,
            CHOICE: !!m.CHOICE
          },
          words
        };
        list.unshift(preset);
        savePresets(list);
        setActivePreset(preset.id);
        try{ refreshPresetList(); }catch{}
        return preset;
      }
      function _drawerShareApplyTab(tab){
        const t = (tab === "import") ? "import" : "share";
        _menuState.presetShare.tab = t;
        const sendTab = document.getElementById("drawerShareTabSend");
        const importTab = document.getElementById("drawerShareTabImport");
        const sendPanel = document.getElementById("drawerShareSendPanel");
        const importPanel = document.getElementById("drawerShareImportPanel");
        if (sendTab) sendTab.classList.toggle("active", t === "share");
        if (importTab) importTab.classList.toggle("active", t === "import");
        if (sendPanel) sendPanel.classList.toggle("hidden", t !== "share");
        if (importPanel) importPanel.classList.toggle("hidden", t !== "import");
      }
      function _drawerShareRenderPresetOptions(){
        const sel = document.getElementById("drawerSharePresetSelect");
        const createBtn = document.getElementById("drawerShareCreateBtn");
        if (!sel) return;
        const list = loadPresets();
        const prev = String(_menuState.presetShare.selectedPresetId || "");
        sel.innerHTML = "";
        if (!list.length){
          const o = document.createElement("option");
          o.value = "";
          o.textContent = "My Preset ";
          sel.appendChild(o);
          sel.disabled = true;
          if (createBtn) createBtn.disabled = true;
          _menuState.presetShare.selectedPresetId = "";
          return;
        }
        sel.disabled = false;
        if (createBtn) createBtn.disabled = false;
        for (const p of list){
          const o = document.createElement("option");
          const count = Array.isArray(p.words) ? p.words.length : 0;
          o.value = p.id;
          o.textContent = `${p.name || "My Preset"} (${count})`;
          sel.appendChild(o);
        }
        if (prev && list.some(p => p.id === prev)) sel.value = prev;
        else sel.value = list[0].id;
        _menuState.presetShare.selectedPresetId = sel.value;
      }
      function _drawerShareRenderQROnce(shareLink){
        const img = document.getElementById("drawerShareQrImg");
        const status = document.getElementById("drawerShareQrStatus");
        if (!img || !status){
          return;
        }
        img.style.display = "none";
        status.textContent = "QR";
        const src = `https://api.qrserver.com/v1/create-qr-code/?size=240x240&data=${encodeURIComponent(String(shareLink || ""))}`;
        let done = false;
        const timeoutId = setTimeout(() => {
          if (done) return;
          done = true;
          img.style.display = "none";
          status.textContent = "QR";
        }, 5000);
        img.onload = () => {
          if (done) return;
          done = true;
          clearTimeout(timeoutId);
          img.style.display = "block";
          status.textContent = "";
        };
        img.onerror = () => {
          if (done) return;
          done = true;
          clearTimeout(timeoutId);
          img.style.display = "none";
          status.textContent = "QR";
        };
        img.src = src;
      }
      function _drawerShareRenderCountdown(){
        const expEl = document.getElementById("drawerShareExpires");
        if (!expEl) return;
        const exp = Number(_menuState.presetShare.entry?.expiresAt || 0);
        if (!exp){
          expEl.textContent = "Expires in --:--";
          return;
        }
        const ms = exp - Date.now();
        const sec = Math.max(0, Math.floor(ms / 1000));
        const mm = String(Math.floor(sec / 60)).padStart(2, "0");
        const ss = String(sec % 60).padStart(2, "0");
        expEl.textContent = `Expires in ${mm}:${ss}`;
      }
      function _drawerShareStopTimer(){
        const id = _menuState.presetShare.timerId;
        if (id){
          clearInterval(id);
          _menuState.presetShare.timerId = null;
        }
      }
      function _drawerShareStartTimer(){
        _drawerShareStopTimer();
        _drawerShareRenderCountdown();
        _menuState.presetShare.timerId = setInterval(() => {
          if (_menuState.view !== "presetShare"){
            _drawerShareStopTimer();
            return;
          }
          _drawerShareRenderCountdown();
          const entry = _menuState.presetShare.entry;
          if (!entry || !entry.expiresAt) return;
          if (entry.expiresAt <= Date.now() && !_menuState.presetShare.creating){
            _drawerShareCreateNow(true);
          }
        }, 1000);
      }
      function _drawerShareRenderEntry(entry){
        const codeEl = document.getElementById("drawerShareCode");
        const linkEl = document.getElementById("drawerShareLinkText");
        const qrImg = document.getElementById("drawerShareQrImg");
        const qrStatus = document.getElementById("drawerShareQrStatus");
        const copyCodeBtn = document.getElementById("drawerShareCopyCodeBtn");
        const copyLinkBtn = document.getElementById("drawerShareCopyLinkBtn");
        if (!entry){
          if (codeEl) codeEl.textContent = "---";
          if (linkEl) linkEl.textContent = "";
          if (qrImg) qrImg.style.display = "none";
          if (qrStatus) qrStatus.textContent = "QR";
          if (copyCodeBtn) copyCodeBtn.disabled = true;
          if (copyLinkBtn) copyLinkBtn.disabled = true;
          _drawerShareStopTimer();
          _drawerShareRenderCountdown();
          return;
        }
        const code = _drawerShareSanitizeCode(entry.code || "");
        if (codeEl) codeEl.textContent = `${code.slice(0,3)} ${code.slice(3)}`;
        if (linkEl) linkEl.textContent = String(entry.shareLink || "");
        if (copyCodeBtn) copyCodeBtn.disabled = false;
        if (copyLinkBtn) copyLinkBtn.disabled = false;
        _drawerShareRenderQROnce(entry.shareLink);
        _drawerShareRenderCountdown();
        _drawerShareStartTimer();
        _drawerShareSetCreateState("ui-updated");
      }
      async function _drawerShareCreateNow(silent){
        const select = document.getElementById("drawerSharePresetSelect");
        const pid = String((select && select.value) || _menuState.presetShare.selectedPresetId || "");
        if (!pid){
          _drawerShareSetStatus("drawerShareSendStatus", " My Preset ", "error");
          _drawerShareSetCreateState("failed", " My Preset ", true);
          return;
        }
        if (_menuState.presetShare.creating) return;
        _menuState.presetShare.creating = true;
        const btn = document.getElementById("drawerShareCreateBtn");
        if (btn) btn.disabled = true;
        _drawerShareSetStatus("drawerShareSendStatus", "");
        _drawerShareSetCreateState("started");
        try{
          const entry = await _drawerShareCreateEntry(pid);
          _menuState.presetShare.selectedPresetId = pid;
          _menuState.presetShare.entry = entry;
          _drawerShareRenderEntry(entry);
          if (!silent){
            const msg = entry.reused ? "" : "";
            _drawerShareSetStatus("drawerShareSendStatus", msg, "ok");
          }
        }catch(err){
          console.warn("[DrawerShare] create failed:", err);
          const msgRaw = String(err?.message || "");
          const msg = (msgRaw === "CODE_GEN_FAILED")
            ? ""
            : `: ${msgRaw || "unknown error"}`;
          _drawerShareSetStatus("drawerShareSendStatus", msg, "error");
          _drawerShareSetCreateState("failed", msgRaw || "unknown error", true);
          _drawerShareRenderEntry(null);
          const qrStatus = document.getElementById("drawerShareQrStatus");
          if (qrStatus) qrStatus.textContent = "QR";
        }finally{
          _menuState.presetShare.creating = false;
          if (btn) btn.disabled = false;
        }
      }
      async function _drawerShareImportByCode(codeRaw, fromHash){
        const code = _drawerShareSanitizeCode(codeRaw);
        const input = document.getElementById("drawerShareImportCode");
        if (input) input.value = code;
        if (_menuState.presetShare.importing) return;
        _menuState.presetShare.importing = true;
        const btn = document.getElementById("drawerShareImportBtn");
        if (btn) btn.disabled = true;
        _drawerShareSetStatus("drawerShareImportStatus", "");
        try{
          const got = await _drawerShareFetchByCode(code);
          const preset = _drawerShareImportPreset(got.body);
          _drawerShareSetStatus("drawerShareImportStatus", `: ${preset.name}`, "ok");
          _drawerShareRenderPresetOptions();
          if (fromHash){
            _drawerShareClearHash();
            _menuState.presetShare.hashCode = "";
          }
        }catch(err){
          _drawerShareSetStatus("drawerShareImportStatus", _drawerShareImportErrorText(err), "error");
        }finally{
          _menuState.presetShare.importing = false;
          if (btn) btn.disabled = false;
        }
      }
      function _drawerShareRefreshBySelection(){
        const sel = document.getElementById("drawerSharePresetSelect");
        const pid = String(sel?.value || "");
        _menuState.presetShare.selectedPresetId = pid;
        if (!pid){
          _menuState.presetShare.entry = null;
          _drawerShareRenderEntry(null);
          _drawerShareSetCreateState("idle");
          return;
        }
        const cached = _drawerShareCacheGet(pid);
        if (cached && cached.expiresAt > Date.now() + 1000){
          _menuState.presetShare.entry = cached;
          _drawerShareRenderEntry(cached);
          _drawerShareSetStatus("drawerShareSendStatus", "", "ok");
          _drawerShareSetCreateState("ui-updated", "cached");
        } else {
          _menuState.presetShare.entry = null;
          _drawerShareRenderEntry(null);
          _drawerShareSetStatus("drawerShareSendStatus", "", "");
          _drawerShareSetCreateState("idle");
        }
      }
      function _drawerShareInitView(){
        if (_menuState.view !== "presetShare") return;
        _drawerShareRenderPresetOptions();
        _drawerShareApplyTab(_menuState.presetShare.tab || "share");
        _drawerShareRefreshBySelection();

        const importInput = document.getElementById("drawerShareImportCode");
        if (importInput){
          const pre = _drawerShareSanitizeCode(importInput.value || "");
          if (pre !== importInput.value) importInput.value = pre;
        }

        const hashCode = _menuState.presetShare.hashCode || _drawerShareCodeFromHash();
        if (hashCode){
          _menuState.presetShare.tab = "import";
          _drawerShareApplyTab("import");
          if (importInput) importInput.value = hashCode;
          if (!_menuState.presetShare.hashTried){
            _menuState.presetShare.hashTried = true;
            _drawerShareImportByCode(hashCode, true);
          }
        }
      }
      function _memoInitView(){
        if (_menuState.view === "memoCheck"){
          _insightsBuildPresetOptions();
          const src = document.getElementById("insightsPresetSelect");
          const dst = document.getElementById("memoInsightsPresetSelect");
          if (src && dst){
            dst.innerHTML = src.innerHTML;
            dst.value = insights.preset || "CURRENT";
          }
          const m = document.getElementById("memoInsightsModeSelect");
          const r = document.getElementById("memoInsightsRangeSelect");
          if (m) m.value = insights.mode || "ALL";
          if (r) r.value = insights.range || "30D";
          _memoRenderInsightsTop();
          _memoRenderCalendar();
        } else if (_menuState.view === "memoDay"){
          _memoRenderRecoList(_menuState.memoCheck.currentDate);
          const all = _memoLoadAll();
          const recMode = all[_menuState.memoCheck.currentDate]?.recommended?.mode || "CHOICE";
          const modeEl = document.getElementById("memoRecommendedMode");
          if (modeEl) modeEl.value = recMode;
        } else if (_menuState.view === "presetShare"){
          _drawerShareInitView();
        }
      }

      function _setMenuView(view){
        const { overlay, panel, title, content } = _menuEls();
        if(!panel || !title || !content) return;

        if(!_menuState.rootHtml){
          _menuState.rootHtml = content.innerHTML || "";
        }

        _menuState.view = view;

        let ttl = "MENU";
        let html = _menuState.rootHtml;

        if(view === "root"){
          panel.classList.remove("has-back");
          ttl = "MENU";
          html = _menuState.rootHtml;
        } else {
          panel.classList.add("has-back");
          if(view === "help"){ ttl = "Help"; html = _renderHelpHTML(); }
          else if(view === "terms"){ ttl = "Terms"; html = _renderTermsHTML(); }
          else if(view === "report"){ ttl = "Report"; html = _renderReportFormHTML(); }
          else if(view === "reportConfirm"){ ttl = "Report"; html = _renderReportConfirmHTML(); }
          else if(view === "reportDone"){ ttl = "Report"; html = _renderReportDoneHTML(); }
          else if(view === "memoCheck"){ ttl = ""; html = _renderMemoCheckHTML(); }
          else if(view === "memoDay"){ ttl = ""; html = _renderMemoDayHTML(_menuState.memoCheck.currentDate || _memoToYmd(Date.now())); }
          else if(view === "presetShare"){ ttl = ""; html = _renderPresetShareHTML(); }
          else { ttl = "MENU"; html = _menuState.rootHtml; panel.classList.remove("has-back"); _menuState.view = "root"; }
        }

        if (view !== "presetShare") _drawerShareStopTimer();

        const isMemoFull = (view === "memoCheck" || view === "memoDay");
        panel.classList.toggle("memo-full", isMemoFull);
        if (overlay) overlay.classList.toggle("memo-full", isMemoFull);

        title.textContent = ttl;
        content.innerHTML = html;

        // Always show the top of the content
        try{ content.scrollTop = 0; }catch(_){}
        requestAnimationFrame(()=>{
          try{ content.focus({ preventScroll: true }); }catch(_){}
        });
        _memoInitView();
      }

      function openMenu(){
        const { overlay, panel } = _menuEls();
        if(!overlay || !panel) return;

        overlay.hidden = false;
        panel.hidden = false;

        // Reset to root each time (no scroll position carry-over)
        _setMenuView("root");

        requestAnimationFrame(()=>{
          overlay.classList.add("open");
          panel.classList.add("open");
        });
      }

      function closeMenu(){
        const { overlay, panel } = _menuEls();
        if(!overlay || !panel) return;

        overlay.classList.remove("open");
        overlay.classList.remove("memo-full");
        panel.classList.remove("open");
        panel.classList.remove("has-back");
        panel.classList.remove("memo-full");
        _drawerShareStopTimer();

        // Stop "sending" state when drawer is closed to avoid stuck UI on next open
        _menuState.sending = false;

        setTimeout(()=>{
          overlay.hidden = true;
          panel.hidden = true;
          // Keep the root view cached
          _menuState.view = "root";
        }, 260);
      }

      function toggleMenu(){
        const { panel } = _menuEls();
        if(panel && !panel.hidden) closeMenu();
        else openMenu();
      }

      function _menuBack(){
        if(_menuState.view === "reportConfirm"){
          _setMenuView("report");
          return;
        }
        if(_menuState.view === "reportDone"){
          _setMenuView("root");
          return;
        }
        if(_menuState.view === "memoDay"){
          _setMenuView("memoCheck");
          return;
        }
        if(_menuState.view !== "root"){
          _setMenuView("root");
          return;
        }
        closeMenu();
      }

      function _handleMenuAction(action){
        if(!action) return;
        if(action === "help"){ _setMenuView("help"); return; }
        if(action === "terms"){ _setMenuView("terms"); return; }
        if(action === "report"){ _setMenuView("report"); return; }
        if(action === "memoCheck"){ _setMenuView("memoCheck"); return; }
        if(action === "presetShare"){ _setMenuView("presetShare"); return; }

        if(action === "settings"){
          closeMenu();
          try{
            if(typeof openSettings === "function") openSettings();
            else if(typeof openSettingsPanel === "function") openSettingsPanel();
            else if(typeof openSettingsModal === "function") openSettingsModal();
            else uiToast("Settings UI");
          }catch(err){
            uiToast("Settings: " + (err && err.message ? err.message : err));
          }
        }
      }

      function _readReportDraftFromDOM(){
        const email = (document.getElementById("reportEmail")?.value || "").trim();
        const subject = (document.getElementById("reportSubject")?.value || "").trim();
        const message = (document.getElementById("reportMessage")?.value || "").trim();
        return { email, subject, message };
      }

      async function _sendReportViaEmailJS(draft){
        if(!EMAILJS_PUBLIC_KEY || !EMAILJS_SERVICE_ID || !EMAILJS_TEMPLATE_ID){
          throw new Error("EmailJS config.public.js  meta ");
        }
        if(!_ensureEmailJSInit()){
          throw new Error("EmailJS /");
        }

        const appVersion = (typeof APP_VERSION === "string" && APP_VERSION) ? APP_VERSION : "v26";
        const params = {
          reply_to: draft.email,
          subject: draft.subject,
          message: draft.message,
          app_version: appVersion,
          page: location.href,
          user_agent: navigator.userAgent,
          sent_at: _fmtLocalSentAt(),
        };

        return window.emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, params);
      }

      function initMenu(){
        if(_menuState.inited) return;
        _menuState.inited = true;

        const { btn, overlay, panel, content } = _menuEls();

        // Cache the root list HTML once
        if(content && !_menuState.rootHtml){
          _menuState.rootHtml = content.innerHTML || "";
        }

        // Init EmailJS once after DOMContentLoaded
        _ensureEmailJSInit();

        // Delegation click handler (prevents "click does nothing" bugs)
        document.addEventListener("click", async (e)=>{
          // Menu button
          const menuBtn = e.target.closest("#menuBtn");
          if(menuBtn){
            e.preventDefault();
            toggleMenu();
            return;
          }

          // Overlay click closes
          const ov = e.target.closest("#menuOverlay");
          if(ov){
            e.preventDefault();
            closeMenu();
            return;
          }

          // Close / Back
          const closeBtn = e.target.closest('[data-menu-action="close"]');
          if(closeBtn && closeBtn.closest("#menuPanel")){
            e.preventDefault();
            closeMenu();
            return;
          }
          const backBtn = e.target.closest('[data-menu-action="back"]');
          if(backBtn && backBtn.closest("#menuPanel")){
            e.preventDefault();
            _menuBack();
            return;
          }

          // Menu items
          const item = e.target.closest('.menu-item[data-menu-action]');
          if(item && item.closest("#menuPanel")){
            e.preventDefault();
            _handleMenuAction(item.getAttribute("data-menu-action"));
            return;
          }

          // Memo check actions
          const memoBtn = e.target.closest("[data-memo-action]");
          if (memoBtn && memoBtn.closest("#menuPanel")){
            e.preventDefault();
            const act = memoBtn.getAttribute("data-memo-action");
            if (act === "monthPrev"){
              const d = new Date(_menuState.memoCheck.monthBaseTs || Date.now());
              d.setMonth(d.getMonth()-1, 1);
              _menuState.memoCheck.monthBaseTs = d.getTime();
              _memoRenderCalendar();
              return;
            }
            if (act === "monthNext"){
              const d = new Date(_menuState.memoCheck.monthBaseTs || Date.now());
              d.setMonth(d.getMonth()+1, 1);
              _menuState.memoCheck.monthBaseTs = d.getTime();
              _memoRenderCalendar();
              return;
            }
            if (act === "backCalendar"){
              _setMenuView("memoCheck");
              return;
            }
            if (act === "addCustomBlock"){
              const ip = document.getElementById("memoCustomBlockInput");
              const t = (ip?.value || "").trim();
              if (t){
                _memoAddPickedBlock(t);
                if (ip) ip.value = "";
              }
              return;
            }
            if (act === "saveDay"){
              const dateYmd = _menuState.memoCheck.currentDate || _memoToYmd(Date.now());
              const all = _memoLoadAll();
              const existing = all[dateYmd] || {};
              all[dateYmd] = {
                blocks: _menuState.memoCheck.draftBlocks.slice(),
                slots: _memoCollectDayDraft(),
                recommended: existing.recommended || null,
                updatedAt: Date.now()
              };
              _memoSaveAll(all);
              uiToast("");
              return;
            }
            if (act === "clearDay"){
              ["memoRangeText","memoWeakText","memoReasonText","memoMemoText"].forEach(id => {
                const elx = document.getElementById(id);
                if (elx) elx.value = "";
              });
              _menuState.memoCheck.draftBlocks = [];
              const picked = document.getElementById("memoPickedBlocks");
              if (picked) picked.innerHTML = "";
              return;
            }
            if (act === "analyzeDay"){
              const dateYmd = _menuState.memoCheck.currentDate || _memoToYmd(Date.now());
              _memoAnalyze(dateYmd);
              return;
            }
            if (act === "startRecommended"){
              const dateYmd = _menuState.memoCheck.currentDate || _memoToYmd(Date.now());
              _memoStartRecommended(dateYmd);
              return;
            }
          }

          const shareTabBtn = e.target.closest("[data-share-tab]");
          if (shareTabBtn && shareTabBtn.closest("#menuPanel")){
            e.preventDefault();
            const tab = shareTabBtn.getAttribute("data-share-tab");
            _drawerShareApplyTab(tab === "import" ? "import" : "share");
            return;
          }

          const shareBtn = e.target.closest("[data-share-action]");
          if (shareBtn && shareBtn.closest("#menuPanel")){
            e.preventDefault();
            const act = shareBtn.getAttribute("data-share-action");
            if (act === "create"){
              _drawerShareCreateNow(false);
              return;
            }
            if (act === "copyCode"){
              const code = _menuState.presetShare.entry?.code || "";
              if (!code) return;
              const ok = await _copyText(code);
              uiToast(ok ? "" : "");
              return;
            }
            if (act === "copyLink"){
              const link = _menuState.presetShare.entry?.shareLink || "";
              if (!link) return;
              const ok = await _copyText(link);
              uiToast(ok ? "" : "");
              return;
            }
            if (act === "import"){
              const code = document.getElementById("drawerShareImportCode")?.value || "";
              _drawerShareImportByCode(code, false);
              return;
            }
          }

          const calDay = e.target.closest("[data-memo-date]");
          if (calDay && calDay.closest("#menuPanel")){
            e.preventDefault();
            const ymd = calDay.getAttribute("data-memo-date");
            _menuState.memoCheck.currentDate = ymd || _memoToYmd(Date.now());
            _setMenuView("memoDay");
            return;
          }

          const memoBlock = e.target.closest("[data-memo-block]");
          if (memoBlock && memoBlock.closest("#menuPanel")){
            e.preventDefault();
            const txt = memoBlock.getAttribute("data-memo-block") || "";
            _menuState.memoCheck.selectedBlock = txt;
            document.querySelectorAll("#menuPanel [data-memo-block]").forEach(x => x.classList.toggle("is-selected", x === memoBlock));
            _memoAddPickedBlock(txt);
            return;
          }

          const memoSlot = e.target.closest(".memo-slot[data-memo-slot]");
          if (memoSlot && memoSlot.closest("#menuPanel")){
            const selected = _menuState.memoCheck.selectedBlock;
            if (selected){
              _memoInsertToSlot(memoSlot.getAttribute("data-memo-slot"), selected);
            }
            return;
          }

          // Report actions
          const rbtn = e.target.closest('[data-report-action]');
          if(rbtn && rbtn.closest("#menuPanel")){
            e.preventDefault();

            const act = rbtn.getAttribute("data-report-action");

            if(act === "goConfirm"){
              const draft = _readReportDraftFromDOM();
              _menuState.reportDraft = draft;

              if(!draft.email || !_isValidEmail(draft.email)){
                _setReportStatus("", true);
                return;
              }
              if(!draft.subject){
                _setReportStatus("", true);
                return;
              }
              if(!draft.message){
                _setReportStatus("", true);
                return;
              }

              _setMenuView("reportConfirm");
              return;
            }

            if(act === "backEdit"){
              _setMenuView("report");
              return;
            }

            if(act === "sendConfirm"){
              if(_menuState.sending) return;

              const draft = _menuState.reportDraft || _readReportDraftFromDOM();

              if(!draft.email || !_isValidEmail(draft.email)){
                _setReportStatus("", true);
                return;
              }
              if(!draft.subject){
                _setReportStatus("", true);
                return;
              }
              if(!draft.message){
                _setReportStatus("", true);
                return;
              }

              _menuState.sending = true;
              _setReportStatus("", false);

              // Disable button & show progress
              const btnEl = rbtn;
              const prevText = btnEl.textContent;
              btnEl.disabled = true;
              btnEl.textContent = "";

              try{
                await _sendReportViaEmailJS(draft);
                _menuState.sending = false;

                // Clear draft after success
                _menuState.reportDraft = { email:"", subject:"", message:"" };

                _setMenuView("reportDone");
              }catch(err){
                _menuState.sending = false;
                console.warn("[Report] send failed:", err);

                btnEl.disabled = false;
                btnEl.textContent = prevText || "";

                _setReportStatus((err && err.message) ? err.message : "", true);
              }
              return;
            }

            if(act === "doneClose"){
              closeMenu();
              return;
            }
          }
        }, true);

        document.addEventListener("change", (e)=>{
          const t = e.target;
          if (!(t instanceof Element)) return;
          if (!t.closest("#menuPanel")) return;
          if (t.id === "memoInsightsPresetSelect" || t.id === "memoInsightsModeSelect" || t.id === "memoInsightsRangeSelect"){
            _memoRenderInsightsTop();
            return;
          }
          if (t.id === "drawerSharePresetSelect"){
            _menuState.presetShare.selectedPresetId = t.value || "";
            _drawerShareRefreshBySelection();
          }
        }, true);

        document.addEventListener("input", (e)=>{
          const t = e.target;
          if (!(t instanceof HTMLInputElement)) return;
          if (!t.closest("#menuPanel")) return;
          if (t.id === "drawerShareImportCode"){
            const code = _drawerShareSanitizeCode(t.value);
            if (code !== t.value) t.value = code;
          }
        }, true);

        document.addEventListener("dragstart", (e)=>{
          const block = e.target && e.target.closest ? e.target.closest("[data-memo-block]") : null;
          if (!block || !block.closest("#menuPanel")) return;
          const text = block.getAttribute("data-memo-block") || "";
          if (!e.dataTransfer) return;
          e.dataTransfer.setData("text/plain", text);
          e.dataTransfer.effectAllowed = "copy";
        }, true);
        document.addEventListener("dragover", (e)=>{
          const slot = e.target && e.target.closest ? e.target.closest(".memo-slot[data-memo-slot]") : null;
          if (!slot || !slot.closest("#menuPanel")) return;
          e.preventDefault();
          if (e.dataTransfer) e.dataTransfer.dropEffect = "copy";
        }, true);
        document.addEventListener("drop", (e)=>{
          const slot = e.target && e.target.closest ? e.target.closest(".memo-slot[data-memo-slot]") : null;
          if (!slot || !slot.closest("#menuPanel")) return;
          e.preventDefault();
          const text = e.dataTransfer ? e.dataTransfer.getData("text/plain") : "";
          if (!text) return;
          _memoAddPickedBlock(text);
          _memoInsertToSlot(slot.getAttribute("data-memo-slot"), text);
        }, true);

        document.addEventListener("keydown", (e)=>{
          const t = e.target;
          if (!(t instanceof HTMLElement)) return;
          if (!t.closest("#menuPanel")) return;
          if (t.id !== "drawerShareImportCode") return;
          if (e.key !== "Enter") return;
          e.preventDefault();
          _drawerShareImportByCode(t.value || "", false);
        }, true);

        // Esc closes drawer (but never steals keys while typing)
        document.addEventListener("keydown", (e)=>{
          if(e.key !== "Escape") return;
          if(typeof _isTyping === "function" && _isTyping()) return;

          const { panel } = _menuEls();
          if(panel && !panel.hidden){
            e.preventDefault();
            closeMenu();
          }
        }, true);

        // Safety: if critical DOM is missing, show a toast so it's never "silent"
        if(!btn || !overlay || !panel){
          try{ uiToast("UI"); }catch(_){}
        }

        const hashCode = _drawerShareCodeFromHash();
        if (hashCode){
          _menuState.presetShare.tab = "import";
          _menuState.presetShare.hashCode = hashCode;
          _menuState.presetShare.hashTried = false;
          setTimeout(() => {
            openMenu();
            _setMenuView("presetShare");
          }, 0);
        }
      }
window.addEventListener("DOMContentLoaded", initMenu);
      if (document.readyState === "complete" || document.readyState === "interactive"){
        setTimeout(initMenu, 0);
      }

})();
  
/* ============================================================
   SERVER (Cloudflare Workers + KV) - reference implementation
   ------------------------------------------------------------
   This client expects:
     POST  /api/share/create
     GET   /api/share/get?code=ABC123
     GET   /s/ABC123
   and CORS: Access-Control-Allow-Origin: *

   1) wrangler.toml (example)
   ------------------------------------------------------------
   name = "word-practice-share"
   main = "src/worker.js"
   compatibility_date = "2026-02-10"

   [[kv_namespaces]]
   binding = "SHAREKV"
   id = "YOUR_KV_ID"

   2) src/worker.js (example)
   ------------------------------------------------------------
   export default {
     async fetch(request, env) {
       const url = new URL(request.url);
       const path = url.pathname;

       // CORS
       if (request.method === "OPTIONS") {
         return new Response(null, {
           status: 204,
           headers: {
             "Access-Control-Allow-Origin": "*",
             "Access-Control-Allow-Methods": "GET,POST,OPTIONS",
             "Access-Control-Allow-Headers": "Content-Type",
             "Access-Control-Max-Age": "86400",
           },
         });
       }
       const cors = { "Access-Control-Allow-Origin": "*" };

       const json = (obj, status=200) => new Response(JSON.stringify(obj), {
         status,
         headers: { "Content-Type":"application/json; charset=utf-8", ...cors }
       });

       const html = (body, status=200) => new Response(body, {
         status,
         headers: { "Content-Type":"text/html; charset=utf-8", ...cors }
       });

       const randomCode = () => {
         const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
         let out = "";
         for (let i=0;i<6;i++) out += chars[Math.floor(Math.random()*chars.length)];
         return out;
       };

       if (path === "/api/share/create" && request.method === "POST") {
         const ct = request.headers.get("content-type") || "";
         if (!ct.includes("application/json")) return json({message:"JSON only"}, 400);
         const body = await request.json().catch(()=>null);
         if (!body || body.schemaVersion !== 1 || !body.preset) return json({message:"bad payload"}, 400);

         const payload = JSON.stringify({
           schemaVersion: 1,
           createdAt: Date.now(),
           expiresAt: Date.now() + 7*24*60*60*1000,
           preset: body.preset
         });

         if (payload.length > 200*1024) return json({message:"payload too large"}, 413);

         // generate non-colliding code
         let code = "";
         for (let i=0;i<12;i++){
           code = randomCode();
           const k = "SHARE:" + code;
           const exists = await env.SHAREKV.get(k);
           if (!exists){
             await env.SHAREKV.put(k, payload, { expirationTtl: 7*24*60*60 });
             break;
           }
           code = "";
         }
         if (!code) return json({message:"failed to allocate code"}, 500);

         const shareUrl = `${url.origin}/s/${code}`;
         return json({ code, shareUrl, expiresAt: Date.now() + 7*24*60*60*1000 }, 200);
       }

       if (path === "/api/share/get" && request.method === "GET") {
         const code = (url.searchParams.get("code") || "").toUpperCase();
         if (!/^[A-Z0-9]{6}$/.test(code)) return json({message:"bad code"}, 400);
         const k = "SHARE:" + code;
         const raw = await env.SHAREKV.get(k);
         if (!raw) return json({message:"not found or expired"}, 404);
         const data = JSON.parse(raw);
         return json({ preset: data.preset, schemaVersion: 1, createdAt: data.createdAt, expiresAt: data.expiresAt }, 200);
       }

       const sMatch = path.match(/^\/s\/([A-Z0-9]{6})$/i);
       if (sMatch){
         const code = sMatch[1].toUpperCase();
         const page = `<!doctype html>
<html lang="ja"><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Preset Share</title>
<style>
  body{font-family:system-ui,-apple-system,BlinkMacSystemFont,sans-serif;background:#f5f5f7;color:#1d1d1f;margin:0;display:grid;place-items:center;min-height:100vh}
  .card{background:#fff;border-radius:18px;box-shadow:0 18px 45px rgba(0,0,0,.12);padding:24px 22px;max-width:420px;width:calc(100% - 40px);text-align:center}
  .code{font-weight:800;font-size:44px;letter-spacing:.14em;font-variant-numeric:tabular-nums;margin:10px 0 6px}
  .btn{appearance:none;border:0;background:#111827;color:#fff;border-radius:12px;padding:10px 14px;font-weight:650;cursor:pointer}
  .note{color:#6e6e73;font-size:12px;line-height:1.6}
</style>
<div class="card">
  <div class="note"></div>
  <div class="code" id="c">${code}</div>
  <button class="btn" id="copy"></button>
  <div class="note" style="margin-top:12px"> </div>
</div>
<script>
  const c = document.getElementById('c').textContent;
  document.getElementById('copy').onclick = async () => {
    try{ await navigator.clipboard.writeText(c); }catch{
      const ta=document.createElement('textarea');ta.value=c;document.body.appendChild(ta);ta.select();document.execCommand('copy');ta.remove();
    }
  };
<\/script>`;
         return html(page, 200);
       }

       return new Response("Not found", { status:404, headers:cors });
     }
   };
   ============================================================ */

</script>

</body>
</html>
